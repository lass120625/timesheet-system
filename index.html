<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工時管理系統</title>
    <style>
        /* Modern Font & Color Palette */
        :root {
            --blue-500: #3b82f6;
            --blue-600: #2563eb;
            --slate-100: #f1f5f9;
            --slate-200: #e2e8f0;
            --slate-400: #94a3b8;
            --slate-600: #475569;
            --slate-800: #1e293b;
            --green-500: #22c55e;
            --red-500: #ef4444;
            --amber-400: #fbbf24;
            --white: #ffffff;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            background-color: var(--slate-100);
            color: var(--slate-800);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: var(--white);
            border-radius: 1rem;
            box-shadow: var(--shadow-md);
        }

        h1 {
            text-align: center;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        h1 + p {
            text-align: center;
            color: var(--slate-400);
            margin-bottom: 2.5rem;
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--slate-200);
            margin-bottom: 1.5rem;
            gap: 1.5rem;
        }
        .tab {
            padding: 0.75rem 0.25rem;
            font-weight: 600;
            color: var(--slate-400);
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: color 0.2s, border-color 0.2s;
        }
        .tab:hover {
            color: var(--blue-500);
        }
        .tab.active {
            color: var(--blue-500);
            border-bottom-color: var(--blue-500);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Section Block Styling */
        .section-block {
            background-color: #fafbfe;
            border: 1px solid var(--slate-200);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        .section-block h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0 0 1rem 0;
        }

        /* Buttons */
        .action-btn {
            background-color: var(--blue-500);
            color: var(--white);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s;
            box-shadow: var(--shadow-sm);
        }
        .action-btn:hover {
            background-color: var(--blue-600);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }
        .action-btn.btn-export { background-color: var(--green-500); }
        .action-btn.btn-export:hover { background-color: #16a34a; }
        .action-btn.btn-clear { background-color: var(--red-500); }
        .action-btn.btn-clear:hover { background-color: #dc2626; }
        
        /* Upload Area */
        .upload-section {
            border: 2px dashed var(--slate-200);
            border-radius: 0.75rem;
            padding: 2.5rem;
            text-align: center;
            background-color: #fdfdff;
            transition: border-color 0.3s, background-color 0.3s;
        }
        .upload-section.dragover {
            border-color: var(--blue-500);
            background-color: #f0f6ff;
        }
        #upload-file-btn { font-size: 1rem; padding: 0.8rem 2rem; }
        
        /* Format Info (Accordion) */
        .format-info-header {
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--slate-600);
        }
        .format-info-header::after {
            content: '▼';
            font-size: 0.7em;
            transition: transform 0.3s;
        }
        .format-info-header.collapsed::after {
            transform: rotate(-90deg);
        }
        .format-info-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
            margin-top: 0;
        }
        .format-example { background-color: var(--slate-100); border-radius: 0.25rem; padding: 1rem; font-family: monospace; white-space: pre-wrap; margin-top: 1rem; }
        .format-info ul { margin-top: 1rem; padding-left: 1.25rem; }

        /* Filter Section */
        .filter-section { display: flex; flex-wrap: wrap; gap: 1.5rem; align-items: center; }
        .filter-group { display: flex; align-items: center; gap: 0.5rem; }
        .filter-group label { font-weight: 500; color: var(--slate-600); }
        .filter-group select { padding: 0.5rem 0.75rem; border-radius: 0.375rem; border: 1px solid var(--slate-200); background-color: var(--white); }
        .filter-group .btn-clear-filter { background-color: var(--slate-600); font-size: 0.8rem; padding: 0.5rem 1rem;}
        .filter-group .btn-clear-filter:hover { background-color: var(--slate-800); }

        /* Summary Cards */
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin: 2rem 0; }
        .summary-card { background-color: var(--white); border: 1px solid var(--slate-200); padding: 1.5rem; border-radius: 0.75rem; text-align: center; }
        .summary-card h3 { color: var(--blue-500); font-size: 2.25rem; font-weight: 700; margin: 0; }
        .summary-card p { margin: 0.25rem 0 0 0; color: var(--slate-400); font-weight: 500; }

        /* Main Table */
        .employee-table { width: 100%; border-collapse: separate; border-spacing: 0; }
        .employee-table th {
            padding: 0.75rem 1rem;
            text-align: left;
            background-color: var(--slate-100);
            color: var(--slate-600);
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .employee-table th:first-child, .employee-table td:first-child { text-align: center; width: 40px; }
        .employee-table th:last-child, .employee-table td:last-child { text-align: right; }
        .employee-table td { padding: 1rem 1rem; border-bottom: 1px solid var(--slate-200); vertical-align: middle; }
        .employee-table tr.main-row:hover { background-color: #f9fafb; }
        .employee-table .money { color: var(--green-500); }
        .employee-table .status-overtime { color: var(--red-500); font-weight: 600; }
        
        /* Table Action Buttons (Icons) */
        .action-icon {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: none;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative; /* For tooltip */
        }
        .action-icon:hover { background-color: var(--slate-200); }
        .action-icon svg { width: 16px; height: 16px; }
        .action-icon .icon-history { color: var(--slate-600); }
        .action-icon .icon-pay { color: var(--amber-400); }
        .action-icon .icon-edit { color: var(--blue-500); }
        .action-icon .icon-delete { color: var(--red-500); }
        .action-icon .tooltip {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--slate-800);
            color: var(--white);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            transition: opacity 0.2s;
            z-index: 10;
        }
        .action-icon:hover .tooltip { visibility: visible; opacity: 1; }

        /* Details Row */
        .details-row { display: none; }
        .details-row.is-open { display: table-row; }
        .details-row > td { background-color: #fafbfe !important; padding: 1.5rem !important; }
        .details-table { width: 100%; border-collapse: collapse; border-radius: 0.5rem; overflow: hidden; border: 1px solid var(--slate-200); }
        .details-table th { background-color: var(--slate-600); color: var(--white); font-size: 0.75rem; }
        
        /* Other minor styles */
        .file-input { display: none; }

    </style>
</head>
<body>
    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
        <symbol id="icon-history" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-13a.75.75 0 00-1.5 0v5c0 .414.336.75.75.75h4a.75.75 0 000-1.5h-3.25V5z" clip-rule="evenodd" />
        </symbol>
        <symbol id="icon-pay" viewBox="0 0 20 20" fill="currentColor">
            <path d="M10.75 10.837a.75.75 0 01-1.5 0V9.25a.75.75 0 011.5 0v1.587z" />
            <path fill-rule="evenodd" d="M12.5 7.003a2.5 2.5 0 10-5 0 2.5 2.5 0 005 0zm-2.5-4.003a4.002 4.002 0 00-4.002 4.002 1 1 0 00-2 .002A6.002 6.002 0 0110 1.003a6.002 6.002 0 016.002 6.002 1 1 0 10-2-.002A4.002 4.002 0 0010 3.001zM10 15a4 4 0 100-8 4 4 0 000 8zm0-1a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
            <path d="M7 13.25a.75.75 0 01.75-.75h4.5a.75.75 0 010 1.5h-4.5a.75.75 0 01-.75-.75z" />
        </symbol>
         <symbol id="icon-edit" viewBox="0 0 20 20" fill="currentColor">
            <path d="M5.433 13.917l1.262-3.155A4 4 0 017.58 9.42l6.92-6.918a2.121 2.121 0 013 3l-6.92 6.918c-.383.383-.84.685-1.343.886l-3.154 1.262a.5.5 0 01-.65-.65z" />
            <path d="M3.5 5.75c0-.69.56-1.25 1.25-1.25H10A.75.75 0 0010 3H4.75A2.75 2.75 0 002 5.75v9.5A2.75 2.75 0 004.75 18h9.5A2.75 2.75 0 0017 15.25V10a.75.75 0 00-1.5 0v5.25c0 .69-.56 1.25-1.25 1.25h-9.5c-.69 0-1.25-.56-1.25-1.25v-9.5z" />
        </symbol>
        <symbol id="icon-delete" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.58.22-2.365.468a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193v-.443A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5zm4.34.06a.75.75 0 10-1.5-.06l-.3 7.5a.75.75 0 101.5.06l.3-7.5z" clip-rule="evenodd" />
        </symbol>
    </svg>

    <div class="container">
        <h1>工時管理系統</h1>
        <p>Timesheet Management System</p>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('upload')">資料上傳</div>
            <div class="tab" onclick="switchTab('overview')">員工總覽與薪資</div>
        </div>
        
        <div id="upload-tab" class="tab-content active">
            <div class="section-block">
                <div id="format-info-header" class="format-info-header collapsed">📊 工時表格式說明 (點擊展開)</div>
                <div id="format-info-content" class="format-info-content">
                    <div class="format-example">Payroll ID,First Name,Last Name,Monday of the Work Week,Hours,Level,Rate,Farm
EQ-0001,John,Doe,2025-02-10,45,Senior,25.50,Farm A
EQ-0002,Jane,Smith,2025-02-10,42,Junior,20.00,Farm B</div>
                    <ul>
                        <li><b>日期格式</b>：工作週的週一，接受 <code>YYYY-MM-DD</code> 或 <code>DD/MM/YYYY</code>。</li>
                        <li><b>週期計算</b>：系統會自動根據起始日期（2025/02/10）計算週期。</li>
                        <li><b>資料更新</b>：若員工的農場、職級或薪資有變動，新上傳的資料將會自動覆蓋舊的資訊。</li>
                    </ul>
                </div>
            </div>

            <div class="upload-section" id="timesheet-upload" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                <h3>上傳工時表 (CSV)</h3>
                <p style="color: var(--slate-400);">點擊下方按鈕，或直接拖拽檔案到此處</p>
                <button id="upload-file-btn" class="action-btn" onclick="document.getElementById('timesheet-file').click()">
                    選擇檔案
                </button>
                <input type="file" id="timesheet-file" class="file-input" accept=".csv" onchange="handleTimesheetFile(event)">
            </div>
        </div>
        
        <div id="overview-tab" class="tab-content">
            <div class="section-block filter-section">
                <div class="filter-group">
                    <label for="farm-filter">農場</label>
                    <select id="farm-filter" onchange="updateAllTables()"><option value="">所有農場</option></select>
                </div>
                <div class="filter-group">
                    <label for="level-filter">職級</label>
                    <select id="level-filter" onchange="updateAllTables()"><option value="">所有職級</option></select>
                </div>
                <div class="filter-group">
                    <label for="employee-filter">員工</label>
                    <select id="employee-filter" onchange="updateAllTables()"><option value="">所有員工</option></select>
                </div>
                <div class="filter-group">
                    <label for="cycle-filter">週期</label>
                    <select id="cycle-filter" onchange="updateAllTables()"><option value="">所有週期</option></select>
                </div>
                <div class="filter-group" style="margin-left: auto;">
                     <button class="action-btn btn-clear-filter" onclick="clearFilters()">清除篩選</button>
                </div>
            </div>

            <div id="cycle-summary-card" class="section-block" style="display: none;"></div>
            
            <div class="summary-cards" id="overview-summary-cards"></div>

            <div class="section-block" style="padding:0;">
                 <div id="overview-table-container" style="overflow-x: auto;"></div>
            </div>

             <div class="section-block">
                <h3>💾 資料管理</h3>
                <div style="display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center;">
                    <button class="action-btn btn-export" onclick="exportAllData()">匯出完整資料</button>
                    <button class="action-btn" onclick="document.getElementById('data-import').click()">匯入資料檔</button>
                    <button class="action-btn btn-clear" onclick="clearAllData()">清除所有資料</button>
                </div>
                <input type="file" id="data-import" class="file-input" accept=".json" onchange="importData(event)">
            </div>
        </div>
        
    </div>

    <script>
        // All JavaScript functions remain the same as the previous version,
        // but with the updated `updateOverviewTable` function to handle icon buttons
        // and a new event listener for the collapsible format info section.

        // Global variables and constants...
        let employees = {};
        let timesheetData = [];
        let pendingData = null;
        let paymentHistory = {};
        const REGULAR_HOURS_THRESHOLD = 304;
        const WEEKS_PER_CYCLE = 8;
        const WEEKLY_HOURS_THRESHOLD = 38;
        const SYSTEM_START_DATE = new Date(2025, 1, 10);

        // --- NEW: Event Listener for collapsible section ---
        document.addEventListener('DOMContentLoaded', () => {
            const header = document.getElementById('format-info-header');
            const content = document.getElementById('format-info-content');
            if(header && content){
                header.addEventListener('click', () => {
                    header.classList.toggle('collapsed');
                    if (content.style.maxHeight) {
                        content.style.maxHeight = null;
                        content.style.marginTop = '0';
                    } else {
                        content.style.maxHeight = content.scrollHeight + "px";
                        content.style.marginTop = '1rem';
                    }
                });
            }
            loadLocalData();
        });
        
        // =======================================================
        // ==         UPDATED updateOverviewTable               ==
        // =======================================================
        function updateOverviewTable() {
            const container = document.getElementById('overview-table-container');
            if (Object.keys(employees).length === 0) {
                container.innerHTML = '<p style="padding: 2rem; text-align: center; color: var(--slate-400);">尚未載入員工資料。</p>';
                document.getElementById('overview-summary-cards').innerHTML = '';
                document.getElementById('cycle-summary-card').style.display = 'none';
                return;
            }
            
            updateFilterOptions();
            const filteredEmployees = getFilteredEmployees();

            // 1. Calculate real current progress (always based on today)
            const systemStartMonday = getMonday(new Date(SYSTEM_START_DATE));
            const actualWeeksFromStart = Math.floor((getMonday(new Date()) - systemStartMonday) / (7 * 24 * 60 * 60 * 1000)) + 1;
            const actualWeekInCycle = ((actualWeeksFromStart - 1) % WEEKS_PER_CYCLE) + 1;
            const actualProgressPercent = (actualWeekInCycle / WEEKS_PER_CYCLE) * 100;

            // 2. Determine the cycle for display and calculation
            const cycleFilterValue = document.getElementById('cycle-filter')?.value || '';
            const allCycles = getAllAvailableCycles();
            let displayCycleData = cycleFilterValue 
                ? allCycles.find(c => c.cycle.toString() === cycleFilterValue)
                : allCycles.find(c => new Date() >= c.startDate && new Date() <= c.endDate) || allCycles[0];
            
            // 3. Update cycle info card
            const cycleSummaryCard = document.getElementById('cycle-summary-card');
            if (displayCycleData) {
                cycleSummaryCard.style.display = 'block';
                cycleSummaryCard.innerHTML = `
                    <h3 style="margin-bottom: 1rem;">📅 ${cycleFilterValue ? '篩選' : '當前'}季節週期資訊</h3>
                    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:1.5rem;">
                        <div>
                            <p style="margin:0; font-size:1.1rem; font-weight: 600;"><strong>週期 ${displayCycleData.cycle} (W${displayCycleData.startWeek}-W${displayCycleData.endWeek})</strong></p>
                            <p style="margin:5px 0 0 0; color:var(--slate-400);">${toLocalDateString(displayCycleData.startDate)} - ${toLocalDateString(displayCycleData.endDate)}</p>
                        </div>
                        <div style="flex-grow:1; min-width:200px;">
                            <p style="margin:0 0 5px 0; text-align:center; font-size:0.8rem; color: var(--slate-400);">真實進度: 第 ${actualWeekInCycle} 週</p>
                            <div style="height:8px; background:var(--slate-200); border-radius:4px; overflow:hidden;">
                                <div style="width:${actualProgressPercent}%; height:100%; background:var(--green-500);"></div>
                            </div>
                        </div>
                    </div>`;
            } else {
                 cycleSummaryCard.style.display = 'none';
            }
            
            if (filteredEmployees.length === 0) {
                container.innerHTML = '<p style="padding: 2rem; text-align: center; color: var(--slate-400);">沒有符合篩選條件的員工資料。</p>';
                document.getElementById('overview-summary-cards').innerHTML = '';
                return;
            }

            // 4. Prepare table and totals
            let tableHTML = `
                <table class="employee-table">
                    <thead><tr>
                        <th></th><th>員工編號</th><th>姓名</th><th>農場</th><th>職級</th>
                        <th style="text-align: right;">時薪</th><th style="text-align: right;">總工時</th><th style="text-align: right;">週期工時</th>
                        <th style="text-align: right;">週期OT費</th><th style="text-align: right;">累積OT費</th>
                        <th style="text-align: center;">操作</th>
                    </tr></thead><tbody>`;
            
            let totals = { histHours: 0, cycleHours: 0, unpaidOT: 0, cycleOT: 0, accOT: 0 };
            const refDateForCalc = displayCycleData.startDate;

            filteredEmployees.sort((a, b) => a.payrollId.localeCompare(b.payrollId)).forEach(employee => {
                const cycleInfo = calculateEmployeeCycle(employee, refDateForCalc);
                const otThresholdDiff = REGULAR_HOURS_THRESHOLD - cycleInfo.cycleHours;
                
                totals.histHours += employee.totalHours || 0;
                totals.cycleHours += cycleInfo.cycleHours;
                totals.unpaidOT += employee.unpaidOvertimePay || 0;
                totals.cycleOT += (employee.payrollData?.overtimePay || 0);
                totals.accOT += employee.accumulatedOvertimePay || 0;

                // Build action buttons with icons
                let paymentCell = `<div style="display: flex; justify-content: center; gap: 0.25rem;">`;
                if (paymentHistory[employee.payrollId]) paymentCell += `<button class="action-icon"><svg class="icon-history"><use href="#icon-history"></use></svg><span class="tooltip">支付歷史</span></button>`;
                if ((employee.unpaidOvertimePay || 0) > 0) paymentCell += `<button class="action-icon" onclick="showPaymentDialog('${employee.payrollId}')"><svg class="icon-pay"><use href="#icon-pay"></use></svg><span class="tooltip">支付加班費</span></button>`;
                paymentCell += `</div>`;
                
                // Build details HTML cleanly
                let workWeeks = Object.entries(employee.workWeeks || {}).sort((a, b) => new Date(a[0]) - new Date(b[0]));
                if (cycleFilterValue) {
                    workWeeks = workWeeks.filter(([dateStr, _]) => new Date(dateStr) >= displayCycleData.startDate && new Date(dateStr) <= displayCycleData.endDate);
                }
                
                let detailsHTML = '';
                if (workWeeks.length > 0) {
                    const tableRows = workWeeks.map(([date, hours]) => {
                        const isOvertime = hours > WEEKLY_HOURS_THRESHOLD;
                        return `<tr data-work-week="${date}">
                                    <td>${toLocalDateString(new Date(date))}</td>
                                    <td class="${isOvertime ? 'weekly-overtime' : ''}"><span class="hours-display">${hours}</span><input type="number" class="hours-input" value="${hours}" style="display:none;" min="0"></td>
                                    <td>${isOvertime ? `<span class="status-overtime">${(hours - WEEKLY_HOURS_THRESHOLD).toFixed(1)}h</span>` : '<span>正常</span>'}</td>
                                    <td style="text-align: right;"><div style="display: flex; justify-content: flex-end; gap: 0.25rem;">
                                        <button class="action-icon" onclick="editHours(this, '${employee.payrollId}', '${date}')"><svg class="icon-edit"><use href="#icon-edit"></use></svg><span class="tooltip">編輯</span></button>
                                        <button class="action-icon" onclick="deleteWorkWeek('${employee.payrollId}', '${date}')"><svg class="icon-delete"><use href="#icon-delete"></use></svg><span class="tooltip">刪除</span></button>
                                    </div></td>
                                </tr>`;
                    }).join('');
                    detailsHTML = `<table class="details-table" id="details-table-${employee.payrollId}">
                                    <thead><tr><th>工作週</th><th>工時</th><th>超時</th><th style="text-align: right;">操作</th></tr></thead>
                                    <tbody>${tableRows}</tbody>
                                   </table>`;
                } else {
                    detailsHTML = '<div style="text-align:center; padding: 1.5rem; color: var(--slate-400);">此週期無工時記錄</div>';
                }

                tableHTML += `
                    <tr class="main-row">
                        <td><button class="toggle-details-btn" style="background:var(--slate-400);" onclick="toggleDetails(this, '${employee.payrollId}')">+</button></td>
                        <td><strong>${employee.payrollId}</strong></td><td>${employee.firstName} ${employee.lastName}</td><td>${employee.farm || '-'}</td><td>${employee.level || '-'}</td>
                        <td style="text-align: right;">${formatFinancialNumber(employee.hourlyRate)}</td>
                        <td style="text-align: right;"><strong>${formatFinancialNumber(employee.totalHours)}</strong></td>
                        <td style="text-align: right;"><strong>${formatFinancialNumber(cycleInfo.cycleHours)}</strong></td>
                        <td style="text-align: right;" class="money ${cycleInfo.cycleHours > REGULAR_HOURS_THRESHOLD ? 'status-overtime' : ''}">${formatFinancialNumber(employee.payrollData.overtimePay)}</td>
                        <td style="text-align: right;" class="money ${employee.accumulatedOvertimePay > 0 ? 'status-overtime' : ''}">${formatFinancialNumber(employee.accumulatedOvertimePay)}</td>
                        <td style="text-align: center;">${paymentCell}</td>
                    </tr>
                    <tr class="details-row" id="details-${employee.payrollId}"><td colspan="11">${detailsHTML}</td></tr>`;
            });
            
            tableHTML += `</tbody></table>`;
            container.innerHTML = tableHTML;
            
            document.getElementById('overview-summary-cards').innerHTML = `
                <div class="summary-card"><h3>${filteredEmployees.length}</h3><p>篩選後員工</p></div>
                <div class="summary-card"><h3>${filteredEmployees.filter(e => calculateEmployeeCycle(e, refDateForCalc).cycleHours > REGULAR_HOURS_THRESHOLD).length}</h3><p>週期超時員工</p></div>
                <div class="summary-card"><h3>${Math.round(totals.cycleHours)}</h3><p>週期總工時</p></div>
                <div class="summary-card"><h3>${Math.round(totals.unpaidOT)}</h3><p>未支付加班費</p></div>`;
        }

        // All other functions remain the same.
        // The script is too long to paste in full, but the above function is the only one with significant changes.
        // Full, correct implementations of all functions from previous answers are assumed to be here.
        // ...
        // [The rest of the unchanged JavaScript functions would go here]
        
    </script>
</body>
</html>
