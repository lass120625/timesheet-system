<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥æ™‚ç®¡ç†ç³»çµ±</title>
    <style>
        /* General Styles */
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.08);
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 32px;
            font-weight: 600;
        }

        /* Message Styles */
        .success-message {
            background: #e6ffe6;
            color: #006600;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 5px solid #006600;
            opacity: 1;
            transition: opacity 0.5s ease;
        }

        .error-message {
            background: #ffe6e6;
            color: #cc0000;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 5px solid #cc0000;
            opacity: 1;
            transition: opacity 0.5s ease;
        }

        .warning-message {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 5px solid #ffc107;
            opacity: 1;
            transition: opacity 0.5s ease;
        }
        
        .message-fadeout {
            opacity: 0;
        }

        /* Upload Section */
        .upload-section {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
            background: #f8f9ff;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }

        .upload-section.dragover {
            border-color: #28a745;
            background: #e8f5e8;
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.2);
        }

        .upload-section.dragover h3 {
            color: #28a745;
        }

        .upload-section.dragover p {
            color: #155724;
            font-weight: bold;
        }

        .file-input {
            display: none;
        }

        .upload-btn, .action-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: transform 0.2s, background 0.3s, box-shadow 0.2s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .upload-btn:hover, .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .upload-btn:active, .action-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .upload-btn:disabled, .action-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .file-info {
            margin-top: 15px;
            padding: 10px;
            background: #e8f5e8;
            border-radius: 5px;
        }

        /* Data Management */
        .data-section {
            background: #f6f8fa;
            border: 2px solid #28a745;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }

        .data-section h3 {
            color: #28a745;
            margin: 0 0 15px 0;
            font-size: 22px;
        }

        .data-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .btn-export {
            background: linear-gradient(45deg, #28a745, #20c997);
        }

        .btn-import {
            background: linear-gradient(45deg, #007bff, #6610f2);
        }

        .btn-clear {
            background: linear-gradient(45deg, #dc3545, #fd7e14);
        }

        /* Tabs */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }

        .tab {
            padding: 15px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            min-width: 120px;
            text-align: center;
            font-weight: 500;
            color: #555;
        }

        .tab.active {
            border-bottom-color: #667eea;
            color: #667eea;
            font-weight: bold;
            background: #f0f2ff;
        }

        .tab:hover:not(.active) {
            background: #f8faff;
            color: #667eea;
        }

        .tab-content {
            display: none;
            padding-top: 10px;
        }

        .tab-content.active {
            display: block;
        }

        /* Tables */
        .employee-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
            text-align: center;
        }

        .employee-table th,
        .employee-table td {
            border: 1px solid #ddd;
            padding: 10px 8px;
            text-align: center;
            vertical-align: middle;
        }

        .employee-table th {
            background: #667eea;
            color: white;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .employee-table tr:nth-child(even) {
            background: #f9f9f9;
        }

        .employee-table tr.main-row:hover {
            background: #f0f2ff;
        }

        .toggle-details-btn {
            cursor: pointer;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-weight: bold;
            font-size: 16px;
            line-height: 24px;
            text-align: center;
        }

        .details-row {
            display: none;
        }

        .details-row.is-open {
            display: table-row;
        }

        .details-row td {
            background-color: #f8f9fa !important;
            padding: 15px !important;
            text-align: left !important;
        }

        .details-table {
            width: 50%;
            margin: 0 auto;
            border-collapse: collapse;
        }

        .details-table th, .details-table td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: center;
            background: white;
        }

        .details-table th {
            background: #6c757d;
            color: white;
            font-size: 12px;
        }

        .details-table input {
            width: 60px;
            padding: 4px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 13px;
        }

        .details-table input:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.25);
        }

        .edit-actions {
            margin-top: 10px;
            text-align: center;
        }

        .btn-save, .btn-cancel-edit {
            padding: 6px 12px;
            margin: 0 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
        }

        .btn-save {
            background: #28a745;
            color: white;
        }

        .btn-save:hover {
            background: #218838;
        }

        .btn-cancel-edit {
            background: #6c757d;
            color: white;
        }

        .btn-cancel-edit:hover {
            background: #5a6268;
        }

        .btn-edit {
            background: #007bff;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            margin-left: 10px;
        }

        .btn-edit:hover {
            background: #0056b3;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            margin-left: 5px;
        }

        .btn-delete:hover {
            background: #c82333;
        }

        .weekly-overtime {
            color: #fd7e14;
            font-weight: bold;
        }

        .status-normal {
            color: #228B22;
            font-weight: bold;
        }

        .status-overtime {
            color: #ff4444;
            font-weight: bold;
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease-out;
        }
        
        #progress-text {
            text-align: center;
            font-weight: 500;
            color: #555;
            margin-top: 5px;
        }

        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .summary-card h3 {
            margin: 0 0 10px 0;
            font-size: 24px;
            font-weight: 700;
        }

        .summary-card p {
            margin: 0;
            font-size: 14px;
            opacity: 0.9;
        }

        .money {
            color: #28a745;
            font-weight: bold;
        }

        .format-info {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            font-size: 14px;
        }

        .format-info h4 {
            margin: 0 0 10px 0;
            color: #0066cc;
            font-size: 18px;
        }

        .format-example {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            margin: 5px 0;
            white-space: pre-wrap;
            word-break: break-all;
            line-height: 1.5;
        }

        .format-info ul {
            padding-left: 20px;
            margin-top: 10px;
        }

        .format-info li {
            margin-bottom: 5px;
        }

        /* Validation Results */
        .validation-results {
            margin: 20px 0;
        }

        .validation-item {
            padding: 12px;
            margin: 8px 0;
            border-radius: 5px;
            border-left: 5px solid;
            font-size: 15px;
        }

        .validation-success {
            background: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }

        .validation-warning {
            background: #fff3cd;
            border-left-color: #ffc107;
            color: #856404;
        }

        .validation-error {
            background: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }

        /* Upload Summary */
        .upload-summary {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .upload-summary h3 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-size: 15px;
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .highlight {
            background: #fff3cd;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: bold;
        }

        /* Confirm Dialog */
        .confirm-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .confirm-dialog.active {
            opacity: 1;
            visibility: visible;
        }

        .confirm-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            max-height: 90%;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .confirm-dialog.active .confirm-content {
            transform: scale(1);
        }

        .confirm-content h3 {
            font-size: 24px;
            margin-bottom: 15px;
            text-align: center;
            color: #333;
        }

        .confirm-content p {
            margin-bottom: 20px;
            text-align: center;
            font-size: 16px;
        }

        .confirm-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .btn-confirm, .btn-cancel {
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s, transform 0.2s;
        }

        .btn-confirm {
            background: #28a745;
            color: white;
        }

        .btn-confirm:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-cancel {
            background: #dc3545;
            color: white;
        }

        .btn-cancel:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        /* Loading spinner */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #fff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 5px;
        }

        .spinner-dark {
            border: 3px solid rgba(0, 0, 0, 0.2);
            border-top: 3px solid #333;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š å·¥æ™‚ç®¡ç†ç³»çµ±</h1>
        <div style="text-align: center; margin-bottom: 20px;">
            <small>ğŸ”„ æœ¬åœ°å„²å­˜ | ğŸ“Š å³æ™‚è¨ˆç®— | ğŸ’¾ æª”æ¡ˆç®¡ç†</small>
        </div>
        
        <div class="data-section">
            <h3>ğŸ’¾ è³‡æ–™ç®¡ç†</h3>
            <p>æ‰€æœ‰è³‡æ–™å„²å­˜åœ¨ç€è¦½å™¨æœ¬åœ°ï¼Œé—œé–‰ç€è¦½å™¨å¾Œè³‡æ–™ä»æœƒä¿ç•™ã€‚</p>
            <div class="data-buttons">
                <button class="action-btn btn-export" onclick="exportAllData()">
                    ğŸ“¤ åŒ¯å‡ºå®Œæ•´è³‡æ–™
                </button>
                <button class="action-btn btn-import" onclick="document.getElementById('data-import').click()">
                    ğŸ“¥ åŒ¯å…¥è³‡æ–™æª”
                </button>
                <button class="action-btn btn-clear" onclick="clearAllData()">
                    ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰è³‡æ–™
                </button>
            </div>
            <input type="file" id="data-import" class="file-input" accept=".json" onchange="importData(event)">
            <div id="data-status" style="margin-top: 15px; padding: 10px; background: #e8f5e8; border-radius: 5px; font-size: 14px; display: none;">
                <strong>è³‡æ–™ç‹€æ…‹ï¼š</strong><span id="data-status-text">è¼‰å…¥ä¸­...</span>
            </div>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('upload')">ğŸ“ è³‡æ–™ä¸Šå‚³</div>
            <div class="tab" onclick="switchTab('overview')">ğŸ‘¥ å“¡å·¥ç¸½è¦½</div>
            <div class="tab" onclick="switchTab('payroll')">ğŸ’° è–ªè³‡è¨ˆç®—</div>
        </div>
        
        <div id="upload-tab" class="tab-content active">
            <div class="format-info">
                <h4>ğŸ“Š å·¥æ™‚è¡¨æ ¼å¼èªªæ˜</h4>
                <div class="format-example">Payroll ID, First Name, Last Name, Start Date, Work Week, Hours, Level, Rate, Farm
EQ-0001, John, Doe, 2024-01-15, 2024-01-15, 45, Senior, 25.50, Farm A
EQ-0001, John, Doe, 2024-01-15, 2024-01-22, 38, Senior, 25.50, Farm A
EQ-0002, Jane, Smith, 2024-02-01, 2024-02-05, 42, Junior, 20.00, Farm B</div>
                <p><strong>é‡è¦æ ¼å¼èªªæ˜ï¼š</strong></p>
                <ul>
                    <li>ğŸ“… <strong>Start Date</strong>ï¼šå“¡å·¥åœ¨è©²è¾²å ´å·¥ä½œçš„ç¬¬ä¸€å¤©ï¼Œæ ¼å¼ç‚º YYYY-MM-DD æˆ– DD/MM/YYYY</li>
                    <li>ğŸ“… <strong>Work Week</strong>ï¼šå·¥ä½œé€±çš„é€±ä¸€æ—¥æœŸï¼Œæ ¼å¼ç‚º YYYY-MM-DD æˆ– DD/MM/YYYY</li>
                    <li>ğŸ”¢ <strong>é€±æ•¸è¨ˆç®—</strong>ï¼šç³»çµ±æœƒè‡ªå‹•æ ¹æ“š Start Date å’Œ Work Week è¨ˆç®—æ­£ç¢ºçš„é€±æ•¸</li>
                    <li>ğŸ­ <strong>Farm/Level/Rate æ›´æ–°</strong>ï¼šå¦‚æœå“¡å·¥è½‰æ›è¾²å ´æˆ–èª¿æ•´è–ªè³‡ï¼Œæ–°è³‡æ–™æœƒè¦†è“‹èˆŠè³‡æ–™</li>
                </ul>
                <p><strong>ä¸Šå‚³å¾Œè‡ªå‹•è™•ç†ï¼š</strong></p>
                <ul>
                    <li>âœ… é©—è­‰ EQ-0001 æ ¼å¼çš„å“¡å·¥ç·¨è™Ÿ</li>
                    <li>âœ… è‡ªå‹•è¨ˆç®—æ­£ç¢ºçš„å·¥ä½œé€±æ•¸</li>
                    <li>âœ… æ”¯æ´è¾²å ´å’Œè·ç´šç•°å‹•</li>
                    <li>âœ… æ•´åˆæ–°èˆŠè³‡æ–™ï¼Œæª¢æ¸¬é‡è¤‡å·¥ä½œé€±</li>
                    <li>âœ… è‡ªå‹•å„²å­˜åˆ°ç€è¦½å™¨æœ¬åœ°</li>
                </ul>
            </div>
            
            <div class="upload-section" id="timesheet-upload" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                <h3>ğŸ“‹ ä¸Šå‚³å·¥æ™‚è¡¨ (CSV)</h3>
                <p>ğŸ–±ï¸ é»æ“Šé¸æ“‡æª”æ¡ˆ æˆ– ğŸ“ ç›´æ¥æ‹–æ‹½ CSV æª”æ¡ˆåˆ°æ­¤å€åŸŸ</p>
                <button id="upload-file-btn" class="upload-btn" onclick="document.getElementById('timesheet-file').click()">
                    <span class="spinner" style="display: none;"></span>
                    é¸æ“‡å·¥æ™‚è¡¨æ–‡ä»¶
                </button>
                <input type="file" id="timesheet-file" class="file-input" accept=".csv" onchange="handleTimesheetFile(event)">
                <div id="timesheet-file-info" class="file-info" style="display: none;"></div>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <p id="progress-text">ç­‰å¾…ä¸Šå‚³æ–‡ä»¶...</p>
            
            <div id="validation-results" class="validation-results"></div>
        </div>
        
        <div id="overview-tab" class="tab-content"> 
            <h2>ğŸ‘¥ å“¡å·¥ç¸½è¦½èˆ‡é€±æœŸåˆ†æ</h2>
            
            <div class="format-info">
                <h4>ğŸ” ç¯©é¸é¸é …</h4>
                <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                    <div>
                        <label for="farm-filter"><strong>è¾²å ´ï¼š</strong></label>
                        <select id="farm-filter" onchange="updateAllTables()" style="padding: 8px 12px; margin-left: 8px; border-radius: 5px; border: 1px solid #ccc;">
                            <option value="">æ‰€æœ‰è¾²å ´</option>
                        </select>
                    </div>
                    <div>
                        <label for="level-filter"><strong>è·ç´šï¼š</strong></label>
                        <select id="level-filter" onchange="updateAllTables()" style="padding: 8px 12px; margin-left: 8px; border-radius: 5px; border: 1px solid #ccc;">
                            <option value="">æ‰€æœ‰è·ç´š</option>
                        </select>
                    </div>
                    <div>
                        <label for="employee-filter"><strong>å“¡å·¥ï¼š</strong></label>
                        <select id="employee-filter" onchange="updateAllTables()" style="padding: 8px 12px; margin-left: 8px; border-radius: 5px; border: 1px solid #ccc;">
                            <option value="">æ‰€æœ‰å“¡å·¥</option>
                        </select>
                    </div>
                    <button class="action-btn" onclick="clearFilters()" style="padding: 8px 18px; background: #6c757d; color: white; border: none; border-radius: 3px; box-shadow: none;">æ¸…é™¤ç¯©é¸</button>
                </div>
            </div>
            
            <div class="summary-cards" id="overview-summary-cards"></div>
            <div id="overview-table-container"></div>
            
            <button id="exportOverview" class="upload-btn action-btn" onclick="exportOverview()" style="margin-top: 20px;">
                <span class="spinner" style="display: none;"></span>
                ğŸ“¥ åŒ¯å‡ºå“¡å·¥ç¸½è¦½å ±å‘Š (CSV)
            </button>
        </div>
        
        <div id="payroll-tab" class="tab-content"> 
            <h2>ğŸ’° è–ªè³‡è¨ˆç®—çµæœ</h2>
            <div class="summary-cards" id="payroll-summary-cards"></div>
            <div id="payroll-table-container"></div>
            <button id="exportPayroll" class="upload-btn action-btn" onclick="exportPayroll()" style="margin-top: 20px;">
                <span class="spinner" style="display: none;"></span>
                ğŸ“¥ åŒ¯å‡ºè–ªè³‡å ±è¡¨ (CSV)
            </button>
        </div>
        
        <div id="messages"></div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let employees = {};
        let timesheetData = [];
        let pendingData = null;
        
        // å¸¸æ•¸å®šç¾©
        const REGULAR_HOURS_THRESHOLD = 304; // 8é€±é€±æœŸå…§æ­£å¸¸å·¥æ™‚ä¸Šé™
        const WEEKS_PER_CYCLE = 8; // æ¯å€‹é€±æœŸçš„é€±æ•¸
        const WEEKLY_HOURS_THRESHOLD = 38; // æ¯é€±å·¥æ™‚æ¨™æº–

        // åˆå§‹åŒ–å‡½æ•¸
        document.addEventListener('DOMContentLoaded', function() {
            loadLocalData();
            updateProgress(0, 'ç³»çµ±å·²å°±ç·’ï¼Œè«‹ä¸Šå‚³å·¥æ™‚è¡¨');
            updateDataStatus();
        });

        // è¼‰å…¥æœ¬åœ°è³‡æ–™
        function loadLocalData() {
            try {
                const storedEmployees = localStorage.getItem('timesheet_employees');
                const storedTimesheetData = localStorage.getItem('timesheet_data');
                
                if (storedEmployees) {
                    employees = JSON.parse(storedEmployees);
                }
                
                if (storedTimesheetData) {
                    timesheetData = JSON.parse(storedTimesheetData);
                }
                
                updateAllTables();
                console.log('âœ… æœ¬åœ°è³‡æ–™è¼‰å…¥æˆåŠŸ');
            } catch (error) {
                console.error('è¼‰å…¥æœ¬åœ°è³‡æ–™å¤±æ•—:', error);
                showMessage('è¼‰å…¥æœ¬åœ°è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤', 'warning');
            }
        }

        // å„²å­˜æœ¬åœ°è³‡æ–™
        function saveLocalData() {
            try {
                localStorage.setItem('timesheet_employees', JSON.stringify(employees));
                localStorage.setItem('timesheet_data', JSON.stringify(timesheetData));
                updateDataStatus();
                console.log('âœ… è³‡æ–™å·²å„²å­˜åˆ°æœ¬åœ°');
            } catch (error) {
                console.error('å„²å­˜æœ¬åœ°è³‡æ–™å¤±æ•—:', error);
                showMessage('å„²å­˜è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
            }
        }

        // æ›´æ–°è³‡æ–™ç‹€æ…‹é¡¯ç¤º
        function updateDataStatus() {
            const statusDiv = document.getElementById('data-status');
            const statusText = document.getElementById('data-status-text');
            
            const empCount = Object.keys(employees).length;
            const recordCount = timesheetData.length;
            const lastUpdate = localStorage.getItem('last_update') || 'æœªçŸ¥';
            
            if (empCount > 0 || recordCount > 0) {
                statusDiv.style.display = 'block';
                statusText.textContent = `${empCount} ä½å“¡å·¥ï¼Œ${recordCount} ç­†å·¥æ™‚è¨˜éŒ„ï¼Œæœ€å¾Œæ›´æ–°ï¼š${lastUpdate}`;
            } else {
                statusDiv.style.display = 'none';
            }
        }

        // åŒ¯å‡ºå®Œæ•´è³‡æ–™
        function exportAllData() {
            if (Object.keys(employees).length === 0 && timesheetData.length === 0) {
                showMessage('æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡º', 'warning');
                return;
            }

            const data = {
                employees: employees,
                timesheetData: timesheetData,
                exportDate: new Date().toISOString(),
                version: '2.0',
                systemName: 'æœ¬åœ°ç‰ˆå·¥æ™‚ç®¡ç†ç³»çµ±'
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `å·¥æ™‚ç³»çµ±å®Œæ•´è³‡æ–™_${new Date().toLocaleDateString('zh-TW').replace(/\//g, '-')}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessage('âœ… å®Œæ•´è³‡æ–™å·²åŒ¯å‡ºï¼');
        }

        // åŒ¯å…¥è³‡æ–™æª”
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.employees && data.timesheetData) {
                        if (confirm('ç¢ºå®šè¦åŒ¯å…¥è³‡æ–™å—ï¼Ÿé€™æœƒè¦†è“‹ç¾æœ‰çš„æ‰€æœ‰è³‡æ–™ï¼')) {
                            employees = data.employees;
                            timesheetData = data.timesheetData;
                            saveLocalData();
                            updateAllTables();
                            showMessage('âœ… è³‡æ–™åŒ¯å…¥æˆåŠŸï¼');
                        }
                    } else {
                        showMessage('æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹é¸æ“‡æ­£ç¢ºçš„è³‡æ–™æª”', 'error');
                    }
                } catch (error) {
                    showMessage('è®€å–æª”æ¡ˆå¤±æ•—ï¼š' + error.message, 'error');
                }
            };
            reader.readAsText(file);
            
            // æ¸…é™¤æª”æ¡ˆé¸æ“‡
            event.target.value = '';
        }

        // æ¸…é™¤æ‰€æœ‰è³‡æ–™
        function clearAllData() {
            if (confirm('âš ï¸ ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿé€™å°‡æœƒåˆªé™¤æ‰€æœ‰å“¡å·¥è³‡æ–™å’Œå·¥æ™‚è¨˜éŒ„ï¼Œä¸¦ä¸”ç„¡æ³•å¾©åŸï¼')) {
                employees = {};
                timesheetData = [];
                localStorage.removeItem('timesheet_employees');
                localStorage.removeItem('timesheet_data');
                localStorage.removeItem('last_update');
                updateAllTables();
                updateDataStatus();
                showMessage('ğŸ—‘ï¸ æ‰€æœ‰è³‡æ–™å·²æ¸…é™¤ï¼', 'warning');
            }
        }

        // åˆ‡æ›åˆ†é 
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        // é¡¯ç¤ºè¨Šæ¯
        function showMessage(message, type = 'success', duration = 8000) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'error' ? 'error-message' : 
                                 type === 'warning' ? 'warning-message' : 'success-message';
            messageDiv.innerHTML = message;
            messagesDiv.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.classList.add('message-fadeout');
                messageDiv.addEventListener('transitionend', () => messageDiv.remove());
            }, duration);
        }

        // æ›´æ–°é€²åº¦æ¢
        function updateProgress(percentage, text) {
            document.getElementById('progress-fill').style.width = percentage + '%';
            document.getElementById('progress-text').textContent = text;
        }

        // é©—è­‰å“¡å·¥ç·¨è™Ÿæ ¼å¼
        function validatePayrollID(payrollId) {
            if (!payrollId) return false;
            const pattern = /^[A-Za-z]{2,3}-\d{3,4}$/;
            return pattern.test(payrollId.trim());
        }

        // è§£ææ—¥æœŸå­—ä¸²
        function parseDate(dateString) {
            if (!dateString) return null;
            
            // å˜—è©¦ YYYY-MM-DD æ ¼å¼
            let date = new Date(dateString);
            if (!isNaN(date.getTime()) && dateString.includes('-')) {
                return new Date(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate());
            }

            // å˜—è©¦ DD/MM/YYYY æ ¼å¼
            const partsSlash = dateString.split('/');
            if (partsSlash.length === 3 && partsSlash[0].length <= 2) {
                date = new Date(parseInt(partsSlash[2]), parseInt(partsSlash[1]) - 1, parseInt(partsSlash[0]));
                if (!isNaN(date.getTime())) return date;
            }
            
            return null;
        }

        // å–å¾—é€±ä¸€æ—¥æœŸ
        function getMonday(date) {
            const result = new Date(date);
            const dayOfWeek = result.getDay();
            const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            result.setDate(result.getDate() + daysToMonday);
            result.setHours(0, 0, 0, 0);
            return result;
        }

        // è§£ææ™‚è–ª
        function parseRate(rateString) {
            if (!rateString) return 0;
            const cleanedString = rateString.toString().replace(/[^0-9.]/g, '');
            return parseFloat(cleanedString) || 0;
        }

        // è™•ç†æ‹–æ‹½äº‹ä»¶
        function handleDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            const uploadSection = document.getElementById('timesheet-upload');
            uploadSection.classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.preventDefault();
            event.stopPropagation();
            const uploadSection = document.getElementById('timesheet-upload');
            uploadSection.classList.remove('dragover');
        }

        function handleDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const uploadSection = document.getElementById('timesheet-upload');
            uploadSection.classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                
                // æª¢æŸ¥æª”æ¡ˆé¡å‹
                if (!file.name.toLowerCase().endsWith('.csv')) {
                    showMessage('âŒ è«‹é¸æ“‡ CSV æª”æ¡ˆ', 'error');
                    return;
                }
                
                // æ¨¡æ“¬æª”æ¡ˆé¸æ“‡äº‹ä»¶
                const fileInput = document.getElementById('timesheet-file');
                const dt = new DataTransfer();
                dt.items.add(file);
                fileInput.files = dt.files;
                
                // è§¸ç™¼æª”æ¡ˆè™•ç†
                const changeEvent = new Event('change', { bubbles: true });
                fileInput.dispatchEvent(changeEvent);
                
                showMessage(`ğŸ“ å·²æ¥æ”¶æª”æ¡ˆ: ${file.name}`, 'success', 3000);
            }
        }

        // è™•ç†å·¥æ™‚è¡¨ä¸Šå‚³
        async function handleTimesheetFile(event) {
            const file = event.target.files[0];
            if (!file) {
                document.getElementById('timesheet-file-info').style.display = 'none';
                updateProgress(0, 'ç­‰å¾…ä¸Šå‚³æ–‡ä»¶...');
                return;
            }
            
            document.getElementById('validation-results').innerHTML = '';
            document.getElementById('timesheet-file-info').style.display = 'none';

            setButtonLoading('upload-file-btn', true, 'è®€å–ä¸­...');

            try {
                updateProgress(20, 'æ­£åœ¨è®€å–å·¥æ™‚è¡¨...');
                
                const data = await readFile(file);
                const parsed = parseCSV(data);
                
                updateProgress(40, 'é©—è­‰è³‡æ–™æ ¼å¼...');
                
                const validationResult = validateTimesheetData(parsed);
                
                if (validationResult.errors.length > 0) {
                    showValidationResults(validationResult);
                    updateProgress(0, 'è³‡æ–™é©—è­‰å¤±æ•—');
                    showMessage('âŒ å·¥æ™‚è¡¨é©—è­‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ ¼å¼ä¸¦é‡è©¦ã€‚', 'error');
                    return;
                }
                
                updateProgress(60, 'æª¢æŸ¥è³‡æ–™è¡çª...');
                
                const conflicts = checkForConflicts(parsed);
                
                if (conflicts.length > 0) {
                    showConflictDialog(parsed, conflicts);
                } else {
                    await processTimesheetData(parsed);
                }
                
            } catch (error) {
                showMessage('è®€å–å·¥æ™‚è¡¨æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message, 'error');
                updateProgress(0, 'è¼‰å…¥å¤±æ•—');
                console.error('File handling error:', error);
            } finally {
                setButtonLoading('upload-file-btn', false, 'é¸æ“‡å·¥æ™‚è¡¨æ–‡ä»¶');
                document.getElementById('timesheet-file').value = '';
            }
        }

        // é©—è­‰å·¥æ™‚è¡¨è³‡æ–™
        function validateTimesheetData(data) {
            const result = {
                success: [],
                warnings: [],
                errors: []
            };
            
            if (data.length === 0) {
                result.errors.push('æ–‡ä»¶ç‚ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹ç¢ºä¿ CSV åŒ…å«æ•¸æ“šè¡Œã€‚');
                return result;
            }
            
            const requiredFields = ['Payroll ID', 'First Name', 'Last Name', 'Work Week', 'Hours'];
            const headers = Object.keys(data[0] || {});
            
            for (const field of requiredFields) {
                if (!headers.includes(field)) {
                    result.errors.push(`ç¼ºå°‘å¿…è¦æ¬„ä½: ${field}ã€‚è«‹æª¢æŸ¥ CSV æ¨™é¡Œè¡Œã€‚`);
                }
            }
            
            if (result.errors.length > 0) {
                return result;
            }
            
            const employeeConsistency = {};
            let validRecords = 0;
            let skippedEmptyRecords = 0;
            
            data.forEach((row, index) => {
                const payrollId = row['Payroll ID']?.trim();
                const firstName = row['First Name']?.trim();
                const lastName = row['Last Name']?.trim();
                const workWeek = row['Work Week']?.trim();
                const hours = parseFloat(row['Hours']);
                
                // è·³éå®Œå…¨ç©ºç™½çš„è¡Œ
                if (!payrollId && !firstName && !lastName && !workWeek && (isNaN(hours) || hours === 0)) {
                    skippedEmptyRecords++;
                    return;
                }
                
                validRecords++;
                
                if (!validatePayrollID(payrollId)) {
                    result.errors.push(`ç¬¬${index + 2}è¡Œ: Payroll ID æ ¼å¼éŒ¯èª¤ (${payrollId || 'ç©º'})ï¼Œæ‡‰ç‚º EQ-XXXX æ ¼å¼ã€‚`);
                }
                
                if (!firstName || !lastName) {
                    result.warnings.push(`ç¬¬${index + 2}è¡Œ: å“¡å·¥ ${payrollId || ''} çš„å§“åè³‡æ–™ä¸å®Œæ•´ã€‚`);
                }
                
                if (!workWeek) {
                    result.errors.push(`ç¬¬${index + 2}è¡Œ: Work Week ç‚ºç©ºã€‚`);
                } else if (isNaN(parseDate(workWeek)?.getTime())) {
                    result.errors.push(`ç¬¬${index + 2}è¡Œ: Work Week æ—¥æœŸæ ¼å¼éŒ¯èª¤ (${workWeek})ã€‚`);
                }

                if (row['Start Date'] && isNaN(parseDate(row['Start Date'])?.getTime())) {
                    result.warnings.push(`ç¬¬${index + 2}è¡Œ: Start Date æ—¥æœŸæ ¼å¼éŒ¯èª¤ (${row['Start Date'] || 'ç©º'})ã€‚`);
                }
                
                if (isNaN(hours) || hours < 0) {
                    result.errors.push(`ç¬¬${index + 2}è¡Œ: å·¥æ™‚è³‡æ–™ç„¡æ•ˆ (${row['Hours'] || 'ç©º'})ã€‚`);
                }
                
                if (hours > 168) {
                    result.warnings.push(`ç¬¬${index + 2}è¡Œ: å“¡å·¥ ${payrollId || ''} å·¥æ™‚è¶…é168å°æ™‚ (${hours})ã€‚`);
                }
            });
            
            if (result.errors.length === 0) {
                result.success.push(`âœ… æˆåŠŸé©—è­‰ ${validRecords} ç­†å·¥æ™‚è¨˜éŒ„`);
                
                if (skippedEmptyRecords > 0) {
                    result.warnings.push(`âš ï¸ å·²è‡ªå‹•è·³é ${skippedEmptyRecords} è¡Œç©ºç™½è¨˜éŒ„ã€‚`);
                }
            }
            
            return result;
        }

        // æª¢æŸ¥è³‡æ–™è¡çª
        function checkForConflicts(newData) {
            const conflicts = [];
            
            const existingDataMap = new Map();
            timesheetData.forEach(item => {
                existingDataMap.set(`${item.payrollId}-${item.workWeekDate}`, item.hours);
            });
            
            newData.forEach(row => {
                const payrollId = row['Payroll ID']?.trim();
                const workWeekDateStr = row['Work Week']?.trim();
                
                if (payrollId && workWeekDateStr) {
                    const parsed = parseDate(workWeekDateStr);
                    if (!parsed) return;
                    
                    const workWeekDate = toLocalDateString(parsed);
                    const key = `${payrollId}-${workWeekDate}`;
                    const existingHours = parseFloat(existingDataMap.get(key));
                    const newHours = parseFloat(row['Hours']) || 0;

                    if (!isNaN(existingHours) && existingHours !== newHours) {
                        conflicts.push({
                            payrollId: payrollId,
                            workWeekDate: workWeekDate,
                            existingHours: existingHours,
                            newHours: newHours,
                            employeeName: `${row['First Name']} ${row['Last Name']}`.trim()
                        });
                    }
                }
            });
            return conflicts;
        }

        // é¡¯ç¤ºè¡çªè§£æ±ºå°è©±æ¡†
        function showConflictDialog(newData, conflicts) {
            const dialog = document.createElement('div');
            dialog.className = 'confirm-dialog active';
            
            const conflictCount = conflicts.length;
            const sampleConflicts = conflicts.slice(0, 5);
            
            let conflictsList = '';
            sampleConflicts.forEach(conflict => {
                conflictsList += `
                    <div class="validation-warning" style="margin-bottom: 5px;">
                        <strong>${conflict.employeeName}</strong> (${conflict.payrollId}) - ${conflict.workWeekDate}
                        <br>ç¾æœ‰å·¥æ™‚: <span class="highlight">${Number(conflict.existingHours) || 0}</span> â†’ æ–°å·¥æ™‚: <span class="highlight">${Number(conflict.newHours) || 0}</span>
                    </div>
                `;
            });
            
            if (conflictCount > 5) {
                conflictsList += `<div class="validation-warning" style="margin-top: 10px;">...é‚„æœ‰ ${conflictCount - 5} å€‹è¡çªæœªé¡¯ç¤º</div>`;
            }
            
            dialog.innerHTML = `
                <div class="confirm-content">
                    <h3>âš ï¸ ç™¼ç¾ ${conflictCount} å€‹è³‡æ–™è¡çª</h3>
                    <p>ä»¥ä¸‹å·¥æ™‚è³‡æ–™å·²å­˜åœ¨ä¸”å·¥æ™‚æ•¸å€¼ä¸åŒï¼Œæ˜¯å¦è¦ç”¨æ–°ä¸Šå‚³çš„è³‡æ–™è¦†è“‹ï¼Ÿ</p>
                    ${conflictsList}
                    <div class="confirm-buttons">
                        <button class="btn-confirm" onclick="confirmOverwrite(true)">è¦†è“‹ä¸¦æ›´æ–°</button>
                        <button class="btn-cancel" onclick="confirmOverwrite(false)">å–æ¶ˆä¸Šå‚³</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(dialog);
            pendingData = newData;
        }

        // ç¢ºèªè¦†è“‹è¡çª
        async function confirmOverwrite(confirmed) {
            closeDialog();
            
            if (confirmed && pendingData) {
                await processTimesheetData(pendingData, true);
            } else {
                updateProgress(0, 'ä¸Šå‚³å·²å–æ¶ˆ');
                showMessage('â„¹ï¸ è³‡æ–™ä¸Šå‚³å·²å–æ¶ˆã€‚');
            }
            
            pendingData = null;
        }

        // é—œé–‰å°è©±æ¡†
        function closeDialog() {
            const dialog = document.querySelector('.confirm-dialog');
            if (dialog) {
                dialog.classList.remove('active');
                setTimeout(() => dialog.remove(), 300);
            }
        }

        // æ ¼å¼åŒ–æ—¥æœŸç‚º YYYY-MM-DD
        function toLocalDateString(date) {
            if (!date || isNaN(date.getTime())) return '';
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // è™•ç†å·¥æ™‚è¡¨è³‡æ–™
        async function processTimesheetData(data, overwrite = false) {
            updateProgress(10, 'é–‹å§‹è™•ç†è³‡æ–™...');
            
            const uploadSummary = {
                totalRecords: data.length,
                employees: new Set(),
                newRecords: 0,
                updatedRecords: 0,
                weeks: new Set()
            };
            
            updateProgress(20, 'è™•ç†è³‡æ–™ä¸­...');
            
            for (let i = 0; i < data.length; i++) {
                const row = data[i];
                const payrollId = row['Payroll ID']?.trim();
                if (!validatePayrollID(payrollId)) continue;
                
                const firstName = row['First Name']?.trim();
                const lastName = row['Last Name']?.trim();
                const startDateStr = row['Start Date']?.trim();
                const workWeekStr = row['Work Week']?.trim();
                const hours = parseFloat(row['Hours']) || 0;
                const level = row['Level']?.trim();
                const rate = parseRate(row['Rate']);
                const farm = row['Farm']?.trim();

                const parsedWorkWeek = parseDate(workWeekStr);
                if (!parsedWorkWeek) continue;
                
                const workWeekDate = toLocalDateString(parsedWorkWeek);
                
                uploadSummary.employees.add(payrollId);
                uploadSummary.weeks.add(workWeekDate);
                
                // å»ºç«‹æˆ–æ›´æ–°å“¡å·¥è³‡æ–™
                if (!employees[payrollId]) {
                    let employeeStartDate = toLocalDateString(parseDate(startDateStr));

                    if (!employeeStartDate) {
                        const allWeeksForNewEmployee = data
                            .filter(d => d['Payroll ID']?.trim() === payrollId)
                            .map(d => parseDate(d['Work Week']?.trim()))
                            .filter(d => d);
                        
                        if (allWeeksForNewEmployee.length > 0) {
                            const oldestWeek = new Date(Math.min(...allWeeksForNewEmployee));
                            employeeStartDate = toLocalDateString(getMonday(oldestWeek));
                        } else {
                            employeeStartDate = '2024-01-01';
                        }
                    }
                    
                    employees[payrollId] = {
                        payrollId, firstName, lastName,
                        startDate: employeeStartDate,
                        level: level || '', farm: farm || '', hourlyRate: rate,
                        workWeeks: {}, totalHours: 0,
                        payrollData: { regularHours: 0, overtimeHours: 0, regularPay: 0, overtimePay: 0, cycleHours: 0 },
                        accumulatedOvertimePay: 0
                    };
                } else {
                    employees[payrollId].firstName = firstName;
                    employees[payrollId].lastName = lastName;
                    if (startDateStr) {
                        const newParsedStartDate = parseDate(startDateStr);
                        if (newParsedStartDate) {
                            const currentStartDate = parseDate(employees[payrollId].startDate);
                            if (!currentStartDate || newParsedStartDate.getTime() < currentStartDate.getTime()) {
                                employees[payrollId].startDate = toLocalDateString(newParsedStartDate);
                            }
                        }
                    }
                    if (farm) employees[payrollId].farm = farm;
                    if (level) employees[payrollId].level = level;
                    if (rate) employees[payrollId].hourlyRate = rate;
                }
                
                // æ›´æ–°å·¥æ™‚è¨˜éŒ„
                const currentRecordIndex = timesheetData.findIndex(item => 
                    item.payrollId === payrollId && item.workWeekDate === workWeekDate
                );

                if (currentRecordIndex !== -1) {
                    if (overwrite || timesheetData[currentRecordIndex].hours !== hours) {
                        timesheetData[currentRecordIndex].hours = hours;
                        timesheetData[currentRecordIndex].uploadDate = new Date().toISOString();
                        uploadSummary.updatedRecords++;
                    }
                } else {
                    timesheetData.push({
                        payrollId, firstName, lastName, workWeekDate, hours,
                        uploadDate: new Date().toISOString()
                    });
                    uploadSummary.newRecords++;
                }
                
                const progress = 30 + ((i + 1) / data.length) * 50;
                updateProgress(progress, `è™•ç†ä¸­... ${i + 1}/${data.length}`);
                
                if (i % 10 === 0) {
                    await new Promise(resolve => setTimeout(resolve, 1));
                }
            }
            
            updateProgress(85, 'è¨ˆç®—å·¥æ™‚èˆ‡è–ªè³‡...');
            
            // é‡æ–°è¨ˆç®—æ‰€æœ‰å“¡å·¥çš„å·¥æ™‚å’Œè–ªè³‡
            Object.values(employees).forEach(employee => {
                employee.workWeeks = timesheetData
                    .filter(item => item.payrollId === employee.payrollId)
                    .reduce((acc, item) => {
                        acc[item.workWeekDate] = item.hours;
                        return acc;
                    }, {});
                employee.totalHours = Object.values(employee.workWeeks).reduce((sum, hours) => sum + hours, 0);
                calculatePayroll(employee);
            });
            
            updateProgress(95, 'å„²å­˜è³‡æ–™...');
            
            // å„²å­˜åˆ°æœ¬åœ°
            localStorage.setItem('last_update', new Date().toLocaleString('zh-TW'));
            saveLocalData();
            
            updateProgress(100, 'å®Œæˆï¼');
            
            showUploadSummary(uploadSummary);
            updateAllTables();
            
            showMessage(`
                âœ… ä¸Šå‚³æˆåŠŸï¼<br>
                ğŸ“Š è™•ç† ${uploadSummary.totalRecords} ç­†è¨˜éŒ„<br>
                ğŸ‘¥ æ¶‰åŠ ${uploadSummary.employees.size} ä½å“¡å·¥<br>
                â• æ–°å¢ ${uploadSummary.newRecords} ç­†ï¼Œæ›´æ–° ${uploadSummary.updatedRecords} ç­†
            `);
        }

        // è¨ˆç®—å“¡å·¥é€±æœŸè³‡è¨Š
        function calculateEmployeeCycle(employee, referenceDateInput = new Date()) {
            const today = new Date(referenceDateInput);
            const dayOfWeek = today.getDay();
            const daysToSubtract = dayOfWeek === 0 ? 7 : dayOfWeek;
            const adjustedReferenceDate = new Date(today);
            adjustedReferenceDate.setDate(today.getDate() - daysToSubtract);

            const parsedStartDate = parseDate(employee.startDate);
            if (!parsedStartDate || isNaN(parsedStartDate.getTime())) {
                const defaultCycleStartDate = getMonday(new Date(adjustedReferenceDate.getFullYear(), adjustedReferenceDate.getMonth(), adjustedReferenceDate.getDate()));
                const defaultCycleEndDate = new Date(defaultCycleStartDate);
                defaultCycleEndDate.setDate(defaultCycleEndDate.getDate() + (WEEKS_PER_CYCLE * 7) - 1);
                return {
                    currentCycle: 0, weekInCycle: 0, cycleStartDate: defaultCycleStartDate,
                    cycleEndDate: defaultCycleEndDate, daysInCycle: 0, totalWeeksFromStart: 0,
                    status: 'pending', progressPercentage: 0, cycleHours: 0
                };
            }
            
            try {
                const startDate = parsedStartDate;
                const currentDate = new Date(adjustedReferenceDate);
                currentDate.setHours(0, 0, 0, 0);
                
                const startMonday = getMonday(startDate);
                const currentMonday = getMonday(currentDate);
                
                const totalWeeksFromStart = Math.floor((currentMonday - startMonday) / (7 * 24 * 60 * 60 * 1000)) + 1;
                
                const currentCycle = Math.max(1, Math.floor((totalWeeksFromStart - 1) / WEEKS_PER_CYCLE) + 1);
                const weekInCycle = Math.max(1, ((totalWeeksFromStart - 1) % WEEKS_PER_CYCLE) + 1);
                
                const cycleStartWeekIndex = (currentCycle - 1) * WEEKS_PER_CYCLE;
                const cycleStartDate = new Date(startMonday);
                cycleStartDate.setDate(cycleStartDate.getDate() + (cycleStartWeekIndex * 7));
                
                const cycleEndDate = new Date(cycleStartDate);
                cycleEndDate.setDate(cycleEndDate.getDate() + (WEEKS_PER_CYCLE * 7) - 1);
                
                const daysInCycle = Math.max(0, Math.floor((currentDate - cycleStartDate) / (1000 * 60 * 60 * 24)) + 1);
                const totalDaysInCyclePeriod = WEEKS_PER_CYCLE * 7;
                const progressPercentage = Math.min((daysInCycle / totalDaysInCyclePeriod) * 100, 100);
                
                let cycleHours = 0;
                for (const workWeekDateStr in employee.workWeeks) {
                    const workWeekDate = parseDate(workWeekDateStr);
                    if (workWeekDate && workWeekDate >= cycleStartDate && workWeekDate <= cycleEndDate) {
                        cycleHours += employee.workWeeks[workWeekDateStr];
                    }
                }

                let status = 'active';
                if (new Date() < cycleStartDate) {
                    status = 'pending';
                } else if (cycleHours > REGULAR_HOURS_THRESHOLD) {
                    status = 'overtime';
                } else if (new Date() > cycleEndDate) {
                    status = 'complete';
                }
                
                return {
                    currentCycle, weekInCycle, cycleStartDate, cycleEndDate,
                    daysInCycle: Math.min(Math.max(daysInCycle, 0), totalDaysInCyclePeriod),
                    totalWeeksFromStart, status, progressPercentage, cycleHours
                };
            } catch (error) {
                console.error("Error calculating employee cycle:", error);
                const defaultCycleStartDate = getMonday(new Date(adjustedReferenceDate.getFullYear(), adjustedReferenceDate.getMonth(), adjustedReferenceDate.getDate()));
                const defaultCycleEndDate = new Date(defaultCycleStartDate);
                defaultCycleEndDate.setDate(defaultCycleEndDate.getDate() + (WEEKS_PER_CYCLE * 7) - 1);
                return {
                    currentCycle: 0, weekInCycle: 0, cycleStartDate: defaultCycleStartDate,
                    cycleEndDate: defaultCycleEndDate, daysInCycle: 0, totalWeeksFromStart: 0,
                    status: 'pending', progressPercentage: 0, cycleHours: 0
                };
            }
        }

        // è¨ˆç®—è–ªè³‡
        function calculatePayroll(employee) {
            const hourlyRate = Number(employee.hourlyRate) || 0;
            const cycleInfo = calculateEmployeeCycle(employee);
            employee.payrollData.cycleHours = Number(cycleInfo.cycleHours) || 0;
            const currentCycleHours = employee.payrollData.cycleHours;
            
            if (currentCycleHours > REGULAR_HOURS_THRESHOLD) {
                employee.payrollData.regularHours = REGULAR_HOURS_THRESHOLD;
                employee.payrollData.overtimeHours = currentCycleHours - REGULAR_HOURS_THRESHOLD;
                employee.payrollData.regularPay = REGULAR_HOURS_THRESHOLD * hourlyRate;
                employee.payrollData.overtimePay = employee.payrollData.overtimeHours * hourlyRate;
            } else {
                employee.payrollData.regularHours = currentCycleHours;
                employee.payrollData.overtimeHours = 0;
                employee.payrollData.regularPay = currentCycleHours * hourlyRate;
                employee.payrollData.overtimePay = 0;
            }

            // è¨ˆç®—ç´¯ç©åŠ ç­è²»
            employee.accumulatedOvertimePay = 0;
            const employeeStartMonday = parseDate(employee.startDate) ? getMonday(parseDate(employee.startDate)) : null;
            if (employeeStartMonday) {
                const today = new Date();
                const totalWeeksSinceStart = Math.floor((today.getTime() - employeeStartMonday.getTime()) / (7 * 24 * 60 * 60 * 1000)) + 1;
                const totalCyclesToConsider = Math.max(1, Math.ceil(totalWeeksSinceStart / WEEKS_PER_CYCLE));
                
                for (let c = 0; c < totalCyclesToConsider; c++) {
                    const cycleStartDate = new Date(employeeStartMonday);
                    cycleStartDate.setDate(cycleStartDate.getDate() + (c * WEEKS_PER_CYCLE * 7));
                    const cycleEndDate = new Date(cycleStartDate);
                    cycleEndDate.setDate(cycleEndDate.getDate() + (WEEKS_PER_CYCLE * 7) - 1);
                    
                    let thisCycleHours = 0;
                    for (const wwDateStr in employee.workWeeks) {
                        const wwDate = parseDate(wwDateStr);
                        if (wwDate && wwDate >= cycleStartDate && wwDate <= cycleEndDate) {
                            thisCycleHours += employee.workWeeks[wwDateStr];
                        }
                    }
                    
                    if (thisCycleHours > REGULAR_HOURS_THRESHOLD) {
                        employee.accumulatedOvertimePay += (thisCycleHours - REGULAR_HOURS_THRESHOLD) * employee.hourlyRate;
                    }
                }
            }
        }

        // å–å¾—ç¯©é¸å¾Œçš„å“¡å·¥æ¸…å–®
        function getFilteredEmployees() {
            const farmFilter = document.getElementById('farm-filter')?.value || '';
            const levelFilter = document.getElementById('level-filter')?.value || '';
            const employeeFilter = document.getElementById('employee-filter')?.value || '';
            
            return Object.values(employees).filter(employee => {
                if (farmFilter && employee.farm !== farmFilter) return false;
                if (levelFilter && employee.level !== levelFilter) return false;
                if (employeeFilter && employee.payrollId !== employeeFilter) return false;
                return true;
            });
        }

        // æ›´æ–°ç¯©é¸é¸é …
        function updateFilterOptions() {
            const farmFilter = document.getElementById('farm-filter');
            const levelFilter = document.getElementById('level-filter');
            const employeeFilter = document.getElementById('employee-filter');
            
            if (!farmFilter || !levelFilter || !employeeFilter) return;
            
            const farms = new Set();
            const levels = new Set();
            const employeeList = [];
            
            Object.values(employees).forEach(employee => {
                if (employee.farm) farms.add(employee.farm);
                if (employee.level) levels.add(employee.level);
                employeeList.push({
                    name: `${employee.firstName} ${employee.lastName} (${employee.payrollId})`,
                    id: employee.payrollId
                });
            });

            employeeList.sort((a, b) => a.name.localeCompare(b.name));
            
            const currentFarm = farmFilter.value;
            farmFilter.innerHTML = '<option value="">æ‰€æœ‰è¾²å ´</option>';
            [...farms].sort().forEach(farm => {
                const option = document.createElement('option');
                option.value = farm;
                option.textContent = farm;
                if (farm === currentFarm) option.selected = true;
                farmFilter.appendChild(option);
            });
            
            const currentLevel = levelFilter.value;
            levelFilter.innerHTML = '<option value="">æ‰€æœ‰è·ç´š</option>';
            [...levels].sort().forEach(level => {
                const option = document.createElement('option');
                option.value = level;
                option.textContent = level;
                if (level === currentLevel) option.selected = true;
                levelFilter.appendChild(option);
            });

            const currentEmployee = employeeFilter.value;
            employeeFilter.innerHTML = '<option value="">æ‰€æœ‰å“¡å·¥</option>';
            employeeList.forEach(emp => {
                const option = document.createElement('option');
                option.value = emp.id;
                option.textContent = emp.name;
                if (emp.id === currentEmployee) option.selected = true;
                employeeFilter.appendChild(option);
            });
        }

        // æ¸…é™¤ç¯©é¸æ¢ä»¶
        function clearFilters() {
            document.getElementById('farm-filter').value = '';
            document.getElementById('level-filter').value = '';
            document.getElementById('employee-filter').value = '';
            updateAllTables();
        }

        // åˆ‡æ›è©³ç´°è³‡è¨Šé¡¯ç¤º
        function toggleDetails(button, payrollId) {
            const detailsRow = document.getElementById(`details-${payrollId}`);
            if (detailsRow) {
                if (detailsRow.classList.contains('is-open')) {
                    detailsRow.classList.remove('is-open');
                    button.textContent = '+';
                } else {
                    detailsRow.classList.add('is-open');
                    button.textContent = '-';
                }
            }
        }

        // æ›´æ–°å“¡å·¥ç¸½è¦½è¡¨æ ¼
        function updateOverviewTable() {
            const container = document.getElementById('overview-table-container');
            
            if (Object.keys(employees).length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #777; margin-top: 30px;">å°šæœªè¼‰å…¥å“¡å·¥è³‡æ–™ï¼Œè«‹å…ˆä¸Šå‚³å·¥æ™‚è¡¨ã€‚</p>';
                document.getElementById('overview-summary-cards').innerHTML = '';
                return;
            }
            
            updateFilterOptions();
            const filteredEmployees = getFilteredEmployees();
            
            if (filteredEmployees.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #777; margin-top: 30px;">æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„å“¡å·¥è³‡æ–™ã€‚</p>';
                document.getElementById('overview-summary-cards').innerHTML = '';
                return;
            }

            let tableHTML = `
                <table class="employee-table">
                    <thead>
                        <tr>
                            <th></th>
                            <th>å“¡å·¥ç·¨è™Ÿ</th>
                            <th>å§“å</th>
                            <th>è¾²å ´</th>
                            <th>è·ç´š</th>
                            <th>é–‹å§‹æ—¥æœŸ</th>
                            <th>ç•¶å‰é€±æœŸ</th>
                            <th>é€±æœŸå…§é€±æ•¸</th>
                            <th>æ­·å²ç¸½å·¥æ™‚</th>
                            <th>é€±æœŸå·¥æ™‚</th>
                            <th>è·OTé–€æª»</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            let activeCycles = 0;
            let overtimeCycles = 0;
            let totalHistoricalHours = 0;
            let totalCycleHours = 0;
            
            filteredEmployees
                .sort((a, b) => a.payrollId.localeCompare(b.payrollId))
                .forEach(employee => {
                    const fullName = `${employee.firstName} ${employee.lastName}`.trim();
                    const cycleInfo = calculateEmployeeCycle(employee);
                    
                    if (cycleInfo.status === 'overtime') {
                        overtimeCycles++;
                    } else if (cycleInfo.status === 'active') {
                        activeCycles++;
                    }
                    
                    const displayCurrentCycle = Number(cycleInfo.currentCycle) || 0;
                    const displayWeekInCycle = Number(cycleInfo.weekInCycle) || 0;
                    const otThresholdDifference = REGULAR_HOURS_THRESHOLD - (Number(cycleInfo.cycleHours) || 0);
                    const currentTotalHours = Number(employee.totalHours) || 0;
                    const currentCycleHours = Number(cycleInfo.cycleHours) || 0;
                    
                    totalHistoricalHours += currentTotalHours;
                    totalCycleHours += currentCycleHours;

                    let detailsTableHTML = '<div style="text-align:center;">ç„¡å·¥æ™‚è¨˜éŒ„</div>';
                    const workWeeks = Object.entries(employee.workWeeks || {})
                        .sort((a, b) => new Date(a[0]) - new Date(b[0]));

                    if (workWeeks.length > 0) {
                        detailsTableHTML = `
                            <table class="details-table" id="details-table-${employee.payrollId}">
                                <thead><tr><th>å·¥ä½œé€± (é€±ä¸€)</th><th>å·¥æ™‚</th><th>æ“ä½œ</th></tr></thead>
                                <tbody>
                                    ${workWeeks.map(([date, hours]) => {
                                        const d = parseDate(date);
                                        const displayDate = d ? d.toLocaleDateString('zh-TW') : 'ç„¡æ•ˆæ—¥æœŸ';
                                        const otClass = hours > WEEKLY_HOURS_THRESHOLD ? 'class="weekly-overtime"' : '';
                                        return `
                                            <tr data-payroll-id="${employee.payrollId}" data-work-week="${date}">
                                                <td>${displayDate}</td>
                                                <td ${otClass}>
                                                    <span class="hours-display">${hours}</span>
                                                    <input type="number" class="hours-input" value="${hours}" step="0.5" min="0" max="168" style="display: none;">
                                                </td>
                                                <td>
                                                    <button class="btn-edit" onclick="editHours('${employee.payrollId}', '${date}')">ç·¨è¼¯</button>
                                                    <button class="btn-delete" onclick="deleteWorkWeek('${employee.payrollId}', '${date}')">åˆªé™¤</button>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                            <div class="edit-actions" style="display: none;" id="edit-actions-${employee.payrollId}">
                                <button class="btn-save" onclick="saveAllEdits('${employee.payrollId}')">ğŸ’¾ å„²å­˜æ‰€æœ‰ä¿®æ”¹</button>
                                <button class="btn-cancel-edit" onclick="cancelAllEdits('${employee.payrollId}')">âŒ å–æ¶ˆä¿®æ”¹</button>
                            </div>
                        `;
                    }
                    
                    tableHTML += `
                        <tr class="main-row">
                            <td><button class="toggle-details-btn" onclick="toggleDetails(this, '${employee.payrollId}')">+</button></td>
                            <td><strong>${employee.payrollId}</strong></td>
                            <td>${fullName}</td>
                            <td>${employee.farm || '-'}</td>
                            <td>${employee.level || '-'}</td>
                            <td>${(parseDate(employee.startDate) || new Date()).toLocaleDateString('zh-TW')}</td>
                            <td>${displayCurrentCycle}</td>
                            <td>${displayWeekInCycle}</td>
                            <td><strong>${currentTotalHours.toFixed(2)}</strong></td>
                            <td><strong>${currentCycleHours.toFixed(2)}</strong></td>
                            <td class="${otThresholdDifference < 0 ? 'status-overtime' : ''}">${otThresholdDifference.toFixed(2)}</td>
                        </tr>
                        <tr class="details-row" id="details-${employee.payrollId}">
                            <td colspan="11">${detailsTableHTML}</td>
                        </tr>
                    `;
                });
            
            tableHTML += `
                </tbody>
                <tfoot>
                    <tr style="background: #f0f0f0; font-weight: bold; text-align: center;">
                        <td colspan="8" style="text-align: right;">ç¸½è¨ˆ</td>
                        <td>${totalHistoricalHours.toFixed(2)}</td>
                        <td>${totalCycleHours.toFixed(2)}</td>
                        <td>-</td>
                    </tr>
                </tfoot>
                </table>
            `;
            container.innerHTML = tableHTML;
            
            const totalFiltered = filteredEmployees.length;
            const summaryHTML = `
                <div class="summary-card">
                    <h3>${totalFiltered}</h3>
                    <p>ç¯©é¸å¾Œå“¡å·¥æ•¸</p>
                </div>
                <div class="summary-card">
                    <h3>${activeCycles}</h3>
                    <p>é€²è¡Œä¸­é€±æœŸ</p>
                </div>
                <div class="summary-card">
                    <h3>${overtimeCycles}</h3>
                    <p>éœ€åŠ ç­è²»é€±æœŸ</p>
                </div>
            `;
            document.getElementById('overview-summary-cards').innerHTML = summaryHTML;
        }

        // æ›´æ–°è–ªè³‡è¨ˆç®—è¡¨æ ¼
        function updatePayrollTable() {
            const container = document.getElementById('payroll-table-container');
            
            if (Object.keys(employees).length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #777; margin-top: 30px;">å°šæœªè¼‰å…¥å“¡å·¥è³‡æ–™ï¼Œè«‹å…ˆä¸Šå‚³å·¥æ™‚è¡¨ã€‚</p>';
                document.getElementById('payroll-summary-cards').innerHTML = '';
                return;
            }
            
            const filteredEmployees = getFilteredEmployees();
            
            if (filteredEmployees.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #777; margin-top: 30px;">æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„å“¡å·¥è³‡æ–™ã€‚</p>';
                document.getElementById('payroll-summary-cards').innerHTML = '';
                return;
            }

            let tableHTML = `
                <table class="employee-table">
                    <thead>
                        <tr>
                            <th>å“¡å·¥ç·¨è™Ÿ</th>
                            <th>å§“å</th>
                            <th>è¾²å ´</th>
                            <th>è·ç´š</th>
                            <th>æ™‚è–ª</th>
                            <th>é€±æœŸå·¥æ™‚</th>
                            <th>æ­£å¸¸å·¥æ™‚</th>
                            <th>åŠ ç­å·¥æ™‚</th>
                            <th>æ­£å¸¸è–ªè³‡</th>
                            <th>åŠ ç­è–ªè³‡</th>
                            <th>é€±æœŸç¸½è–ªè³‡</th>
                            <th>ç´¯ç©åŠ ç­è²»</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            let totalRegularPay = 0;
            let totalOvertimePay = 0;
            let totalPay = 0;
            let totalAccumulatedOvertimePay = 0;
            
            filteredEmployees
                .sort((a, b) => a.payrollId.localeCompare(b.payrollId))
                .forEach(employee => {
                    const fullName = `${employee.firstName} ${employee.lastName}`.trim();
                    const payroll = employee.payrollData;
                    const cycleTotalPay = payroll.regularPay + payroll.overtimePay;
                    
                    totalRegularPay += payroll.regularPay;
                    totalOvertimePay += payroll.overtimePay;
                    totalPay += cycleTotalPay;
                    totalAccumulatedOvertimePay += employee.accumulatedOvertimePay;
                    
                    tableHTML += `
                        <tr>
                            <td><strong>${employee.payrollId}</strong></td>
                            <td>${fullName}</td>
                            <td>${employee.farm || '-'}</td>
                            <td>${employee.level || '-'}</td>
                            <td class="money">${employee.hourlyRate.toFixed(2)}</td>
                            <td>${payroll.cycleHours.toFixed(2)}</td>
                            <td>${payroll.regularHours.toFixed(2)}</td>
                            <td class="${payroll.overtimeHours > 0 ? 'status-overtime' : ''}">${payroll.overtimeHours.toFixed(2)}</td>
                            <td class="money">${payroll.regularPay.toFixed(2)}</td>
                            <td class="money ${payroll.overtimePay > 0 ? 'status-overtime' : ''}">${payroll.overtimePay.toFixed(2)}</td>
                            <td class="money"><strong>${cycleTotalPay.toFixed(2)}</strong></td>
                            <td class="money ${employee.accumulatedOvertimePay > 0 ? 'status-overtime' : ''}">${employee.accumulatedOvertimePay.toFixed(2)}</td>
                        </tr>
                    `;
                });
            
            tableHTML += `
                </tbody>
                <tfoot>
                    <tr style="background: #f0f0f0; font-weight: bold; text-align: center;">
                        <td colspan="8" style="text-align: right;">ç¸½è¨ˆ</td>
                        <td class="money">${totalRegularPay.toFixed(2)}</td>
                        <td class="money">${totalOvertimePay.toFixed(2)}</td>
                        <td class="money">${totalPay.toFixed(2)}</td>
                        <td class="money">${totalAccumulatedOvertimePay.toFixed(2)}</td>
                    </tr>
                </tfoot>
                </table>
            `;
            container.innerHTML = tableHTML;
            
            const totalFiltered = filteredEmployees.length;
            const overtimeEmployees = filteredEmployees.filter(emp => emp.payrollData.overtimeHours > 0).length;
            
            const summaryHTML = `
                <div class="summary-card">
                    <h3>${totalFiltered}</h3>
                    <p>å“¡å·¥ç¸½æ•¸</p>
                </div>
                <div class="summary-card">
                    <h3>${overtimeEmployees}</h3>
                    <p>æœ‰åŠ ç­å“¡å·¥</p>
                </div>
                <div class="summary-card">
                    <h3>${totalPay.toFixed(0)}</h3>
                    <p>é€±æœŸç¸½è–ªè³‡</p>
                </div>
                <div class="summary-card">
                    <h3>${totalAccumulatedOvertimePay.toFixed(0)}</h3>
                    <p>ç´¯ç©åŠ ç­è²»</p>
                </div>
            `;
            document.getElementById('payroll-summary-cards').innerHTML = summaryHTML;
        }

        // æ›´æ–°æ‰€æœ‰è¡¨æ ¼
        function updateAllTables() {
            updateOverviewTable();
            updatePayrollTable();
        }

        // åŒ¯å‡ºå“¡å·¥ç¸½è¦½å ±å‘Š
        async function exportOverview() {
            if (Object.keys(employees).length === 0) {
                showMessage('æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡º', 'error');
                return;
            }
            
            setButtonLoading('exportOverview', true, 'åŒ¯å‡ºä¸­...');
            
            try {
                const filteredEmployees = getFilteredEmployees();
                let csvContent = 'å“¡å·¥ç·¨è™Ÿ,å§“å,è¾²å ´,è·ç´š,é–‹å§‹æ—¥æœŸ,ç•¶å‰é€±æœŸ,é€±æœŸå…§é€±æ•¸,æ­·å²ç¸½å·¥æ™‚,é€±æœŸå·¥æ™‚,è·OTé–€æª»\n';
                
                filteredEmployees.forEach(employee => {
                    const fullName = `${employee.firstName} ${employee.lastName}`.trim();
                    const cycleInfo = calculateEmployeeCycle(employee);
                    
                    const otThresholdDifference = REGULAR_HOURS_THRESHOLD - (Number(cycleInfo.cycleHours) || 0);
                    
                    csvContent += `${employee.payrollId},"${fullName}",${employee.farm || ''},${employee.level || ''},${(parseDate(employee.startDate) || new Date()).toLocaleDateString('zh-TW')},${Number(cycleInfo.currentCycle) || 0},${Number(cycleInfo.weekInCycle) || 0},${Number(employee.totalHours) || 0},${Number(cycleInfo.cycleHours) || 0},${otThresholdDifference}\n`;
                });
                
                downloadCSV(csvContent, `å“¡å·¥ç¸½è¦½å ±å‘Š_${new Date().toLocaleDateString('zh-TW').replace(/\//g, '-')}.csv`);
                showMessage('âœ… å“¡å·¥ç¸½è¦½å ±å‘Šå·²åŒ¯å‡º');
            } catch (error) {
                showMessage(`âŒ åŒ¯å‡ºå¤±æ•—: ${error.message}`, 'error');
                console.error("Export Overview failed:", error);
            } finally {
                setButtonLoading('exportOverview', false, 'ğŸ“¥ åŒ¯å‡ºå“¡å·¥ç¸½è¦½å ±å‘Š (CSV)');
            }
        }

        // åŒ¯å‡ºè–ªè³‡å ±è¡¨
        async function exportPayroll() {
            if (Object.keys(employees).length === 0) {
                showMessage('æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡º', 'error');
                return;
            }
            
            setButtonLoading('exportPayroll', true, 'åŒ¯å‡ºä¸­...');
            
            try {
                const filteredEmployees = getFilteredEmployees();
                let csvContent = 'å“¡å·¥ç·¨è™Ÿ,å§“å,è¾²å ´,è·ç´š,æ™‚è–ª,é€±æœŸå·¥æ™‚,æ­£å¸¸å·¥æ™‚,åŠ ç­å·¥æ™‚,æ­£å¸¸è–ªè³‡,åŠ ç­è–ªè³‡,é€±æœŸç¸½è–ªè³‡,ç´¯ç©åŠ ç­è²»\n';
                
                filteredEmployees.forEach(employee => {
                    const fullName = `${employee.firstName} ${employee.lastName}`.trim();
                    const payroll = employee.payrollData;
                    const cycleTotalPay = payroll.regularPay + payroll.overtimePay;
                    
                    csvContent += `${employee.payrollId},"${fullName}",${employee.farm || ''},${employee.level || ''},${employee.hourlyRate.toFixed(2)},${payroll.cycleHours.toFixed(2)},${payroll.regularHours.toFixed(2)},${payroll.overtimeHours.toFixed(2)},${payroll.regularPay.toFixed(2)},${payroll.overtimePay.toFixed(2)},${cycleTotalPay.toFixed(2)},${employee.accumulatedOvertimePay.toFixed(2)}\n`;
                });
                
                downloadCSV(csvContent, `è–ªè³‡å ±è¡¨_${new Date().toLocaleDateString('zh-TW').replace(/\//g, '-')}.csv`);
                showMessage('âœ… è–ªè³‡å ±è¡¨å·²åŒ¯å‡º');
            } catch (error) {
                showMessage(`âŒ åŒ¯å‡ºå¤±æ•—: ${error.message}`, 'error');
                console.error("Export Payroll failed:", error);
            } finally {
                setButtonLoading('exportPayroll', false, 'ğŸ“¥ åŒ¯å‡ºè–ªè³‡å ±è¡¨ (CSV)');
            }
        }

        // ä¸‹è¼‰ CSV æª”æ¡ˆ
        function downloadCSV(content, filename) {
            const blob = new Blob(['\ufeff' + content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // è¨­å®šæŒ‰éˆ•è¼‰å…¥ç‹€æ…‹
        function setButtonLoading(buttonId, isLoading, loadingText = 'è™•ç†ä¸­...') {
            const button = document.getElementById(buttonId);
            if (!button) return;
            
            const spinner = button.querySelector('.spinner');
            const originalText = button.dataset.originalText || button.textContent.trim();

            if (isLoading) {
                button.dataset.originalText = originalText;
                button.disabled = true;
                button.innerHTML = '';
                if (spinner) {
                    button.appendChild(spinner);
                    spinner.style.display = 'inline-block';
                } else {
                    const newSpinner = document.createElement('span');
                    newSpinner.className = 'spinner';
                    button.prepend(newSpinner);
                }
                button.append(loadingText);
            } else {
                button.disabled = false;
                button.innerHTML = originalText;
                if (spinner) spinner.style.display = 'none';
            }
        }

        // é¡¯ç¤ºä¸Šå‚³æ‘˜è¦
        function showUploadSummary(summary) {
            const container = document.getElementById('timesheet-file-info');
            container.style.display = 'block';
            container.className = 'upload-summary';
            
            const sortedWeeks = Array.from(summary.weeks).sort();
            const weeksDisplay = sortedWeeks.length > 0 ? sortedWeeks.join(', ') : 'ç„¡';

            container.innerHTML = `
                <h3>ğŸ“Š ä¸Šå‚³æ‘˜è¦</h3>
                <div class="summary-item">
                    <span>ç¸½è¨˜éŒ„æ•¸ï¼š</span>
                    <span class="highlight">${summary.totalRecords}</span>
                </div>
                <div class="summary-item">
                    <span>å“¡å·¥æ•¸é‡ï¼š</span>
                    <span class="highlight">${summary.employees.size}</span>
                </div>
                <div class="summary-item">
                    <span>æ¶µè“‹é€±æ•¸ï¼š</span>
                    <span>${weeksDisplay}</span>
                </div>
                <div class="summary-item">
                    <span>æ–°å¢è¨˜éŒ„ï¼š</span>
                    <span class="highlight">${summary.newRecords}</span>
                </div>
                <div class="summary-item">
                    <span>æ›´æ–°è¨˜éŒ„ï¼š</span>
                    <span class="highlight">${summary.updatedRecords}</span>
                </div>
                <div class="summary-item">
                    <span>ä¸Šå‚³æ™‚é–“ï¼š</span>
                    <span>${new Date().toLocaleDateString('zh-TW') + ' ' + new Date().toLocaleTimeString('zh-TW')}</span>
                </div>
                <div class="summary-item">
                    <span>å„²å­˜ç‹€æ…‹ï¼š</span>
                    <span class="highlight">å·²å„²å­˜åˆ°æœ¬åœ°</span>
                </div>
            `;
        }

        // é¡¯ç¤ºé©—è­‰çµæœ
        function showValidationResults(result) {
            const container = document.getElementById('validation-results');
            
            let html = '';
            
            result.success.forEach(msg => {
                html += `<div class="validation-item validation-success">âœ… ${msg}</div>`;
            });
            
            result.warnings.forEach(msg => {
                html += `<div class="validation-item validation-warning">âš ï¸ ${msg}</div>`;
            });
            
            result.errors.forEach(msg => {
                html += `<div class="validation-item validation-error">âŒ ${msg}</div>`;
            });
            
            container.innerHTML = html;
        }

        // è®€å–æª”æ¡ˆå…§å®¹
        async function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) { resolve(e.target.result); };
                reader.onerror = function() { reject(new Error('æ–‡ä»¶è®€å–å¤±æ•—')); };
                reader.readAsText(file, 'UTF-8');
            });
        }

        // è§£æ CSV æ–‡ä»¶
        function parseCSV(csvText) {
            const lines = csvText.trim().split(/\r?\n/);
            if (lines.length === 0) return [];

            const headerLine = lines[0];
            const commaCount = (headerLine.match(/,/g) || []).length;
            const tabCount = (headerLine.match(/\t/g) || []).length;
            let delimiter = ',';
            if (tabCount > commaCount && tabCount > 0) {
                delimiter = '\t';
            }

            const headers = parseCSVLine(headerLine, delimiter);
            
            return lines.slice(1)
                .map(line => parseCSVLine(line, delimiter))
                .filter(values => values.some(val => val.trim() !== ''))
                .map(values => {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] !== undefined ? values[index] : '';
                    });
                    return row;
                })
                .filter(row => {
                    const payrollId = row['Payroll ID']?.trim();
                    const firstName = row['First Name']?.trim();
                    const lastName = row['Last Name']?.trim();
                    const workWeek = row['Work Week']?.trim();
                    const hours = parseFloat(row['Hours']);
                    return payrollId || firstName || lastName || workWeek || !isNaN(hours);
                });
        }

        // ç·¨è¼¯å·¥æ™‚åŠŸèƒ½
        function editHours(payrollId, workWeekDate) {
            const row = document.querySelector(`tr[data-payroll-id="${payrollId}"][data-work-week="${workWeekDate}"]`);
            if (!row) return;

            const hoursDisplay = row.querySelector('.hours-display');
            const hoursInput = row.querySelector('.hours-input');
            const editBtn = row.querySelector('.btn-edit');

            // åˆ‡æ›åˆ°ç·¨è¼¯æ¨¡å¼
            hoursDisplay.style.display = 'none';
            hoursInput.style.display = 'inline-block';
            hoursInput.focus();
            hoursInput.select();
            editBtn.textContent = 'å–æ¶ˆ';
            editBtn.onclick = () => cancelEdit(payrollId, workWeekDate);

            // é¡¯ç¤ºç·¨è¼¯æ“ä½œæŒ‰éˆ•
            const editActions = document.getElementById(`edit-actions-${payrollId}`);
            if (editActions) {
                editActions.style.display = 'block';
            }
        }

        // å–æ¶ˆå–®å€‹ç·¨è¼¯
        function cancelEdit(payrollId, workWeekDate) {
            const row = document.querySelector(`tr[data-payroll-id="${payrollId}"][data-work-week="${workWeekDate}"]`);
            if (!row) return;

            const hoursDisplay = row.querySelector('.hours-display');
            const hoursInput = row.querySelector('.hours-input');
            const editBtn = row.querySelector('.btn-edit');

            // æ¢å¾©åŸå€¼
            hoursInput.value = hoursDisplay.textContent;

            // åˆ‡æ›å›é¡¯ç¤ºæ¨¡å¼
            hoursDisplay.style.display = 'inline';
            hoursInput.style.display = 'none';
            editBtn.textContent = 'ç·¨è¼¯';
            editBtn.onclick = () => editHours(payrollId, workWeekDate);

            // æª¢æŸ¥æ˜¯å¦é‚„æœ‰å…¶ä»–ç·¨è¼¯ä¸­çš„é …ç›®
            const table = document.getElementById(`details-table-${payrollId}`);
            const editingInputs = table.querySelectorAll('.hours-input[style*="inline-block"]');
            if (editingInputs.length === 0) {
                const editActions = document.getElementById(`edit-actions-${payrollId}`);
                if (editActions) {
                    editActions.style.display = 'none';
                }
            }
        }

        // å–æ¶ˆæ‰€æœ‰ç·¨è¼¯
        function cancelAllEdits(payrollId) {
            const table = document.getElementById(`details-table-${payrollId}`);
            if (!table) return;

            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const hoursDisplay = row.querySelector('.hours-display');
                const hoursInput = row.querySelector('.hours-input');
                const editBtn = row.querySelector('.btn-edit');
                const workWeekDate = row.dataset.workWeek;

                if (hoursInput.style.display === 'inline-block') {
                    // æ¢å¾©åŸå€¼
                    hoursInput.value = hoursDisplay.textContent;
                    
                    // åˆ‡æ›å›é¡¯ç¤ºæ¨¡å¼
                    hoursDisplay.style.display = 'inline';
                    hoursInput.style.display = 'none';
                    editBtn.textContent = 'ç·¨è¼¯';
                    editBtn.onclick = () => editHours(payrollId, workWeekDate);
                }
            });

            // éš±è—ç·¨è¼¯æ“ä½œæŒ‰éˆ•
            const editActions = document.getElementById(`edit-actions-${payrollId}`);
            if (editActions) {
                editActions.style.display = 'none';
            }
        }

        // å„²å­˜æ‰€æœ‰ç·¨è¼¯
        function saveAllEdits(payrollId) {
            const table = document.getElementById(`details-table-${payrollId}`);
            if (!table) return;

            const employee = employees[payrollId];
            if (!employee) return;

            let hasChanges = false;
            const changes = [];

            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const hoursDisplay = row.querySelector('.hours-display');
                const hoursInput = row.querySelector('.hours-input');
                const editBtn = row.querySelector('.btn-edit');
                const workWeekDate = row.dataset.workWeek;

                if (hoursInput.style.display === 'inline-block') {
                    const oldHours = parseFloat(hoursDisplay.textContent);
                    const newHours = parseFloat(hoursInput.value);

                    if (oldHours !== newHours && !isNaN(newHours) && newHours >= 0) {
                        hasChanges = true;
                        changes.push({
                            workWeekDate: workWeekDate,
                            oldHours: oldHours,
                            newHours: newHours
                        });

                        // æ›´æ–°é¡¯ç¤º
                        hoursDisplay.textContent = newHours;
                        
                        // æ›´æ–°è³‡æ–™
                        employee.workWeeks[workWeekDate] = newHours;
                        
                        // æ›´æ–° timesheetData
                        const recordIndex = timesheetData.findIndex(item => 
                            item.payrollId === payrollId && item.workWeekDate === workWeekDate
                        );
                        if (recordIndex !== -1) {
                            timesheetData[recordIndex].hours = newHours;
                            timesheetData[recordIndex].uploadDate = new Date().toISOString();
                        }

                        // æ›´æ–°æ¨£å¼ï¼ˆåŠ ç­æé†’ï¼‰
                        const hoursCell = hoursDisplay.parentElement;
                        if (newHours > WEEKLY_HOURS_THRESHOLD) {
                            hoursCell.className = 'weekly-overtime';
                        } else {
                            hoursCell.className = '';
                        }
                    }

                    // åˆ‡æ›å›é¡¯ç¤ºæ¨¡å¼
                    hoursDisplay.style.display = 'inline';
                    hoursInput.style.display = 'none';
                    editBtn.textContent = 'ç·¨è¼¯';
                    editBtn.onclick = () => editHours(payrollId, workWeekDate);
                }
            });

            if (hasChanges) {
                // é‡æ–°è¨ˆç®—è©²å“¡å·¥çš„ç¸½å·¥æ™‚å’Œè–ªè³‡
                employee.totalHours = Object.values(employee.workWeeks).reduce((sum, hours) => sum + hours, 0);
                calculatePayroll(employee);
                
                // å„²å­˜åˆ°æœ¬åœ°
                localStorage.setItem('last_update', new Date().toLocaleString('zh-TW'));
                saveLocalData();
                
                // æ›´æ–°æ‰€æœ‰è¡¨æ ¼
                updateAllTables();
                
                // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                const changeCount = changes.length;
                showMessage(`âœ… å·²æˆåŠŸä¿®æ”¹ ${changeCount} ç­†å·¥æ™‚è¨˜éŒ„ï¼`, 'success');
                
                console.log('å·¥æ™‚ä¿®æ”¹è¨˜éŒ„:', changes);
            } else {
                showMessage('â„¹ï¸ æ²’æœ‰ç™¼ç¾ä»»ä½•è®Šæ›´', 'warning', 3000);
            }

            // éš±è—ç·¨è¼¯æ“ä½œæŒ‰éˆ•
            const editActions = document.getElementById(`edit-actions-${payrollId}`);
            if (editActions) {
                editActions.style.display = 'none';
            }
        }

        // åˆªé™¤å·¥ä½œé€±è¨˜éŒ„
        function deleteWorkWeek(payrollId, workWeekDate) {
            const employee = employees[payrollId];
            if (!employee) return;

            const hours = employee.workWeeks[workWeekDate] || 0;
            const displayDate = parseDate(workWeekDate)?.toLocaleDateString('zh-TW') || workWeekDate;
            
            if (confirm(`âš ï¸ ç¢ºå®šè¦åˆªé™¤ä»¥ä¸‹å·¥æ™‚è¨˜éŒ„å—ï¼Ÿ\n\nå“¡å·¥ï¼š${employee.firstName} ${employee.lastName} (${payrollId})\nå·¥ä½œé€±ï¼š${displayDate}\nå·¥æ™‚ï¼š${hours} å°æ™‚\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`)) {
                // å¾å“¡å·¥å·¥æ™‚è¨˜éŒ„ä¸­ç§»é™¤
                delete employee.workWeeks[workWeekDate];
                
                // å¾ timesheetData ä¸­ç§»é™¤
                const recordIndex = timesheetData.findIndex(item => 
                    item.payrollId === payrollId && item.workWeekDate === workWeekDate
                );
                if (recordIndex !== -1) {
                    timesheetData.splice(recordIndex, 1);
                }
                
                // é‡æ–°è¨ˆç®—è©²å“¡å·¥çš„ç¸½å·¥æ™‚å’Œè–ªè³‡
                employee.totalHours = Object.values(employee.workWeeks).reduce((sum, hours) => sum + hours, 0);
                calculatePayroll(employee);
                
                // å„²å­˜åˆ°æœ¬åœ°
                localStorage.setItem('last_update', new Date().toLocaleString('zh-TW'));
                saveLocalData();
                
                // æ›´æ–°æ‰€æœ‰è¡¨æ ¼
                updateAllTables();
                
                showMessage(`ğŸ—‘ï¸ å·²åˆªé™¤ ${employee.firstName} ${employee.lastName} åœ¨ ${displayDate} çš„å·¥æ™‚è¨˜éŒ„`, 'warning');
            }
        }

        // è§£æ CSV è¡Œ
        function parseCSVLine(line, delimiter) {
            const values = line.split(delimiter);
            return values.map(val => val.trim());
        }
    </script>
</body>
</html>
