<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub ç‰ˆå·¥æ™‚ç®¡ç†ç³»çµ±</title>
    <style>
        /* General Styles */
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            /* Softer gradient for a more 'exquisite' feel */
            background: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            /* Lighter, more subtle shadow */
            box-shadow: 0 15px 30px rgba(0,0,0,0.08);
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 32px; /* Slightly larger */
            font-weight: 600;
        }

        /* Token Setup */
        .token-setup {
            background: #f8f9fa;
            border: 2px solid #28a745;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .token-setup h3 {
            color: #28a745;
            margin: 0 0 15px 0;
            font-size: 22px;
        }

        .token-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap; /* Allow wrapping on small screens */
        }

        .token-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
            min-width: 200px; /* Ensure input is not too small */
        }

        .token-input:focus {
            border-color: #667eea; /* Focus color for inputs */
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.25);
        }

        .save-token-btn {
            background: #667eea; /* Use main theme color */
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s ease, transform 0.2s ease;
        }

        .save-token-btn:hover {
            background: #506ee5; /* Darker shade on hover */
            transform: translateY(-2px);
        }

        .save-token-btn:active {
            transform: translateY(0);
        }

        .token-instructions {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 5px;
            padding: 15px;
            margin-top: 15px;
            font-size: 14px;
        }

        /* Message Styles */
        .success-message {
            background: #e6ffe6;
            color: #006600;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 5px solid #006600;
            opacity: 1;
            transition: opacity 0.5s ease;
        }

        .error-message {
            background: #ffe6e6;
            color: #cc0000;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 5px solid #cc0000;
            opacity: 1;
            transition: opacity 0.5s ease;
        }

        .warning-message {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 5px solid #ffc107;
            opacity: 1;
            transition: opacity 0.5s ease;
        }
        
        .message-fadeout {
            opacity: 0;
        }

        /* GitHub Section */
        .github-section {
            background: #f6f8fa;
            border: 2px solid #0366d6;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }

        .github-connected {
            background: #d4edda;
            border-color: #28a745;
        }

        .github-disconnected {
            background: #f8d7da;
            border-color: #dc3545;
        }

        .github-loading {
            background: #fff3cd;
            border-color: #ffc107;
        }

        .central-db-info {
            background: #e7f3ff;
            border: 2px solid #b3d9ff;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .central-db-info h3 {
            color: #0066cc;
            margin: 0 0 15px 0;
            font-size: 22px;
        }

        .workflow-step {
            display: flex;
            align-items: center;
            margin: 15px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); /* Subtle shadow for steps */
        }

        .step-number {
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: bold;
            flex-shrink: 0; /* Prevent shrinking */
        }

        /* Upload Section */
        .upload-section {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
            background: #f8f9ff;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }

        .upload-section.dragover {
            border-color: #764ba2;
            background: #e8ebff;
            transform: scale(1.01); /* Slightly less aggressive scale */
        }

        .file-input {
            display: none;
        }

        .upload-btn, .github-btn, .action-btn { /* Unified button styles */
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px; /* Adjust margin for multiple buttons */
            transition: transform 0.2s, background 0.3s, box-shadow 0.2s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); /* Add shadow */
            display: inline-flex; /* For spinner alignment */
            align-items: center;
            justify-content: center;
            gap: 8px; /* Space for spinner */
        }
        
        .github-btn {
            background: linear-gradient(45deg, #0366d6, #0256cc);
        }

        .github-btn-warning {
            background: linear-gradient(45deg, #ffc107, #e0a800);
            color: #333;
        }
        
        .github-btn-danger { /* For clear data button */
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
        }
        .github-btn-danger:hover {
            background: linear-gradient(45deg, #c82333, #bd2130);
        }


        .upload-btn:hover, .github-btn:hover, .action-btn:hover {
            transform: translateY(-3px); /* More pronounced lift */
            box-shadow: 0 6px 12px rgba(0,0,0,0.15); /* Stronger shadow on hover */
        }
        .upload-btn:active, .github-btn:active, .action-btn:active {
             transform: translateY(0);
             box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .upload-btn:disabled, .github-btn:disabled, .action-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .file-info {
            margin-top: 15px;
            padding: 10px;
            background: #e8f5e8;
            border-radius: 5px;
            display: none;
        }

        /* Tabs */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
            flex-wrap: wrap;
            justify-content: center; /* Center tabs */
            gap: 10px; /* Gap between tabs */
        }

        .tab {
            padding: 15px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            min-width: 120px;
            text-align: center;
            font-weight: 500;
            color: #555;
        }

        .tab.active {
            border-bottom-color: #667eea;
            color: #667eea;
            font-weight: bold;
            background: #f0f2ff; /* Light background for active tab */
        }
        .tab:hover:not(.active) {
            background: #f8faff;
            color: #667eea;
        }

        .tab-content {
            display: none;
            padding-top: 10px; /* Give some space below tabs */
        }

        .tab-content.active {
            display: block;
        }

        /* Tables */
        .employee-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px; /* Slightly larger font */
        }

        .employee-table th,
        .employee-table td {
            border: 1px solid #ddd;
            padding: 10px 8px; /* More padding */
            text-align: left;
        }

        .employee-table th {
            background: #667eea;
            color: white;
            font-size: 13px;
            text-transform: uppercase; /* Uppercase headers */
            letter-spacing: 0.5px;
        }

        .employee-table tr:nth-child(even) {
            background: #f9f9f9;
        }
        .employee-table tr:hover {
            background: #f0f2ff; /* Hover effect for table rows */
        }

        .status-normal {
            color: #228B22;
            font-weight: bold;
        }

        .status-overtime {
            color: #ff4444;
            font-weight: bold;
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef; /* Lighter background */
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease-out; /* Smoother transition */
        }
        
        #progress-text {
            text-align: center;
            font-weight: 500;
            color: #555;
        }

        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); /* Add shadow */
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .summary-card h3 {
            margin: 0 0 10px 0;
            font-size: 24px; /* Larger font for key numbers */
            font-weight: 700;
        }

        .summary-card p {
            margin: 0;
            font-size: 14px;
            opacity: 0.9;
        }

        /* Other utility styles */
        .money {
            color: #28a745;
            font-weight: bold;
        }

        .format-info {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            font-size: 14px;
        }

        .format-info h4 {
            margin: 0 0 10px 0;
            color: #0066cc;
            font-size: 18px;
        }

        .format-example {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            margin: 5px 0;
            white-space: pre-wrap; /* Preserve line breaks */
            word-break: break-all;
            line-height: 1.5;
        }
        .format-info ul {
            padding-left: 20px;
            margin-top: 10px;
        }
        .format-info li {
            margin-bottom: 5px;
        }

        /* Confirmation Dialog */
        .confirm-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6); /* Slightly darker overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .confirm-dialog.active {
            opacity: 1;
            visibility: visible;
        }

        .confirm-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            max-height: 90%; /* Allow more height */
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0,0,0,0.25); /* Stronger shadow */
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        .confirm-dialog.active .confirm-content {
            transform: scale(1);
        }
        
        .confirm-content h3 {
            font-size: 24px;
            margin-bottom: 15px;
            text-align: center;
            color: #333;
        }
        .confirm-content p {
            margin-bottom: 20px;
            text-align: center;
            font-size: 16px;
        }

        .confirm-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .btn-confirm, .btn-cancel {
            border: none;
            padding: 12px 25px; /* More generous padding */
            border-radius: 8px; /* Softer corners */
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s, transform 0.2s;
        }
        .btn-confirm {
            background: #28a745;
            color: white;
        }
        .btn-confirm:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        .btn-cancel {
            background: #dc3545;
            color: white;
        }
        .btn-cancel:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        /* Upload Summary */
        .upload-summary {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .upload-summary h3 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-size: 15px;
        }
        .summary-item:last-child {
            border-bottom: none;
        }

        .highlight {
            background: #fff3cd;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: bold;
        }
        
        /* Validation Results */
        .validation-results {
            margin: 20px 0;
        }

        .validation-item {
            padding: 12px; /* More padding */
            margin: 8px 0; /* More margin */
            border-radius: 5px;
            border-left: 5px solid; /* Thicker border */
            font-size: 15px;
        }

        .validation-success {
            background: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }

        .validation-warning {
            background: #fff3cd;
            border-left-color: #ffc107;
            color: #856404;
        }

        .validation-error {
            background: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }

        /* Last Sync Info */
        .last-sync {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin: 10px auto; /* Center it */
            font-size: 14px;
            color: #6c757d;
            display: inline-block; /* Adjust display for centering */
        }
        
        /* Cycle Info Card */
        .cycle-info-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .cycle-progress {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            margin: 8px 0;
            overflow: hidden;
        }

        .cycle-progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #28a745, #20c997);
            transition: width 0.3s;
        }

        .cycle-progress-overtime {
            background: linear-gradient(45deg, #dc3545, #fd7e14);
        }

        .cycle-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            min-width: 80px;
        }

        .cycle-active {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .cycle-complete {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .cycle-overtime {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .cycle-pending {
            background: #e7f3ff;
            color: #0066cc;
            border: 1px solid #b3d9ff;
        }
        
        /* Loading spinner */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #fff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 5px;
        }
        .spinner-dark {
            border: 3px solid rgba(0, 0, 0, 0.2);
            border-top: 3px solid #333;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ™ GitHub ç‰ˆå·¥æ™‚ç®¡ç†ç³»çµ±</h1>
        <div style="text-align: center; margin-bottom: 20px;">
            <small>ğŸ“Š GitHub è³‡æ–™åº« | ğŸ”„ å³æ™‚åŒæ­¥ | ğŸ‘¥ åœ˜éšŠå”ä½œ</small>
        </div>
        
        <div id="token-setup" class="token-setup">
            <h3>ğŸ”‘ GitHub Token è¼¸å…¥</h3>
            <p><strong>ç‚ºäº†æ‚¨çš„å®‰å…¨ï¼ŒToken ä¸æœƒè¢«å„²å­˜ï¼Œæ¯æ¬¡ä½¿ç”¨éƒ½éœ€è¦é‡æ–°è¼¸å…¥ã€‚</strong></p>
            
            <div class="token-input-group">
                <input 
                    type="password" 
                    id="github-token-input" 
                    class="token-input" 
                    placeholder="è«‹è¼¸å…¥æ‚¨çš„ GitHub Personal Access Token (ghp_ æˆ– github_pat_ é–‹é ­)"
                    title="è«‹è¼¸å…¥æ‚¨çš„ GitHub Personal Access Token"
                >
                <button id="save-token-btn" class="save-token-btn" onclick="saveGitHubToken()">
                    ğŸ”— é€£æ¥ GitHub
                </button>
            </div>
            
            <div class="token-instructions">
                <h4>ğŸ“‹ å¦‚ä½•ä½¿ç”¨ï¼š</h4>
                <ol>
                    <li><strong>è¼¸å…¥ Tokenï¼š</strong>å°‡æ‚¨çš„ GitHub Token è²¼åˆ°ä¸Šæ–¹è¼¸å…¥æ¡†</li>
                    <li><strong>é»æ“Šé€£æ¥ï¼š</strong>ç³»çµ±æœƒæ¸¬è©¦é€£æ¥ä¸¦è¼‰å…¥è³‡æ–™</li>
                    <li><strong>é–‹å§‹ä½¿ç”¨ï¼š</strong>ä¸Šå‚³å·¥æ™‚è¡¨ã€æŸ¥çœ‹å ±è¡¨ç­‰</li>
                    <li><strong>å®‰å…¨æ€§æé†’ï¼š</strong>Token ä¸æœƒè¢«å„²å­˜ï¼Œé—œé–‰ç€è¦½å™¨å¾Œè‡ªå‹•æ¸…é™¤ï¼Œç¢ºä¿å®‰å…¨ã€‚</li>
                </ol>
                
                <h4>ğŸ” å¦‚ä½•å–å¾— GitHub Tokenï¼š</h4>
                <ol>
                    <li>ç™»å…¥ GitHub â†’ Settings â†’ Developer settings â†’ Personal access tokens</li>
                    <li>é»æ“Š "Generate new token (classic)" æˆ– "Generate new token"</li>
                    <li>è¨­å®šæ¬Šé™ï¼šå‹¾é¸ <code>repo</code> æ¬Šé™ (å¿…è¦)</li>
                    <li>è¤‡è£½ç”Ÿæˆçš„ tokenï¼ˆæ ¼å¼ï¼šghp_xxxxxxxxxxxxxx æˆ– github_pat_xxxxxxxxxxxxxxï¼‰</li>
                </ol>
                
                <div class="success-message">
                    <strong>âœ… å®‰å…¨å„ªå‹¢ï¼š</strong><br>
                    â€¢ Token ä¸æœƒè¢«**æŒä¹…åŒ–**å„²å­˜åœ¨é›»è…¦ä¸­<br>
                    â€¢ æ¯æ¬¡ä½¿ç”¨éƒ½éœ€è¦é‡æ–°è¼¸å…¥ï¼Œé©åˆå…±ç”¨é›»è…¦ç’°å¢ƒ<br>
                    â€¢ é—œé–‰ç€è¦½å™¨å¾Œ Token å¾è¨˜æ†¶é«”ä¸­è‡ªå‹•æ¸…é™¤
                </div>
                
                <div class="warning-message">
                    <strong>ğŸ¯ ä½¿ç”¨å»ºè­°ï¼š</strong><br>
                    â€¢ å»ºè­°å»ºç«‹å°ˆç”¨çš„ GitHub å¸³æˆ¶ä¾›å·¥æ™‚ç³»çµ±ä½¿ç”¨<br>
                    â€¢ æˆ–ä½¿ç”¨å…¬å¸çµ±ä¸€çš„ GitHub Token<br>
                    â€¢ Token å…·æœ‰ GitHub æ¬Šé™ï¼Œè«‹å¦¥å–„ä¿ç®¡ï¼Œå¦‚æœæ´©éœ²è«‹ç«‹å³æ’¤éŠ·ä¸¦é‡æ–°ç”Ÿæˆ
                </div>
            </div>
        </div>
        
        <div class="central-db-info">
            <h3>ğŸ’¡ GitHub è³‡æ–™åº«æ¦‚å¿µ</h3>
            <div class="workflow-step">
                <div class="step-number">1</div>
                <div>ä»»ä½•äººä¸Šå‚³ CSV å·¥æ™‚è¡¨</div>
            </div>
            <div class="workflow-step">
                <div class="step-number">2</div>
                <div>ç³»çµ±è‡ªå‹•æ•´åˆè³‡æ–™ä¸¦æ¨é€åˆ° GitHub repository</div>
            </div>
            <div class="workflow-step">
                <div class="step-number">3</div>
                <div>æ‰€æœ‰åœ˜éšŠæˆå“¡é‡æ–°æ•´ç†é é¢å³å¯çœ‹åˆ°æœ€æ–°è³‡æ–™</div>
            </div>
            <div class="workflow-step">
                <div class="step-number">4</div>
                <div>å®Œæ•´çš„ç‰ˆæœ¬æ§åˆ¶ï¼Œå¯æŸ¥çœ‹æ‰€æœ‰æ­·å²æ›´æ–°</div>
            </div>
        </div>
        
        <div id="github-status" class="github-section github-disconnected">
            <h3>ğŸ™ GitHub é€£æ¥ç‹€æ…‹</h3>
            <p id="github-status-text">å°šæœªé€£æ¥åˆ° GitHub repository</p>
            <div id="last-sync" class="last-sync" style="display: none;">
                <strong>æœ€å¾ŒåŒæ­¥ï¼š</strong><span id="sync-time">å°šæœªåŒæ­¥</span>
            </div>
            <button id="github-sync-btn" class="github-btn" onclick="syncFromGitHub()" style="display: none;">
                <span class="spinner" style="display: none;"></span>
                ğŸ”„ å¾ GitHub è¼‰å…¥æœ€æ–°è³‡æ–™
            </button>
            <button id="github-download-btn" class="github-btn" onclick="downloadFromGitHub()" style="display: none;">
                <span class="spinner" style="display: none;"></span>
                ğŸ“¥ ä¸‹è¼‰å®Œæ•´è³‡æ–™æª”
            </button>
            <button id="github-disconnect-btn" class="github-btn-warning" onclick="disconnectGitHub()" style="display: none;">
                <span class="spinner spinner-dark" style="display: none;"></span>
                ğŸ”Œ ä¸­æ–·é€£æ¥
            </button>
            
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                <button id="resetAllData" class="github-btn-danger action-btn" onclick="resetAllData()">
                    <span class="spinner" style="display: none;"></span>
                    ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰è³‡æ–™
                </button>
                <p style="font-size: 12px; color: #666; margin: 5px 0 0 0;">
                    å¦‚æœç³»çµ±å¡ä½æˆ–è³‡æ–™ç•°å¸¸ï¼Œå¯ä»¥æ¸…é™¤é‡æ–°é–‹å§‹
                </p>
            </div>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('upload')">ğŸ“ è³‡æ–™ä¸Šå‚³</div>
            <div class="tab" onclick="switchTab('overview')">ğŸ‘¥ å“¡å·¥ç¸½è¦½</div>
            <div class="tab" onclick="switchTab('payroll')">ğŸ’° è–ªè³‡è¨ˆç®—</div>
        </div>
        
        <div id="upload-tab" class="tab-content active">
            <div class="format-info">
                <h4>ğŸ“Š å·¥æ™‚è¡¨æ ¼å¼èªªæ˜</h4>
                <div class="format-example">
                    Payroll ID, First Name, Last Name, Start Date, Work Week, Hours, Level, Rate, Farm
                    <br>EQ-0001, John, Doe, 2024-01-15, 2024-01-15, 45, Senior, 25.50, Farm A
                    <br>EQ-0001, John, Doe, 2024-01-15, 2024-01-22, 38, Senior, 25.50, Farm A
                    <br>EQ-0002, Jane, Smith, 2024-02-01, 2024-02-05, 42, Junior, 20.00, Farm B
                </div>
                <p><strong>é‡è¦æ ¼å¼èªªæ˜ï¼š</strong></p>
                <ul>
                    <li>ğŸ“… <strong>Start Date</strong>ï¼šå“¡å·¥åœ¨è©²è¾²å ´å·¥ä½œçš„ç¬¬ä¸€å¤©ï¼ˆåªéœ€åœ¨ç¬¬ä¸€æ¬¡ä¸Šå‚³æ™‚æä¾›ï¼Œå¾ŒçºŒæœƒè‡ªå‹•ä¿ç•™ï¼‰ï¼Œæ ¼å¼ç‚º `YYYY-MM-DD`ã€‚</li>
                    <li>ğŸ“… <strong>Work Week</strong>ï¼šå·¥ä½œé€±çš„é€±ä¸€æ—¥æœŸï¼ˆä¾‹å¦‚ï¼š2024-01-15 è¡¨ç¤º 2024å¹´1æœˆ15æ—¥é‚£ä¸€é€±ï¼‰ï¼Œæ ¼å¼ç‚º `YYYY-MM-DD`ã€‚</li>
                    <li>ğŸ”¢ <strong>é€±æ•¸è¨ˆç®—</strong>ï¼šç³»çµ±æœƒè‡ªå‹•æ ¹æ“š Start Date å’Œ Work Week è¨ˆç®—æ­£ç¢ºçš„é€±æ•¸</li>
                    <li>ğŸ­ <strong>Farm/Level/Rate æ›´æ–°</strong>ï¼šå¦‚æœå“¡å·¥è½‰æ›è¾²å ´æˆ–èª¿æ•´è–ªè³‡ï¼Œæ–°è³‡æ–™æœƒè¦†è“‹èˆŠè³‡æ–™</li>
                </ul>
                <p><strong>ä¸Šå‚³å¾Œè‡ªå‹•è™•ç†ï¼š</strong></p>
                <ul>
                    <li>âœ… é©—è­‰ EQ-0001 æ ¼å¼çš„å“¡å·¥ç·¨è™Ÿ</li>
                    <li>âœ… è‡ªå‹•è¨ˆç®—æ­£ç¢ºçš„å·¥ä½œé€±æ•¸</li>
                    <li>âœ… æ”¯æ´è¾²å ´å’Œè·ç´šç•°å‹•</li>
                    <li>âœ… æ•´åˆæ–°èˆŠè³‡æ–™ï¼Œæª¢æ¸¬é‡è¤‡å·¥ä½œé€±</li>
                    <li>âœ… è‡ªå‹•æ¨é€åˆ° GitHub repository</li>
                    <li>âœ… æ‰€æœ‰åœ˜éšŠæˆå“¡å³æ™‚çœ‹åˆ°æœ€æ–°è³‡æ–™</li>
                </ul>
            </div>
            
            <div class="upload-section" id="timesheet-upload">
                <h3>ğŸ“‹ ä¸Šå‚³å·¥æ™‚è¡¨ (CSV)</h3>
                <p>ä¸Šå‚³å¾Œå°‡è‡ªå‹•æ•´åˆä¸¦æ¨é€åˆ° GitHub repository</p>
                <button id="upload-file-btn" class="upload-btn" onclick="document.getElementById('timesheet-file').click()">
                    <span class="spinner" style="display: none;"></span>
                    é¸æ“‡å·¥æ™‚è¡¨æ–‡ä»¶
                </button>
                <input type="file" id="timesheet-file" class="file-input" accept=".csv" onchange="handleTimesheetFile(event)">
                <div id="timesheet-file-info" class="file-info"></div>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <p id="progress-text">ç­‰å¾…ä¸Šå‚³æ–‡ä»¶...</p>
            
            <div id="validation-results" class="validation-results"></div>
        </div>
        
        <div id="overview-tab" class="tab-content">
            <h2>ğŸ‘¥ å“¡å·¥ç¸½è¦½èˆ‡é€±æœŸåˆ†æ</h2>
            
            <div class="format-info">
                <h4>ğŸ” ç¯©é¸é¸é …</h4>
                <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                    <div>
                        <label for="farm-filter"><strong>è¾²å ´ï¼š</strong></label>
                        <select id="farm-filter" onchange="updateAllTables()" style="padding: 8px 12px; margin-left: 8px; border-radius: 5px; border: 1px solid #ccc;">
                            <option value="">æ‰€æœ‰è¾²å ´</option>
                        </select>
                    </div>
                    <div>
                        <label for="level-filter"><strong>è·ç´šï¼š</strong></label>
                        <select id="level-filter" onchange="updateAllTables()" style="padding: 8px 12px; margin-left: 8px; border-radius: 5px; border: 1px solid #ccc;">
                            <option value="">æ‰€æœ‰è·ç´š</option>
                        </select>
                    </div>
                    <div>
                        <label for="status-filter"><strong>é€±æœŸç‹€æ…‹ï¼š</strong></label>
                        <select id="status-filter" onchange="updateAllTables()" style="padding: 8px 12px; margin-left: 8px; border-radius: 5px; border: 1px solid #ccc;">
                            <option value="">æ‰€æœ‰ç‹€æ…‹</option>
                            <option value="active">é€²è¡Œä¸­</option>
                            <option value="overtime">éœ€åŠ ç­è²»</option>
                            <option value="complete">å·²å®Œæˆ</option>
                            <option value="pending">æœªé–‹å§‹</option>
                        </select>
                    </div>
                    <button class="action-btn" onclick="clearFilters()" style="background: #6c757d; color: white; padding: 8px 18px; border-radius: 5px; box-shadow: none;">æ¸…é™¤ç¯©é¸</button>
                </div>
            </div>
            
            <div class="summary-cards" id="overview-summary-cards"></div>
            <div id="overview-table-container"></div>
            
            <button id="exportOverview" class="upload-btn action-btn" onclick="exportOverview()" style="margin-top: 20px;">
                <span class="spinner" style="display: none;"></span>
                ğŸ“¥ åŒ¯å‡ºå“¡å·¥ç¸½è¦½å ±å‘Š (CSV)
            </button>
        </div>
        
        <div id="payroll-tab" class="tab-content">
            <h2>ğŸ’° è–ªè³‡è¨ˆç®—çµæœ</h2>
            <div class="summary-cards" id="payroll-summary-cards"></div>
            <div id="payroll-table-container"></div>
            <button id="exportPayroll" class="upload-btn action-btn" onclick="exportPayroll()" style="margin-top: 20px;">
                <span class="spinner" style="display: none;"></span>
                ğŸ“¥ åŒ¯å‡ºè–ªè³‡å ±è¡¨ (CSV)
            </button>
        </div>
        
        <div id="messages"></div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let employees = {};
        let timesheetData = [];
        let pendingData = null;
        let isGitHubConnected = false;
        
        // ================================
        // ğŸ”‘ GitHub è¨­å®šå€åŸŸ - æ¯æ¬¡è¼¸å…¥æ¨¡å¼ (å·²ç§»é™¤ localStorage å„²å­˜)
        // ================================
        let githubToken = ''; // æ¯æ¬¡ä½¿ç”¨éƒ½éœ€è¦è¼¸å…¥ï¼Œä¸å†æŒä¹…åŒ–å„²å­˜
        
        const REPO_OWNER = 'lass120625';  // æ‚¨çš„ GitHub ç”¨æˆ¶å
        const REPO_NAME = 'timesheet-system';  // Repository åç¨±
        const DATA_FILE_NAME = 'timesheet_data.json';
        
        // å¸¸æ•¸å®šç¾©
        const REGULAR_HOURS_THRESHOLD = 304; // 8é€±é€±æœŸæ­£å¸¸å·¥æ™‚ä¸Šé™ (8é€± * 38å°æ™‚/é€±)
        const WEEKS_PER_CYCLE = 8; // æ¯é€±æœŸçš„é€±æ•¸
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // æ¸…é™¤æ‰€æœ‰èˆŠè³‡æ–™ï¼Œç¢ºä¿æ¯æ¬¡é–‹å•Ÿéƒ½å¾é›¶é–‹å§‹ï¼ˆç¬¦åˆä¸å„²å­˜ Token çš„é‚è¼¯ï¼‰
            // clearAllData(); // åˆå§‹é é¢è¼‰å…¥æ™‚ä¸éœ€è¦æ¸…é™¤ï¼Œå› ç‚ºè³‡æ–™å°‡å¾ GitHub è¼‰å…¥æˆ–ç­‰å¾…ä¸Šå‚³
            loadSettings(); // åŸ·è¡Œé€£æ¥é‚è¼¯
            updateProgress(0, 'è«‹å…ˆé€£æ¥ GitHub ä»¥é–‹å§‹ä½¿ç”¨');
        });
        
        // æ¸…é™¤æ‰€æœ‰è³‡æ–™
        function clearAllData() {
            employees = {};
            timesheetData = [];
            
            // æ¸…é™¤ localStorage (å¦‚æœä¹‹å‰æœ‰å­˜éï¼Œç¢ºä¿æ¸…ç©º)
            try {
                localStorage.removeItem('timesheet_employees');
                localStorage.removeItem('timesheet_data');
                localStorage.removeItem('github_token'); // ç¢ºä¿ç§»é™¤èˆŠçš„ token
                console.log('âœ… å·²æ¸…é™¤æ‰€æœ‰æœ¬åœ°è³‡æ–™');
            } catch (error) {
                console.log('æ¸…é™¤è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            }
        }
        
        // æ‰‹å‹•æ¸…é™¤è³‡æ–™æŒ‰éˆ•åŠŸèƒ½
        async function resetAllData() {
            if (confirm('âš ï¸ ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿ\n\né€™å°‡æœƒåˆªé™¤ï¼š\nâ€¢ æ‰€æœ‰å“¡å·¥è³‡æ–™\nâ€¢ æ‰€æœ‰å·¥æ™‚è¨˜éŒ„\nâ€¢ æœ¬åœ°å„²å­˜çš„è³‡æ–™\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
                // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
                setButtonLoading('resetAllData', true, 'æ¸…é™¤ä¸­...');

                clearAllData();
                updateAllTables();
                showMessage('ğŸ—‘ï¸ æ‰€æœ‰è³‡æ–™å·²æ¸…é™¤ï¼å¯ä»¥é‡æ–°é–‹å§‹ä¸Šå‚³ã€‚', 'warning');
                
                // å˜—è©¦æ¸…ç©º GitHub ä¸Šçš„æª”æ¡ˆ
                if (isGitHubConnected && githubToken) {
                    try {
                        showMessage('å˜—è©¦å¾ GitHub åˆªé™¤è³‡æ–™æª”æ¡ˆ...', 'warning');
                        await deleteGitHubFile(DATA_FILE_NAME);
                        showMessage('âœ… GitHub è³‡æ–™æª”æ¡ˆå·²åˆªé™¤ã€‚', 'success');
                    } catch (error) {
                        showMessage(`âŒ å¾ GitHub åˆªé™¤æª”æ¡ˆå¤±æ•—: ${error.message}<br>è«‹æ‰‹å‹•å‰å¾€ GitHub repository åˆªé™¤æª”æ¡ˆã€‚`, 'error');
                        console.error('å¾ GitHub åˆªé™¤æª”æ¡ˆå¤±æ•—:', error);
                    }
                }
                
                // é‡æ–°è¼‰å…¥é é¢ä»¥ç¢ºä¿å®Œå…¨é‡ç½®
                setTimeout(() => {
                    location.reload();
                }, 2000);

                setButtonLoading('resetAllData', false, 'æ¸…é™¤æ‰€æœ‰è³‡æ–™'); // é‡ç½®è¼‰å…¥ç‹€æ…‹
            }
        }
        
        // åˆªé™¤ GitHub æª”æ¡ˆ
        async function deleteGitHubFile(filePath) {
            const getFileResponse = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${filePath}`, {
                headers: {
                    'Authorization': `token ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });

            if (getFileResponse.status === 404) {
                // File does not exist, nothing to delete
                return;
            }

            if (!getFileResponse.ok) {
                throw new Error(`Failed to get file SHA: HTTP ${getFileResponse.status}`);
            }

            const fileData = await getFileResponse.json();
            const sha = fileData.sha;

            const deleteResponse = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${filePath}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `token ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: `Delete ${filePath} for timesheet system reset - ${new Date().toLocaleString('zh-TW')}`,
                    sha: sha
                })
            });

            if (!deleteResponse.ok) {
                const errorData = await deleteResponse.json();
                throw new Error(`Failed to delete file: ${errorData.message || deleteResponse.statusText}`);
            }
        }

        // è¼‰å…¥è¨­å®šï¼ˆä¸å¾ localStorage è¼‰å…¥ Tokenï¼‰
        function loadSettings() {
            // ç”±æ–¼ä¸å„²å­˜ Tokenï¼Œé€™è£¡åªè² è²¬é¡¯ç¤º Token è¼¸å…¥ä»‹é¢
            showTokenSetup();
            updateGitHubStatus('disconnected', 'å°šæœªé€£æ¥åˆ° GitHub repository');
        }
        
        // é¡¯ç¤ºå»ºç«‹ Repository å°è©±æ¡†
        function showCreateRepositoryDialog() {
            const dialog = document.createElement('div');
            dialog.className = 'confirm-dialog active'; // Add active class to show it
            
            dialog.innerHTML = `
                <div class="confirm-content">
                    <h3>ğŸ“ Repository ä¸å­˜åœ¨</h3>
                    <p>åœ¨æ‚¨çš„ GitHub å¸³æˆ¶ä¸­æ‰¾ä¸åˆ°åç‚º <strong>${REPO_NAME}</strong> çš„ repositoryã€‚</p>
                    
                    <div class="warning-message">
                        <strong>ç›®å‰è¨­å®šï¼š</strong><br>
                        ç”¨æˆ¶ï¼š${REPO_OWNER}<br>
                        Repositoryï¼š${REPO_NAME}
                    </div>
                    
                    <p>è«‹é¸æ“‡ä»¥ä¸‹å…¶ä¸­ä¸€å€‹é¸é …ï¼š</p>
                    
                    <div class="confirm-buttons">
                        <button class="btn-confirm" onclick="createRepository()">
                            ğŸ†• è‡ªå‹•å»ºç«‹ Repository
                        </button>
                        <button class="btn-cancel" onclick="showRepositorySettings()">
                            âš™ï¸ ä¿®æ”¹è¨­å®š (éœ€æ‰‹å‹•ä¿®æ”¹ä»£ç¢¼)
                        </button>
                        <button class="btn-cancel" onclick="closeCreateDialog()">
                            âŒ å–æ¶ˆ
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(dialog);
        }
        
        // å»ºç«‹æ–°çš„ Repository
        async function createRepository() {
            try {
                showMessage('ğŸ”¨ æ­£åœ¨å»ºç«‹ Repository...', 'warning');
                setButtonLoading('createRepository', true, 'å»ºç«‹ä¸­...'); // Example: assuming a button ID or direct manipulation

                const response = await fetch('https://api.github.com/user/repos', {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: REPO_NAME,
                        description: 'GitHub ç‰ˆå·¥æ™‚ç®¡ç†ç³»çµ± - è‡ªå‹•å»ºç«‹',
                        private: false, // For public access, change to true for private
                        auto_init: true // Creates README.md
                    })
                });
                
                if (response.ok) {
                    const repo = await response.json();
                    closeCreateDialog();
                    
                    isGitHubConnected = true;
                    updateGitHubStatus('connected', `âœ… å·²å»ºç«‹ä¸¦é€£æ¥åˆ° Repository: ${repo.full_name}`);
                    showMessage(`âœ… Repository å»ºç«‹æˆåŠŸï¼<br>ğŸ“ ä½ç½®ï¼š<a href="${repo.html_url}" target="_blank">${repo.full_name}</a>`);
                    
                    // ç¨ç­‰ä¸€ä¸‹è®“ GitHub å®Œæˆåˆå§‹åŒ–ï¼Œç„¶å¾Œé–‹å§‹åŒæ­¥
                    setTimeout(() => {
                        syncFromGitHub();
                    }, 2000);
                    
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `å»ºç«‹å¤±æ•—: HTTP ${response.status}`);
                }
                
            } catch (error) {
                showMessage(`âŒ å»ºç«‹ Repository å¤±æ•—: ${error.message}`, 'error');
                console.error('å»ºç«‹ Repository å¤±æ•—:', error);
            } finally {
                setButtonLoading('createRepository', false, 'è‡ªå‹•å»ºç«‹ Repository'); // This assumes the button has this ID
            }
        }
        
        // é¡¯ç¤º Repository è¨­å®š
        function showRepositorySettings() {
            closeCreateDialog();
            
            const currentOwner = REPO_OWNER;
            const currentName = REPO_NAME;
            
            // This is just a prompt, actual change requires code modification as indicated
            alert(`
                è«‹æ‰‹å‹•ä¿®æ”¹ä»£ç¢¼ä¸­çš„ REPO_OWNER å’Œ REPO_NAME å¸¸æ•¸ï¼Œä¸¦é‡æ–°è¼‰å…¥é é¢ã€‚

                ç›®å‰è¨­å®šï¼š
                REPO_OWNER = '${currentOwner}'
                REPO_NAME = '${currentName}'
            `);
        }
        
        // é—œé–‰å»ºç«‹å°è©±æ¡†
        function closeCreateDialog() {
            const dialog = document.querySelector('.confirm-dialog');
            if (dialog) {
                dialog.classList.remove('active');
                setTimeout(() => dialog.remove(), 300); // Allow fade-out animation
            }
        }
        
        // å„²å­˜ GitHub Token (ä¸å†å„²å­˜åˆ° localStorage)
        async function saveGitHubToken() {
            const tokenInput = document.getElementById('github-token-input');
            const token = tokenInput.value.trim();
            
            if (!token) {
                showMessage('è«‹è¼¸å…¥ GitHub Token', 'error');
                return;
            }
            
            // é©—è­‰ token æ ¼å¼ï¼ˆGitHub Personal Access Token é€šå¸¸ä»¥ ghp_ æˆ– github_pat_ é–‹é ­ï¼‰
            if (!token.startsWith('ghp_') && !token.startsWith('github_pat_')) {
                showMessage('Token æ ¼å¼å¯èƒ½ä¸æ­£ç¢ºï¼Œè«‹ç¢ºèªæ˜¯å¦ç‚ºæ­£ç¢ºçš„ GitHub Personal Access Token', 'warning');
                // return; // Allow user to proceed with potentially malformed token, but warn them
            }
            
            githubToken = token;
            
            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            setButtonLoading('save-token-btn', true, 'é€£æ¥ä¸­...');
            
            try {
                await connectToGitHub();
            } finally {
                setButtonLoading('save-token-btn', false, 'é€£æ¥ GitHub');
            }
        }
        
        // éš±è— Token è¨­å®šå€åŸŸ
        function hideTokenSetup() {
            const tokenSetup = document.getElementById('token-setup');
            tokenSetup.style.display = 'none';
        }
        
        // é¡¯ç¤º Token è¨­å®šå€åŸŸ
        function showTokenSetup() {
            const tokenSetup = document.getElementById('token-setup');
            tokenSetup.style.display = 'block';
        }
        
        // è¼‰å…¥æœ¬åœ°è³‡æ–™ (åƒ…ä¾›è¨˜æ†¶é«”ä½¿ç”¨ï¼Œä¸å¾ localStorage è®€å–)
        function loadLocalData() {
            // ç›®å‰é‚è¼¯ä¸­ï¼Œæœ¬åœ°è³‡æ–™åªåœ¨ GitHub åŒæ­¥æˆåŠŸå¾Œæ‰å¡«å……
            // æ­¤å‡½æ•¸çš„å­˜åœ¨ä¸»è¦ç”¨æ–¼æœªä¾†æ“´å±•æˆ–æœ¬åœ°æ¸¬è©¦
            // å¯¦éš›ä¸Šï¼Œæ•¸æ“šä¸»è¦ä¾†è‡ª GitHub
            if (Object.keys(employees).length > 0) {
                updateAllTables();
                // showMessage('ğŸ“‚ å·²è¼‰å…¥æœ¬åœ°è¨˜æ†¶é«”è³‡æ–™'); // é¿å…é »ç¹æç¤º
            }
        }
        
        // å„²å­˜æœ¬åœ°è³‡æ–™ (åƒ…é™è¨˜æ†¶é«”ï¼Œä¸ä½¿ç”¨ localStorage)
        function saveLocalData() {
            // åœ¨æ­¤æ‡‰ç”¨ä¸­ï¼Œæ•¸æ“šåªåœ¨è¨˜æ†¶é«”ä¸­ç¶­è­·ï¼Œä¸¦åœ¨æ¯æ¬¡ä¸Šå‚³æ™‚æ¨é€åˆ° GitHub
            // æ­¤å‡½æ•¸å¯ç‚ºæœªä¾†å¯èƒ½å¯¦ç¾çš„é›¢ç·šæ¨¡å¼åšæº–å‚™ï¼Œä½†ç›®å‰ä¸å¯¦éš›å„²å­˜åˆ° localStorage
        }
        
        // é€£æ¥åˆ° GitHub
        async function connectToGitHub() {
            if (!githubToken) {
                showMessage('âŒ è«‹å…ˆè¨­å®š GitHub Token', 'error');
                showTokenSetup();
                return;
            }
            
            updateGitHubStatus('loading', 'æ­£åœ¨é€£æ¥ GitHub...');
            
            try {
                // æ¸¬è©¦ GitHub API é€£æ¥
                const userResponse = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'User-Agent': 'Timesheet-System/1.0'
                    }
                });
                
                if (!userResponse.ok) {
                    if (userResponse.status === 401) {
                        throw new Error('Token èªè­‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Token æ˜¯å¦æ­£ç¢º');
                    } else if (userResponse.status === 403) {
                        throw new Error('æ¬Šé™ä¸è¶³ï¼Œè«‹æª¢æŸ¥ Token æ¬Šé™è¨­å®šï¼ˆéœ€å‹¾é¸ repo æ¬Šé™ï¼‰');
                    } else {
                        throw new Error(`API éŒ¯èª¤: ${userResponse.status} - ${userResponse.statusText}`);
                    }
                }
                const user = await userResponse.json();
                showMessage(`âœ… GitHub èªè­‰æˆåŠŸï¼ç”¨æˆ¶ï¼š${user.login}`, 'success');
                
                // æ¸¬è©¦ Repository å­˜å–
                const repoResponse = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}`, {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'User-Agent': 'Timesheet-System/1.0'
                    }
                });
                
                if (repoResponse.status === 404) {
                    showCreateRepositoryDialog();
                    isGitHubConnected = false; // Not connected yet, needs repo creation
                    updateGitHubStatus('disconnected', `Repository '${REPO_NAME}' ä¸å­˜åœ¨`);
                    return; // Stop here, wait for user action on dialog
                } else if (!repoResponse.ok) {
                    throw new Error(`ç„¡æ³•å­˜å– Repository: ${repoResponse.status} - ${repoResponse.statusText}`);
                }
                
                const repo = await repoResponse.json();
                isGitHubConnected = true;
                updateGitHubStatus('connected', `âœ… å·²é€£æ¥åˆ° Repository: ${repo.full_name}`);
                showMessage('âœ… GitHub é€£æ¥å®Œå…¨æˆåŠŸï¼æ­£åœ¨è¼‰å…¥è³‡æ–™...');
                syncFromGitHub();
                
            } catch (error) {
                let errorMessage = error.message;
                let suggestions = '';
                
                if (error.message.includes('Token èªè­‰å¤±æ•—')) {
                    suggestions = '<br><br>ğŸ”§ è«‹æª¢æŸ¥ Token æ˜¯å¦æ­£ç¢ºè¤‡è£½';
                } else if (error.message.includes('æ¬Šé™ä¸è¶³')) {
                    suggestions = '<br><br>ğŸ”§ è«‹æª¢æŸ¥ Token æ¬Šé™æ˜¯å¦åŒ…å« "repo"';
                } else if (error.message.includes('Repository')) {
                    suggestions = '<br><br>ğŸ”§ è«‹ç¢ºèª Repository åç¨±æ­£ç¢ºï¼Œæˆ–é»æ“Šè‡ªå‹•å»ºç«‹';
                }
                
                showMessage(`âŒ GitHub é€£æ¥å¤±æ•—: ${errorMessage}${suggestions}`, 'error');
                updateGitHubStatus('disconnected', `GitHub é€£æ¥å¤±æ•—: ${errorMessage}`);
                
                // æ ¹æ“šéŒ¯èª¤é¡å‹æ±ºå®šæ˜¯å¦é¡¯ç¤ºè¨­å®šå€åŸŸ
                if (error.message.includes('Token') || error.message.includes('èªè­‰') || error.message.includes('æ¬Šé™')) {
                    setTimeout(() => {
                        showTokenSetup();
                    }, 1000);
                }
            }
        }
        
        // æ›´æ–° GitHub é€£æ¥ç‹€æ…‹
        function updateGitHubStatus(status, message) {
            const statusDiv = document.getElementById('github-status');
            const statusText = document.getElementById('github-status-text');
            const syncBtn = document.getElementById('github-sync-btn');
            const downloadBtn = document.getElementById('github-download-btn');
            const disconnectBtn = document.getElementById('github-disconnect-btn');
            const lastSyncDiv = document.getElementById('last-sync');
            const resetButton = document.getElementById('resetAllData'); // Select the reset button by ID

            statusText.textContent = message;
            
            if (status === 'connected') {
                statusDiv.className = 'github-section github-connected';
                syncBtn.style.display = 'inline-flex'; // Use flex for spinner
                downloadBtn.style.display = 'inline-flex';
                disconnectBtn.style.display = 'inline-flex';
                lastSyncDiv.style.display = 'block';
                resetButton.style.display = 'inline-flex'; // Show reset button
            } else if (status === 'loading') {
                statusDiv.className = 'github-section github-loading';
                syncBtn.style.display = 'none';
                downloadBtn.style.display = 'none';
                disconnectBtn.style.display = 'none';
                resetButton.style.display = 'none'; // Hide reset button during loading
            } else {
                statusDiv.className = 'github-section github-disconnected';
                syncBtn.style.display = 'none';
                downloadBtn.style.display = 'none';
                disconnectBtn.style.display = 'none';
                lastSyncDiv.style.display = 'none';
                resetButton.style.display = 'inline-flex'; // Show reset button when disconnected
            }
        }
        
        // ä¸­æ–· GitHub é€£æ¥
        function disconnectGitHub() {
            if (confirm('ç¢ºå®šè¦ä¸­æ–· GitHub é€£æ¥å—ï¼Ÿæ‚¨å¯ä»¥éš¨æ™‚é‡æ–°é€£æ¥ã€‚é€™å°‡æœƒæ¸…é™¤æ‚¨æœ¬æ¬¡è¼¸å…¥çš„ GitHub Tokenã€‚')) {
                isGitHubConnected = false;
                githubToken = ''; // æ¸…é™¤è¨˜æ†¶é«”ä¸­çš„ Token
                document.getElementById('github-token-input').value = ''; // æ¸…ç©ºè¼¸å…¥æ¡†
                updateGitHubStatus('disconnected', 'å°šæœªé€£æ¥åˆ° GitHub repository');
                showTokenSetup();
                showMessage('ğŸ”Œ å·²ä¸­æ–· GitHub é€£æ¥');
            }
        }

        // è¨­ç½®æŒ‰éˆ•è¼‰å…¥ç‹€æ…‹
        function setButtonLoading(buttonId, isLoading, loadingText = 'è™•ç†ä¸­...') {
            const button = document.getElementById(buttonId);
            if (!button) { // Fallback for buttons without specific ID passed in parameter
                 const buttons = document.querySelectorAll(`button.action-btn, button.upload-btn, button.github-btn, button.save-token-btn`);
                 for(let i = 0; i < buttons.length; i++) {
                     if (buttons[i].textContent.includes(buttonId)) { // Simple text match if ID not available
                         button = buttons[i];
                         break;
                     }
                 }
                 if (!button) return; // If still no button found
            }
            
            const spinner = button.querySelector('.spinner');
            const originalText = button.dataset.originalText || button.textContent.trim(); // Use .trim() for consistency

            if (isLoading) {
                button.dataset.originalText = originalText; // Store original text
                button.disabled = true;
                // Remove existing text before adding spinner and new text
                button.innerHTML = '';
                if (spinner) {
                    button.appendChild(spinner);
                    spinner.style.display = 'inline-block';
                } else { // Create spinner if not found (e.g., for dynamically identified buttons)
                    const newSpinner = document.createElement('span');
                    newSpinner.className = `spinner ${buttonId.includes('warning') || buttonId.includes('danger') ? 'spinner-dark' : ''}`;
                    button.prepend(newSpinner);
                }
                button.append(loadingText); // Append new text after spinner
            } else {
                button.disabled = false;
                button.innerHTML = originalText;
                if (spinner) spinner.style.display = 'none';
            }
        }
        
        // å¾ GitHub åŒæ­¥è³‡æ–™
        async function syncFromGitHub() {
            if (!isGitHubConnected) {
                showMessage('âŒ è«‹å…ˆé€£æ¥ GitHub', 'error');
                return;
            }
            
            setButtonLoading('github-sync-btn', true, 'è¼‰å…¥ä¸­...');
            
            try {
                showMessage('ğŸ”„ æ­£åœ¨å¾ GitHub è¼‰å…¥æœ€æ–°è³‡æ–™...');
                
                const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${DATA_FILE_NAME}`, {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.status === 404) {
                    showMessage('ğŸ“ GitHub ä¸­å°šç„¡è³‡æ–™æª”æ¡ˆï¼Œå°‡åœ¨é¦–æ¬¡ä¸Šå‚³æ™‚å»ºç«‹', 'warning');
                    updateSyncTime();
                    // Clear local data if no file found on GitHub to avoid stale data
                    employees = {};
                    timesheetData = [];
                    updateAllTables();
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const fileData = await response.json();
                const content = atob(fileData.content);
                const data = JSON.parse(content);
                
                // è¼‰å…¥åˆ°ç³»çµ±ä¸­
                employees = data.employees || {};
                timesheetData = data.timesheetData || [];
                
                // å„²å­˜åˆ°æœ¬åœ°è¨˜æ†¶é«” (é localStorage)
                saveLocalData(); 
                
                updateAllTables();
                updateSyncTime();
                
                const empCount = Object.keys(employees).length;
                const recordCount = timesheetData.length;
                
                showMessage(`âœ… æˆåŠŸè¼‰å…¥ GitHub è³‡æ–™ï¼<br>ğŸ‘¥ ${empCount} ä½å“¡å·¥<br>ğŸ“Š ${recordCount} ç­†å·¥æ™‚è¨˜éŒ„`);
                
            } catch (error) {
                console.error('å¾ GitHub åŒæ­¥å¤±æ•—:', error);
                showMessage(`âŒ å¾ GitHub è¼‰å…¥å¤±æ•—: ${error.message}`, 'error');
            } finally {
                setButtonLoading('github-sync-btn', false, 'ğŸ”„ å¾ GitHub è¼‰å…¥æœ€æ–°è³‡æ–™');
            }
        }
        
        // ä¸Šå‚³åˆ° GitHub
        async function uploadToGitHub() {
            if (!isGitHubConnected) {
                throw new Error('æœªé€£æ¥åˆ° GitHub');
            }
            
            try {
                // æº–å‚™è³‡æ–™
                const data = {
                    employees: employees,
                    timesheetData: timesheetData,
                    lastUpdated: new Date().toISOString(),
                    version: '1.1', // Increment version
                    systemName: 'GitHub ç‰ˆå·¥æ™‚ç®¡ç†ç³»çµ±'
                };
                
                const content = JSON.stringify(data, null, 2);
                const encodedContent = btoa(unescape(encodeURIComponent(content)));
                
                // å…ˆæª¢æŸ¥æª”æ¡ˆæ˜¯å¦å­˜åœ¨ä»¥å–å¾— sha
                let sha = null;
                try {
                    const existingFile = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${DATA_FILE_NAME}`, {
                        headers: {
                            'Authorization': `token ${githubToken}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (existingFile.ok) {
                        const fileData = await existingFile.json();
                        sha = fileData.sha;
                    }
                } catch (error) {
                    console.log('æª”æ¡ˆä¸å­˜åœ¨æˆ–ç„¡æ³•å–å¾— SHAï¼Œå°‡å»ºç«‹æ–°æª”æ¡ˆ:', error.message);
                }
                
                // æ›´æ–°æˆ–å»ºç«‹æª”æ¡ˆ
                const updateData = {
                    message: `æ›´æ–°å·¥æ™‚è³‡æ–™ - ${new Date().toLocaleString('zh-TW')}`,
                    content: encodedContent
                };
                
                if (sha) {
                    updateData.sha = sha;
                }
                
                const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${DATA_FILE_NAME}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`GitHub API éŒ¯èª¤: ${errorData.message || response.statusText}`);
                }
                
                const result = await response.json();
                console.log('GitHub æ›´æ–°æˆåŠŸ:', result);
                
                updateSyncTime();
                return true;
                
            } catch (error) {
                console.error('ä¸Šå‚³åˆ° GitHub å¤±æ•—:', error);
                throw error;
            }
        }
        
        // å¾ GitHub ä¸‹è¼‰å®Œæ•´è³‡æ–™æª”
        async function downloadFromGitHub() {
            if (!isGitHubConnected) {
                showMessage('âŒ è«‹å…ˆé€£æ¥ GitHub', 'error');
                return;
            }
            
            setButtonLoading('github-download-btn', true, 'ä¸‹è¼‰ä¸­...');

            try {
                const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${DATA_FILE_NAME}`, {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.status === 404) {
                     showMessage('âš ï¸ GitHub ä¸­å°šç„¡è³‡æ–™æª”æ¡ˆå¯ä¾›ä¸‹è¼‰ã€‚', 'warning');
                     return;
                }

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const fileData = await response.json();
                const content = atob(fileData.content);
                
                const blob = new Blob([content], { type: 'application/json' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `å·¥æ™‚ç³»çµ±å®Œæ•´è³‡æ–™_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link); // Append to body for Firefox
                link.click();
                document.body.removeChild(link); // Clean up
                
                showMessage('âœ… å®Œæ•´è³‡æ–™æª”å·²ä¸‹è¼‰ï¼');
                
            } catch (error) {
                showMessage(`âŒ ä¸‹è¼‰å¤±æ•—: ${error.message}`, 'error');
            } finally {
                setButtonLoading('github-download-btn', false, 'ğŸ“¥ ä¸‹è¼‰å®Œæ•´è³‡æ–™æª”');
            }
        }
        
        // æ›´æ–°åŒæ­¥æ™‚é–“
        function updateSyncTime() {
            const syncTimeElement = document.getElementById('sync-time');
            if (syncTimeElement) {
                syncTimeElement.textContent = new Date().toLocaleString('zh-TW');
            }
        }
        
        // è¨ˆç®—å“¡å·¥é€±æœŸè³‡è¨Š
        function calculateEmployeeCycle(employee, referenceDate = new Date()) {
            // Ensure employee.startDate is a valid date string
            if (!employee.startDate || isNaN(new Date(employee.startDate).getTime())) {
                return {
                    currentCycle: 1,
                    weekInCycle: 1,
                    cycleStartDate: new Date(referenceDate.getFullYear(), referenceDate.getMonth(), referenceDate.getDate()),
                    cycleEndDate: new Date(referenceDate.getFullYear(), referenceDate.getMonth(), referenceDate.getDate() + (WEEKS_PER_CYCLE * 7) -1), // Default end date
                    daysInCycle: 0,
                    totalWeeksFromStart: 0,
                    status: 'pending',
                    progressPercentage: 0
                };
            }
            
            try {
                const startDate = parseDate(employee.startDate);
                if (!startDate || isNaN(startDate.getTime())) { // Fallback if parseDate fails for some reason
                    return {
                        currentCycle: 1,
                        weekInCycle: 1,
                        cycleStartDate: new Date(referenceDate.getFullYear(), referenceDate.getMonth(), referenceDate.getDate()),
                        cycleEndDate: new Date(referenceDate.getFullYear(), referenceDate.getMonth(), referenceDate.getDate() + (WEEKS_PER_CYCLE * 7) -1),
                        daysInCycle: 0,
                        totalWeeksFromStart: 0,
                        status: 'pending',
                        progressPercentage: 0
                    };
                }
                
                const currentDate = new Date(referenceDate);
                currentDate.setHours(0, 0, 0, 0);
                
                // æ‰¾åˆ°é€±ä¸€
                const startMonday = getMonday(startDate);
                const currentMonday = getMonday(currentDate);
                
                // è¨ˆç®—ç¸½é€±æ•¸
                const totalWeeksFromStart = Math.floor((currentMonday - startMonday) / (7 * 24 * 60 * 60 * 1000)) + 1;
                
                // è¨ˆç®—é€±æœŸ
                const currentCycle = Math.floor((totalWeeksFromStart - 1) / WEEKS_PER_CYCLE) + 1;
                const weekInCycle = ((totalWeeksFromStart - 1) % WEEKS_PER_CYCLE) + 1;
                
                // è¨ˆç®—é€±æœŸæ—¥æœŸ
                const cycleStartWeekIndex = (currentCycle - 1) * WEEKS_PER_CYCLE;
                const cycleStartDate = new Date(startMonday);
                cycleStartDate.setDate(cycleStartDate.getDate() + (cycleStartWeekIndex * 7));
                
                const cycleEndDate = new Date(cycleStartDate);
                cycleEndDate.setDate(cycleEndDate.getDate() + (WEEKS_PER_CYCLE * 7) - 1); // 8 weeks = 56 days, end on 56th day
                
                // è¨ˆç®—é€²åº¦
                const daysInCycle = Math.max(0, Math.floor((currentDate - cycleStartDate) / (1000 * 60 * 60 * 24)) + 1);
                const totalDaysInCyclePeriod = WEEKS_PER_CYCLE * 7;
                const progressPercentage = Math.min((daysInCycle / totalDaysInCyclePeriod) * 100, 100);
                
                // åˆ¤æ–·ç‹€æ…‹
                let status = 'active';
                if (employee.totalHours > REGULAR_HOURS_THRESHOLD) {
                    status = 'overtime';
                } else if (daysInCycle >= totalDaysInCyclePeriod && employee.totalHours > 0) { // Cycle period finished AND has some hours
                    status = 'complete';
                } else if (daysInCycle <= 0 || employee.totalHours === 0) { // Start date in future or no hours logged yet
                    status = 'pending';
                }
                
                return {
                    currentCycle,
                    weekInCycle: Math.min(Math.max(weekInCycle, 1), WEEKS_PER_CYCLE), // Cap week in cycle to max WEEKS_PER_CYCLE
                    cycleStartDate,
                    cycleEndDate,
                    daysInCycle: Math.min(Math.max(daysInCycle, 0), totalDaysInCyclePeriod),
                    totalWeeksFromStart,
                    status,
                    progressPercentage
                };
            } catch (error) {
                console.error("Error calculating employee cycle:", employee, error);
                return { // Fallback to a default, safe state
                    currentCycle: 1,
                    weekInCycle: 1,
                    cycleStartDate: new Date(referenceDate.getFullYear(), referenceDate.getMonth(), referenceDate.getDate()),
                    cycleEndDate: new Date(referenceDate.getFullYear(), referenceDate.getMonth(), referenceDate.getDate() + (WEEKS_PER_CYCLE * 7) -1),
                    daysInCycle: 0,
                    totalWeeksFromStart: 0,
                    status: 'pending',
                    progressPercentage: 0
                };
            }
        }
        
        // Tab åˆ‡æ›
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }
        
        // é¡¯ç¤ºè¨Šæ¯
        function showMessage(message, type = 'success', duration = 8000) { // Add duration parameter
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'error' ? 'error-message' : 
                                 type === 'warning' ? 'warning-message' : 'success-message';
            messageDiv.innerHTML = message;
            messagesDiv.appendChild(messageDiv);
            
            // Auto-remove message after duration
            setTimeout(() => {
                messageDiv.classList.add('message-fadeout'); // Add fade-out class
                messageDiv.addEventListener('transitionend', () => messageDiv.remove()); // Remove after transition
            }, duration);
        }
        
        // æ›´æ–°é€²åº¦
        function updateProgress(percentage, text) {
            document.getElementById('progress-fill').style.width = percentage + '%';
            document.getElementById('progress-text').textContent = text;
        }
        
        // é©—è­‰ Payroll ID æ ¼å¼
        function validatePayrollID(payrollId) {
            if (!payrollId) return false;
            // Updated pattern to be more flexible but still ensure 2-3 letters and 3-4 digits
            const pattern = /^[A-Za-z]{2,3}-\d{3,4}$/; 
            return pattern.test(payrollId.trim());
        }
        
        // è§£æé€±æ•¸ (å·²åœ¨ calculateEmployeeCycle è™•ç†ï¼Œæ­¤å‡½æ•¸å¯èƒ½ä¸å†éœ€è¦ç›´æ¥èª¿ç”¨)
        // ç•™è‘—ä»¥é˜²è¬ä¸€æˆ–æœªä¾†ç¨ç«‹ä½¿ç”¨
        function parseWeekNumber(workWeekDateString, startDateString) {
            if (!workWeekDateString || !startDateString) return 1;
            
            try {
                const workWeekDate = parseDate(workWeekDateString);
                const startDate = parseDate(startDateString);
                
                if (!workWeekDate || !startDate) return 1;
                
                const startMonday = getMonday(startDate);
                const workWeekMonday = getMonday(workWeekDate);
                
                const weeksDiff = Math.round((workWeekMonday - startMonday) / (7 * 24 * 60 * 60 * 1000));
                
                const weekInCycle = ((weeksDiff % WEEKS_PER_CYCLE) + WEEKS_PER_CYCLE) % WEEKS_PER_CYCLE + 1;
                
                return Math.max(1, Math.min(weekInCycle, WEEKS_PER_CYCLE));
                
            } catch (error) {
                console.error("Error parsing week number:", error);
                return 1;
            }
        }
        
        // å¿«é€Ÿæ—¥æœŸè§£æå‡½æ•¸ (æ›´å¼·å¥)
        function parseDate(dateString) {
            if (!dateString) return null;
            
            // Try YYYY-MM-DD
            let date = new Date(dateString);
            if (!isNaN(date.getTime()) && date.toISOString().slice(0,10) === dateString) {
                return date;
            }

            // Try DD/MM/YYYY
            const partsSlash = dateString.split('/');
            if (partsSlash.length === 3) {
                date = new Date(parseInt(partsSlash[2]), parseInt(partsSlash[1]) - 1, parseInt(partsSlash[0]));
                if (!isNaN(date.getTime())) return date;
            }
            
            // Try MM/DD/YYYY (common in some locales)
            const partsSlashMDY = dateString.split('/');
            if (partsSlashMDY.length === 3) {
                date = new Date(parseInt(partsSlashMDY[2]), parseInt(partsSlashMDY[0]) - 1, parseInt(partsSlashMDY[1]));
                if (!isNaN(date.getTime())) return date;
            }

            // If all fails, return null
            return null;
        }
        
        // å¿«é€Ÿå–å¾—é€±ä¸€çš„å‡½æ•¸
        function getMonday(date) {
            const result = new Date(date);
            const dayOfWeek = result.getDay(); // Sunday - 0, Monday - 1, ..., Saturday - 6
            // Calculate days to subtract to get to Monday. If Sunday (0), subtract 6. Else subtract dayOfWeek - 1.
            const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            result.setDate(result.getDate() + daysToMonday);
            result.setHours(0, 0, 0, 0); // Set to start of the day
            return result;
        }
        
        // è§£æå·¥è³‡ç‡
        function parseRate(rateString) {
            if (!rateString) return 0;
            // Remove any non-numeric characters except the decimal point
            const cleanedString = rateString.toString().replace(/[^0-9.]/g, '');
            return parseFloat(cleanedString) || 0;
        }
        
        // è™•ç†å·¥æ™‚è¡¨æ–‡ä»¶
        async function handleTimesheetFile(event) {
            const file = event.target.files[0];
            if (!file) {
                document.getElementById('timesheet-file-info').style.display = 'none'; // Hide file info if no file selected
                updateProgress(0, 'ç­‰å¾…ä¸Šå‚³æ–‡ä»¶...');
                return;
            }
            
            // Reset validation results and file info
            document.getElementById('validation-results').innerHTML = '';
            document.getElementById('timesheet-file-info').style.display = 'none';

            setButtonLoading('upload-file-btn', true, 'è®€å–ä¸­...');

            try {
                updateProgress(20, 'æ­£åœ¨è®€å–å·¥æ™‚è¡¨...');
                
                const data = await readFile(file);
                const parsed = parseCSV(data);
                
                updateProgress(40, 'é©—è­‰è³‡æ–™æ ¼å¼...');
                
                const validationResult = validateTimesheetData(parsed);
                
                if (validationResult.errors.length > 0) {
                    showValidationResults(validationResult);
                    updateProgress(0, 'è³‡æ–™é©—è­‰å¤±æ•—');
                    showMessage('âŒ å·¥æ™‚è¡¨é©—è­‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ ¼å¼ä¸¦é‡è©¦ã€‚', 'error');
                    return;
                }
                
                updateProgress(60, 'æª¢æŸ¥è³‡æ–™è¡çª...');
                
                const conflicts = checkForConflicts(parsed);
                
                if (conflicts.length > 0) {
                    showConflictDialog(parsed, conflicts);
                } else {
                    await processTimesheetData(parsed);
                }
                
            } catch (error) {
                showMessage('è®€å–å·¥æ™‚è¡¨æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message, 'error');
                updateProgress(0, 'è¼‰å…¥å¤±æ•—');
                console.error('File handling error:', error);
            } finally {
                setButtonLoading('upload-file-btn', false, 'é¸æ“‡å·¥æ™‚è¡¨æ–‡ä»¶');
                document.getElementById('timesheet-file').value = ''; // Clear the file input
            }
        }
        
        // é©—è­‰å·¥æ™‚è¡¨è³‡æ–™
        function validateTimesheetData(data) {
            const result = {
                success: [],
                warnings: [],
                errors: []
            };
            
            if (data.length === 0) {
                result.errors.push('æ–‡ä»¶ç‚ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹ç¢ºä¿ CSV åŒ…å«æ•¸æ“šè¡Œã€‚');
                return result;
            }
            
            const requiredFields = ['Payroll ID', 'First Name', 'Last Name', 'Work Week', 'Hours'];
            const headers = Object.keys(data[0] || {}); // Ensure data[0] exists
            
            for (const field of requiredFields) {
                if (!headers.includes(field)) {
                    result.errors.push(`ç¼ºå°‘å¿…è¦æ¬„ä½: ${field}ã€‚è«‹æª¢æŸ¥ CSV æ¨™é¡Œè¡Œã€‚`);
                }
            }
            
            if (result.errors.length > 0) {
                return result;
            }
            
            const employeeConsistency = {};
            let validRecords = 0;
            let skippedEmptyRecords = 0;
            
            data.forEach((row, index) => {
                const payrollId = row['Payroll ID']?.trim();
                const firstName = row['First Name']?.trim();
                const lastName = row['Last Name']?.trim();
                const workWeek = row['Work Week']?.trim();
                const hours = parseFloat(row['Hours']);
                
                // å¦‚æœæ•´è¡Œéƒ½æ˜¯ç©ºçš„ï¼Œè·³éä½†ä¸å ±éŒ¯ (æ›´åš´è¬¹çš„ç©ºè¡Œåˆ¤æ–·)
                if (!payrollId && !firstName && !lastName && !workWeek && (isNaN(hours) || hours === 0) && !row['Start Date'] && !row['Level'] && !row['Rate'] && !row['Farm']) {
                    skippedEmptyRecords++;
                    return;
                }
                
                validRecords++;
                
                if (!validatePayrollID(payrollId)) {
                    result.errors.push(`ç¬¬${index + 2}è¡Œ: Payroll ID æ ¼å¼éŒ¯èª¤ (${payrollId || 'ç©º'})ï¼Œæ‡‰ç‚º EQ-0001 æ ¼å¼ã€‚`);
                } else if (!payrollId) { // This condition is now redundant if validatePayrollID is robust
                    result.errors.push(`ç¬¬${index + 2}è¡Œ: Payroll ID ç‚ºç©ºã€‚`);
                }
                
                if (!firstName || !lastName) {
                    result.warnings.push(`ç¬¬${index + 2}è¡Œ: å“¡å·¥ ${payrollId || ''} çš„å§“åè³‡æ–™ä¸å®Œæ•´ã€‚`);
                }
                
                if (!workWeek) {
                    result.errors.push(`ç¬¬${index + 2}è¡Œ: Work Week ç‚ºç©ºã€‚`);
                } else if (isNaN(parseDate(workWeek)?.getTime())) {
                    result.errors.push(`ç¬¬${index + 2}è¡Œ: Work Week æ—¥æœŸæ ¼å¼éŒ¯èª¤ (${workWeek})ï¼Œè«‹ä½¿ç”¨YYYY-MM-DD æ ¼å¼ã€‚`);
                }

                if (!row['Start Date'] || isNaN(parseDate(row['Start Date'])?.getTime())) {
                    result.warnings.push(`ç¬¬${index + 2}è¡Œ: Start Date æ—¥æœŸæ ¼å¼éŒ¯èª¤æˆ–ç‚ºç©º (${row['Start Date'] || 'ç©º'})ï¼Œå°‡ä½¿ç”¨é è¨­æ—¥æœŸã€‚`);
                }
                
                if (isNaN(hours) || hours < 0) {
                    result.errors.push(`ç¬¬${index + 2}è¡Œ: å·¥æ™‚è³‡æ–™ç„¡æ•ˆ (${row['Hours'] || 'ç©º'})ï¼Œå¿…é ˆæ˜¯æ­£æ•¸ã€‚`);
                }
                
                if (hours > 168) {
                    result.warnings.push(`ç¬¬${index + 2}è¡Œ: å“¡å·¥ ${payrollId || ''} åœ¨ ${workWeek || ''} çš„å·¥æ™‚è¶…éä¸€é€±168å°æ™‚ (${hours}h)ï¼Œè«‹ç¢ºèªã€‚`);
                }
                
                if (payrollId && validatePayrollID(payrollId)) {
                    if (!employeeConsistency[payrollId]) {
                        employeeConsistency[payrollId] = {
                            firstName: firstName,
                            lastName: lastName,
                            startDate: row['Start Date'],
                            level: row['Level'],
                            rate: row['Rate'],
                            farm: row['Farm']
                        };
                    } else {
                        const existing = employeeConsistency[payrollId];
                        // Warn if names are inconsistent
                        if (existing.firstName !== firstName || existing.lastName !== lastName) {
                            result.warnings.push(`ç¬¬${index + 2}è¡Œ: å“¡å·¥ ${payrollId} çš„å§“å (${firstName} ${lastName}) èˆ‡å…ˆå‰è¨˜éŒ„ (${existing.firstName} ${existing.lastName}) ä¸ä¸€è‡´ï¼Œå°‡ä»¥æœ€æ–°è¨˜éŒ„ç‚ºæº–ã€‚`);
                        }
                        // Warn if start date, level, rate, farm are inconsistent but only if payrollId is the same
                        // For simplicity, we just take the latest from the CSV rows if they differ, as per requirement
                    }
                }
            });
            
            if (result.errors.length === 0) {
                result.success.push(`âœ… æˆåŠŸé©—è­‰ ${validRecords} ç­†å·¥æ™‚è¨˜éŒ„`);
                result.success.push(`ğŸ‘¥ æ¶‰åŠ ${Object.keys(employeeConsistency).length} ä½å“¡å·¥`);
                
                if (skippedEmptyRecords > 0) {
                    result.warnings.push(`âš ï¸ å·²è‡ªå‹•è·³é ${skippedEmptyRecords} è¡Œç©ºç™½è¨˜éŒ„ã€‚`);
                }
            }
            
            return result;
        }
        
        // æª¢æŸ¥è³‡æ–™è¡çªï¼ˆå„ªåŒ–ç‰ˆæœ¬ - ä½¿ç”¨å¿«é€ŸæŸ¥æ‰¾ï¼‰
        function checkForConflicts(newData) {
            const conflicts = [];
            
            // å»ºç«‹ç¾æœ‰è³‡æ–™çš„å¿«é€ŸæŸ¥æ‰¾è¡¨
            const existingDataMap = new Map();
            timesheetData.forEach(item => {
                existingDataMap.set(`${item.payrollId}-${item.workWeekDate}`, item.hours);
            });
            
            // å¿«é€Ÿæª¢æŸ¥è¡çª
            newData.forEach(row => {
                const payrollId = row['Payroll ID']?.trim();
                const workWeekDate = row['Work Week']?.trim();
                
                if (payrollId && workWeekDate) { // Only check if critical fields exist
                    const key = `${payrollId}-${workWeekDate}`;
                    const existingHours = existingDataMap.get(key);
                    
                    if (existingHours !== undefined) { // Found a record for this payrollId and workWeekDate
                        const newHours = parseFloat(row['Hours']) || 0;
                        if (existingHours !== newHours) { // Conflict only if hours differ
                            conflicts.push({
                                payrollId: payrollId,
                                workWeekDate: workWeekDate,
                                existingHours: existingHours,
                                newHours: newHours,
                                employeeName: `${row['First Name']} ${row['Last Name']}`.trim()
                            });
                        }
                    }
                }
            });
            
            return conflicts;
        }
        
        // é¡¯ç¤ºè¡çªå°è©±æ¡†
        function showConflictDialog(newData, conflicts) {
            const dialog = document.createElement('div');
            dialog.className = 'confirm-dialog active'; // Add active class
            
            const conflictCount = conflicts.length;
            const sampleConflicts = conflicts.slice(0, 5); // åªé¡¯ç¤ºå‰5å€‹è¡çª
            
            let conflictsList = '';
            sampleConflicts.forEach(conflict => {
                conflictsList += `
                    <div class="validation-warning" style="margin-bottom: 5px;">
                        <strong>${conflict.employeeName}</strong> (${conflict.payrollId}) - ${conflict.workWeekDate}
                        <br>ç¾æœ‰å·¥æ™‚: <span class="highlight">${conflict.existingHours}h</span> â†’ æ–°å·¥æ™‚: <span class="highlight">${conflict.newHours}h</span>
                    </div>
                `;
            });
            
            if (conflictCount > 5) {
                conflictsList += `<div class="validation-warning" style="margin-top: 10px;">...é‚„æœ‰ ${conflictCount - 5} å€‹è¡çªæœªé¡¯ç¤º</div>`;
            }
            
            dialog.innerHTML = `
                <div class="confirm-content">
                    <h3>âš ï¸ ç™¼ç¾ ${conflictCount} å€‹è³‡æ–™è¡çª</h3>
                    <p>ä»¥ä¸‹å·¥æ™‚è³‡æ–™å·²å­˜åœ¨ä¸”å·¥æ™‚æ•¸å€¼ä¸åŒï¼Œæ˜¯å¦è¦ç”¨æ–°ä¸Šå‚³çš„è³‡æ–™è¦†è“‹ï¼Ÿ</p>
                    ${conflictsList}
                    <div class="confirm-buttons">
                        <button class="btn-confirm" onclick="confirmOverwrite(true)">è¦†è“‹ä¸¦æ›´æ–°</button>
                        <button class="btn-cancel" onclick="confirmOverwrite(false)">å–æ¶ˆä¸Šå‚³</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(dialog);
            pendingData = newData; // Store data for later processing
        }
        
        // ç¢ºèªè¦†è“‹
        async function confirmOverwrite(confirmed) {
            closeCreateDialog(); // Use the general dialog closing function
            
            if (confirmed && pendingData) {
                await processTimesheetData(pendingData, true); // Pass true for overwrite
            } else {
                updateProgress(0, 'ä¸Šå‚³å·²å–æ¶ˆ');
                showMessage('â„¹ï¸ è³‡æ–™ä¸Šå‚³å·²å–æ¶ˆã€‚', 'info');
            }
            
            pendingData = null; // Clear pending data
        }
        
        // è™•ç†å·¥æ™‚è¡¨è³‡æ–™ (ä¿®æ­£ `summary.weeks` å’Œ `calculatePayroll` èª¿ç”¨)
        async function processTimesheetData(data, overwrite = false) {
            updateProgress(10, 'é–‹å§‹è™•ç†è³‡æ–™...');
            
            const uploadSummary = {
                totalRecords: data.length,
                employees: new Set(),
                newRecords: 0,
                updatedRecords: 0,
                weeks: new Set() // <-- FIX: Initialize weeks as a Set
            };
            
            updateProgress(20, 'æª¢æŸ¥é‡è¤‡è³‡æ–™...');
            
            // ç°¡å–®çš„é‡è¤‡æª¢æŸ¥
            const existingKeys = new Set(timesheetData.map(item => `${item.payrollId}-${item.workWeekDate}`));
            
            updateProgress(30, 'è™•ç†æ–°è³‡æ–™...');
            
            // é€ç­†è™•ç†
            for (let i = 0; i < data.length; i++) {
                const row = data[i];
                const payrollId = row['Payroll ID']?.trim();
                const firstName = row['First Name']?.trim();
                const lastName = row['Last Name']?.trim();
                const startDateStr = row['Start Date']?.trim();
                const workWeekDate = row['Work Week']?.trim();
                const hours = parseFloat(row['Hours']) || 0;
                const level = row['Level']?.trim();
                const rate = parseRate(row['Rate']);
                const farm = row['Farm']?.trim();

                // Skip processing if no valid Payroll ID or Work Week
                if (!validatePayrollID(payrollId) || !workWeekDate || isNaN(parseDate(workWeekDate)?.getTime())) {
                    // This data row will be ignored from processing, but validation should catch it before this point.
                    // For robustness, ensure basic data validity.
                    continue; 
                }
                
                uploadSummary.employees.add(payrollId);
                uploadSummary.weeks.add(workWeekDate); // <-- FIX: Add work week to the set
                
                // Establish a consistent startDate for the employee
                let employeeStartDate = '2024-01-01'; // Default if not provided
                if (startDateStr) {
                    const parsedStartDate = parseDate(startDateStr);
                    if (parsedStartDate && !isNaN(parsedStartDate.getTime())) {
                        employeeStartDate = parsedStartDate.toISOString().slice(0, 10);
                    }
                }

                // Create or update employee data
                if (!employees[payrollId]) {
                    employees[payrollId] = {
                        payrollId,
                        firstName,
                        lastName,
                        startDate: employeeStartDate, // Use the determined start date
                        level: level || '',
                        farm: farm || '',
                        hourlyRate: rate,
                        workWeeks: {}, // Stores workWeekDate -> hours
                        totalHours: 0,
                        payrollData: { regularHours: 0, overtimeHours: 0, regularPay: 0, overtimePay: 0 }
                    };
                } else {
                    // Update employee details with the latest from CSV if provided and valid
                    // Ensure name consistency (already warned in validation)
                    employees[payrollId].firstName = firstName;
                    employees[payrollId].lastName = lastName;
                    if (startDateStr) { // Only update if a valid startDate is provided in the CSV
                         const newParsedStartDate = parseDate(startDateStr);
                         if(newParsedStartDate && !isNaN(newParsedStartDate.getTime())) {
                            // Only update start date if the new one is earlier or significantly different (logic depends on business rules)
                            // For simplicity, let's say the first valid one or the one with content overrides default.
                            // Or, if new one is earlier, keep new one.
                            const currentStartDate = parseDate(employees[payrollId].startDate);
                            if (!currentStartDate || newParsedStartDate.getTime() < currentStartDate.getTime()) {
                                employees[payrollId].startDate = newParsedStartDate.toISOString().slice(0, 10);
                            }
                         }
                    }
                    if (farm) employees[payrollId].farm = farm;
                    if (level) employees[payrollId].level = level;
                    if (rate) employees[payrollId].hourlyRate = rate;
                }
                
                // Update work week hours
                const currentRecordIndex = timesheetData.findIndex(item => 
                    item.payrollId === payrollId && item.workWeekDate === workWeekDate
                );

                if (currentRecordIndex !== -1) {
                    // Record exists
                    if (overwrite || timesheetData[currentRecordIndex].hours !== hours) {
                        timesheetData[currentRecordIndex].hours = hours;
                        timesheetData[currentRecordIndex].uploadDate = new Date().toISOString();
                        uploadSummary.updatedRecords++;
                    }
                } else {
                    // New record
                    timesheetData.push({
                        payrollId,
                        firstName,
                        lastName,
                        workWeekDate,
                        hours,
                        uploadDate: new Date().toISOString()
                    });
                    uploadSummary.newRecords++;
                }
                
                // Update progress
                const progress = 30 + ((i + 1) / data.length) * 50; // 30-80%
                updateProgress(progress, `è™•ç†ä¸­... ${i + 1}/${data.length}`);
                
                // æ¯è™•ç† 5 ç­†å°±è®“å‡ºæ§åˆ¶æ¬Š
                if (i % 5 === 0) {
                    await new Promise(resolve => setTimeout(resolve, 1));
                }
            }
            
            updateProgress(85, 'è¨ˆç®—å·¥æ™‚ç¸½è¨ˆ...');
            
            // è¨ˆç®—æ¯å€‹å“¡å·¥çš„ç¸½å·¥æ™‚å’Œè–ªè³‡
            Object.values(employees).forEach(employee => {
                employee.totalHours = Object.entries(employee.workWeeks)
                                       .filter(([weekDate, hours]) => {
                                           // Only sum up hours from valid work weeks in timesheetData
                                           // This ensures consistency even if workWeeks map has old entries
                                           return timesheetData.some(item => item.payrollId === employee.payrollId && item.workWeekDate === weekDate);
                                       })
                                       .reduce((sum, [, hours]) => sum + hours, 0);
                
                // Re-calculate workWeeks based on filtered timesheetData
                employee.workWeeks = timesheetData
                                        .filter(item => item.payrollId === employee.payrollId)
                                        .reduce((acc, item) => {
                                            acc[item.workWeekDate] = item.hours;
                                            return acc;
                                        }, {});

                calculatePayroll(employee); // <-- FIX: Ensure this is called to update payrollData
            });
            
            updateProgress(90, 'å„²å­˜è³‡æ–™...');
            saveLocalData();
            
            try {
                if (isGitHubConnected) {
                    updateProgress(95, 'æ¨é€åˆ° GitHub...');
                    await uploadToGitHub();
                }
            } catch (error) {
                console.error('GitHub ä¸Šå‚³å¤±æ•—:', error);
                showMessage(`âŒ è‡ªå‹•åŒæ­¥åˆ° GitHub å¤±æ•—: ${error.message}<br>æ•¸æ“šå·²å„²å­˜åœ¨æœ¬åœ°ï¼Œè«‹å˜—è©¦æ‰‹å‹•åŒæ­¥ã€‚`, 'error', 15000); // Longer error message for critical sync failure
            }
            
            updateProgress(100, 'å®Œæˆï¼');
            
            // é¡¯ç¤ºçµæœ
            showUploadSummary(uploadSummary);
            updateAllTables();
            
            showMessage(`
                âœ… ä¸Šå‚³æˆåŠŸï¼<br>
                ğŸ“Š è™•ç† ${uploadSummary.totalRecords} ç­†è¨˜éŒ„<br>
                ğŸ‘¥ æ¶‰åŠ ${uploadSummary.employees.size} ä½å“¡å·¥<br>
                â• æ–°å¢ ${uploadSummary.newRecords} ç­†ï¼Œæ›´æ–° ${uploadSummary.updatedRecords} ç­†
            `);
        }
        
        // è¨ˆç®—è–ªè³‡
        function calculatePayroll(employee) {
            const totalHours = employee.totalHours;
            const hourlyRate = employee.hourlyRate || 0; // Default to 0 if not set
            
            if (totalHours > REGULAR_HOURS_THRESHOLD) {
                employee.payrollData.regularHours = REGULAR_HOURS_THRESHOLD;
                employee.payrollData.overtimeHours = totalHours - REGULAR_HOURS_THRESHOLD;
                employee.payrollData.regularPay = REGULAR_HOURS_THRESHOLD * hourlyRate;
                // Assuming overtime pay is calculated at regular rate as per original code.
                // If overtime rate is different, this needs modification.
                employee.payrollData.overtimePay = employee.payrollData.overtimeHours * hourlyRate; 
            } else {
                employee.payrollData.regularHours = totalHours;
                employee.payrollData.overtimeHours = 0;
                employee.payrollData.regularPay = totalHours * hourlyRate;
                employee.payrollData.overtimePay = 0;
            }
        }
        
        // å–å¾—ç¯©é¸å¾Œçš„å“¡å·¥åˆ—è¡¨
        function getFilteredEmployees() {
            const farmFilter = document.getElementById('farm-filter')?.value || '';
            const levelFilter = document.getElementById('level-filter')?.value || '';
            const statusFilter = document.getElementById('status-filter')?.value || '';
            
            return Object.values(employees).filter(employee => {
                // Farm filter
                if (farmFilter && employee.farm !== farmFilter) return false;
                
                // Level filter
                if (levelFilter && employee.level !== levelFilter) return false;
                
                // Status filter
                if (statusFilter) {
                    const cycleInfo = calculateEmployeeCycle(employee, new Date()); // Pass current date
                    if (statusFilter === 'overtime' && employee.totalHours <= REGULAR_HOURS_THRESHOLD) return false;
                    if (statusFilter === 'active' && (employee.totalHours > REGULAR_HOURS_THRESHOLD || cycleInfo.status !== 'active')) return false;
                    if (statusFilter === 'complete' && cycleInfo.status !== 'complete') return false;
                    if (statusFilter === 'pending' && cycleInfo.status !== 'pending') return false; // Added pending filter
                }
                
                return true;
            });
        }
        
        // æ›´æ–°ç¯©é¸å™¨é¸é …
        function updateFilterOptions() {
            const farmFilter = document.getElementById('farm-filter');
            const levelFilter = document.getElementById('level-filter');
            
            if (!farmFilter || !levelFilter) return;
            
            // æ”¶é›†æ‰€æœ‰è¾²å ´å’Œè·ç´š
            const farms = new Set();
            const levels = new Set();
            
            Object.values(employees).forEach(employee => {
                if (employee.farm) farms.add(employee.farm);
                if (employee.level) levels.add(employee.level);
            });
            
            // æ›´æ–°è¾²å ´ç¯©é¸å™¨
            const currentFarm = farmFilter.value;
            farmFilter.innerHTML = '<option value="">æ‰€æœ‰è¾²å ´</option>';
            [...farms].sort().forEach(farm => {
                const option = document.createElement('option');
                option.value = farm;
                option.textContent = farm;
                if (farm === currentFarm) option.selected = true;
                farmFilter.appendChild(option);
            });
            
            // æ›´æ–°è·ç´šç¯©é¸å™¨
            const currentLevel = levelFilter.value;
            levelFilter.innerHTML = '<option value="">æ‰€æœ‰è·ç´š</option>';
            [...levels].sort().forEach(level => {
                const option = document.createElement('option');
                option.value = level;
                option.textContent = level;
                if (level === currentLevel) option.selected = true;
                levelFilter.appendChild(option);
            });
        }
        
        // æ¸…é™¤ç¯©é¸
        function clearFilters() {
            document.getElementById('farm-filter').value = '';
            document.getElementById('level-filter').value = '';
            document.getElementById('status-filter').value = '';
            updateAllTables();
        }
        
        // æ›´æ–°å“¡å·¥ç¸½è¦½
        function updateOverviewTable() {
            const container = document.getElementById('overview-table-container');
            
            if (Object.keys(employees).length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #777; margin-top: 30px;">å°šæœªè¼‰å…¥å“¡å·¥è³‡æ–™ï¼Œè«‹å…ˆä¸Šå‚³å·¥æ™‚è¡¨æˆ–å¾ GitHub åŒæ­¥ã€‚</p>';
                document.getElementById('overview-summary-cards').innerHTML = ''; // Clear summary cards
                return;
            }
            
            updateFilterOptions();
            const filteredEmployees = getFilteredEmployees();
            
            if (filteredEmployees.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #777; margin-top: 30px;">æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„å“¡å·¥è³‡æ–™ã€‚</p>';
                document.getElementById('overview-summary-cards').innerHTML = ''; // Clear summary cards
                return;
            }

            let tableHTML = `
                <table class="employee-table">
                    <thead>
                        <tr>
                            <th>å“¡å·¥ç·¨è™Ÿ</th>
                            <th>å§“å</th>
                            <th>è¾²å ´</th>
                            <th>è·ç´š</th>
                            <th>é–‹å§‹æ—¥æœŸ</th>
                            <th>ç•¶å‰é€±æœŸ</th>
                            <th>é€±æœŸé€²åº¦</th>
                            <th>é€±æœŸç‹€æ…‹</th>
                            <th>ç¸½å·¥æ™‚</th>
                            <th>å‰©é¤˜é¡åº¦</th>
                            <th>é è¨ˆçµæŸ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // è¨ˆç®—çµ±è¨ˆ
            let activeCycles = 0;
            let completeCycles = 0;
            let overtimeCycles = 0;
            let pendingCycles = 0; // Count for pending cycles
            
            filteredEmployees
                .sort((a, b) => a.payrollId.localeCompare(b.payrollId))
                .forEach(employee => {
                    const fullName = `${employee.firstName} ${employee.lastName}`.trim();
                    const cycleInfo = calculateEmployeeCycle(employee, new Date());
                    
                    // çµ±è¨ˆé€±æœŸç‹€æ…‹
                    if (employee.totalHours > REGULAR_HOURS_THRESHOLD) {
                        overtimeCycles++;
                    } else if (cycleInfo.status === 'complete') {
                        completeCycles++;
                    } else if (cycleInfo.status === 'pending') {
                        pendingCycles++;
                    }
                    else {
                        activeCycles++;
                    }
                    
                    // ç‹€æ…‹é¡¯ç¤º
                    let statusClass = 'cycle-active';
                    let statusText = 'é€²è¡Œä¸­';
                    
                    if (employee.totalHours > REGULAR_HOURS_THRESHOLD) {
                        statusClass = 'cycle-overtime';
                        statusText = 'éœ€åŠ ç­è²»';
                    } else if (cycleInfo.status === 'complete') {
                        statusClass = 'cycle-complete';
                        statusText = 'å·²å®Œæˆ';
                    } else if (cycleInfo.status === 'pending') {
                        statusClass = 'cycle-pending';
                        statusText = 'æœªé–‹å§‹';
                    }
                    
                    // å‰©é¤˜å·¥æ™‚é¡åº¦
                    const remainingHours = Math.max(0, REGULAR_HOURS_THRESHOLD - employee.totalHours);
                    const remainingText = employee.totalHours > REGULAR_HOURS_THRESHOLD ? 
                        `è¶…å‡º ${employee.totalHours - REGULAR_HOURS_THRESHOLD}h` : 
                        `å‰©é¤˜ ${remainingHours}h`;
                    
                    // é€±æœŸé€²åº¦æ¢
                    const progressPercentage = cycleInfo.progressPercentage;
                    const progressClass = employee.totalHours > REGULAR_HOURS_THRESHOLD ? 'cycle-progress-overtime' : '';
                    
                    tableHTML += `
                        <tr>
                            <td><strong>${employee.payrollId}</strong></td>
                            <td>${fullName}</td>
                            <td>${employee.farm || '-'}</td>
                            <td>${employee.level || '-'}</td>
                            <td>${employee.startDate || '-'}</td>
                            <td>ç¬¬ ${cycleInfo.currentCycle} é€±æœŸ<br><small>ç¬¬ ${cycleInfo.weekInCycle}/${WEEKS_PER_CYCLE} é€±</small></td>
                            <td>
                                <div class="cycle-progress">
                                    <div class="cycle-progress-fill ${progressClass}" style="width: ${progressPercentage}%"></div>
                                </div>
                                <small>${progressPercentage.toFixed(1)}% å®Œæˆ</small>
                            </td>
                            <td><span class="cycle-status ${statusClass}">${statusText}</span></td>
                            <td><strong>${employee.totalHours}h</strong></td>
                            <td>${remainingText}</td>
                            <td>${cycleInfo.cycleEndDate.toLocaleDateString('zh-TW')}</td>
                        </tr>
                    `;
                });
            
            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
            
            // æ›´æ–°æ‘˜è¦å¡ç‰‡
            const totalFiltered = filteredEmployees.length;
            const summaryHTML = `
                <div class="summary-card">
                    <h3>${totalFiltered}</h3>
                    <p>ç¯©é¸å¾Œå“¡å·¥æ•¸</p>
                </div>
                <div class="summary-card">
                    <h3>${activeCycles}</h3>
                    <p>é€²è¡Œä¸­é€±æœŸ</p>
                </div>
                <div class="summary-card">
                    <h3>${overtimeCycles}</h3>
                    <p>éœ€åŠ ç­è²»é€±æœŸ</p>
                </div>
                <div class="summary-card">
                    <h3>${completeCycles}</h3>
                    <p>å·²å®Œæˆé€±æœŸ</p>
                </div>
                <div class="summary-card">
                    <h3>${pendingCycles}</h3>
                    <p>æœªé–‹å§‹é€±æœŸ</p>
                </div>
            `;
            document.getElementById('overview-summary-cards').innerHTML = summaryHTML;
        }
        
        // åŒ¯å‡ºå“¡å·¥ç¸½è¦½å ±å‘Š
        async function exportOverview() {
            if (Object.keys(employees).length === 0) {
                showMessage('æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡º', 'error');
                return;
            }
            
            setButtonLoading('exportOverview', true, 'åŒ¯å‡ºä¸­...'); // Assuming an ID for the button
            
            try {
                const filteredEmployees = getFilteredEmployees();
                let csvContent = 'å“¡å·¥ç·¨è™Ÿ,å§“å,è¾²å ´,è·ç´š,é–‹å§‹æ—¥æœŸ,ç•¶å‰é€±æœŸ,é€±æœŸå…§é€±æ•¸,é€±æœŸç‹€æ…‹,ç¸½å·¥æ™‚,å‰©é¤˜é¡åº¦,é€±æœŸé–‹å§‹æ—¥,é€±æœŸçµæŸæ—¥,é€²åº¦ç™¾åˆ†æ¯”\n';
                
                filteredEmployees.forEach(employee => {
                    const fullName = `${employee.firstName} ${employee.lastName}`.trim();
                    const cycleInfo = calculateEmployeeCycle(employee, new Date());
                    
                    let statusText = 'é€²è¡Œä¸­';
                    if (employee.totalHours > REGULAR_HOURS_THRESHOLD) statusText = 'éœ€åŠ ç­è²»';
                    else if (cycleInfo.status === 'complete') statusText = 'å·²å®Œæˆ';
                    else if (cycleInfo.status === 'pending') statusText = 'æœªé–‹å§‹';
                    
                    const remainingHours = Math.max(0, REGULAR_HOURS_THRESHOLD - employee.totalHours);
                    const remainingText = employee.totalHours > REGULAR_HOURS_THRESHOLD ? 
                        `è¶…å‡º${employee.totalHours - REGULAR_HOURS_THRESHOLD}å°æ™‚` : 
                        `å‰©é¤˜${remainingHours}å°æ™‚`;
                    
                    csvContent += `${employee.payrollId},"${fullName}",${employee.farm || ''},${employee.level || ''},${employee.startDate || ''},${cycleInfo.currentCycle},${cycleInfo.weekInCycle},${statusText},${employee.totalHours},"${remainingText}",${cycleInfo.cycleStartDate.toLocaleDateString('zh-TW')},${cycleInfo.cycleEndDate.toLocaleDateString('zh-TW')},${cycleInfo.progressPercentage.toFixed(1)}%\n`;
                });
                
                downloadCSV(csvContent, `å“¡å·¥ç¸½è¦½å ±å‘Š_${new Date().toISOString().split('T')[0]}.csv`);
                showMessage('âœ… å“¡å·¥ç¸½è¦½å ±å‘Šå·²åŒ¯å‡º');
            } catch (error) {
                showMessage(`âŒ åŒ¯å‡ºå¤±æ•—: ${error.message}`, 'error');
                console.error("Export Overview failed:", error);
            } finally {
                setButtonLoading('exportOverview', false, 'ğŸ“¥ åŒ¯å‡ºå“¡å·¥ç¸½è¦½å ±å‘Š (CSV)');
            }
        }
        
        // é¡¯ç¤ºä¸Šå‚³æ‘˜è¦
        function showUploadSummary(summary) {
            const container = document.getElementById('timesheet-file-info');
            container.style.display = 'block';
            container.className = 'upload-summary';
            
            // Format weeks for display
            const sortedWeeks = Array.from(summary.weeks).sort();
            const weeksDisplay = sortedWeeks.length > 0 ? sortedWeeks.join(', ') : 'ç„¡';

            container.innerHTML = `
                <h3>ğŸ“Š ä¸Šå‚³æ‘˜è¦</h3>
                <div class="summary-item">
                    <span>ç¸½è¨˜éŒ„æ•¸ï¼š</span>
                    <span class="highlight">${summary.totalRecords}</span>
                </div>
                <div class="summary-item">
                    <span>å“¡å·¥æ•¸é‡ï¼š</span>
                    <span class="highlight">${summary.employees.size}</span>
                </div>
                <div class="summary-item">
                    <span>æ¶µè“‹é€±æ•¸ï¼š</span>
                    <span>${weeksDisplay}</span>
                </div>
                <div class="summary-item">
                    <span>æ–°å¢è¨˜éŒ„ï¼š</span>
                    <span class="highlight">${summary.newRecords}</span>
                </div>
                <div class="summary-item">
                    <span>æ›´æ–°è¨˜éŒ„ï¼š</span>
                    <span class="highlight">${summary.updatedRecords}</span>
                </div>
                <div class="summary-item">
                    <span>ä¸Šå‚³æ™‚é–“ï¼š</span>
                    <span>${new Date().toLocaleString('zh-TW')}</span>
                </div>
                <div class="summary-item">
                    <span>åŒæ­¥ç‹€æ…‹ï¼š</span>
                    <span class="highlight">${isGitHubConnected ? 'å·²åŒæ­¥åˆ° GitHub' : 'æœªé€£æ¥ GitHub (åƒ…æœ¬åœ°è¨˜æ†¶é«”)'}</span>
                </div>
            `;
        }
        
        // é¡¯ç¤ºé©—è­‰çµæœ
        function showValidationResults(result) {
            const container = document.getElementById('validation-results');
            
            let html = '';
            
            result.success.forEach(msg => {
                html += `<div class="validation-item validation-success">âœ… ${msg}</div>`;
            });
            
            result.warnings.forEach(msg => {
                html += `<div class="validation-item validation-warning">âš ï¸ ${msg}</div>`;
            });
            
            result.errors.forEach(msg => {
                html += `<div class="validation-item validation-error">âŒ ${msg}</div>`;
            });
            
            container.innerHTML = html;
        }
        
        // è®€å–æ–‡ä»¶
        async function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) { resolve(e.target.result); };
                reader.onerror = function() { reject(new Error('æ–‡ä»¶è®€å–å¤±æ•—')); };
                reader.readAsText(file, 'UTF-8');
            });
        }
        
        // è§£æCSV (åŠ å¼·äº†å°å¼•è™Ÿå…§é€—è™Ÿå’Œç©ºè¡Œçš„è™•ç†)
        function parseCSV(csvText) {
            const lines = csvText.trim().split(/\r?\n/); // Handle both \n and \r\n line endings
            if (lines.length === 0) return [];

            // Robust header parsing
            const headerLine = lines[0];
            const headers = parseCSVLine(headerLine);
            
            return lines.slice(1)
                .map(line => parseCSVLine(line))
                .filter(values => {
                    // Filter out truly empty lines where all values are empty
                    return values.some(val => val.trim() !== '');
                })
                .map(values => {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] !== undefined ? values[index] : '';
                    });
                    return row;
                })
                .filter(row => {
                    // Final filter: ensure at least some key data exists
                    const payrollId = row['Payroll ID']?.trim();
                    const firstName = row['First Name']?.trim();
                    const lastName = row['Last Name']?.trim();
                    const workWeek = row['Work Week']?.trim();
                    const hours = parseFloat(row['Hours']);
                    return payrollId || firstName || lastName || workWeek || !isNaN(hours);
                });
        }

        // Helper function to parse a single CSV line, handling quoted commas
        function parseCSVLine(line) {
            const values = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    if (inQuotes && i + 1 < line.length && line[i+1] === '"') {
                        // Handle escaped quote "" -> "
                        current += '"';
                        i++; // Skip the next quote
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    values.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            values.push(current.trim()); // Add the last value
            return values;
        }
        
        // æ›´æ–°æ‰€æœ‰è¡¨æ ¼
        function updateAllTables() {
            updateOverviewTable();
            updatePayrollTable();
        }
        
        // æ›´æ–°è–ªè³‡è¡¨æ ¼ï¼ˆç§»é™¤ç¸½è–ªè³‡æ¬„ä½ï¼‰
        function updatePayrollTable() {
            const container = document.getElementById('payroll-table-container');
            
            if (Object.keys(employees).length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #777; margin-top: 30px;">å°šæœªè¼‰å…¥å“¡å·¥è³‡æ–™ï¼Œè«‹å…ˆä¸Šå‚³å·¥æ™‚è¡¨æˆ–å¾ GitHub åŒæ­¥ã€‚</p>';
                document.getElementById('payroll-summary-cards').innerHTML = ''; // Clear summary cards
                return;
            }
            
            let tableHTML = `
                <table class="employee-table">
                    <thead>
                        <tr>
                            <th>å“¡å·¥ç·¨è™Ÿ</th>
                            <th>å§“å</th>
                            <th>è¾²å ´</th>
                            <th>è·ç´š</th>
                            <th>ç¸½å·¥æ™‚</th>
                            <th>æ­£å¸¸å·¥æ™‚</th>
                            <th>åŠ ç­å·¥æ™‚</th>
                            <th>æ™‚è–ª</th>
                            <th>åŠ ç­è²»</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            let totalOvertimePay = 0;
            let totalOvertimeHours = 0;
            
            Object.values(employees)
                .sort((a, b) => b.payrollData.overtimePay - a.payrollData.overtimePay)
                .forEach(employee => {
                    const fullName = `${employee.firstName} ${employee.lastName}`.trim();
                    
                    totalOvertimePay += employee.payrollData.overtimePay;
                    totalOvertimeHours += employee.payrollData.overtimeHours;
                    
                    const overtimeClass = employee.payrollData.overtimeHours > 0 ? 'status-overtime' : '';
                    
                    tableHTML += `
                        <tr>
                            <td><strong>${employee.payrollId}</strong></td>
                            <td>${fullName}</td>
                            <td>${employee.farm || '-'}</td>
                            <td>${employee.level || '-'}</td>
                            <td><strong>${employee.totalHours}h</strong></td>
                            <td>${employee.payrollData.regularHours}h</td>
                            <td class="${overtimeClass}">${employee.payrollData.overtimeHours}h</td>
                            <td>${employee.hourlyRate.toFixed(2)}</td>
                            <td class="money ${overtimeClass}"><strong>$${employee.payrollData.overtimePay.toFixed(2)}</strong></td>
                        </tr>
                    `;
                });
            
            tableHTML += `
                <tr style="background: #f0f0f0; font-weight: bold;">
                    <td colspan="5" style="text-align: right;">ç¸½è¨ˆ</td>
                    <td>-</td>
                    <td class="status-overtime">${totalOvertimeHours}h</td>
                    <td>-</td>
                    <td class="money status-overtime">$${totalOvertimePay.toFixed(2)}</td>
                </tr>
            `;
            
            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
            
            // æ›´æ–°è–ªè³‡æ‘˜è¦ï¼ˆåªé¡¯ç¤ºåŠ ç­è²»ç›¸é—œï¼‰
            const totalEmployees = Object.keys(employees).length;
            const overtimeEmployees = Object.values(employees).filter(emp => emp.payrollData.overtimeHours > 0).length;
            const avgOvertimePay = overtimeEmployees > 0 ? (totalOvertimePay / overtimeEmployees) : 0;
            
            const summaryHTML = `
                <div class="summary-card">
                    <h3>$${totalOvertimePay.toFixed(0)}</h3>
                    <p>ç¸½åŠ ç­è²»æ”¯å‡º</p>
                </div>
                <div class="summary-card">
                    <h3>${totalOvertimeHours}h</h3>
                    <p>ç¸½åŠ ç­å·¥æ™‚</p>
                </div>
                <div class="summary-card">
                    <h3>${overtimeEmployees} / ${totalEmployees}</h3>
                    <p>éœ€åŠ ç­è²»å“¡å·¥</p>
                </div>
                <div class="summary-card">
                    <h3>$${avgOvertimePay.toFixed(0)}</h3>
                    <p>å¹³å‡åŠ ç­è²» (æŒ‰äºº)</p>
                </div>
            `;
            document.getElementById('payroll-summary-cards').innerHTML = summaryHTML;
        }
        
        // åŒ¯å‡ºè–ªè³‡å ±è¡¨ï¼ˆåŠ ç­è²»å ±è¡¨ï¼‰
        async function exportPayroll() {
            if (Object.keys(employees).length === 0) {
                showMessage('æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡º', 'error');
                return;
            }
            
            setButtonLoading('exportPayroll', true, 'åŒ¯å‡ºä¸­...');
            
            try {
                const filteredEmployees = getFilteredEmployees();
                let csvContent = 'å“¡å·¥ç·¨è™Ÿ,å§“å,è¾²å ´,è·ç´š,ç¸½å·¥æ™‚,æ­£å¸¸å·¥æ™‚,åŠ ç­å·¥æ™‚,æ™‚è–ª,åŠ ç­è²»\n';
                
                filteredEmployees.forEach(employee => {
                    const fullName = `${employee.firstName} ${employee.lastName}`.trim();
                    
                    csvContent += `${employee.payrollId},"${fullName}",${employee.farm || ''},${employee.level || ''},${employee.totalHours},${employee.payrollData.regularHours},${employee.payrollData.overtimeHours},${employee.hourlyRate},${employee.payrollData.overtimePay.toFixed(2)}\n`;
                });
                
                downloadCSV(csvContent, `åŠ ç­è²»å ±è¡¨_${new Date().toISOString().split('T')[0]}.csv`);
                showMessage('âœ… åŠ ç­è²»å ±è¡¨å·²åŒ¯å‡º');
            } catch (error) {
                showMessage(`âŒ åŒ¯å‡ºå¤±æ•—: ${error.message}`, 'error');
                console.error("Export Payroll failed:", error);
            } finally {
                setButtonLoading('exportPayroll', false, 'ğŸ“¥ åŒ¯å‡ºè–ªè³‡å ±è¡¨ (CSV)');
            }
        }
        
        // ä¸‹è¼‰CSVæ–‡ä»¶
        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link); // Append to body for Firefox compatibility
            link.click();
            document.body.removeChild(link); // Clean up
        }
        
        // æ‹–æ‹½åŠŸèƒ½
        const uploadSection = document.getElementById('timesheet-upload');
        
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });
        
        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });
        
        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('timesheet-file').files = files;
                handleTimesheetFile({ target: { files } });
            }
        });
    </script>
</body>
</html>
