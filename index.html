<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥æ™‚ç®¡ç†ç³»çµ±</title>
    <style>
        /* General Styles */
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.08);
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 32px;
            font-weight: 600;
        }

        /* Message Styles */
        .success-message, .error-message, .warning-message {
            padding: 15px;
            border-radius: 5px;
            margin: 10px auto;
            border-left: 5px solid;
            opacity: 1;
            transition: opacity 0.5s ease;
            max-width: 95%;
        }
        .success-message { background: #e6ffe6; color: #006600; border-left-color: #006600; }
        .error-message { background: #ffe6e6; color: #cc0000; border-left-color: #cc0000; }
        .warning-message { background: #fff3cd; color: #856404; border-left-color: #ffc107; }
        .message-fadeout { opacity: 0; }

        /* Upload Section */
        .upload-section {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
            background: #f8f9ff;
            transition: all 0.3s ease;
        }
        .upload-section:hover { border-color: #764ba2; background: #f0f2ff; }
        .upload-section.dragover {
            border-color: #28a745;
            background: #e8f5e8;
            transform: scale(1.02);
        }

        .file-input { display: none; }

        .upload-btn, .action-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .upload-btn:hover, .action-btn:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        .upload-btn:disabled, .action-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }

        /* Data Management */
        .data-section {
            background: #f6f8fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }
        .data-section h3 { color: #333; margin: 0 0 15px 0; font-size: 22px; }
        .data-buttons { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin-top: 15px; }
        .btn-export { background: linear-gradient(45deg, #28a745, #20c997); }
        .btn-import { background: linear-gradient(45deg, #007bff, #6610f2); }
        .btn-clear { background: linear-gradient(45deg, #dc3545, #fd7e14); }

        /* Tabs */
        .tabs { display: flex; margin-bottom: 20px; border-bottom: 2px solid #eee; flex-wrap: wrap; justify-content: center; gap: 10px; }
        .tab { padding: 15px 20px; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s; min-width: 120px; text-align: center; font-weight: 500; color: #555; }
        .tab.active { border-bottom-color: #667eea; color: #667eea; font-weight: bold; background: #f0f2ff; }
        .tab:hover:not(.active) { background: #f8faff; color: #667eea; }
        .tab-content { display: none; padding-top: 10px; }
        .tab-content.active { display: block; }

        /* Tables */
        .employee-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; text-align: center; }
        .employee-table th, .employee-table td { border: 1px solid #ddd; padding: 10px 8px; text-align: center; vertical-align: middle; }
        .employee-table th { background: #667eea; color: white; font-size: 13px; text-transform: uppercase; }
        .employee-table tr.main-row:hover { background: #f0f2ff; }
        .toggle-details-btn { cursor: pointer; background: #6c757d; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-weight: bold; line-height: 24px; }
        .details-row { display: none; }
        .details-row.is-open { display: table-row; }
        .details-row td { background-color: #f8f9fa !important; padding: 15px !important; }
        .details-table { width: 100%; margin: 0 auto; border-collapse: collapse; }
        .details-table th, .details-table td { border: 1px solid #ccc; padding: 8px; text-align: center; background: white; }
        .details-table th { background: #6c757d; color: white; font-size: 12px; }

        /* Buttons in table */
        .btn-edit, .btn-delete, .btn-payment { border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px; margin: 0 2px; }
        .btn-edit { background: #007bff; color: white; }
        .btn-delete { background: #dc3545; color: white; }
        .btn-payment { background: #ffc107; color: #212529; font-weight: bold; }

        /* Status colors */
        .status-overtime { color: #ff4444; font-weight: bold; }
        .money { color: #28a745; font-weight: bold; }

        /* Progress Bar */
        .progress-bar { width: 100%; height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden; margin: 20px 0; }
        .progress-fill { height: 100%; background: linear-gradient(45deg, #667eea, #764ba2); width: 0%; transition: width 0.3s ease-out; }
        #progress-text { text-align: center; font-weight: 500; color: #555; margin-top: 5px; }

        /* Summary Cards */
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .summary-card { background: #fff; color: #333; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border-left: 5px solid #667eea; }
        .summary-card h3 { margin: 0 0 10px 0; font-size: 24px; font-weight: 700; color: #667eea; }
        .summary-card p { margin: 0; font-size: 14px; color: #555; }
        
        /* Format Info Box */
        .format-info { background: #e7f3ff; border: 1px solid #b3d9ff; border-radius: 5px; padding: 15px; margin: 15px 0; font-size: 14px; }
        .format-info h4 { margin: 0 0 10px 0; color: #0066cc; }
        .format-example { background: #f8f9fa; padding: 10px; border-radius: 5px; font-family: monospace; margin: 5px 0; white-space: pre-wrap; word-break: break-all; }

        /* Confirm Dialog */
        .confirm-dialog { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease; }
        .confirm-dialog.active { opacity: 1; visibility: visible; }
        .confirm-content { background: white; padding: 30px; border-radius: 15px; max-width: 600px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); transform: scale(0.9); transition: transform 0.3s ease; }
        .confirm-dialog.active .confirm-content { transform: scale(1); }
        .confirm-content h3 { margin-bottom: 15px; text-align: center; }
        .confirm-content p { margin-bottom: 20px; text-align: center; }
        .confirm-buttons { display: flex; gap: 15px; justify-content: center; margin-top: 20px; }
        .btn-confirm, .btn-cancel { border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-confirm { background: #28a745; color: white; }
        .btn-cancel { background: #dc3545; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š å·¥æ™‚ç®¡ç†ç³»çµ±</h1>
        <div style="text-align: center; margin-bottom: 20px;">
            <small>ğŸ”„ æœ¬åœ°å„²å­˜ | ğŸ“Š å³æ™‚è¨ˆç®— | ğŸ’¾ æª”æ¡ˆç®¡ç†</small>
        </div>
        
        <div class="data-section">
            <h3>ğŸ’¾ è³‡æ–™ç®¡ç†</h3>
            <p>æ‰€æœ‰è³‡æ–™å„²å­˜åœ¨æ‚¨çš„ç€è¦½å™¨ä¸­ï¼Œé—œé–‰åˆ†é å¾Œä¾ç„¶ä¿ç•™ã€‚</p>
            <div class="data-buttons">
                <button class="action-btn btn-export" onclick="exportAllData()">ğŸ“¤ åŒ¯å‡ºå®Œæ•´è³‡æ–™</button>
                <button class="action-btn btn-import" onclick="document.getElementById('data-import').click()">ğŸ“¥ åŒ¯å…¥è³‡æ–™æª”</button>
                <button class="action-btn btn-clear" onclick="clearAllData()">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
            </div>
            <input type="file" id="data-import" class="file-input" accept=".json" onchange="importData(event)">
            <div id="data-status" style="margin-top: 15px; padding: 10px; background: #e8f5e8; border-radius: 5px; font-size: 14px; display: none;">
                <strong>è³‡æ–™ç‹€æ…‹ï¼š</strong><span id="data-status-text"></span>
            </div>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('upload')">ğŸ“ è³‡æ–™ä¸Šå‚³</div>
            <div class="tab" onclick="switchTab('overview')">ğŸ‘¥ å“¡å·¥ç¸½è¦½èˆ‡è–ªè³‡</div>
        </div>
        
        <div id="upload-tab" class="tab-content active">
            <div class="format-info">
                <h4>ğŸ“Š CSV å·¥æ™‚è¡¨æ ¼å¼</h4>
                <div class="format-example">Payroll ID,First Name,Last Name,Monday of the Work Week,Hours,Level,Rate,Farm</div>
                <ul>
                    <li><b>Payroll ID</b>: å“¡å·¥ç·¨è™Ÿ (å¿…å¡«)</li>
                    <li><b>Monday of the Work Week</b>: å·¥ä½œé€±çš„é€±ä¸€ï¼Œæ ¼å¼ç‚º yyyy-MM-dd æˆ– dd/MM/yyyy (å¿…å¡«)</li>
                    <li>å…¶é¤˜æ¬„ä½ç‚ºé¸å¡«ï¼Œä¸Šå‚³æ™‚æœƒè‡ªå‹•æ›´æ–°å“¡å·¥è³‡æ–™ã€‚</li>
                </ul>
            </div>
            
            <div class="upload-section" id="timesheet-upload" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                <h3>ğŸ“‹ ä¸Šå‚³å·¥æ™‚è¡¨ (CSV)</h3>
                <p>ğŸ–±ï¸ é»æ“Šæˆ–æ‹–æ‹½æª”æ¡ˆåˆ°æ­¤è™•</p>
                <button class="upload-btn" onclick="document.getElementById('timesheet-file').click()">é¸æ“‡æª”æ¡ˆ</button>
                <input type="file" id="timesheet-file" class="file-input" accept=".csv" onchange="handleTimesheetFile(event)">
            </div>
            
            <div id="progress-container" style="display:none;">
                <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
                <p id="progress-text">ç­‰å¾…ä¸Šå‚³æ–‡ä»¶...</p>
            </div>
        </div>
        
        <div id="overview-tab" class="tab-content"> 
            <h2>ğŸ‘¥ å“¡å·¥ç¸½è¦½èˆ‡è–ªè³‡ç®¡ç†</h2>
            
            <div class="format-info">
                <h4>ğŸ” ç¯©é¸é¸é …</h4>
                <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                    <select id="farm-filter" onchange="updateAllTables()"><option value="">æ‰€æœ‰è¾²å ´</option></select>
                    <select id="level-filter" onchange="updateAllTables()"><option value="">æ‰€æœ‰è·ç´š</option></select>
                    <select id="employee-filter" onchange="updateAllTables()"><option value="">æ‰€æœ‰å“¡å·¥</option></select>
                    <select id="cycle-filter" onchange="updateAllTables()"><option value="">æ‰€æœ‰é€±æœŸ</option></select>
                    <button onclick="clearFilters()" style="padding: 8px 12px; background: #6c757d; color:white; border:none; border-radius: 5px; cursor:pointer;">æ¸…é™¤</button>
                </div>
            </div>
            
            <div id="cycle-summary-card" class="format-info" style="display: none;"></div>
            <div class="summary-cards" id="overview-summary-cards"></div>
            <div id="overview-table-container" style="overflow-x: auto;"></div>
        </div>
        
        <div id="messages" style="position: fixed; top: 20px; right: 20px; z-index: 2000; width: 300px;"></div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let employees = {};
        let timesheetData = [];
        let paymentHistory = {};
        
        // å¸¸æ•¸
        const REGULAR_HOURS_THRESHOLD = 304;
        const WEEKS_PER_CYCLE = 8;
        const SYSTEM_START_DATE = new Date(2025, 1, 10); // æœˆä»½æ˜¯ 0-11, æ‰€ä»¥ 1 ä»£è¡¨ 2 æœˆ

        // --- åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', () => {
            loadLocalData();
            updateAllTables();
            updateDataStatus();
        });

        function loadLocalData() {
            try {
                const storedEmployees = localStorage.getItem('employees');
                const storedTimesheet = localStorage.getItem('timesheetData');
                const storedPayments = localStorage.getItem('paymentHistory');
                if (storedEmployees) employees = JSON.parse(storedEmployees);
                if (storedTimesheet) timesheetData = JSON.parse(storedTimesheet);
                if (storedPayments) paymentHistory = JSON.parse(storedPayments);
            } catch (e) {
                showMessage('è®€å–æœ¬åœ°è³‡æ–™å¤±æ•—', 'error');
            }
        }

        // --- è³‡æ–™ç®¡ç† (å­˜/è®€/åŒ¯å‡º/åŒ¯å…¥/æ¸…é™¤) ---
        function saveLocalData() {
            try {
                localStorage.setItem('employees', JSON.stringify(employees));
                localStorage.setItem('timesheetData', JSON.stringify(timesheetData));
                localStorage.setItem('paymentHistory', JSON.stringify(paymentHistory));
                localStorage.setItem('last_update', new Date().toLocaleString('zh-TW'));
                updateDataStatus();
            } catch (e) {
                showMessage('å„²å­˜è³‡æ–™å¤±æ•—', 'error');
            }
        }
        
        function updateDataStatus() {
            const statusDiv = document.getElementById('data-status');
            const empCount = Object.keys(employees).length;
            if (empCount > 0) {
                statusDiv.style.display = 'block';
                document.getElementById('data-status-text').textContent = `${empCount} ä½å“¡å·¥ï¼Œæœ€å¾Œæ›´æ–°ï¼š${localStorage.getItem('last_update') || 'æœªçŸ¥'}`;
            } else {
                statusDiv.style.display = 'none';
            }
        }

        function exportAllData() {
            if (Object.keys(employees).length === 0) return showMessage('æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º', 'warning');
            const data = { employees, timesheetData, paymentHistory, exportDate: new Date() };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `å·¥æ™‚ç³»çµ±è³‡æ–™_${toLocalDateString(new Date())}.json`;
            link.click();
            link.remove();
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.employees && data.timesheetData) {
                        if (confirm('ç¢ºå®šåŒ¯å…¥ï¼Ÿé€™å°‡è¦†è“‹æ‰€æœ‰ç¾æœ‰è³‡æ–™ï¼')) {
                            employees = data.employees;
                            timesheetData = data.timesheetData;
                            paymentHistory = data.paymentHistory || {};
                            saveLocalData();
                            updateAllTables();
                            showMessage('è³‡æ–™åŒ¯å…¥æˆåŠŸï¼', 'success');
                        }
                    } else {
                        showMessage('æª”æ¡ˆæ ¼å¼ä¸ç¬¦', 'error');
                    }
                } catch (err) {
                    showMessage('è®€å–æª”æ¡ˆå¤±æ•—', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        function clearAllData() {
            if (confirm('âš ï¸ ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
                employees = {}; timesheetData = []; paymentHistory = {};
                localStorage.removeItem('employees');
                localStorage.removeItem('timesheetData');
                localStorage.removeItem('paymentHistory');
                localStorage.removeItem('last_update');
                updateAllTables();
                updateDataStatus();
                showMessage('æ‰€æœ‰è³‡æ–™å·²æ¸…é™¤', 'warning');
            }
        }

        // --- æª”æ¡ˆè™•ç† ---
        function handleDragOver(e) { e.preventDefault(); e.currentTarget.classList.add('dragover'); }
        function handleDragLeave(e) { e.preventDefault(); e.currentTarget.classList.remove('dragover'); }
        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                document.getElementById('timesheet-file').files = e.dataTransfer.files;
                handleTimesheetFile({ target: document.getElementById('timesheet-file') });
            }
        }
        async function handleTimesheetFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const progressContainer = document.getElementById('progress-container');
            progressContainer.style.display = 'block';
            updateProgress(10, 'è®€å–æª”æ¡ˆ...');

            try {
                const csvData = await new Promise((res, rej) => {
                    const reader = new FileReader();
                    reader.onload = () => res(reader.result);
                    reader.onerror = rej;
                    reader.readAsText(file);
                });
                
                updateProgress(30, 'è§£æ CSV...');
                const lines = csvData.replace(/\r\n/g, '\n').split('\n');
                const headers = lines[0].split(',').map(h => h.trim());
                const data = lines.slice(1).map(line => {
                    const values = line.split(',');
                    return headers.reduce((obj, h, i) => {
                        obj[h] = values[i] ? values[i].trim() : '';
                        return obj;
                    }, {});
                }).filter(r => r['Payroll ID']);
                
                if (data.length === 0) throw new Error('CSV ç„¡æœ‰æ•ˆè³‡æ–™');
                
                updateProgress(70, 'è™•ç†è³‡æ–™...');
                processTimesheetData(data);

                updateProgress(100, 'å®Œæˆï¼');
                showMessage(`æˆåŠŸè™•ç† ${data.length} ç­†è¨˜éŒ„`, 'success');

            } catch(e) {
                showMessage(`è™•ç†å¤±æ•—: ${e.message}`, 'error');
                updateProgress(0, 'å¤±æ•—');
            } finally {
                setTimeout(() => { progressContainer.style.display = 'none'; }, 2000);
                event.target.value = '';
            }
        }
        
        function processTimesheetData(data) {
            data.forEach(row => {
                const id = row['Payroll ID'];
                const dateStr = row['Monday of the Work Week'];
                if (!id || !dateStr) return;

                const workWeekDate = toLocalDateString(parseDate(dateStr));
                if (!workWeekDate) return;

                const hours = parseFloat(row['Hours']) || 0;
                
                // æ›´æ–°å“¡å·¥è³‡æ–™
                if (!employees[id]) employees[id] = { payrollId: id };
                Object.assign(employees[id], {
                    firstName: row['First Name'] || employees[id].firstName,
                    lastName: row['Last Name'] || employees[id].lastName,
                    level: row['Level'] || employees[id].level,
                    farm: row['Farm'] || employees[id].farm,
                    hourlyRate: parseFloat(row['Rate']) || employees[id].hourlyRate || 0,
                });

                // æ–°å¢æˆ–æ›´æ–°å·¥æ™‚è¨˜éŒ„
                const recordIndex = timesheetData.findIndex(r => r.payrollId === id && r.workWeekDate === workWeekDate);
                if (recordIndex !== -1) {
                    timesheetData[recordIndex].hours = hours;
                } else {
                    timesheetData.push({ payrollId: id, workWeekDate, hours });
                }
            });
            recalculateAllPayrolls();
            saveLocalData();
            updateAllTables();
        }

        // --- è–ªè³‡èˆ‡é€±æœŸè¨ˆç®— ---
        function recalculateAllPayrolls() {
            Object.values(employees).forEach(emp => {
                emp.workWeeks = timesheetData
                    .filter(r => r.payrollId === emp.payrollId)
                    .reduce((acc, r) => { acc[r.workWeekDate] = r.hours; return acc; }, {});
                calculatePayroll(emp);
            });
        }
        function calculatePayroll(employee) {
            const hourlyRate = Number(employee.hourlyRate) || 0;
            employee.totalHours = Object.values(employee.workWeeks || {}).reduce((sum, h) => sum + Number(h), 0);
            
            employee.accumulatedOvertimePay = 0;
            const allCycles = getAllAvailableCycles();
            allCycles.forEach(cycle => {
                let cycleHours = 0;
                Object.entries(employee.workWeeks || {}).forEach(([dateStr, hours]) => {
                    const workDate = parseDate(dateStr);
                    if (workDate >= cycle.startDate && workDate <= cycle.endDate) {
                        cycleHours += Number(hours);
                    }
                });
                if (cycleHours > REGULAR_HOURS_THRESHOLD) {
                    employee.accumulatedOvertimePay += (cycleHours - REGULAR_HOURS_THRESHOLD) * hourlyRate;
                }
            });

            const totalPaid = Object.values(paymentHistory[employee.payrollId] || {}).reduce((sum, p) => sum + p.amount, 0);
            employee.unpaidOvertimePay = Math.max(0, employee.accumulatedOvertimePay - totalPaid);
        }

        // --- æ”¯ä»˜ç®¡ç† ---
        function recordOvertimePayment(payrollId, amount, date) {
            if (!paymentHistory[payrollId]) paymentHistory[payrollId] = {};
            paymentHistory[payrollId][`pay_${Date.now()}`] = { amount: parseFloat(amount), date };
            recalculateAllPayrolls();
            saveLocalData();
            updateAllTables();
        }
        function showPaymentDialog(payrollId) {
            const employee = employees[payrollId];
            if (!employee) return;
            const dialog = document.createElement('div');
            dialog.className = 'confirm-dialog active';
            dialog.innerHTML = `<div class="confirm-content">
                <h3>ğŸ’° è¨˜éŒ„æ”¯ä»˜ for ${employee.firstName}</h3>
                <p>æœªæ”¯ä»˜åŠ ç­è²»: \$${employee.unpaidOvertimePay.toFixed(2)}</p>
                <div style="margin:20px 0;"><label>æ”¯ä»˜é‡‘é¡: <input type="number" id="payment-amount" value="${employee.unpaidOvertimePay.toFixed(2)}" style="padding:5px;"></label></div>
                <div style="margin:20px 0;"><label>æ”¯ä»˜æ—¥æœŸ: <input type="date" id="payment-date" value="${toLocalDateString(new Date())}" style="padding:5px;"></label></div>
                <div class="confirm-buttons">
                    <button class="btn-confirm" onclick="confirmPayment('${payrollId}')">ç¢ºèªæ”¯ä»˜</button>
                    <button class="btn-cancel" onclick="closeDialog()">å–æ¶ˆ</button>
                </div></div>`;
            document.body.appendChild(dialog);
        }
        function confirmPayment(payrollId) {
            const amount = parseFloat(document.getElementById('payment-amount').value);
            const date = document.getElementById('payment-date').value;
            if (isNaN(amount) || amount <= 0 || !date) return alert('è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡å’Œæ—¥æœŸ');
            recordOvertimePayment(payrollId, amount, date);
            closeDialog();
            showMessage('âœ… æ”¯ä»˜å·²è¨˜éŒ„');
        }
        function showPaymentHistory(payrollId) {
             const history = paymentHistory[payrollId];
             if(!history) return showMessage('ç„¡æ”¯ä»˜è¨˜éŒ„', 'warning');
             const dialog = document.createElement('div');
             dialog.className = 'confirm-dialog active';
             dialog.innerHTML = `<div class="confirm-content">
                <h3>æ”¯ä»˜æ­·å²: ${employees[payrollId].firstName}</h3>
                <div style="max-height:300px; overflow-y:auto; text-align:left;">
                ${Object.values(history).map(p => `<div>${p.date}: <b>\$${p.amount.toFixed(2)}</b></div>`).join('')}
                </div><div class="confirm-buttons"><button class="btn-cancel" onclick="closeDialog()">é—œé–‰</button></div></div>`;
             document.body.appendChild(dialog);
        }

        // --- UI æ›´æ–° & ç¯©é¸ ---
        function updateAllTables() { updateOverviewTable(); }
        function clearFilters() {
            ['farm-filter', 'level-filter', 'employee-filter', 'cycle-filter'].forEach(id=>document.getElementById(id).value='');
            updateAllTables();
        }
        function getMonday(d) {
            d = new Date(d);
            let day = d.getDay(), diff = d.getDate() - day + (day == 0 ? -6:1);
            return new Date(d.setDate(diff));
        }
        function getAllAvailableCycles() {
            const startMonday = getMonday(SYSTEM_START_DATE);
            const today = new Date();
            if (today < startMonday) return [];
            
            const totalWeeks = Math.floor((today - startMonday) / (1000 * 60 * 60 * 24 * 7));
            const totalCycles = Math.floor(totalWeeks / WEEKS_PER_CYCLE) + 1;
            
            return Array.from({ length: totalCycles }, (_, i) => {
                const cycleNum = i + 1;
                const startDate = new Date(startMonday);
                startDate.setDate(startDate.getDate() + i * WEEKS_PER_CYCLE * 7);
                const endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + (WEEKS_PER_CYCLE * 7) - 1);
                return { cycle: cycleNum, startDate, endDate };
            });
        }
        function getFilteredEmployees() {
            const allCycles = getAllAvailableCycles();
            const farm = document.getElementById('farm-filter').value;
            const level = document.getElementById('level-filter').value;
            const empId = document.getElementById('employee-filter').value;
            const cycleVal = document.getElementById('cycle-filter').value;
            
            let selectedCycleRange = cycleVal ? allCycles.find(c => c.cycle.toString() === cycleVal) : null;
            
            return Object.values(employees).filter(emp => {
                if (farm && emp.farm !== farm) return false;
                if (level && emp.level !== level) return false;
                if (empId && emp.payrollId !== empId) return false;
                if (selectedCycleRange) {
                    return Object.keys(emp.workWeeks || {}).some(dateStr => {
                        const workDate = parseDate(dateStr);
                        return workDate >= selectedCycleRange.startDate && workDate <= selectedCycleRange.endDate;
                    });
                }
                return true;
            });
        }
        function updateFilterOptions() {
            const farms = new Set(), levels = new Set(), empList = [];
            Object.values(employees).forEach(e => {
                if (e.farm) farms.add(e.farm);
                if (e.level) levels.add(e.level);
                empList.push({ id: e.payrollId, name: `${e.firstName || ''} ${e.lastName || ''} (${e.payrollId})` });
            });
            const populate = (selId, data, nameKey, valKey) => {
                const select = document.getElementById(selId), currentVal = select.value;
                select.innerHTML = `<option value="">${select.firstElementChild.textContent}</option>`;
                data.forEach(item => {
                    const val = valKey ? item[valKey] : item;
                    const text = nameKey ? item[nameKey] : item;
                    select.add(new Option(text, val, false, val === currentVal));
                });
            };
            populate('farm-filter', [...farms].sort());
            populate('level-filter', [...levels].sort());
            populate('employee-filter', empList.sort((a,b)=>a.name.localeCompare(b.name)), 'name', 'id');
            populate('cycle-filter', getAllAvailableCycles().reverse(), 'cycle', 'cycle');
        }
        function toggleDetails(btn, id) {
            const row = document.getElementById(`details-${id}`);
            row.classList.toggle('is-open');
            btn.textContent = row.classList.contains('is-open') ? '-' : '+';
        }
        function updateOverviewTable() {
            const container = document.getElementById('overview-table-container');
            const summaryContainer = document.getElementById('overview-summary-cards');
            const cycleCard = document.getElementById('cycle-summary-card');

            if (Object.keys(employees).length === 0) {
                container.innerHTML = '<p style="text-align: center;">å°šæœªè¼‰å…¥å“¡å·¥è³‡æ–™</p>';
                summaryContainer.innerHTML = '';
                cycleCard.style.display = 'none';
                return;
            }
            
            updateFilterOptions();
            const filteredEmployees = getFilteredEmployees();
            
            // æ›´æ–°é€±æœŸé€²åº¦ Bar
            const currentSystemCycle = getAllAvailableCycles().find(c => new Date() >= c.startDate && new Date() <= c.endDate);
            if (currentSystemCycle) {
                const progress = ((new Date() - currentSystemCycle.startDate) / (currentSystemCycle.endDate - currentSystemCycle.startDate)) * 100;
                cycleCard.innerHTML = `
                    <h4 style="margin:0 0 10px 0;">ç•¶å‰ç³»çµ±é€±æœŸ: ${currentSystemCycle.cycle} (${toLocalDateString(currentSystemCycle.startDate)} - ${toLocalDateString(currentSystemCycle.endDate)})</h4>
                    <div class="progress-bar" style="margin-top:10px;"><div class="progress-fill" style="width:${progress.toFixed(2)}%;"></div></div>`;
                cycleCard.style.display = 'block';
            } else {
                cycleCard.style.display = 'none';
            }

            if (filteredEmployees.length === 0) {
                container.innerHTML = '<p style="text-align: center;">æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„è³‡æ–™</p>';
                summaryContainer.innerHTML = '';
                return;
            }
            
            let totalUnpaid = 0;
            let tableHTML = `<table class="employee-table"><thead><tr>
                <th></th><th>ID</th><th>å§“å</th><th>è¾²å ´</th><th>æ™‚è–ª</th>
                <th>ç¸½å·¥æ™‚</th><th>ç´¯è¨ˆOTè²»</th><th>æœªä»˜OTè²»</th><th>æ“ä½œ</th>
                </tr></thead><tbody>`;

            filteredEmployees.sort((a,b)=>a.payrollId.localeCompare(b.payrollId)).forEach(emp => {
                totalUnpaid += emp.unpaidOvertimePay || 0;
                tableHTML += `<tr class="main-row">
                    <td><button class="toggle-details-btn" onclick="toggleDetails(this, '${emp.payrollId}')">+</button></td>
                    <td>${emp.payrollId}</td><td>${emp.firstName} ${emp.lastName}</td><td>${emp.farm || '-'}</td>
                    <td class="money">${(emp.hourlyRate || 0).toFixed(2)}</td>
                    <td>${(emp.totalHours || 0).toFixed(1)}</td>
                    <td class="money">${(emp.accumulatedOvertimePay || 0).toFixed(2)}</td>
                    <td class="money ${emp.unpaidOvertimePay > 0 ? 'status-overtime' : ''}">${(emp.unpaidOvertimePay || 0).toFixed(2)}</td>
                    <td>
                        ${emp.unpaidOvertimePay > 0 ? `<button class="btn-payment" onclick="showPaymentDialog('${emp.payrollId}')">æ”¯ä»˜</button>` : ''}
                        ${paymentHistory[emp.payrollId] ? `<button class="btn-edit" onclick="showPaymentHistory('${emp.payrollId}')">æ­·å²</button>`: ''}
                    </td></tr>
                    <tr class="details-row" id="details-${emp.payrollId}"><td colspan="9">
                        <table class="details-table"><thead><tr><th>å·¥ä½œé€± (é€±ä¸€)</th><th>å·¥æ™‚</th></tr></thead><tbody>
                        ${Object.entries(emp.workWeeks || {}).sort((a,b)=>b[0].localeCompare(a[0])).map(([date, hours])=>`<tr><td>${date}</td><td>${hours}</td></tr>`).join('') || '<tr><td colspan="2">ç„¡å·¥æ™‚è³‡æ–™</td></tr>'}
                        </tbody></table>
                    </td></tr>`;
            });
            tableHTML += `</tbody></table>`;
            container.innerHTML = tableHTML;
            summaryContainer.innerHTML = `
                <div class="summary-card"><h3>${filteredEmployees.length}</h3><p>ç¯©é¸å¾Œå“¡å·¥</p></div>
                <div class="summary-card"><h3>$${totalUnpaid.toFixed(2)}</h3><p>æœªæ”¯ä»˜åŠ ç­è²»ç¸½é¡</p></div>`;
        }
        
        // --- è¼”åŠ©å‡½æ•¸ ---
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }
        function showMessage(message, type = 'success') {
            const container = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = `${type}-message`;
            div.textContent = message;
            container.appendChild(div);
            setTimeout(() => {
                div.classList.add('message-fadeout');
                div.addEventListener('transitionend', () => div.remove());
            }, 3000);
        }
        function updateProgress(p, text) {
            document.getElementById('progress-fill').style.width = p + '%';
            document.getElementById('progress-text').textContent = text;
        }
        function toLocalDateString(date) {
            if (!date) return '';
            return new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
        }
        function parseDate(ds) {
            if (!ds) return null;
            let d = new Date(ds);
            if (!isNaN(d.getTime()) && ds.includes('-')) return new Date(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate());
            const p = ds.split('/');
            if (p.length === 3) {
                d = new Date(+p[2], +p[1] - 1, +p[0]);
                if (!isNaN(d.getTime())) return d;
            }
            return null;
        }
        function closeDialog() {
            const dialog = document.querySelector('.confirm-dialog.active');
            if (dialog) {
                dialog.classList.remove('active');
                setTimeout(() => dialog.remove(), 300);
            }
        }
    </script>
</body>
</html>
