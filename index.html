<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工時管理系統</title>
    <style>
        /* General Styles */
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.08);
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 32px;
            font-weight: 600;
        }

        /* Message Styles */
        .success-message {
            background: #e6ffe6;
            color: #006600;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 5px solid #006600;
            opacity: 1;
            transition: opacity 0.5s ease;
        }

        .error-message {
            background: #ffe6e6;
            color: #cc0000;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 5px solid #cc0000;
            opacity: 1;
            transition: opacity 0.5s ease;
        }

        .warning-message {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 5px solid #ffc107;
            opacity: 1;
            transition: opacity 0.5s ease;
        }
        
        .message-fadeout {
            opacity: 0;
        }

        /* Upload Section */
        .upload-section {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
            background: #f8f9ff;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }

        .upload-section.dragover {
            border-color: #28a745;
            background: #e8f5e8;
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.2);
        }

        .upload-section.dragover h3 {
            color: #28a745;
        }

        .upload-section.dragover p {
            color: #155724;
            font-weight: bold;
        }

        .file-input {
            display: none;
        }

        .upload-btn, .action-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: transform 0.2s, background 0.3s, box-shadow 0.2s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .upload-btn:hover, .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .upload-btn:active, .action-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .upload-btn:disabled, .action-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .file-info {
            margin-top: 15px;
            padding: 10px;
            background: #e8f5e8;
            border-radius: 5px;
        }

        /* Data Management */
        .data-section {
            background: #f6f8fa;
            border: 2px solid #28a745;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }

        .data-section h3 {
            color: #28a745;
            margin: 0 0 15px 0;
            font-size: 22px;
        }

        .data-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .btn-export {
            background: linear-gradient(45deg, #28a745, #20c997);
        }

        .btn-import {
            background: linear-gradient(45deg, #007bff, #6610f2);
        }

        .btn-clear {
            background: linear-gradient(45deg, #dc3545, #fd7e14);
        }

        /* Tabs */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }

        .tab {
            padding: 15px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            min-width: 120px;
            text-align: center;
            font-weight: 500;
            color: #555;
        }

        .tab.active {
            border-bottom-color: #667eea;
            color: #667eea;
            font-weight: bold;
            background: #f0f2ff;
        }

        .tab:hover:not(.active) {
            background: #f8faff;
            color: #667eea;
        }

        .tab-content {
            display: none;
            padding-top: 10px;
        }

        .tab-content.active {
            display: block;
        }

        /* Tables */
        .employee-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
            text-align: center;
        }

        .employee-table th,
        .employee-table td {
            border: 1px solid #ddd;
            padding: 10px 8px;
            text-align: center;
            vertical-align: middle;
        }

        .employee-table th {
            background: #667eea;
            color: white;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .employee-table tr:nth-child(even) {
            background: #f9f9f9;
        }

        .employee-table tr.main-row:hover {
            background: #f0f2ff;
        }

        .toggle-details-btn {
            cursor: pointer;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-weight: bold;
            font-size: 16px;
            line-height: 24px;
            text-align: center;
        }

        .details-row {
            display: none;
        }

        .details-row.is-open {
            display: table-row;
        }

        .details-row td {
            background-color: #f8f9fa !important;
            padding: 15px !important;
            text-align: left !important;
        }

        .details-table {
            width: 100%;
            margin: 0 auto;
            border-collapse: collapse;
        }

        .details-table th, .details-table td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: center;
            background: white;
        }

        .details-table th {
            background: #6c757d;
            color: white;
            font-size: 12px;
        }

        .details-table input {
            width: 80px;
            padding: 4px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 13px;
        }

        .details-table input:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.25);
        }

        .edit-actions {
            margin-top: 10px;
            text-align: center;
        }

        .btn-save, .btn-cancel-edit {
            padding: 6px 12px;
            margin: 0 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
        }

        .btn-save {
            background: #28a745;
            color: white;
        }

        .btn-save:hover {
            background: #218838;
        }

        .btn-cancel-edit {
            background: #6c757d;
            color: white;
        }

        .btn-cancel-edit:hover {
            background: #5a6268;
        }

        .btn-edit {
            background: #007bff;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            margin-left: 10px;
        }

        .btn-edit:hover {
            background: #0056b3;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            margin-left: 5px;
        }

        .btn-delete:hover {
            background: #c82333;
        }

        .btn-payment {
            background: #ffc107;
            color: #212529;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            margin-left: 5px;
            font-weight: bold;
        }

        .btn-payment:hover {
            background: #e0a800;
        }

        .btn-payment.paid {
            background: #28a745;
            color: white;
        }

        .btn-payment.paid:hover {
            background: #218838;
        }

        .weekly-overtime {
            color: #fd7e14;
            font-weight: bold;
        }

        .status-normal {
            color: #228B22;
            font-weight: bold;
        }

        .status-overtime {
            color: #ff4444;
            font-weight: bold;
        }

        .status-paid {
            color: #28a745;
            font-weight: bold;
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease-out;
        }
        
        #progress-text {
            text-align: center;
            font-weight: 500;
            color: #555;
            margin-top: 5px;
        }

        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .summary-card h3 {
            margin: 0 0 10px 0;
            font-size: 24px;
            font-weight: 700;
        }

        .summary-card p {
            margin: 0;
            font-size: 14px;
            opacity: 0.9;
        }

        .money {
            color: #28a745;
            font-weight: bold;
        }

        .format-info {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            font-size: 14px;
        }

        .format-info h4 {
            margin: 0 0 10px 0;
            color: #0066cc;
            font-size: 18px;
        }

        .format-example {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            margin: 5px 0;
            white-space: pre-wrap;
            word-break: break-all;
            line-height: 1.5;
        }

        .format-info ul {
            padding-left: 20px;
            margin-top: 10px;
        }

        .format-info li {
            margin-bottom: 5px;
        }

        /* Validation Results */
        .validation-results {
            margin: 20px 0;
        }

        .validation-item {
            padding: 12px;
            margin: 8px 0;
            border-radius: 5px;
            border-left: 5px solid;
            font-size: 15px;
        }

        .validation-success {
            background: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }

        .validation-warning {
            background: #fff3cd;
            border-left-color: #ffc107;
            color: #856404;
        }

        .validation-error {
            background: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }

        /* Upload Summary */
        .upload-summary {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .upload-summary h3 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-size: 15px;
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .highlight {
            background: #fff3cd;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: bold;
        }

        /* Confirm Dialog */
        .confirm-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .confirm-dialog.active {
            opacity: 1;
            visibility: visible;
        }

        .confirm-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            max-height: 90%;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .confirm-dialog.active .confirm-content {
            transform: scale(1);
        }

        .confirm-content h3 {
            font-size: 24px;
            margin-bottom: 15px;
            text-align: center;
            color: #333;
        }

        .confirm-content p {
            margin-bottom: 20px;
            text-align: center;
            font-size: 16px;
        }

        .confirm-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .btn-confirm, .btn-cancel {
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s, transform 0.2s;
        }

        .btn-confirm {
            background: #28a745;
            color: white;
        }

        .btn-confirm:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-cancel {
            background: #dc3545;
            color: white;
        }

        .btn-cancel:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        /* Loading spinner */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #fff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 5px;
        }

        .spinner-dark {
            border: 3px solid rgba(0, 0, 0, 0.2);
            border-top: 3px solid #333;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Payment tracking styles */
        .payment-status {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 5px;
        }

        .payment-pending {
            background: #fff3cd;
            color: #856404;
        }

        .payment-paid {
            background: #d4edda;
            color: #155724;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>📊 工時管理系統</h1>
        <div style="text-align: center; margin-bottom: 20px;">
            <small>🔄 本地儲存 | 📊 即時計算 | 💾 檔案管理</small>
        </div>
        
        <div class="data-section">
            <h3>💾 資料管理</h3>
            <p>所有資料儲存在瀏覽器本地，關閉瀏覽器後資料仍會保留。</p>
            <div class="data-buttons">
                <button class="action-btn btn-export" onclick="exportAllData()">
                    📤 匯出完整資料
                </button>
                <button class="action-btn btn-import" onclick="document.getElementById('data-import').click()">
                    📥 匯入資料檔
                </button>
                <button class="action-btn btn-clear" onclick="clearAllData()">
                    🗑️ 清除所有資料
                </button>
            </div>
            <input type="file" id="data-import" class="file-input" accept=".json" onchange="importData(event)">
            <div id="data-status" style="margin-top: 15px; padding: 10px; background: #e8f5e8; border-radius: 5px; font-size: 14px; display: none;">
                <strong>資料狀態：</strong><span id="data-status-text">載入中...</span>
            </div>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('upload')">📁 資料上傳</div>
            <div class="tab" onclick="switchTab('overview')">👥 員工總覽與薪資</div>
        </div>
        
        <div id="upload-tab" class="tab-content active">
            <div class="format-info">
                <h4>📊 工時表格式說明</h4>
                <div class="format-example">Payroll ID, First Name, Last Name, Monday of the Work Week, Hours, Level, Rate, Farm
EQ-0001, John, Doe, 2025-02-10, 45, Senior, 25.50, Farm A
EQ-0001, John, Doe, 2025-02-17, 38, Senior, 25.50, Farm A
EQ-0002, Jane, Smith, 2025-02-10, 42, Junior, 20.00, Farm B</div>
                <p><strong>重要格式說明：</strong></p>
                <ul>
                    <li>📅 <strong>Monday of the Work Week</strong>：工作週的週一日期，格式為 YYYY-MM-DD 或 DD/MM/YYYY</li>
                    <li>🔢 <strong>週期計算</strong>：系統會自動根據統一起始日期（2025/2/10）計算週期</li>
                    <li>🏭 <strong>Farm/Level/Rate 更新</strong>：如果員工轉換農場或調整薪資，新資料會覆蓋舊資料</li>
                    <li>👤 <strong>員工資訊</strong>：系統會自動建立員工檔案，無需額外的開始日期</li>
                </ul>
                <p><strong>上傳後自動處理：</strong></p>
                <ul>
                    <li>✅ 驗證 EQ-0001 格式的員工編號</li>
                    <li>✅ 自動計算正確的工作週數</li>
                    <li>✅ 支援農場和職級異動</li>
                    <li>✅ 整合新舊資料，檢測重複工作週</li>
                    <li>✅ 自動儲存到瀏覽器本地</li>
                </ul>
            </div>
            
            <div class="upload-section" id="timesheet-upload" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                <h3>📋 上傳工時表 (CSV)</h3>
                <p>🖱️ 點擊選擇檔案 或 📁 直接拖拽 CSV 檔案到此區域</p>
                <button id="upload-file-btn" class="upload-btn" onclick="document.getElementById('timesheet-file').click()">
                    <span class="spinner" style="display: none;"></span>
                    選擇工時表文件
                </button>
                <input type="file" id="timesheet-file" class="file-input" accept=".csv" onchange="handleTimesheetFile(event)">
                <div id="timesheet-file-info" class="file-info" style="display: none;"></div>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <p id="progress-text">等待上傳文件...</p>
            
            <div id="validation-results" class="validation-results"></div>
        </div>
        
        <div id="overview-tab" class="tab-content"> 
            <h2>👥 員工總覽與薪資管理</h2>
            
            <div class="format-info">
                <h4>🔍 篩選選項</h4>
                <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                    <div>
                        <label for="farm-filter"><strong>農場：</strong></label>
                        <select id="farm-filter" onchange="updateAllTables()" style="padding: 8px 12px; margin-left: 8px; border-radius: 5px; border: 1px solid #ccc;">
                            <option value="">所有農場</option>
                        </select>
                    </div>
                    <div>
                        <label for="level-filter"><strong>職級：</strong></label>
                        <select id="level-filter" onchange="updateAllTables()" style="padding: 8px 12px; margin-left: 8px; border-radius: 5px; border: 1px solid #ccc;">
                            <option value="">所有職級</option>
                        </select>
                    </div>
                    <div>
                        <label for="employee-filter"><strong>員工：</strong></label>
                        <select id="employee-filter" onchange="updateAllTables()" style="padding: 8px 12px; margin-left: 8px; border-radius: 5px; border: 1px solid #ccc;">
                            <option value="">所有員工</option>
                        </select>
                    </div>
                    <div>
                        <label for="cycle-filter"><strong>週期：</strong></label>
                        <select id="cycle-filter" onchange="updateAllTables()" style="padding: 8px 12px; margin-left: 8px; border-radius: 5px; border: 1px solid #ccc;">
                            <option value="">所有週期</option>
                        </select>
                    </div>
                    <button class="action-btn" onclick="clearFilters()" style="padding: 8px 18px; background: #6c757d; color: white; border: none; border-radius: 3px; box-shadow: none;">清除篩選</button>
                </div>
            </div>
            
            <div id="cycle-summary-card" class="format-info" style="display: none; border-left: 5px solid #667eea;">
            </div>
            
            <div class="summary-cards" id="overview-summary-cards"></div>
            <div id="overview-table-container"></div>
            
            <button id="exportOverview" class="upload-btn action-btn" onclick="exportOverview()" style="margin-top: 20px;">
                <span class="spinner" style="display: none;"></span>
                📥 匯出完整報告 (CSV)
            </button>
        </div>
        
        <div id="messages"></div>
    </div>

    <script>
        // 全域變數
        let employees = {};
        let timesheetData = [];
        let pendingData = null;
        let paymentHistory = {};
        
        // 常數定義
        const REGULAR_HOURS_THRESHOLD = 304;
        const WEEKS_PER_CYCLE = 8;
        const WEEKLY_HOURS_THRESHOLD = 38;
        const SYSTEM_START_DATE = new Date(2025, 1, 10); // 月份是 0-indexed, 1 = 二月

        // 初始化函數
        document.addEventListener('DOMContentLoaded', function() {
            loadLocalData();
            updateProgress(0, '系統已就緒，請上傳工時表');
            updateDataStatus();
        });

        // 載入本地資料
        function loadLocalData() {
            try {
                const storedEmployees = localStorage.getItem('timesheet_employees');
                const storedTimesheetData = localStorage.getItem('timesheet_data');
                const storedPaymentHistory = localStorage.getItem('payment_history');
                
                if (storedEmployees) {
                    employees = JSON.parse(storedEmployees);
                }
                
                if (storedTimesheetData) {
                    timesheetData = JSON.parse(storedTimesheetData);
                }

                if (storedPaymentHistory) {
                    paymentHistory = JSON.parse(storedPaymentHistory);
                }
                
                updateAllTables();
                console.log('✅ 本地資料載入成功');
            } catch (error) {
                console.error('載入本地資料失敗:', error);
                showMessage('載入本地資料時發生錯誤', 'warning');
            }
        }

        // 儲存本地資料
        function saveLocalData() {
            try {
                localStorage.setItem('timesheet_employees', JSON.stringify(employees));
                localStorage.setItem('timesheet_data', JSON.stringify(timesheetData));
                localStorage.setItem('payment_history', JSON.stringify(paymentHistory));
                updateDataStatus();
                console.log('✅ 資料已儲存到本地');
            } catch (error) {
                console.error('儲存本地資料失敗:', error);
                showMessage('儲存資料時發生錯誤', 'error');
            }
        }

        // 更新資料狀態顯示
        function updateDataStatus() {
            const statusDiv = document.getElementById('data-status');
            const statusText = document.getElementById('data-status-text');
            
            const empCount = Object.keys(employees).length;
            const recordCount = timesheetData.length;
            const lastUpdate = localStorage.getItem('last_update') || '未知';
            
            if (empCount > 0 || recordCount > 0) {
                statusDiv.style.display = 'block';
                statusText.textContent = `${empCount} 位員工，${recordCount} 筆工時記錄，最後更新：${lastUpdate}`;
            } else {
                statusDiv.style.display = 'none';
            }
        }

        // 匯出完整資料
        function exportAllData() {
            if (Object.keys(employees).length === 0 && timesheetData.length === 0) {
                showMessage('沒有資料可以匯出', 'warning');
                return;
            }

            const data = {
                employees: employees,
                timesheetData: timesheetData,
                paymentHistory: paymentHistory,
                exportDate: new Date().toISOString(),
                version: '2.2',
                systemName: '本地版工時管理系統'
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `工時系統完整資料_${new Date().toLocaleDateString('en-CA').replace(/-/g, '')}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessage('✅ 完整資料已匯出！');
        }

        // 匯入資料檔
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.employees && data.timesheetData) {
                        if (confirm('確定要匯入資料嗎？這會覆蓋現有的所有資料！')) {
                            employees = data.employees;
                            timesheetData = data.timesheetData;
                            paymentHistory = data.paymentHistory || {};
                            saveLocalData();
                            updateAllTables();
                            showMessage('✅ 資料匯入成功！');
                        }
                    } else {
                        showMessage('檔案格式不正確，請選擇正確的資料檔', 'error');
                    }
                } catch (error) {
                    showMessage('讀取檔案失敗：' + error.message, 'error');
                }
            };
            reader.readAsText(file);
            
            event.target.value = '';
        }

        // 清除所有資料
        function clearAllData() {
            if (confirm('⚠️ 確定要清除所有資料嗎？這將會刪除所有員工資料和工時記錄，並且無法復原！')) {
                employees = {};
                timesheetData = [];
                paymentHistory = {};
                localStorage.removeItem('timesheet_employees');
                localStorage.removeItem('timesheet_data');
                localStorage.removeItem('payment_history');
                localStorage.removeItem('last_update');
                updateAllTables();
                updateDataStatus();
                showMessage('🗑️ 所有資料已清除！', 'warning');
            }
        }

        // 切換分頁
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        // 顯示訊息
        function showMessage(message, type = 'success', duration = 8000) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'error' ? 'error-message' : 
                                 type === 'warning' ? 'warning-message' : 'success-message';
            messageDiv.innerHTML = message;
            messagesDiv.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.classList.add('message-fadeout');
                messageDiv.addEventListener('transitionend', () => messageDiv.remove());
            }, duration);
        }

        // 更新進度條
        function updateProgress(percentage, text) {
            document.getElementById('progress-fill').style.width = percentage + '%';
            document.getElementById('progress-text').textContent = text;
        }

        // 驗證員工編號格式
        function validatePayrollID(payrollId) {
            if (!payrollId) return false;
            const pattern = /^[A-Za-z]{2,3}-\d{3,4}$/;
            return pattern.test(payrollId.trim());
        }

        // 解析日期字串
        function parseDate(dateString) {
            if (!dateString) return null;
            
            // 優先處理 YYYY-MM-DD
            let date = new Date(dateString);
            if (!isNaN(date.getTime()) && dateString.includes('-')) {
                // 從 UTC 時間轉換為本地時間以避免時區問題
                return new Date(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate());
            }

            // 處理 DD/MM/YYYY
            const partsSlash = dateString.split('/');
            if (partsSlash.length === 3 && partsSlash[0].length <= 2) {
                date = new Date(parseInt(partsSlash[2]), parseInt(partsSlash[1]) - 1, parseInt(partsSlash[0]));
                if (!isNaN(date.getTime())) return date;
            }
            
            return null;
        }

        // 取得週一日期
        function getMonday(date) {
            const result = new Date(date);
            const dayOfWeek = result.getDay(); // Sunday = 0, Monday = 1, ...
            const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            result.setDate(result.getDate() + daysToMonday);
            result.setHours(0, 0, 0, 0);
            return result;
        }

        // 解析時薪
        function parseRate(rateString) {
            if (!rateString) return 0;
            const cleanedString = rateString.toString().replace(/[^0-9.]/g, '');
            return parseFloat(cleanedString) || 0;
        }

        // 處理拖拽事件
        function handleDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            document.getElementById('timesheet-upload').classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.preventDefault();
            event.stopPropagation();
            document.getElementById('timesheet-upload').classList.remove('dragover');
        }

        function handleDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            document.getElementById('timesheet-upload').classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (!file.name.toLowerCase().endsWith('.csv')) {
                    showMessage('❌ 請選擇 CSV 檔案', 'error');
                    return;
                }
                
                const fileInput = document.getElementById('timesheet-file');
                const dt = new DataTransfer();
                dt.items.add(file);
                fileInput.files = dt.files;
                
                const changeEvent = new Event('change', { bubbles: true });
                fileInput.dispatchEvent(changeEvent);
                
                showMessage(`📁 已接收檔案: ${file.name}`, 'success', 3000);
            }
        }

        // 處理工時表上傳
        async function handleTimesheetFile(event) {
            const file = event.target.files[0];
            if (!file) {
                document.getElementById('timesheet-file-info').style.display = 'none';
                updateProgress(0, '等待上傳文件...');
                return;
            }
            
            document.getElementById('validation-results').innerHTML = '';
            document.getElementById('timesheet-file-info').style.display = 'none';
            setButtonLoading('upload-file-btn', true, '讀取中...');

            try {
                updateProgress(20, '正在讀取工時表...');
                const data = await readFile(file);
                const parsed = parseCSV(data);
                
                updateProgress(40, '驗證資料格式...');
                const validationResult = validateTimesheetData(parsed);
                if (validationResult.errors.length > 0) {
                    showValidationResults(validationResult);
                    updateProgress(0, '資料驗證失敗');
                    showMessage('❌ 工時表驗證失敗，請檢查格式並重試。', 'error');
                    return;
                }
                
                updateProgress(60, '檢查資料衝突...');
                const conflicts = checkForConflicts(parsed);
                if (conflicts.length > 0) {
                    showConflictDialog(parsed, conflicts);
                } else {
                    await processTimesheetData(parsed);
                }
                
            } catch (error) {
                showMessage('讀取工時表時發生錯誤: ' + error.message, 'error');
                updateProgress(0, '載入失敗');
                console.error('File handling error:', error);
            } finally {
                setButtonLoading('upload-file-btn', false, '選擇工時表文件');
                document.getElementById('timesheet-file').value = '';
            }
        }

        // 驗證工時表資料
        function validateTimesheetData(data) {
            const result = { success: [], warnings: [], errors: [] };
            if (data.length === 0) {
                result.errors.push('文件為空或格式不正確。');
                return result;
            }
            const requiredFields = ['Payroll ID', 'First Name', 'Last Name', 'Monday of the Work Week', 'Hours'];
            const headers = Object.keys(data[0] || {});
            requiredFields.forEach(field => {
                if (!headers.includes(field)) result.errors.push(`缺少必要欄位: ${field}。`);
            });
            if (result.errors.length > 0) return result;
            
            const employeeSet = new Set();
            data.forEach((row, index) => {
                const payrollId = row['Payroll ID']?.trim();
                const workWeek = row['Monday of the Work Week']?.trim();
                const hours = parseFloat(row['Hours']);
                
                if (!payrollId || !workWeek || isNaN(hours)) {
                     // 跳過不完整的行
                    return;
                }
                if (!validatePayrollID(payrollId)) result.errors.push(`第${index + 2}行: Payroll ID 格式錯誤 (${payrollId})。`);
                else employeeSet.add(payrollId);
                
                if (!parseDate(workWeek)) result.errors.push(`第${index + 2}行: 日期格式錯誤 (${workWeek})。`);
                if (hours < 0) result.errors.push(`第${index + 2}行: 工時資料無效 (${row['Hours']})。`);
                if (hours > 168) result.warnings.push(`第${index + 2}行: 員工 ${payrollId} 工時超過168小時 (${hours})。`);
            });
            
            if (result.errors.length === 0) {
                result.success.push(`✅ 成功驗證 ${data.length} 筆工時記錄`);
                result.success.push(`👥 涉及 ${employeeSet.size} 位員工`);
            }
            return result;
        }

        // 檢查資料衝突
        function checkForConflicts(newData) {
            const conflicts = [];
            const existingDataMap = new Map(timesheetData.map(item => [`${item.payrollId}-${item.workWeekDate}`, item.hours]));
            
            newData.forEach(row => {
                const payrollId = row['Payroll ID']?.trim();
                const workWeekStr = row['Monday of the Work Week']?.trim();
                if (!payrollId || !workWeekStr) return;

                const parsed = parseDate(workWeekStr);
                if (!parsed) return;
                
                const workWeekDate = toLocalDateString(parsed);
                const key = `${payrollId}-${workWeekDate}`;
                const newHours = parseFloat(row['Hours']) || 0;
                
                if (existingDataMap.has(key) && existingDataMap.get(key) !== newHours) {
                    conflicts.push({
                        payrollId, workWeekDate,
                        existingHours: existingDataMap.get(key), newHours,
                        employeeName: `${row['First Name']} ${row['Last Name']}`.trim()
                    });
                }
            });
            return conflicts;
        }

        // 顯示衝突解決對話框
        function showConflictDialog(newData, conflicts) {
            const dialog = document.createElement('div');
            dialog.className = 'confirm-dialog active';
            const sampleConflicts = conflicts.slice(0, 5);
            let conflictsList = sampleConflicts.map(c => `
                <div class="validation-warning" style="margin-bottom: 5px;">
                    <strong>${c.employeeName}</strong> (${c.payrollId}) - ${c.workWeekDate}
                    <br>現有: <span class="highlight">${c.existingHours}h</span> → 新: <span class="highlight">${c.newHours}h</span>
                </div>`).join('');
            if (conflicts.length > 5) conflictsList += `<p>...還有 ${conflicts.length - 5} 個衝突未顯示</p>`;
            
            dialog.innerHTML = `
                <div class="confirm-content">
                    <h3>⚠️ 發現 ${conflicts.length} 個資料衝突</h3>
                    <p>以下工時資料已存在且數值不同，是否用新資料覆蓋？</p>
                    ${conflictsList}
                    <div class="confirm-buttons">
                        <button class="btn-confirm" onclick="confirmOverwrite(true)">覆蓋並更新</button>
                        <button class="btn-cancel" onclick="confirmOverwrite(false)">取消上傳</button>
                    </div>
                </div>`;
            document.body.appendChild(dialog);
            pendingData = newData;
        }

        // 確認覆蓋衝突
        async function confirmOverwrite(confirmed) {
            closeDialog();
            if (confirmed && pendingData) await processTimesheetData(pendingData, true);
            else {
                updateProgress(0, '上傳已取消');
                showMessage('ℹ️ 資料上傳已取消。');
            }
            pendingData = null;
        }

        // 關閉對話框
        function closeDialog() {
            const dialog = document.querySelector('.confirm-dialog');
            if (dialog) {
                dialog.classList.remove('active');
                setTimeout(() => dialog.remove(), 300);
            }
        }

        // 格式化日期為 YYYY-MM-DD
        function toLocalDateString(date) {
            if (!date || isNaN(date.getTime())) return '';
            return date.toISOString().split('T')[0];
        }

        // 處理工時表資料
        async function processTimesheetData(data, overwrite = false) {
            updateProgress(10, '開始處理資料...');
            const summary = { total: data.length, new: 0, updated: 0, employees: new Set() };
            
            const existingDataMap = new Map(timesheetData.map(item => [`${item.payrollId}-${item.workWeekDate}`, item]));

            for (const row of data) {
                const payrollId = row['Payroll ID']?.trim();
                if (!validatePayrollID(payrollId)) continue;
                
                const workWeekStr = row['Monday of the Work Week']?.trim();
                const parsedWorkWeek = parseDate(workWeekStr);
                if (!parsedWorkWeek) continue;
                
                const workWeekDate = toLocalDateString(parsedWorkWeek);
                const hours = parseFloat(row['Hours']) || 0;
                summary.employees.add(payrollId);

                if (!employees[payrollId]) {
                    employees[payrollId] = { payrollId, workWeeks: {}, totalHours: 0 };
                }
                employees[payrollId].firstName = row['First Name']?.trim();
                employees[payrollId].lastName = row['Last Name']?.trim();
                if (row['Farm']?.trim()) employees[payrollId].farm = row['Farm'].trim();
                if (row['Level']?.trim()) employees[payrollId].level = row['Level'].trim();
                if (row['Rate']) employees[payrollId].hourlyRate = parseRate(row['Rate']);

                const key = `${payrollId}-${workWeekDate}`;
                if (existingDataMap.has(key)) {
                    if (overwrite && existingDataMap.get(key).hours !== hours) {
                        existingDataMap.get(key).hours = hours;
                        summary.updated++;
                    }
                } else {
                    const newRecord = {
                        payrollId, firstName: employees[payrollId].firstName, lastName: employees[payrollId].lastName,
                        workWeekDate, hours, uploadDate: new Date().toISOString()
                    };
                    timesheetData.push(newRecord);
                    existingDataMap.set(key, newRecord);
                    summary.new++;
                }
            }
            
            updateProgress(85, '重新計算薪資...');
            Object.values(employees).forEach(emp => {
                emp.workWeeks = {};
                timesheetData.filter(d => d.payrollId === emp.payrollId).forEach(d => {
                    emp.workWeeks[d.workWeekDate] = d.hours;
                });
                emp.totalHours = Object.values(emp.workWeeks).reduce((sum, h) => sum + h, 0);
                calculatePayroll(emp);
            });
            
            updateProgress(95, '儲存資料...');
            localStorage.setItem('last_update', new Date().toLocaleString('zh-TW'));
            saveLocalData();
            
            updateProgress(100, '完成！');
            showUploadSummary(summary);
            updateAllTables();
            showMessage(`✅ 上傳成功！新增 ${summary.new} 筆，更新 ${summary.updated} 筆`);
        }

        // 計算員工週期資訊
        function calculateEmployeeCycle(employee, referenceDateInput = new Date()) {
            const systemStartMonday = getMonday(new Date(SYSTEM_START_DATE));
            const currentMonday = getMonday(new Date(referenceDateInput));
            
            const totalWeeksFromStart = Math.floor((currentMonday - systemStartMonday) / (7 * 24 * 60 * 60 * 1000)) + 1;
            const currentCycle = Math.max(1, Math.ceil(totalWeeksFromStart / WEEKS_PER_CYCLE));
            
            const cycleStartWeekIndex = (currentCycle - 1) * WEEKS_PER_CYCLE;
            const cycleStartDate = new Date(systemStartMonday);
            cycleStartDate.setDate(cycleStartDate.getDate() + (cycleStartWeekIndex * 7));
            const cycleEndDate = new Date(cycleStartDate);
            cycleEndDate.setDate(cycleEndDate.getDate() + (WEEKS_PER_CYCLE * 7) - 1);
            
            let cycleHours = 0;
            for (const workWeekDateStr in employee.workWeeks) {
                const workWeekDate = parseDate(workWeekDateStr);
                if (workWeekDate >= cycleStartDate && workWeekDate <= cycleEndDate) {
                    cycleHours += (parseFloat(employee.workWeeks[workWeekDateStr]) || 0);
                }
            }
            return { currentCycle, cycleStartDate, cycleEndDate, cycleHours };
        }

        // 計算薪資
        function calculatePayroll(employee) {
            employee.payrollData = employee.payrollData || {};
            const hourlyRate = Number(employee.hourlyRate) || 0;
            
            // 計算所有歷史週期的加班費
            employee.accumulatedOvertimePay = 0;
            const systemStartMonday = getMonday(new Date(SYSTEM_START_DATE));
            const today = new Date();
            const totalWeeksSinceStart = Math.floor((today - systemStartMonday) / (7 * 24 * 60 * 60 * 1000)) + 1;
            const totalCycles = Math.ceil(totalWeeksSinceStart / WEEKS_PER_CYCLE);

            for (let c = 1; c <= totalCycles; c++) {
                const cycleStartWeekIndex = (c - 1) * WEEKS_PER_CYCLE;
                const cycleStartDate = new Date(systemStartMonday);
                cycleStartDate.setDate(systemStartMonday.getDate() + cycleStartWeekIndex * 7);
                const cycleEndDate = new Date(cycleStartDate);
                cycleEndDate.setDate(cycleEndDate.getDate() + (WEEKS_PER_CYCLE * 7) - 1);

                let thisCycleHours = 0;
                for (const wwDateStr in employee.workWeeks) {
                    const wwDate = parseDate(wwDateStr);
                    if (wwDate >= cycleStartDate && wwDate <= cycleEndDate) {
                        thisCycleHours += (parseFloat(employee.workWeeks[wwDateStr]) || 0);
                    }
                }
                
                if (thisCycleHours > REGULAR_HOURS_THRESHOLD) {
                    employee.accumulatedOvertimePay += (thisCycleHours - REGULAR_HOURS_THRESHOLD) * hourlyRate;
                }
            }

            // 計算當前週期的薪資
            const currentCycleInfo = calculateEmployeeCycle(employee);
            employee.payrollData.cycleHours = currentCycleInfo.cycleHours;
            if (currentCycleInfo.cycleHours > REGULAR_HOURS_THRESHOLD) {
                employee.payrollData.overtimePay = (currentCycleInfo.cycleHours - REGULAR_HOURS_THRESHOLD) * hourlyRate;
            } else {
                employee.payrollData.overtimePay = 0;
            }
            
            // 計算未支付加班費
            const totalPaid = Object.values(paymentHistory[employee.payrollId] || {}).reduce((sum, p) => sum + p.amount, 0);
            employee.unpaidOvertimePay = Math.max(0, employee.accumulatedOvertimePay - totalPaid);
        }

        // 記錄加班費支付
        function recordOvertimePayment(payrollId, amount, paymentDate, notes) {
            if (!paymentHistory[payrollId]) paymentHistory[payrollId] = {};
            const paymentId = `payment_${Date.now()}`;
            paymentHistory[payrollId][paymentId] = {
                amount: parseFloat(amount), paymentDate, notes,
                recordedAt: new Date().toISOString()
            };
            if (employees[payrollId]) calculatePayroll(employees[payrollId]);
            saveLocalData();
            updateAllTables();
        }

        // 顯示支付對話框
        function showPaymentDialog(payrollId) {
            const employee = employees[payrollId];
            if (!employee) return;
            
            const dialog = document.createElement('div');
            dialog.className = 'confirm-dialog active';
            dialog.innerHTML = `
                <div class="confirm-content">
                    <h3>💰 記錄加班費支付</h3>
                    <p><strong>員工：</strong>${employee.firstName} ${employee.lastName}</p>
                    <p><strong>待支付總額：</strong>${employee.unpaidOvertimePay.toFixed(2)}</p>
                    <div style="margin: 20px 0;">
                        <label for="payment-amount"><strong>支付金額：</strong></label>
                        <input type="number" id="payment-amount" step="0.01" min="0" 
                               max="${employee.unpaidOvertimePay.toFixed(2)}" 
                               value="${employee.unpaidOvertimePay.toFixed(2)}"
                               style="padding: 5px;">
                    </div>
                    <div style="margin: 20px 0;">
                        <label for="payment-date"><strong>支付日期：</strong></label>
                        <input type="date" id="payment-date" value="${new Date().toISOString().split('T')[0]}" style="padding: 5px;">
                    </div>
                    <div class="confirm-buttons">
                        <button class="btn-confirm" onclick="confirmPayment('${payrollId}')">確認支付</button>
                        <button class="btn-cancel" onclick="closeDialog()">取消</button>
                    </div>
                </div>`;
            document.body.appendChild(dialog);
        }

        // 確認支付
        function confirmPayment(payrollId) {
            const amount = parseFloat(document.getElementById('payment-amount').value);
            const date = document.getElementById('payment-date').value;
            if (isNaN(amount) || amount <= 0) { alert('請輸入有效的支付金額'); return; }
            if (amount > employees[payrollId].unpaidOvertimePay) { alert('支付金額不能超過未支付總額'); return; }
            recordOvertimePayment(payrollId, amount, date, '');
            closeDialog();
            showMessage(`✅ 已記錄 ${employees[payrollId].firstName} 的加班費支付`);
        }

        // 顯示支付歷史
        function showPaymentHistory(payrollId) {
            const employee = employees[payrollId];
            const payments = paymentHistory[payrollId];
            if (!employee || !payments) { showMessage('該員工沒有支付記錄', 'warning'); return; }
            
            const dialog = document.createElement('div');
            dialog.className = 'confirm-dialog active';
            const paymentList = Object.values(payments).map(p => `
                <div style="border-bottom: 1px solid #eee; padding: 10px 0;">
                    <div><strong>金額：</strong>${p.amount.toFixed(2)} | <strong>日期：</strong>${p.paymentDate}</div>
                </div>`).join('');
            const totalPaid = Object.values(payments).reduce((sum, p) => sum + p.amount, 0);
            
            dialog.innerHTML = `
                <div class="confirm-content">
                    <h3>📋 支付歷史: ${employee.firstName} ${employee.lastName}</h3>
                    <p><strong>總支付金額：</strong><span class="money">${totalPaid.toFixed(2)}</span></p>
                    <div style="max-height: 300px; overflow-y: auto; margin: 20px 0;">${paymentList}</div>
                    <div class="confirm-buttons"><button class="btn-cancel" onclick="closeDialog()">關閉</button></div>
                </div>`;
            document.body.appendChild(dialog);
        }
        
        // 取得所有可用的週期選項
        function getAllAvailableCycles() {
            const systemStartMonday = getMonday(new Date(SYSTEM_START_DATE));
            const today = new Date();
            const totalWeeksSinceStart = Math.floor((today - systemStartMonday) / (7 * 24 * 60 * 60 * 1000)) + 1;
            const totalCycles = Math.max(1, Math.ceil(totalWeeksSinceStart / WEEKS_PER_CYCLE));
            
            const cycles = [];
            for (let c = 1; c <= totalCycles; c++) {
                const cycleStartDate = new Date(systemStartMonday);
                cycleStartDate.setDate(cycleStartDate.getDate() + ((c - 1) * WEEKS_PER_CYCLE * 7));
                const cycleEndDate = new Date(cycleStartDate);
                cycleEndDate.setDate(cycleEndDate.getDate() + (WEEKS_PER_CYCLE * 7) - 1);
                
                cycles.push({
                    cycle: c,
                    startWeek: ((c - 1) * WEEKS_PER_CYCLE) + 1,
                    endWeek: c * WEEKS_PER_CYCLE,
                    startDate: cycleStartDate,
                    endDate: cycleEndDate
                });
            }
            return cycles.reverse(); // 讓最新週期在最前面
        }

        // 取得篩選後的員工清單
        function getFilteredEmployees() {
            const farmFilter = document.getElementById('farm-filter')?.value;
            const levelFilter = document.getElementById('level-filter')?.value;
            const employeeFilter = document.getElementById('employee-filter')?.value;
            const cycleFilter = document.getElementById('cycle-filter')?.value;
            
            return Object.values(employees).filter(emp => {
                if (farmFilter && emp.farm !== farmFilter) return false;
                if (levelFilter && emp.level !== levelFilter) return false;
                if (employeeFilter && emp.payrollId !== employeeFilter) return false;
                if (cycleFilter) {
                    const cycleInfo = calculateEmployeeCycle(emp, getAllAvailableCycles().find(c => c.cycle.toString() === cycleFilter).startDate);
                    if (cycleInfo.cycleHours <= 0) return false;
                }
                return true;
            });
        }

        // 更新篩選選項
        function updateFilterOptions() {
            const farmFilter = document.getElementById('farm-filter');
            const levelFilter = document.getElementById('level-filter');
            const employeeFilter = document.getElementById('employee-filter');
            const cycleFilter = document.getElementById('cycle-filter');
            if (!farmFilter) return;

            const farms = new Set(Object.values(employees).map(e => e.farm).filter(Boolean));
            const levels = new Set(Object.values(employees).map(e => e.level).filter(Boolean));
            const empList = Object.values(employees).map(e => ({ id: e.payrollId, name: `${e.firstName} ${e.lastName}` })).sort((a,b) => a.name.localeCompare(b.name));
            
            const updateSelect = (select, options, currentVal) => {
                select.innerHTML = `<option value="">所有${select.id.includes('farm') ? '農場' : select.id.includes('level') ? '職級' : '員工'}</option>`;
                options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = typeof opt === 'object' ? opt.id : opt;
                    option.textContent = typeof opt === 'object' ? `${opt.name} (${opt.id})` : opt;
                    if (option.value === currentVal) option.selected = true;
                    select.appendChild(option);
                });
            };

            updateSelect(farmFilter, [...farms].sort(), farmFilter.value);
            updateSelect(levelFilter, [...levels].sort(), levelFilter.value);
            updateSelect(employeeFilter, empList, employeeFilter.value);

            const currentCycle = cycleFilter.value;
            cycleFilter.innerHTML = '<option value="">所有週期</option>';
            getAllAvailableCycles().forEach(c => {
                const option = document.createElement('option');
                option.value = c.cycle.toString();
                option.textContent = `週期${c.cycle} (W${c.startWeek}-W${c.endWeek}): ${toLocalDateString(c.startDate)} - ${toLocalDateString(c.endDate)}`;
                if (c.cycle.toString() === currentCycle) option.selected = true;
                cycleFilter.appendChild(option);
            });
        }
        
        // 清除篩選條件
        function clearFilters() {
            ['farm-filter', 'level-filter', 'employee-filter', 'cycle-filter'].forEach(id => document.getElementById(id).value = '');
            updateAllTables();
        }

        // 切換詳細資訊顯示
        function toggleDetails(button, payrollId) {
            const detailsRow = document.getElementById(`details-${payrollId}`);
            detailsRow.classList.toggle('is-open');
            button.textContent = detailsRow.classList.contains('is-open') ? '-' : '+';
        }

        // =======================================================
        // ==               MODIFICATION START                  ==
        // =======================================================
        
        // 用於格式化財報數字，將 0 或 null 轉為 '-'
        function formatFinancialNumber(num) {
            const value = Number(num);
            if (isNaN(value) || Math.abs(value) < 0.005) { // 檢查數字是否四捨五入後為 0.00
                return '-';
            }
            return value.toFixed(2);
        }

        // 更新員工總覽表格
        function updateOverviewTable() {
            const container = document.getElementById('overview-table-container');
            if (Object.keys(employees).length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #777; margin-top: 30px;">尚未載入員工資料。</p>';
                return;
            }
            
            updateFilterOptions();
            const filteredEmployees = getFilteredEmployees();
            
            // --- 獲取週期篩選器的日期範圍 ---
            const cycleFilterValue = document.getElementById('cycle-filter')?.value || '';
            let cycleStartDate, cycleEndDate;
            if (cycleFilterValue) {
                const allCycles = getAllAvailableCycles();
                const selectedCycleData = allCycles.find(c => c.cycle.toString() === cycleFilterValue);
                if (selectedCycleData) {
                    cycleStartDate = selectedCycleData.startDate;
                    cycleEndDate = selectedCycleData.endDate;
                }
            }

            // 更新週期進度卡片
            const cycleSummaryCard = document.getElementById('cycle-summary-card');
            const refDate = cycleStartDate || new Date();
            const cycleInfoForCard = calculateEmployeeCycle({}, refDate);
            const totalWeeksFromStartForCard = Math.floor((getMonday(refDate) - getMonday(new Date(SYSTEM_START_DATE))) / (7 * 24 * 60 * 60 * 1000)) + 1;
            const weekInCycleForCard = ((totalWeeksFromStartForCard - 1) % WEEKS_PER_CYCLE) + 1;
            const progressPercentage = (weekInCycleForCard / WEEKS_PER_CYCLE) * 100;
            const startWeekForCard = ((cycleInfoForCard.currentCycle - 1) * WEEKS_PER_CYCLE) + 1;
            cycleSummaryCard.innerHTML = `
                <h4 style="margin: 0 0 10px 0; color: #667eea;">📅 ${cycleFilterValue ? '篩選' : '當前'}季節週期資訊</h4>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span><strong>週期 ${cycleInfoForCard.currentCycle} (W${startWeekForCard}-W${startWeekForCard+7})</strong>: ${toLocalDateString(cycleInfoForCard.startDate)} - ${toLocalDateString(cycleInfoForCard.endDate)}</span>
                    <span style="font-weight:bold;">第 ${weekInCycleForCard} 週 (${progressPercentage.toFixed(1)}%)</span>
                </div>`;
            cycleSummaryCard.style.display = 'block';

            if (filteredEmployees.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #777; margin-top: 30px;">沒有符合篩選條件的員工資料。</p>';
                document.getElementById('overview-summary-cards').innerHTML = '';
                return;
            }

            let tableHTML = `
                <table class="employee-table">
                    <thead><tr>
                        <th></th><th>員工編號</th><th>姓名</th><th>農場</th><th>職級</th><th>時薪</th>
                        <th>季節總工時</th><th>週期工時</th><th>週期加班費</th>
                        <th>累積加班費</th><th>支付狀態</th><th>距OT門檻</th>
                    </tr></thead><tbody>`;
            
            let totalHistoricalHours = 0, totalCycleHours = 0, totalUnpaidOvertimePay = 0;
            let totalCycleOvertimePay = 0, totalAccumulatedOvertimePay = 0; // 新增的總計變數
            
            filteredEmployees.sort((a, b) => a.payrollId.localeCompare(b.payrollId)).forEach(employee => {
                const fullName = `${employee.firstName} ${employee.lastName}`.trim();
                const cycleInfo = calculateEmployeeCycle(employee, refDate);
                
                const currentTotalHours = employee.totalHours || 0;
                const currentCycleHours = cycleInfo.cycleHours;
                const cycleOvertimePay = employee.payrollData?.overtimePay || 0;
                const accumulatedOvertimePay = employee.accumulatedOvertimePay || 0;
                const unpaidOvertimePay = employee.unpaidOvertimePay || 0;
                const otThresholdDifference = REGULAR_HOURS_THRESHOLD - currentCycleHours;
                
                // 累加總計
                totalHistoricalHours += currentTotalHours;
                totalCycleHours += currentCycleHours;
                totalUnpaidOvertimePay += unpaidOvertimePay;
                totalCycleOvertimePay += cycleOvertimePay;
                totalAccumulatedOvertimePay += accumulatedOvertimePay;

                // --- 組裝支付狀態欄位 ---
                let paymentStatusCell = '';
                if (paymentHistory[employee.payrollId]) paymentStatusCell += `<button class="btn-edit" onclick="showPaymentHistory('${employee.payrollId}')" style="font-size:10px;padding:2px 6px;margin-right:5px;">歷史</button>`;
                if (unpaidOvertimePay > 0) paymentStatusCell += `<button class="btn-payment" onclick="showPaymentDialog('${employee.payrollId}')" style="font-size:10px;padding:2px 6px;">支付</button>`;
                if (paymentStatusCell === '') paymentStatusCell = '-';

                // --- 篩選工時明細 ---
                let workWeeks = Object.entries(employee.workWeeks || {}).sort((a, b) => new Date(a[0]) - new Date(b[0]));
                if (cycleStartDate && cycleEndDate) {
                    workWeeks = workWeeks.filter(([dateStr, _]) => {
                        const workWeekDate = parseDate(dateStr);
                        return workWeekDate >= cycleStartDate && workWeekDate <= cycleEndDate;
                    });
                }

                let detailsTableHTML = '<div style="text-align:center;">無工時記錄</div>';
                if (workWeeks.length > 0) {
                    detailsTableHTML = `<table class="details-table"><thead><tr><th>工作週 (週一)</th><th>工時</th><th>是否超時</th><th>操作</th></tr></thead><tbody>
                        ${workWeeks.map(([date, hours]) => {
                            const isOvertime = hours > WEEKLY_HOURS_THRESHOLD;
                            return `<tr data-work-week="${date}">
                                <td>${parseDate(date).toLocaleDateString('en-CA')}</td>
                                <td class="${isOvertime ? 'weekly-overtime' : ''}"><span class="hours-display">${hours}</span><input type="number" class="hours-input" value="${hours}" style="display:none;"></td>
                                <td>${isOvertime ? `<span class="status-overtime">${(hours - WEEKLY_HOURS_THRESHOLD).toFixed(1)}h</span>` : '<span class="status-normal">正常</span>'}</td>
                                <td><button class="btn-edit" onclick="editHours(this, '${employee.payrollId}', '${date}')">編輯</button><button class="btn-delete" onclick="deleteWorkWeek('${employee.payrollId}', '${date}')">刪除</button></td>
                            </tr>`;
                        }).join('')}
                    </tbody></table>
                    <div class="edit-actions" style="display:none;" id="edit-actions-${employee.payrollId}"><button class="btn-save" onclick="saveAllEdits('${employee.payrollId}')">儲存</button><button class="btn-cancel-edit" onclick="cancelAllEdits('${employee.payrollId}')">取消</button></div>`;
                }
                
                tableHTML += `
                    <tr class="main-row">
                        <td><button class="toggle-details-btn" onclick="toggleDetails(this, '${employee.payrollId}')">+</button></td>
                        <td><strong>${employee.payrollId}</strong></td><td>${fullName}</td><td>${employee.farm || '-'}</td><td>${employee.level || '-'}</td>
                        <td class="money">${formatFinancialNumber(employee.hourlyRate)}</td>
                        <td><strong>${formatFinancialNumber(currentTotalHours)}</strong></td>
                        <td><strong>${formatFinancialNumber(currentCycleHours)}</strong></td>
                        <td class="money ${cycleOvertimePay > 0 ? 'status-overtime' : ''}">${formatFinancialNumber(cycleOvertimePay)}</td>
                        <td class="money ${accumulatedOvertimePay > 0 ? 'status-overtime' : ''}">${formatFinancialNumber(accumulatedOvertimePay)}</td>
                        <td>${paymentStatusCell}</td>
                        <td class="${otThresholdDifference < 0 ? 'status-overtime' : ''}">${formatFinancialNumber(otThresholdDifference)}</td>
                    </tr>
                    <tr class="details-row" id="details-${employee.payrollId}"><td colspan="12">${detailsTableHTML}</td></tr>`;
            });
            
            tableHTML += `</tbody><tfoot>
                <tr style="background:#f0f0f0;font-weight:bold;text-align:center;">
                    <td colspan="6" style="text-align:right;">總計</td>
                    <td>${formatFinancialNumber(totalHistoricalHours)}</td>
                    <td>${formatFinancialNumber(totalCycleHours)}</td>
                    <td class="money">${formatFinancialNumber(totalCycleOvertimePay)}</td>
                    <td class="money">${formatFinancialNumber(totalAccumulatedOvertimePay)}</td>
                    <td>-</td><td>-</td>
                </tr></tfoot></table>`;
            container.innerHTML = tableHTML;
            
            // 更新總覽卡片
            document.getElementById('overview-summary-cards').innerHTML = `
                <div class="summary-card"><h3>${filteredEmployees.length}</h3><p>篩選後員工數</p></div>
                <div class="summary-card"><h3>${filteredEmployees.filter(e => calculateEmployeeCycle(e, refDate).cycleHours > REGULAR_HOURS_THRESHOLD).length}</h3><p>超過304小時</p></div>
                <div class="summary-card"><h3>${totalCycleHours.toFixed(0)}</h3><p>篩選週期總工時</p></div>
                <div class="summary-card"><h3>${totalUnpaidOvertimePay.toFixed(0)}</h3><p>未支付加班費</p></div>`;
        }

        // =======================================================
        // ==                MODIFICATION END                   ==
        // =======================================================

        // 更新所有表格
        function updateAllTables() {
            updateOverviewTable();
        }

        // 匯出員工總覽報告
        async function exportOverview() {
            if (Object.keys(employees).length === 0) return showMessage('沒有資料可以匯出', 'error');
            setButtonLoading('exportOverview', true, '匯出中...');
            
            const filteredEmployees = getFilteredEmployees();
            let csvContent = '員工編號,姓名,農場,職級,時薪,季節總工時,週期工時,週期加班費,累積加班費,待支付加班費,距OT門檻\n';
            filteredEmployees.forEach(emp => {
                const cycleInfo = calculateEmployeeCycle(emp, document.getElementById('cycle-filter')?.value ? getAllAvailableCycles().find(c => c.cycle.toString() === document.getElementById('cycle-filter').value).startDate : new Date());
                csvContent += `${emp.payrollId},"${emp.firstName} ${emp.lastName}",${emp.farm||''},${emp.level||''},${emp.hourlyRate||0},${emp.totalHours||0},${cycleInfo.cycleHours},${emp.payrollData.overtimePay||0},${emp.accumulatedOvertimePay||0},${emp.unpaidOvertimePay||0},${REGULAR_HOURS_THRESHOLD - cycleInfo.cycleHours}\n`;
            });
            downloadCSV(csvContent, `員工報告_${new Date().toLocaleDateString('en-CA')}.csv`);
            setButtonLoading('exportOverview', false, '📥 匯出完整報告 (CSV)');
        }

        // 下載 CSV 檔案
        function downloadCSV(content, filename) {
            const blob = new Blob(['\ufeff' + content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 設定按鈕載入狀態
        function setButtonLoading(buttonId, isLoading, loadingText = '處理中...') {
            const button = document.getElementById(buttonId);
            if (!button) return;
            const originalText = button.dataset.originalText || button.textContent.trim();
            button.disabled = isLoading;
            if (isLoading) {
                button.dataset.originalText = originalText;
                button.innerHTML = `<span class="spinner"></span> ${loadingText}`;
            } else {
                button.innerHTML = originalText;
            }
        }

        // 顯示上傳摘要
        function showUploadSummary(summary) {
            const container = document.getElementById('timesheet-file-info');
            container.style.display = 'block';
            container.className = 'upload-summary';
            container.innerHTML = `
                <h3>📊 上傳摘要</h3>
                <div class="summary-item"><span>總處理記錄：</span><span class="highlight">${summary.total}</span></div>
                <div class="summary-item"><span>新增記錄：</span><span class="highlight">${summary.new}</span></div>
                <div class="summary-item"><span>更新記錄：</span><span class="highlight">${summary.updated}</span></div>
                <div class="summary-item"><span>涉及員工數：</span><span class="highlight">${summary.employees.size}</span></div>`;
        }

        // 顯示驗證結果
        function showValidationResults(result) {
            const container = document.getElementById('validation-results');
            let html = '';
            result.success.forEach(msg => html += `<div class="validation-item validation-success">${msg}</div>`);
            result.warnings.forEach(msg => html += `<div class="validation-item validation-warning">${msg}</div>`);
            result.errors.forEach(msg => html += `<div class="validation-item validation-error">${msg}</div>`);
            container.innerHTML = html;
        }

        // 讀取檔案內容
        function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = () => reject(new Error('文件讀取失敗'));
                reader.readAsText(file, 'UTF-8');
            });
        }

        // 解析 CSV 文件
        function parseCSV(csvText) {
            const lines = csvText.trim().split(/\r?\n/);
            if (lines.length < 2) return [];
            const headers = lines[0].split(',').map(h => h.trim());
            return lines.slice(1).map(line => {
                const values = line.split(',');
                return headers.reduce((obj, header, index) => {
                    obj[header] = values[index]?.trim() || '';
                    return obj;
                }, {});
            });
        }

        // 編輯工時功能
        function editHours(button, payrollId, workWeekDate) {
            const row = button.closest('tr');
            const display = row.querySelector('.hours-display');
            const input = row.querySelector('.hours-input');
            display.style.display = 'none';
            input.style.display = 'inline-block';
            input.focus();
            document.getElementById(`edit-actions-${payrollId}`).style.display = 'block';
        }

        function cancelAllEdits(payrollId) {
            document.querySelectorAll(`#details-table-${payrollId} tbody tr`).forEach(row => {
                const display = row.querySelector('.hours-display');
                const input = row.querySelector('.hours-input');
                input.value = display.textContent;
                display.style.display = 'inline';
                input.style.display = 'none';
            });
            document.getElementById(`edit-actions-${payrollId}`).style.display = 'none';
        }

        function saveAllEdits(payrollId) {
            let hasChanges = false;
            document.querySelectorAll(`#details-table-${payrollId} tbody tr`).forEach(row => {
                const input = row.querySelector('.hours-input');
                if (input.style.display === 'none') return;
                
                const workWeekDate = row.dataset.workWeek;
                const newHours = parseFloat(input.value);
                const record = timesheetData.find(d => d.payrollId === payrollId && d.workWeekDate === workWeekDate);
                
                if (record && !isNaN(newHours) && record.hours !== newHours) {
                    record.hours = newHours;
                    employees[payrollId].workWeeks[workWeekDate] = newHours;
                    hasChanges = true;
                }
            });

            if (hasChanges) {
                calculatePayroll(employees[payrollId]);
                saveLocalData();
                updateAllTables();
                showMessage(`✅ 已成功修改工時記錄！`);
            }
            document.getElementById(`edit-actions-${payrollId}`).style.display = 'none';
        }

        function deleteWorkWeek(payrollId, workWeekDate) {
            const employee = employees[payrollId];
            if (!employee) return;
            
            if (confirm(`⚠️ 確定要刪除 ${employee.firstName} 在 ${workWeekDate} 的工時記錄嗎？`)) {
                const recordIndex = timesheetData.findIndex(item => item.payrollId === payrollId && item.workWeekDate === workWeekDate);
                if (recordIndex !== -1) timesheetData.splice(recordIndex, 1);
                
                delete employee.workWeeks[workWeekDate];
                employee.totalHours = Object.values(employee.workWeeks).reduce((sum, h) => sum + h, 0);
                calculatePayroll(employee);
                
                saveLocalData();
                updateAllTables();
                showMessage(`🗑️ 已刪除工時記錄`, 'warning');
            }
        }
    </script>
</body>
</html>
