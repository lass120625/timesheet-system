<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工時管理系統</title>
    <style>
        /* --- 全域 & 佈局優化 --- */
        :root {
            --primary-color: #5D5FEF;
            --primary-color-dark: #4a4dbe;
            --secondary-color: #6c757d;
            --success-color: #198754;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --light-bg-color: #f8f9fa;
            --border-color: #dee2e6;
            --text-color: #212529;
            --text-muted-color: #6c757d;
            --font-family-sans-serif: 'Microsoft YaHei', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            --box-shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --border-radius: 0.5rem; /* 8px */
            --border-radius-lg: 1rem; /* 16px */
        }
        
        body {
            font-family: var(--font-family-sans-serif);
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            background-color: var(--light-bg-color);
            min-height: 100vh;
            color: var(--text-color);
        }

        .container {
            background: white;
            border-radius: var(--border-radius-lg);
            padding: 2.5rem;
            box-shadow: var(--box-shadow-lg);
        }

        h1 {
            color: var(--text-color);
            text-align: center;
            margin-bottom: 0.5rem;
            font-size: 2.25rem;
            font-weight: 700;
        }

        /* --- 訊息提示匡優化 (Toast Notifications) --- */
        #messages {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            width: 350px;
        }
        .success-message, .error-message, .warning-message {
            padding: 1rem;
            border-radius: var(--border-radius);
            margin: 0 0 1rem 0;
            border-left: 5px solid;
            opacity: 1;
            transition: all 0.5s ease;
            box-shadow: var(--box-shadow-lg);
            background-color: #fff;
        }
        .success-message { color: #0a3622; border-left-color: var(--success-color); }
        .error-message { color: #58151c; border-left-color: var(--danger-color); }
        .warning-message { color: #664d03; border-left-color: var(--warning-color); }
        .message-fadeout { opacity: 0; transform: translateX(20px); }

        /* --- 上傳區塊優化 --- */
        .upload-section {
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius);
            padding: 2.5rem;
            text-align: center;
            margin-bottom: 2rem;
            background: #fdfdff;
            transition: all 0.3s ease;
        }
        .upload-section:hover {
            border-color: var(--primary-color);
            background: #fafaff;
        }
        .upload-section.dragover {
            border-color: var(--success-color);
            background: #f0fff4;
            transform: scale(1.01);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.1);
        }
        .upload-section h3 { font-size: 1.5rem; margin-top: 0; color: #343a40; }
        .upload-section p { color: var(--text-muted-color); }

        .file-input { display: none; }

        /* --- 按鈕樣式優化 --- */
        .upload-btn, .action-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.8rem 1.75rem;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            margin: 0.5rem;
            transition: all 0.2s ease;
            box-shadow: var(--box-shadow);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .upload-btn:hover, .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(93, 95, 239, 0.2);
            background: var(--primary-color-dark);
        }
        .upload-btn:disabled, .action-btn:disabled {
            background: #ccc; cursor: not-allowed; transform: none; box-shadow: none;
        }
        .btn-export { background: #198754; } .btn-export:hover { background: #157347; box-shadow: 0 6px 12px rgba(25, 135, 84, 0.2); }
        .btn-import { background: #0d6efd; } .btn-import:hover { background: #0b5ed7; box-shadow: 0 6px 12px rgba(13, 110, 253, 0.2); }
        .btn-clear { background: #dc3545; } .btn-clear:hover { background: #bb2d3b; box-shadow: 0 6px 12px rgba(220, 53, 69, 0.2); }

        .file-info { margin-top: 1rem; padding: 0.75rem; background: #e9ecef; border-radius: var(--border-radius); font-size: 0.9rem; }

        /* --- 資料管理區塊 --- */
        .data-section {
            background: var(--light-bg-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 2.5rem;
            text-align: center;
        }
        .data-section h3 { color: var(--text-color); margin: 0 0 1rem 0; font-size: 1.5rem; }
        .data-section p { margin-top:0; color: var(--text-muted-color); }
        .data-buttons { display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; margin-top: 1.5rem; }
        
        /* --- 分頁 (Tabs) 優化 --- */
        .tabs {
            display: flex;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
            justify-content: center;
            gap: 1.5rem;
        }
        .tab {
            padding: 1rem 1.25rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-weight: 500;
            color: var(--text-muted-color);
            font-size: 1.1rem;
        }
        .tab.active {
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
            font-weight: 600;
        }
        .tab:hover:not(.active) { color: var(--primary-color); }
        .tab-content { display: none; padding-top: 1rem; }
        .tab-content.active { display: block; }

        /* --- 表格 (Tables) 優化 --- */
        .employee-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
            font-size: 0.9rem;
            text-align: center;
            box-shadow: var(--box-shadow);
            border-radius: var(--border-radius);
            overflow: hidden;
        }
        .employee-table th, .employee-table td {
            border-bottom: 1px solid var(--border-color);
            padding: 12px 10px;
            text-align: center;
            vertical-align: middle;
        }
        .employee-table th {
            background: var(--light-bg-color);
            color: var(--text-color);
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .employee-table tr:last-child td { border-bottom: none; }
        .employee-table tr:nth-child(even) { background: #fdfdff; }
        .employee-table tr.main-row:hover { background: #f1f3ff; }
        .employee-table tfoot tr { background: #f1f3f9 !important; }
        .employee-table tfoot td { font-weight: bold; color: var(--text-color); }

        .toggle-details-btn {
            cursor: pointer;
            background: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 26px; height: 26px;
            font-weight: bold; font-size: 16px;
            line-height: 26px; text-align: center;
            transition: background-color 0.2s, transform 0.2s;
        }
        .toggle-details-btn:hover { background: #5a6268; transform: scale(1.1); }
        .details-row { display: none; }
        .details-row.is-open { display: table-row; }
        .details-row td { background-color: #f7f8fc !important; padding: 1rem !important; }
        .details-table {
            width: 100%; margin: 0 auto; border-collapse: collapse; background: white;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.04); border-radius: var(--border-radius);
        }
        .details-table th, .details-table td { border: 1px solid #e9ecef; padding: 10px; text-align: center; }
        .details-table th { background: #6c757d; color: white; font-size: 0.8rem; }
        .details-table input { width: 80px; padding: 6px; text-align: center; border: 1px solid var(--border-color); border-radius: 4px; font-size: 14px; }
        .details-table input:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 3px rgba(93, 95, 239, 0.15); }

        /* --- 小按鈕優化 --- */
        .btn-save, .btn-cancel-edit, .btn-edit, .btn-delete, .btn-payment {
            border: none;
            padding: 5px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
        }
        .btn-save:hover, .btn-cancel-edit:hover, .btn-edit:hover, .btn-delete:hover, .btn-payment:hover { transform: translateY(-1px); }
        .btn-save { background: var(--success-color); color: white; } .btn-save:hover { background: #146c43; }
        .btn-cancel-edit { background: var(--secondary-color); color: white; } .btn-cancel-edit:hover { background: #5a6268; }
        .btn-edit { background: #0d6efd; color: white; margin-left: 10px; } .btn-edit:hover { background: #0b5ed7; }
        .btn-delete { background: var(--danger-color); color: white; margin-left: 5px; } .btn-delete:hover { background: #bb2d3b; }
        .btn-payment { background: var(--warning-color); color: var(--text-color); margin-left: 5px; font-weight: bold; } .btn-payment:hover { background: #ffca2c; }
        .btn-payment.paid { background: var(--success-color); color: white; } .btn-payment.paid:hover { background: #146c43; }
        
        .weekly-overtime { color: #fd7e14; font-weight: bold; }
        .status-normal { color: #198754; font-weight: bold; }
        .status-overtime { color: #dc3545; font-weight: bold; }
        .status-paid { color: #198754; font-weight: bold; }
        
        /* --- 進度條 & 總覽卡片 --- */
        .progress-bar { width: 100%; height: 10px; background: #e9ecef; border-radius: 5px; overflow: hidden; margin: 1rem 0 0.5rem; box-shadow: inset 0 1px 2px rgba(0,0,0,0.07); }
        .progress-fill { height: 100%; background: var(--primary-color); width: 0%; transition: width 0.4s ease-out; }
        #progress-text { text-align: center; font-weight: 500; color: var(--text-muted-color); margin-top: 5px; font-size: 0.9rem; }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }
        .summary-card {
            background: white;
            color: var(--text-color);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            text-align: left;
            box-shadow: var(--box-shadow);
            border: 1px solid var(--border-color);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .summary-card:hover { transform: translateY(-5px); box-shadow: var(--box-shadow-lg); }
        .summary-card h3 { margin: 0 0 0.5rem 0; font-size: 2rem; font-weight: 700; color: var(--primary-color); }
        .summary-card p { margin: 0; font-size: 0.9rem; color: var(--text-muted-color); }
        
        /* --- 格式說明區塊 --- */
        .format-info {
            background: var(--light-bg-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin: 1.5rem 0;
            font-size: 0.95rem;
        }
        .format-info h4 { margin: 0 0 1rem 0; color: var(--primary-color); font-size: 1.25rem; font-weight: 600; }
        .format-example { background: #e9ecef; padding: 1rem; border-radius: var(--border-radius); font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace; margin: 0.5rem 0 1rem; white-space: pre-wrap; word-break: break-all; line-height: 1.6; font-size: 0.85rem; }
        .format-info ul { padding-left: 20px; margin-top: 1rem; color: var(--text-muted-color); }
        .format-info li { margin-bottom: 0.5rem; }

        /* --- 篩選器 & 確認對話框 --- */
        .filter-controls { display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; }
        .filter-controls label { font-weight: 500; }
        .filter-controls select {
            padding: 0.5rem 0.75rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            background-color: white;
            font-size: 0.9rem;
        }
        .filter-controls button { padding: 0.5rem 1rem; background: var(--secondary-color); color: white; border-radius: var(--border-radius); box-shadow: none; font-size: 0.9rem;}
        
        .confirm-dialog {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .confirm-dialog.active { opacity: 1; visibility: visible; }
        .confirm-content {
            background: white; padding: 2.5rem; border-radius: var(--border-radius-lg);
            width: 90%;
            max-width: 600px; max-height: 90%; overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            transform: scale(0.95); transition: transform 0.3s ease;
        }
        .confirm-dialog.active .confirm-content { transform: scale(1); }
        .confirm-content h3 { font-size: 1.75rem; margin-bottom: 1rem; text-align: center; color: var(--text-color); }
        .confirm-content p { margin-bottom: 1.5rem; text-align: center; font-size: 1rem; color: var(--text-muted-color); line-height: 1.6; }
        .confirm-buttons { display: flex; gap: 1rem; justify-content: center; margin-top: 1.5rem; }
        .btn-confirm, .btn-cancel { border: none; padding: 0.75rem 1.5rem; border-radius: var(--border-radius); cursor: pointer; font-weight: bold; transition: all 0.2s; }
        .btn-confirm { background: var(--success-color); color: white; } .btn-confirm:hover { background: #146c43; transform: translateY(-2px); }
        .btn-cancel { background: var(--danger-color); color: white; } .btn-cancel:hover { background: #bb2d3b; transform: translateY(-2px); }

        /* --- Dialog-specific Form --- */
        .dialog-form { display: flex; flex-direction: column; gap: 1rem; }
        .dialog-form label { font-weight: 500; margin-bottom: -0.5rem; }
        .dialog-form input, .dialog-form select, .dialog-form textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            box-sizing: border-box;
        }
        .dialog-form input:focus, .dialog-form select:focus, .dialog-form textarea:focus {
             border-color: var(--primary-color);
             outline: none;
             box-shadow: 0 0 0 3px rgba(93, 95, 239, 0.15);
        }

        /* --- 其他輔助樣式 --- */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3); border-top: 3px solid #fff;
            border-radius: 50%; width: 16px; height: 16px;
            animation: spin 1s linear infinite; display: inline-block;
            vertical-align: middle; margin-right: 5px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .money { color: var(--success-color); font-weight: bold; }

    </style>
</head>
<body>
    <div class="container">
        <h1>📊 工時管理系統</h1>
        <div style="text-align: center; margin-bottom: 2.5rem; color: var(--text-muted-color);">
            <small>🔄 本地儲存 | 📊 即時計算 | 💾 檔案管理</small>
        </div>
        
        <div class="data-section">
            <h3>💾 資料管理</h3>
            <p>所有資料將安全地儲存在您的瀏覽器本地。除非手動清除，否則資料將會保留。</p>
            <div class="data-buttons">
                <button class="action-btn btn-export" onclick="exportAllData()">📤 匯出完整資料</button>
                <button class="action-btn btn-import" onclick="document.getElementById('data-import').click()">📥 匯入資料檔</button>
                <button class="action-btn btn-clear" onclick="clearAllData()">🗑️ 清除所有資料</button>
            </div>
            <input type="file" id="data-import" class="file-input" accept=".json" onchange="importData(event)">
            <div id="data-status" style="margin-top: 1.5rem; padding: 0.75rem; background: #e9ecef; border-radius: var(--border-radius); font-size: 0.9rem; display: none;">
                <strong>資料狀態：</strong><span id="data-status-text">載入中...</span>
            </div>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('upload')">📁 資料上傳</div>
            <div class="tab" onclick="switchTab('overview')">👥 員工總覽與薪資</div>
        </div>
        
        <div id="upload-tab" class="tab-content active">
            <div class="format-info">
                <h4>📊 工時表格式說明</h4>
                <p>請確保您的 CSV 檔案包含以下欄位，且日期格式正確。</p>
                <div class="format-example">Payroll ID, First Name, Last Name, Monday of the Work Week, Hours, Level, Rate, Farm
EQ-0001, John, Doe, 2025-02-10, 45, Senior, 25.50, Farm A
EQ-0002, Jane, Smith, 2025-02-17, 38, Junior, 20.00, Farm B</div>
                <ul>
                    <li>📅 <strong>日期格式</strong>：接受 Vishal-MM-DD 或 DD/MM/YYYY。</li>
                    <li>🔢 <strong>週期計算</strong>：系統以 2025/02/10 為基準，自動計算8週為一週期。</li>
                    <li>👤 <strong>資訊更新</strong>：若員工的農場、職級或薪資變動，上傳新資料即可覆蓋。</li>
                </ul>
            </div>
            
            <div class="upload-section" id="timesheet-upload" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                <h3>📋 上傳工時表 (CSV)</h3>
                <p>🖱️ 點擊下方按鈕 或 直接將 CSV 檔案拖拽至此區域</p>
                <button id="upload-file-btn" class="upload-btn" onclick="document.getElementById('timesheet-file').click()">
                    <span class="spinner" style="display: none;"></span>
                    選擇工時表文件
                </button>
                <input type="file" id="timesheet-file" class="file-input" accept=".csv" onchange="handleTimesheetFile(event)">
                <div id="timesheet-file-info" class="file-info" style="display: none;"></div>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <p id="progress-text">等待上傳文件...</p>
            
            <div id="validation-results" class="validation-results"></div>
        </div>
        
        <div id="overview-tab" class="tab-content"> 
            <h2 style="text-align:center; font-weight:600; margin-bottom:2rem;">👥 員工總覽與薪資管理</h2>
            
            <div class="format-info">
                <h4>🔍 篩選與檢視</h4>
                <div class="filter-controls">
                    <div>
                        <label for="farm-filter"><strong>農場：</strong></label>
                        <select id="farm-filter" onchange="updateAllTables()"><option value="">所有農場</option></select>
                    </div>
                    <div>
                        <label for="level-filter"><strong>職級：</strong></label>
                        <select id="level-filter" onchange="updateAllTables()"><option value="">所有職級</option></select>
                    </div>
                    <div>
                        <label for="employee-filter"><strong>員工：</strong></label>
                        <select id="employee-filter" onchange="updateAllTables()"><option value="">所有員工</option></select>
                    </div>
                    <div>
                        <label for="cycle-filter"><strong>週期：</strong></label>
                        <select id="cycle-filter" onchange="updateAllTables()"><option value="">所有週期</option></select>
                    </div>
                    <button class="action-btn" onclick="showAddHoursDialog()" style="background:var(--success-color); padding: 8px 18px; box-shadow: none;">手動增加時數</button>
                    <button class="action-btn" onclick="clearFilters()" style="padding: 8px 18px; background: var(--secondary-color); color: white; border: none; box-shadow: none; border-radius: var(--border-radius);">清除篩選</button>
                </div>
            </div>
            
            <div id="cycle-summary-card" class="format-info" style="display: none; border-left: 5px solid var(--primary-color);"></div>
            
            <div class="summary-cards" id="overview-summary-cards">
                 <!-- Summary cards will be populated by JS -->
            </div>
            <div id="overview-table-container">
                 <!-- Overview table will be populated by JS -->
            </div>
            
            <div style="text-align:center; margin-top:2.5rem;">
                <button id="exportOverview" class="upload-btn action-btn" onclick="exportOverview()">
                    <span class="spinner" style="display: none;"></span>
                    📥 匯出當前報告 (CSV)
                </button>
            </div>
        </div>
    </div>

    <!-- Dialogs -->
    <div id="messages"></div>
    
    <div id="add-hours-dialog" class="confirm-dialog">
        <div class="confirm-content">
            <h3>手動增加工時</h3>
            <div class="dialog-form">
                <div>
                    <label for="manual-employee-select">選擇員工</label>
                    <select id="manual-employee-select"></select>
                </div>
                <div>
                    <label for="manual-date-input">工作週的週一</label>
                    <input type="date" id="manual-date-input">
                </div>
                <div>
                    <label for="manual-hours-input">工時</label>
                    <input type="number" step="0.01" id="manual-hours-input" placeholder="例如: 40.5">
                </div>
            </div>
            <div class="confirm-buttons">
                <button class="btn-cancel" onclick="document.getElementById('add-hours-dialog').classList.remove('active')">取消</button>
                <button class="btn-confirm" onclick="saveManualHours()">儲存</button>
            </div>
        </div>
    </div>
    
    <div id="payment-dialog" class="confirm-dialog">
        <div class="confirm-content">
            <h3 id="payment-dialog-title">記錄加班費支付</h3>
            <div id="payment-dialog-content" class="dialog-form"></div>
            <div class="confirm-buttons">
                <button class="btn-cancel" onclick="document.getElementById('payment-dialog').classList.remove('active')">取消</button>
                <button class="btn-confirm" id="save-payment-btn">儲存支付紀錄</button>
            </div>
        </div>
    </div>

    <div id="payment-history-dialog" class="confirm-dialog">
        <div class="confirm-content">
            <h3 id="payment-history-title">支付歷史紀錄</h3>
            <div id="payment-history-content"></div>
            <div class="confirm-buttons">
                <button class="btn-confirm" onclick="document.getElementById('payment-history-dialog').classList.remove('active')">關閉</button>
            </div>
        </div>
    </div>
    
    <div id="custom-confirm-dialog" class="confirm-dialog">
        <div class="confirm-content">
            <h3 id="confirm-title"></h3>
            <p id="confirm-message"></p>
            <div class="confirm-buttons">
                <button id="confirm-btn-cancel" class="btn-cancel">取消</button>
                <button id="confirm-btn-ok" class="btn-confirm">確定</button>
            </div>
        </div>
    </div>


    <script>
        // 全域變數
        let employees = {};
        let timesheetData = [];
        let pendingData = null;
        let paymentHistory = {};
        let confirmCallback = null;
        
        // 常數定義
        const REGULAR_HOURS_THRESHOLD = 304;
        const WEEKS_PER_CYCLE = 8;
        const WEEKLY_HOURS_THRESHOLD = 38;
        const SYSTEM_START_DATE = new Date(2025, 1, 10); // 月份是 0-indexed, 1 = 二月

        // 初始化函數
        document.addEventListener('DOMContentLoaded', function() {
            loadLocalData();
            updateProgress(0, '系統已就緒，請上傳工時表');
            updateDataStatus();
            
            // Dialog event listeners
            document.getElementById('confirm-btn-ok').addEventListener('click', () => {
                if (confirmCallback) confirmCallback();
                closeCustomConfirm();
            });
            document.getElementById('confirm-btn-cancel').addEventListener('click', closeCustomConfirm);
        });

        // --- Custom Confirm Dialog ---
        function showCustomConfirm(title, message, callback) {
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-message').innerHTML = message;
            document.getElementById('custom-confirm-dialog').classList.add('active');
            confirmCallback = callback;
        }
        function closeCustomConfirm() {
            document.getElementById('custom-confirm-dialog').classList.remove('active');
            confirmCallback = null;
        }

        // 載入本地資料
        function loadLocalData() {
            try {
                const storedEmployees = localStorage.getItem('timesheet_employees');
                const storedTimesheetData = localStorage.getItem('timesheet_data');
                const storedPaymentHistory = localStorage.getItem('payment_history');
                
                if (storedEmployees) employees = JSON.parse(storedEmployees);
                if (storedTimesheetData) timesheetData = JSON.parse(storedTimesheetData);
                if (storedPaymentHistory) paymentHistory = JSON.parse(storedPaymentHistory);
                
                updateAllTables();
            } catch (error) {
                console.error('載入本地資料失敗:', error);
                showMessage('載入本地資料時發生錯誤', 'warning');
            }
        }

        // 儲存本地資料
        function saveLocalData() {
            try {
                localStorage.setItem('timesheet_employees', JSON.stringify(employees));
                localStorage.setItem('timesheet_data', JSON.stringify(timesheetData));
                localStorage.setItem('payment_history', JSON.stringify(paymentHistory));
                localStorage.setItem('last_update', new Date().toLocaleString('zh-TW'));
                updateDataStatus();
            } catch (error) {
                console.error('儲存本地資料失敗:', error);
                showMessage('儲存資料時發生錯誤', 'error');
            }
        }

        // 更新資料狀態顯示
        function updateDataStatus() {
            const statusDiv = document.getElementById('data-status');
            const statusText = document.getElementById('data-status-text');
            const empCount = Object.keys(employees).length;
            const recordCount = timesheetData.length;
            const lastUpdate = localStorage.getItem('last_update') || '未知';
            
            if (empCount > 0 || recordCount > 0) {
                statusDiv.style.display = 'block';
                statusText.textContent = `${empCount} 位員工，${recordCount} 筆工時記錄。最後更新：${lastUpdate}`;
            } else {
                statusDiv.style.display = 'none';
            }
        }

        // 匯出完整資料
        function exportAllData() {
            if (Object.keys(employees).length === 0 && timesheetData.length === 0) {
                return showMessage('沒有資料可以匯出', 'warning');
            }
            const data = { employees, timesheetData, paymentHistory, exportDate: new Date().toISOString(), version: '2.5' };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `工時系統完整資料_${new Date().toLocaleDateString('en-CA').replace(/-/g, '')}.json`;
            link.click();
            link.remove();
            showMessage('✅ 完整資料已匯出！');
        }

        // 匯入資料檔
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.employees && data.timesheetData) {
                        showCustomConfirm('匯入資料', '確定要匯入資料嗎？<br>這將會覆蓋所有現有的資料！', () => {
                            employees = data.employees;
                            timesheetData = data.timesheetData;
                            paymentHistory = data.paymentHistory || {};
                            saveLocalData();
                            updateAllTables();
                            showMessage('✅ 資料匯入成功！');
                        });
                    } else {
                        showMessage('檔案格式不正確', 'error');
                    }
                } catch (error) {
                    showMessage('讀取檔案失敗：' + error.message, 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // 允許再次選擇同一個檔案
        }

        // 清除所有資料
        function clearAllData() {
             showCustomConfirm('🗑️ 清除所有資料', '您確定要清除所有資料嗎？<br>此操作無法復原！', () => {
                employees = {};
                timesheetData = [];
                paymentHistory = {};
                localStorage.clear();
                updateAllTables();
                updateDataStatus();
                showMessage('所有資料已清除！', 'warning');
            });
        }

        // 切換分頁
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        // 顯示訊息
        function showMessage(message, type = 'success', duration = 5000) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `${type}-message`;
            messageDiv.innerHTML = message;
            messagesDiv.appendChild(messageDiv);
            setTimeout(() => {
                messageDiv.classList.add('message-fadeout');
                messageDiv.addEventListener('transitionend', () => messageDiv.remove());
            }, duration);
        }

        // 更新進度條
        function updateProgress(percentage, text) {
            document.getElementById('progress-fill').style.width = percentage + '%';
            document.getElementById('progress-text').textContent = text;
        }
        
        // 按鈕加載狀態
        function setButtonLoading(btnId, isLoading, loadingText = '處理中...') {
             const button = document.getElementById(btnId);
             const spinner = button.querySelector('.spinner');
             const textSpan = button.lastChild;
             if (isLoading) {
                 button.disabled = true;
                 spinner.style.display = 'inline-block';
                 if(!button.dataset.originalText) button.dataset.originalText = textSpan.textContent.trim();
                 textSpan.textContent = ` ${loadingText}`;
             } else {
                 button.disabled = false;
                 spinner.style.display = 'none';
                 if(button.dataset.originalText) textSpan.textContent = button.dataset.originalText;
             }
         }

        // 驗證員工編號格式
        const validatePayrollID = (id) => id && /^[A-Za-z]{2,3}-\d{3,4}$/.test(id.trim());

        // 解析日期字串
        function parseDate(dateString) {
            if (!dateString) return null;
            let date = new Date(dateString);
            if (!isNaN(date.getTime()) && dateString.includes('-')) {
                return new Date(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate());
            }
            const parts = dateString.split('/');
            if (parts.length === 3) {
                date = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
                if (!isNaN(date.getTime())) return date;
            }
            return null;
        }

        // 取得週一日期
        function getMonday(d) {
            const date = new Date(d);
            const day = date.getDay();
            const diff = date.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(date.setDate(diff));
        }
        
        // 解析時薪
        const parseRate = (rate) => parseFloat(String(rate).replace(/[^0-9.]/g, '')) || 0;

        // 拖拽事件
        const handleDragOver = (e) => { e.preventDefault(); e.target.closest('.upload-section').classList.add('dragover'); };
        const handleDragLeave = (e) => e.target.closest('.upload-section').classList.remove('dragover');
        function handleDrop(event) {
            event.preventDefault();
            const uploadSection = event.target.closest('.upload-section');
            uploadSection.classList.remove('dragover');
            const file = event.dataTransfer.files[0];
            if (file) {
                const fileInput = document.getElementById('timesheet-file');
                const dt = new DataTransfer();
                dt.items.add(file);
                fileInput.files = dt.files;
                fileInput.dispatchEvent(new Event('change', { bubbles: true }));
            }
        }
        
        // 讀取檔案
        const readFile = (file) => new Promise((resolve, reject) => {
             const reader = new FileReader();
             reader.onload = (e) => resolve(e.target.result);
             reader.onerror = (e) => reject(new Error("無法讀取檔案"));
             reader.readAsText(file);
         });

        // 解析CSV
        const parseCSV = (csvText) => {
            const lines = csvText.split(/\r?\n/).filter(line => line.trim() !== '');
            if (lines.length < 2) return [];
            const headers = lines[0].split(',').map(h => h.trim());
            return lines.slice(1).map(line => {
                const values = line.split(',');
                return headers.reduce((obj, header, index) => {
                    obj[header] = values[index] ? values[index].trim() : '';
                    return obj;
                }, {});
            });
        };

        // 處理工時表上傳
        async function handleTimesheetFile(event) {
            const file = event.target.files[0];
            if (!file) return updateProgress(0, '等待上傳文件...');
            
            setButtonLoading('upload-file-btn', true, '讀取中...');
            try {
                const data = await readFile(file);
                const parsed = parseCSV(data);
                const validationResult = validateTimesheetData(parsed);
                if (validationResult.errors.length > 0) throw new Error(validationResult.errors.join('<br>'));
                
                const conflicts = checkForConflicts(parsed);
                if (conflicts.length > 0) {
                    showConflictDialog(parsed, conflicts);
                }
                else {
                    await processTimesheetData(parsed);
                }

            } catch (error) {
                showMessage(`❌ 上傳失敗: ${error.message}`, 'error');
                updateProgress(0, '載入失敗');
            } finally {
                setButtonLoading('upload-file-btn', false, '選擇工時表文件');
                event.target.value = '';
            }
        }

        // 驗證工時表資料
        function validateTimesheetData(data) {
            const result = { warnings: [], errors: [] };
            if (data.length === 0) {
                result.errors.push('文件為空或格式不正確。');
                return result;
            }
            const headers = Object.keys(data[0] || {});
            ['Payroll ID', 'First Name', 'Last Name', 'Monday of the Work Week', 'Hours'].forEach(h => {
                if (!headers.includes(h)) result.errors.push(`缺少必要欄位: ${h}`);
            });
            data.forEach((row, i) => {
                if (!validatePayrollID(row['Payroll ID'])) result.errors.push(`第${i + 2}行: Payroll ID 格式錯誤`);
                if (!parseDate(row['Monday of the Work Week'])) result.errors.push(`第${i + 2}行: 日期格式錯誤`);
            });
            return result;
        }

        // 檢查資料衝突
        function checkForConflicts(newData) {
            const existing = new Map(timesheetData.map(item => [`${item.payrollId}-${item.workWeekDate}`, item.hours]));
            return newData.filter(row => {
                const key = `${row['Payroll ID']?.trim()}-${toLocalDateString(parseDate(row['Monday of the Work Week']?.trim()))}`;
                return existing.has(key) && existing.get(key) !== (parseFloat(row.Hours) || 0);
            }).map(row => ({ payrollId: row['Payroll ID'], workWeekDate: toLocalDateString(parseDate(row['Monday of the Work Week'])), newHours: parseFloat(row.Hours) || 0 }));
        }

        // 顯示衝突對話框
        function showConflictDialog(newData, conflicts) {
            pendingData = newData;
            
            let conflictHTML = conflicts.slice(0, 5).map(c => 
                `<p style="text-align:left; background: #f8f9fa; padding: 8px; border-radius: 4px; margin-bottom: 8px;">
                    員工 <strong>${c.payrollId}</strong> 在 <strong>${c.workWeekDate}</strong> 的工時將從
                    <span style="color: #dc3545;">${timesheetData.find(d => d.payrollId === c.payrollId && d.workWeekDate === c.workWeekDate).hours}h</span> 更新為
                    <span style="color: #198754;">${c.newHours}h</span>
                </p>`
            ).join('');
            if (conflicts.length > 5) conflictHTML += `<p>...等共 ${conflicts.length} 筆衝突。</p>`;
            
            const message = `系統檢測到您上傳的檔案與現有資料存在 ${conflicts.length} 筆工時衝突。是否要用新檔案的資料覆蓋舊資料？<br><br><div style="max-height: 150px; overflow-y: auto; padding: 10px; border: 1px solid #dee2e6; border-radius: 8px;">${conflictHTML}</div>`;
            
            showCustomConfirm('資料衝突警告', message, () => {
                 confirmOverwrite(true);
            });
        }

        // 確認覆蓋
        async function confirmOverwrite(confirmed) {
            closeCustomConfirm();
            if (confirmed) {
                 await processTimesheetData(pendingData, true)
                 showMessage('✅ 資料已成功覆蓋並更新！');
            }
            else showMessage('上傳已取消', 'warning');
            pendingData = null;
        }

        // 關閉對話框
        const closeDialog = () => document.querySelector('.confirm-dialog.active')?.classList.remove('active');

        // 格式化日期
        const toLocalDateString = (d) => d ? new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().split("T")[0] : '';
        
        // 處理工時表資料
        async function processTimesheetData(data, overwrite = false) {
            let updatedCount = 0, newCount = 0;
            data.forEach(row => {
                const payrollId = row['Payroll ID']?.trim();
                if (!payrollId) return;

                if (!employees[payrollId]) employees[payrollId] = { payrollId, workWeeks: {} };
                Object.assign(employees[payrollId], {
                    firstName: row['First Name']?.trim(),
                    lastName: row['Last Name']?.trim(),
                    farm: row['Farm']?.trim() || employees[payrollId].farm,
                    level: row['Level']?.trim() || employees[payrollId].level,
                    hourlyRate: parseRate(row['Rate']) || employees[payrollId].hourlyRate,
                });

                const workWeekDate = toLocalDateString(parseDate(row['Monday of the Work Week']?.trim()));
                const hours = parseFloat(row.Hours) || 0;
                const existingIndex = timesheetData.findIndex(d => d.payrollId === payrollId && d.workWeekDate === workWeekDate);

                if (existingIndex > -1) {
                    if ((overwrite || timesheetData[existingIndex].hours === 0) && timesheetData[existingIndex].hours !== hours) {
                        timesheetData[existingIndex].hours = hours;
                        updatedCount++;
                    }
                } else {
                    timesheetData.push({ payrollId, workWeekDate, hours });
                    newCount++;
                }
            });

            Object.values(employees).forEach(calculatePayroll); // Recalculate all
            saveLocalData();
            updateAllTables();
            if (!overwrite) showMessage(`處理完成！新增 ${newCount}, 更新 ${updatedCount} 筆記錄`, 'success');
        }

        // 計算薪資
        function calculatePayroll(employee) {
            employee.workWeeks = {};
            timesheetData.filter(d => d.payrollId === employee.payrollId).forEach(d => {
                employee.workWeeks[d.workWeekDate] = d.hours;
            });
            employee.totalHours = Object.values(employee.workWeeks).reduce((sum, h) => sum + h, 0);

            const hourlyRate = employee.hourlyRate || 0;
            const systemStartMonday = getMonday(new Date(SYSTEM_START_DATE));
            const latestDate = timesheetData.length > 0 ? new Date(Math.max(...timesheetData.map(d => new Date(d.workWeekDate)))) : new Date();
            const totalWeeksSinceStart = Math.ceil((latestDate - systemStartMonday) / (7 * 24 * 60 * 60 * 1000));
            const totalCycles = Math.ceil(totalWeeksSinceStart / WEEKS_PER_CYCLE);
            
            let accumulatedOvertime = 0;
            for (let i = 1; i <= totalCycles; i++) {
                const cycleStartDate = new Date(systemStartMonday.getTime() + (i - 1) * WEEKS_PER_CYCLE * 7 * 24 * 60 * 60 * 1000);
                const cycleEndDate = new Date(cycleStartDate.getTime() + (WEEKS_PER_CYCLE * 7 - 1) * 24 * 60 * 60 * 1000);
                const cycleHours = Object.entries(employee.workWeeks)
                    .filter(([date, _]) => new Date(date) >= cycleStartDate && new Date(date) <= cycleEndDate)
                    .reduce((sum, [_, hours]) => sum + hours, 0);
                
                if (cycleHours > REGULAR_HOURS_THRESHOLD) {
                    accumulatedOvertime += (cycleHours - REGULAR_HOURS_THRESHOLD) * hourlyRate;
                }
            }
            employee.accumulatedOvertimePay = accumulatedOvertime;
            
            const currentCycleInfo = calculateEmployeeCycle(employee, new Date());
            employee.payrollData = {
                cycleHours: currentCycleInfo.cycleHours,
                overtimePay: currentCycleInfo.cycleHours > REGULAR_HOURS_THRESHOLD ? (currentCycleInfo.cycleHours - REGULAR_HOURS_THRESHOLD) * hourlyRate : 0
            };

            const totalPaid = Object.values(paymentHistory[employee.payrollId] || {}).reduce((sum, p) => sum + p.amount, 0);
            employee.unpaidOvertimePay = Math.max(0, employee.accumulatedOvertimePay - totalPaid);
        }
        
        // 計算週期資訊
        function calculateEmployeeCycle(employee, refDate) {
            const systemStartMonday = getMonday(new Date(SYSTEM_START_DATE));
            const refMonday = getMonday(new Date(refDate));
            const totalWeeks = Math.floor((refMonday - systemStartMonday) / (7 * 24 * 60 * 60 * 1000));
            if(totalWeeks < 0) return { currentCycle: 1, cycleStartDate: systemStartMonday, cycleEndDate: new Date(systemStartMonday.getTime() + (WEEKS_PER_CYCLE * 7 - 1) * 24 * 60 * 60 * 1000), cycleHours: 0 };

            const currentCycle = Math.floor(totalWeeks / WEEKS_PER_CYCLE) + 1;
            
            const cycleStartDate = new Date(systemStartMonday.getTime() + (currentCycle - 1) * WEEKS_PER_CYCLE * 7 * 24 * 60 * 60 * 1000);
            const cycleEndDate = new Date(cycleStartDate.getTime() + (WEEKS_PER_CYCLE * 7 - 1) * 24 * 60 * 60 * 1000);

            const cycleHours = Object.entries(employee.workWeeks || {})
                .filter(([date, _]) => new Date(date) >= cycleStartDate && new Date(date) <= cycleEndDate)
                .reduce((sum, [_, hours]) => sum + hours, 0);
            
            return { currentCycle, cycleStartDate, cycleEndDate, cycleHours };
        }

        // 取得所有週期選項
        function getAllAvailableCycles() {
            const systemStartMonday = getMonday(new Date(SYSTEM_START_DATE));
            const latestDate = timesheetData.length > 0 ? new Date(Math.max(...timesheetData.map(d => new Date(d.workWeekDate)))) : new Date();
            const today = new Date();
            const finalDate = latestDate > today ? latestDate : today;

            const totalWeeks = Math.floor((getMonday(finalDate) - systemStartMonday) / (7 * 24 * 60 * 60 * 1000));
            const totalCycles = Math.floor(totalWeeks / WEEKS_PER_CYCLE) + 1;
            if (totalCycles <= 0) return [];
            
            return Array.from({ length: totalCycles }, (_, i) => {
                const cycle = i + 1;
                const startDate = new Date(systemStartMonday.getTime() + (cycle - 1) * WEEKS_PER_CYCLE * 7 * 24 * 60 * 60 * 1000);
                const endDate = new Date(startDate.getTime() + (WEEKS_PER_CYCLE * 7 - 1) * 24 * 60 * 60 * 1000);
                return {
                    cycle,
                    startWeek: (cycle - 1) * WEEKS_PER_CYCLE + 1,
                    endWeek: cycle * WEEKS_PER_CYCLE,
                    startDate,
                    endDate,
                };
            }).reverse();
        }

        // 更新篩選選項
        function updateFilterOptions() {
            const farms = [...new Set(Object.values(employees).map(e => e.farm).filter(Boolean))].sort();
            const levels = [...new Set(Object.values(employees).map(e => e.level).filter(Boolean))].sort();
            const empList = Object.values(employees).map(e => ({ id: e.payrollId, name: `${e.firstName} ${e.lastName}` })).sort((a, b) => a.name.localeCompare(b.name));

            const populateSelect = (id, data, currentVal, placeholder, nameKey = 'name', idKey = 'id') => {
                const select = document.getElementById(id);
                select.innerHTML = `<option value="">${placeholder}</option>`;
                data.forEach(item => {
                    const value = typeof item === 'object' ? item[idKey] : item;
                    const text = typeof item === 'object' ? `${item[nameKey]} (${item[idKey]})` : item;
                    select.innerHTML += `<option value="${value}" ${value == currentVal ? 'selected' : ''}>${text}</option>`;
                });
            };
            populateSelect('farm-filter', farms, document.getElementById('farm-filter').value, '所有農場');
            populateSelect('level-filter', levels, document.getElementById('level-filter').value, '所有職級');
            populateSelect('employee-filter', empList, document.getElementById('employee-filter').value, '所有員工');
            
            const cycleSelect = document.getElementById('cycle-filter');
            const currentCycle = cycleSelect.value;
            cycleSelect.innerHTML = '<option value="">所有週期</option>';
            getAllAvailableCycles().forEach(c => {
                cycleSelect.innerHTML += `<option value="${c.cycle}" ${c.cycle == currentCycle ? 'selected' : ''}>週期 ${c.cycle} (W${c.startWeek}-W${c.endWeek})</option>`;
            });
        }
        
        // 清除篩選
        const clearFilters = () => { ['farm-filter', 'level-filter', 'employee-filter', 'cycle-filter'].forEach(id => document.getElementById(id).value = ''); updateAllTables(); };
        const toggleDetails = (btn, id) => { 
            const detailsRow = document.getElementById(`details-${id}`);
            const isOpen = detailsRow.classList.toggle('is-open');
            btn.textContent = isOpen ? '−' : '+';
            btn.style.transform = isOpen ? 'rotate(180deg)' : 'rotate(0deg)';
        };
        
        // 用於格式化財報數字，將 0 或 null 轉為 '-'
        function formatFinancialNumber(num) {
            const value = Number(num);
            return (isNaN(value) || Math.abs(value) < 0.005) ? '–' : value.toFixed(2);
        }

        // 更新員工總覽表格
        function updateOverviewTable() {
            const container = document.getElementById('overview-table-container');
            if (Object.keys(employees).length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #777; margin-top: 30px;">尚未載入員工資料。</p>';
                document.getElementById('overview-summary-cards').innerHTML = '';
                document.getElementById('cycle-summary-card').style.display = 'none';
                return;
            }
            
            updateFilterOptions();
            const filteredEmployees = getFilteredEmployees();
            
            const systemStartMonday = getMonday(new Date(SYSTEM_START_DATE));
            const actualCurrentCycleInfo = calculateEmployeeCycle({workWeeks:{}}, new Date());
            const actualCurrentCycle = actualCurrentCycleInfo.currentCycle;
            const actualWeeksFromStart = Math.floor((getMonday(new Date()) - systemStartMonday) / (7 * 24 * 60 * 60 * 1000)) + 1;
            const actualWeekInCycle = ((actualWeeksFromStart - 1) % WEEKS_PER_CYCLE) + 1;
            const actualProgressPercent = (actualWeekInCycle / WEEKS_PER_CYCLE) * 100;

            const cycleFilterValue = document.getElementById('cycle-filter')?.value || '';
            const allCycles = getAllAvailableCycles();
            let displayCycleData = cycleFilterValue 
                ? allCycles.find(c => c.cycle.toString() === cycleFilterValue)
                : allCycles.find(c => c.cycle === actualCurrentCycle) || (allCycles.length > 0 ? allCycles[0] : null);
            
            const cycleSummaryCard = document.getElementById('cycle-summary-card');
            if (displayCycleData) {
                const showProgressBar = !cycleFilterValue || (displayCycleData && displayCycleData.cycle === actualCurrentCycle);
                const progressBarHTML = showProgressBar ? `
                    <div style="flex-grow:1; min-width:200px;">
                        <p style="margin:0 0 5px 0; text-align:center; font-size:13px; color:var(--text-muted-color);">真實週期進度: 第 ${actualWeekInCycle} 週 / ${WEEKS_PER_CYCLE} 週</p>
                        <div style="height:12px; background:#e9ecef; border-radius:6px; overflow:hidden;">
                            <div style="width:${actualProgressPercent}%; height:100%; background:linear-gradient(90deg, #198754, #20c997); transition: width 0.3s ease;"></div>
                        </div>
                    </div>` : '';

                cycleSummaryCard.innerHTML = `
                    <h4 style="margin:0 0 10px 0; color:var(--primary-color);">📅 ${cycleFilterValue ? '篩選' : '當前'}季節週期資訊</h4>
                    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:15px;">
                        <div>
                            <p style="margin:0; font-size:16px;"><strong>週期 ${displayCycleData.cycle} (W${displayCycleData.startWeek}-W${displayCycleData.endWeek})</strong></p>
                            <p style="margin:5px 0 0 0; color:#555;">${toLocalDateString(displayCycleData.startDate)} 至 ${toLocalDateString(displayCycleData.endDate)}</p>
                        </div>
                        ${progressBarHTML}
                    </div>`;
                cycleSummaryCard.style.display = 'block';
            } else {
                 cycleSummaryCard.style.display = 'none';
            }
            
            if (filteredEmployees.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-muted-color); margin-top: 30px;">沒有符合篩選條件的員工資料。</p>';
                document.getElementById('overview-summary-cards').innerHTML = '';
                return;
            }

            let tableHTML = `
                <table class="employee-table">
                    <thead><tr>
                        <th></th><th>員工編號</th><th>姓名</th><th>農場</th><th>職級</th><th>時薪 ($)</th>
                        <th>季節總工時</th><th>週期工時</th><th>週期加班費 ($)</th>
                        <th>累積未付加班費 ($)</th><th>支付操作</th><th>距OT門檻 (hr)</th>
                    </tr></thead><tbody>`;
            
            let totals = { histHours: 0, cycleHours: 0, unpaidOT: 0, cycleOT: 0, accOT: 0 };
            const refDateForCalc = displayCycleData ? displayCycleData.startDate : new Date();

            filteredEmployees.sort((a, b) => a.payrollId.localeCompare(b.payrollId)).forEach(employee => {
                const cycleInfo = displayCycleData ? calculateEmployeeCycle(employee, refDateForCalc) : { cycleHours: 0 };
                employee.payrollData.overtimePay = cycleInfo.cycleHours > REGULAR_HOURS_THRESHOLD ? (cycleInfo.cycleHours - REGULAR_HOURS_THRESHOLD) * employee.hourlyRate : 0;
                
                const otThresholdDiff = REGULAR_HOURS_THRESHOLD - cycleInfo.cycleHours;
                
                totals.histHours += employee.totalHours || 0;
                totals.cycleHours += cycleInfo.cycleHours;
                totals.unpaidOT += employee.unpaidOvertimePay || 0;
                totals.cycleOT += (employee.payrollData?.overtimePay || 0);
                totals.accOT += employee.accumulatedOvertimePay || 0;

                let paymentCell = '';
                if (paymentHistory[employee.payrollId] && paymentHistory[employee.payrollId].length > 0) {
                     paymentCell += `<button class="btn-edit" onclick="showPaymentHistory('${employee.payrollId}')" style="font-size:11px; padding:3px 8px; margin-right:5px;">歷史</button>`;
                }
                if ((employee.unpaidOvertimePay || 0) > 0) {
                    paymentCell += `<button class="btn-payment" onclick="showPaymentDialog('${employee.payrollId}')" style="font-size:11px; padding:3px 8px;">支付</button>`;
                }
                
                let workWeeks = Object.entries(employee.workWeeks || {}).sort((a, b) => new Date(a[0]) - new Date(b[0]));
                if (cycleFilterValue && displayCycleData) {
                    workWeeks = workWeeks.filter(([dateStr, _]) => new Date(dateStr) >= displayCycleData.startDate && new Date(dateStr) <= displayCycleData.endDate);
                }

                let detailsHTML = workWeeks.length > 0 
                    ? `<table class="details-table" id="details-table-${employee.payrollId}">
                        <thead><tr><th>工作週 (週一)</th><th>工時</th><th>週加班</th><th>操作</th></tr></thead>
                        <tbody>${workWeeks.map(([date, hours]) => {
                            const isOvertime = hours > WEEKLY_HOURS_THRESHOLD;
                            return `<tr data-work-week="${date}">
                                        <td>${toLocalDateString(new Date(date))}</td>
                                        <td class="${isOvertime ? 'weekly-overtime' : ''}"><span class="hours-display">${hours}</span><input type="number" step="0.01" class="hours-input" value="${hours}" style="display:none; width: 60px;"></td>
                                        <td>${isOvertime ? `<span class="status-overtime">${(hours - WEEKLY_HOURS_THRESHOLD).toFixed(1)}h</span>` : '<span class="status-normal">–</span>'}</td>
                                        <td>
                                          <div class="edit-actions" style="display:none; text-align:center;">
                                             <button class="btn-save" onclick="saveHours(this, '${employee.payrollId}', '${date}')">保存</button>
                                             <button class="btn-cancel-edit" onclick="cancelEditHours(this, '${hours}')">取消</button>
                                          </div>
                                          <div class="view-actions">
                                            <button class="btn-edit" onclick="editHours(this, '${employee.payrollId}', '${date}')">編輯</button>
                                            <button class="btn-delete" onclick="deleteWorkWeekWrapper('${employee.payrollId}', '${date}')">刪除</button>
                                          </div>
                                        </td>
                                    </tr>`;
                        }).join('')}</tbody>
                       </table>` 
                    : '<div style="text-align:center; padding: 1rem; color: var(--text-muted-color);">此週期無工時記錄</div>';

                tableHTML += `
                    <tr class="main-row">
                        <td><button class="toggle-details-btn" onclick="toggleDetails(this, '${employee.payrollId}')">+</button></td>
                        <td><strong>${employee.payrollId}</strong></td><td>${employee.firstName} ${employee.lastName}</td><td>${employee.farm || '–'}</td><td>${employee.level || '–'}</td>
                        <td class="money">${formatFinancialNumber(employee.hourlyRate)}</td>
                        <td><strong>${formatFinancialNumber(employee.totalHours)}</strong></td>
                        <td><strong>${formatFinancialNumber(cycleInfo.cycleHours)}</strong></td>
                        <td class="money ${cycleInfo.cycleHours > REGULAR_HOURS_THRESHOLD ? 'status-overtime' : ''}">${formatFinancialNumber(employee.payrollData.overtimePay)}</td>
                        <td class="money ${employee.unpaidOvertimePay > 0 ? 'status-overtime' : ''}">${formatFinancialNumber(employee.unpaidOvertimePay)}</td>
                        <td>${paymentCell || '–'}</td>
                        <td class="${otThresholdDiff < 0 ? 'status-overtime' : 'status-normal'}">${formatFinancialNumber(otThresholdDiff)}</td>
                    </tr>
                    <tr class="details-row" id="details-${employee.payrollId}"><td colspan="12">${detailsHTML}</td></tr>`;
            });
            
            tableHTML += `</tbody><tfoot>
                <tr style="background:#f0f2f5; font-weight:bold; text-align:center;">
                    <td colspan="6" style="text-align:right;">總計 (篩選結果)</td>
                    <td>${formatFinancialNumber(totals.histHours)}</td><td>${formatFinancialNumber(totals.cycleHours)}</td>
                    <td class="money">${formatFinancialNumber(totals.cycleOT)}</td><td class="money">${formatFinancialNumber(totals.accOT)}</td>
                    <td colspan="2" style="background-color: #f0f2f5 !important;"></td>
                </tr></tfoot></table>`;
            container.innerHTML = tableHTML;
            
            document.getElementById('overview-summary-cards').innerHTML = `
                <div class="summary-card"><h3>${filteredEmployees.length}</h3><p>名員工 (篩選後)</p></div>
                <div class="summary-card"><h3>${filteredEmployees.filter(e => {
                    const cycleData = displayCycleData ? calculateEmployeeCycle(e, refDateForCalc) : {cycleHours: 0};
                    return cycleData.cycleHours > REGULAR_HOURS_THRESHOLD;
                }).length}</h3><p>名週期超時員工</p></div>
                <div class="summary-card"><h3>${formatFinancialNumber(totals.cycleHours)}</h3><p>小時 (週期總工時)</p></div>
                <div class="summary-card"><h3>$${formatFinancialNumber(totals.unpaidOT)}</h3><p>未支付加班費總額</p></div>`;
        }
        
        // 更新所有表格
        function updateAllTables() {
            Object.values(employees).forEach(calculatePayroll);
            updateOverviewTable();
        }
        
        function getFilteredEmployees() {
            const farm = document.getElementById('farm-filter').value;
            const level = document.getElementById('level-filter').value;
            const employeeId = document.getElementById('employee-filter').value;
            const cycleVal = document.getElementById('cycle-filter').value;

            return Object.values(employees).filter(emp => {
                if (farm && emp.farm !== farm) return false;
                if (level && emp.level !== level) return false;
                if (employeeId && emp.payrollId !== employeeId) return false;
                // No need to filter by cycle hours here, table display logic handles it
                return true;
            });
        }
        
        // --- Edit/Delete/Payment/Add Functions ---

        function editHours(btn, payrollId, workWeekDate) {
            const row = btn.closest('tr');
            row.querySelector('.view-actions').style.display = 'none';
            row.querySelector('.edit-actions').style.display = 'block';
            row.querySelector('.hours-display').style.display = 'none';
            row.querySelector('.hours-input').style.display = 'inline-block';
            row.querySelector('.hours-input').focus();
        }

        function cancelEditHours(btn, originalHours) {
            const row = btn.closest('tr');
            row.querySelector('.view-actions').style.display = 'block';
            row.querySelector('.edit-actions').style.display = 'none';
            row.querySelector('.hours-display').style.display = 'inline-block';
            row.querySelector('.hours-input').style.display = 'none';
            row.querySelector('.hours-input').value = originalHours;
        }

        function saveHours(btn, payrollId, workWeekDate) {
            const row = btn.closest('tr');
            const input = row.querySelector('.hours-input');
            const newHours = parseFloat(input.value);

            if (isNaN(newHours) || newHours < 0) {
                showMessage('請輸入有效的工時數字', 'error');
                return;
            }

            const recordIndex = timesheetData.findIndex(d => d.payrollId === payrollId && d.workWeekDate === workWeekDate);
            if (recordIndex > -1) {
                timesheetData[recordIndex].hours = newHours;
                saveLocalData();
                updateAllTables();
                showMessage('工時已更新', 'success');
            }
        }

        function deleteWorkWeekWrapper(payrollId, workWeekDate) {
            showCustomConfirm('刪除工時記錄', `確定要刪除員工 ${payrollId} 於 ${workWeekDate} 的工時記錄嗎？`, () => {
                timesheetData = timesheetData.filter(d => !(d.payrollId === payrollId && d.workWeekDate === workWeekDate));
                saveLocalData();
                updateAllTables();
                showMessage('工時記錄已刪除', 'warning');
            });
        }

        function showAddHoursDialog() {
            const dialog = document.getElementById('add-hours-dialog');
            const select = document.getElementById('manual-employee-select');
            
            select.innerHTML = '<option value="">-- 請選擇員工 --</option>';
            Object.values(employees)
                .sort((a,b) => a.firstName.localeCompare(b.firstName))
                .forEach(emp => {
                    select.innerHTML += `<option value="${emp.payrollId}">${emp.firstName} ${emp.lastName} (${emp.payrollId})</option>`;
                });
            
            document.getElementById('manual-date-input').value = '';
            document.getElementById('manual-hours-input').value = '';

            dialog.classList.add('active');
        }

        function saveManualHours() {
            const payrollId = document.getElementById('manual-employee-select').value;
            const dateValue = document.getElementById('manual-date-input').value;
            const hours = parseFloat(document.getElementById('manual-hours-input').value);

            if (!payrollId) { return showMessage('請選擇一位員工', 'error'); }
            if (!dateValue) { return showMessage('請選擇日期', 'error'); }
            if (isNaN(hours) || hours <= 0) { return showMessage('請輸入有效的工時', 'error'); }

            const workWeekDate = toLocalDateString(getMonday(new Date(dateValue)));
            const existingIndex = timesheetData.findIndex(d => d.payrollId === payrollId && d.workWeekDate === workWeekDate);

            const performSave = () => {
                if (existingIndex > -1) {
                    timesheetData[existingIndex].hours = hours;
                } else {
                    timesheetData.push({ payrollId, workWeekDate, hours });
                }
                saveLocalData();
                updateAllTables();
                document.getElementById('add-hours-dialog').classList.remove('active');
                showMessage('工時已成功儲存！', 'success');
            };

            if (existingIndex > -1) {
                showCustomConfirm(
                    '覆蓋現有工時',
                    `員工 ${payrollId} 在 ${workWeekDate} 已有 ${timesheetData[existingIndex].hours} 小時的記錄。要將其覆蓋為 ${hours} 小時嗎？`,
                    performSave
                );
            } else {
                performSave();
            }
        }

        function exportOverview() {
            setButtonLoading('exportOverview', true, '匯出中...');
            
            try {
                const filteredEmployees = getFilteredEmployees();
                if (filteredEmployees.length === 0) {
                    showMessage('沒有可匯出的資料', 'warning');
                    return;
                }

                const cycleFilterValue = document.getElementById('cycle-filter')?.value || '';
                const allCycles = getAllAvailableCycles();
                const actualCurrentCycleInfo = calculateEmployeeCycle({}, new Date());
                let displayCycleData = cycleFilterValue 
                    ? allCycles.find(c => c.cycle.toString() === cycleFilterValue)
                    : allCycles.find(c => c.cycle === actualCurrentCycleInfo.currentCycle) || (allCycles.length > 0 ? allCycles[0] : null);

                const headers = [
                    '員工編號', '姓', '名', '農場', '職級', '時薪',
                    '週期編號', '週期開始日期', '週期結束日期',
                    '週期工時', '週期加班費', '累積未付加班費'
                ];

                const csvRows = [headers.join(',')];

                filteredEmployees.forEach(emp => {
                    const cycleInfo = displayCycleData ? calculateEmployeeCycle(emp, displayCycleData.startDate) : { cycleHours: 0, currentCycle: '', startDate: null, endDate: null };
                    const cycleOT = cycleInfo.cycleHours > REGULAR_HOURS_THRESHOLD ? (cycleInfo.cycleHours - REGULAR_HOURS_THRESHOLD) * emp.hourlyRate : 0;
                    
                    const row = [
                        emp.payrollId,
                        emp.lastName,
                        emp.firstName,
                        emp.farm || '',
                        emp.level || '',
                        emp.hourlyRate || 0,
                        displayCycleData ? displayCycleData.cycle : 'N/A',
                        displayCycleData ? toLocalDateString(displayCycleData.startDate) : 'N/A',
                        displayCycleData ? toLocalDateString(displayCycleData.endDate) : 'N/A',
                        cycleInfo.cycleHours.toFixed(2),
                        cycleOT.toFixed(2),
                        emp.unpaidOvertimePay.toFixed(2)
                    ];
                    // Escape commas in names or other fields if necessary
                    const sanitizedRow = row.map(field => `"${String(field || '').replace(/"/g, '""')}"`);
                    csvRows.push(sanitizedRow.join(','));
                });

                const blob = new Blob(["\uFEFF" + csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const cycleName = displayCycleData ? `週期${displayCycleData.cycle}` : '總覽';
                link.href = URL.createObjectURL(blob);
                link.download = `工時報告_${cycleName}_${new Date().toLocaleDateString('en-CA')}.csv`;
                link.click();
                link.remove();
                
                showMessage('報告匯出成功！', 'success');
            } catch (error) {
                console.error("匯出失敗:", error);
                showMessage('匯出報告時發生錯誤', 'error');
            } finally {
                setButtonLoading('exportOverview', false);
            }
        }

        function showPaymentDialog(payrollId) {
            const employee = employees[payrollId];
            if (!employee) return;
            const dialog = document.getElementById('payment-dialog');
            const content = document.getElementById('payment-dialog-content');
            
            document.getElementById('payment-dialog-title').textContent = `支付給 ${employee.firstName} ${employee.lastName}`;
            
            content.innerHTML = `
                <p>未支付加班費總額: <strong class="status-overtime">$${employee.unpaidOvertimePay.toFixed(2)}</strong></p>
                <div>
                    <label for="payment-amount">支付金額</label>
                    <input type="number" step="0.01" id="payment-amount" placeholder="輸入支付金額" value="${employee.unpaidOvertimePay.toFixed(2)}">
                </div>
                <div>
                    <label for="payment-date">支付日期</label>
                    <input type="date" id="payment-date" value="${new Date().toISOString().split('T')[0]}">
                </div>
                <div>
                    <label for="payment-note">備註 (選填)</label>
                    <textarea id="payment-note" rows="3" placeholder="例如：銀行轉帳"></textarea>
                </div>
            `;
            
            const saveBtn = document.getElementById('save-payment-btn');
            saveBtn.onclick = () => recordPayment(payrollId); // Pass payrollId to the handler
            
            dialog.classList.add('active');
        }

        function recordPayment(payrollId) {
            const amount = parseFloat(document.getElementById('payment-amount').value);
            const date = document.getElementById('payment-date').value;
            const note = document.getElementById('payment-note').value.trim();

            if (isNaN(amount) || amount <= 0) {
                return showMessage('請輸入有效的支付金額', 'error');
            }
            if (!date) {
                return showMessage('請選擇支付日期', 'error');
            }

            if (!paymentHistory[payrollId]) {
                paymentHistory[payrollId] = [];
            }
            paymentHistory[payrollId].push({
                amount,
                date,
                note,
                timestamp: new Date().toISOString()
            });

            saveLocalData();
            updateAllTables();
            document.getElementById('payment-dialog').classList.remove('active');
            showMessage(`$${amount.toFixed(2)} 的支付紀錄已儲存`, 'success');
        }

        function showPaymentHistory(payrollId) {
            const employee = employees[payrollId];
            const history = paymentHistory[payrollId] || [];
            if (!employee) return;

            const dialog = document.getElementById('payment-history-dialog');
            const content = document.getElementById('payment-history-content');
            document.getElementById('payment-history-title').textContent = `${employee.firstName} ${employee.lastName} 的支付歷史`;

            if (history.length === 0) {
                content.innerHTML = '<p>沒有支付紀錄。</p>';
            } else {
                let historyHTML = `<table class="details-table" style="text-align:left;">
                    <thead><tr><th>支付日期</th><th>金額</th><th>備註</th></tr></thead><tbody>`;
                
                [...history].reverse().forEach(p => {
                    historyHTML += `<tr>
                        <td>${p.date}</td>
                        <td class="money">$${p.amount.toFixed(2)}</td>
                        <td>${p.note || '–'}</td>
                    </tr>`;
                });

                const totalPaid = history.reduce((sum, p) => sum + p.amount, 0);
                historyHTML += `</tbody><tfoot><tr style="font-weight:bold;">
                    <td>總計</td>
                    <td class="money">$${totalPaid.toFixed(2)}</td>
                    <td></td>
                </tr></tfoot></table>`;
                content.innerHTML = historyHTML;
            }

            dialog.classList.add('active');
        }
    </script>
</body>
</html>
