<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub 版工時管理系統</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
        }
        
        .token-setup {
            background: #f8f9fa;
            border: 2px solid #28a745;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .token-setup h3 {
            color: #28a745;
            margin: 0 0 15px 0;
        }
        
        .token-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .token-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
        }
        
        .token-input:focus {
            border-color: #28a745;
            outline: none;
        }
        
        .save-token-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .save-token-btn:hover {
            background: #218838;
        }
        
        .token-instructions {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 5px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .github-section {
            background: #f6f8fa;
            border: 2px solid #0366d6;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .github-connected {
            background: #d4edda;
            border-color: #28a745;
        }
        
        .github-disconnected {
            background: #f8d7da;
            border-color: #dc3545;
        }
        
        .github-loading {
            background: #fff3cd;
            border-color: #ffc107;
        }
        
        .central-db-info {
            background: #e7f3ff;
            border: 2px solid #b3d9ff;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .central-db-info h3 {
            color: #0066cc;
            margin: 0 0 15px 0;
        }
        
        .workflow-step {
            display: flex;
            align-items: center;
            margin: 15px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .step-number {
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: bold;
        }
        
        .upload-section {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
            background: #f8f9ff;
            transition: all 0.3s ease;
        }
        
        .upload-section:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }
        
        .upload-section.dragover {
            border-color: #764ba2;
            background: #e8ebff;
            transform: scale(1.02);
        }
        
        .file-input {
            display: none;
        }
        
        .upload-btn, .github-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            transition: transform 0.2s;
        }
        
        .github-btn {
            background: linear-gradient(45deg, #0366d6, #0256cc);
        }
        
        .github-btn-warning {
            background: linear-gradient(45deg, #ffc107, #e0a800);
            color: #333;
        }
        
        .upload-btn:hover, .github-btn:hover {
            transform: translateY(-2px);
        }
        
        .upload-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .file-info {
            margin-top: 15px;
            padding: 10px;
            background: #e8f5e8;
            border-radius: 5px;
            display: none;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 15px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            min-width: 120px;
            text-align: center;
        }
        
        .tab.active {
            border-bottom-color: #667eea;
            color: #667eea;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .employee-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 13px;
        }
        
        .employee-table th,
        .employee-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        .employee-table th {
            background: #667eea;
            color: white;
            font-size: 12px;
        }
        
        .employee-table tr:nth-child(even) {
            background: #f9f9f9;
        }
        
        .status-normal {
            color: #228B22;
            font-weight: bold;
        }
        
        .status-overtime {
            color: #ff4444;
            font-weight: bold;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .summary-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .summary-card h3 {
            margin: 0 0 10px 0;
            font-size: 20px;
        }
        
        .summary-card p {
            margin: 0;
            font-size: 12px;
            opacity: 0.9;
        }
        
        .error-message {
            background: #ffe6e6;
            color: #cc0000;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 5px solid #cc0000;
        }
        
        .success-message {
            background: #e6ffe6;
            color: #006600;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 5px solid #006600;
        }
        
        .warning-message {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 5px solid #ffc107;
        }
        
        .money {
            color: #28a745;
            font-weight: bold;
        }
        
        .format-info {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            font-size: 14px;
        }
        
        .format-info h4 {
            margin: 0 0 10px 0;
            color: #0066cc;
        }
        
        .format-example {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            margin: 5px 0;
        }
        
        .confirm-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .confirm-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        
        .confirm-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .btn-confirm {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .btn-cancel {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .upload-summary {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .upload-summary h3 {
            margin: 0 0 15px 0;
            color: #495057;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .highlight {
            background: #fff3cd;
            padding: 2px 6px;
            border-radius: 3px;
        }
        
        .validation-results {
            margin: 20px 0;
        }
        
        .validation-item {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            border-left: 4px solid;
        }
        
        .validation-success {
            background: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }
        
        .validation-warning {
            background: #fff3cd;
            border-left-color: #ffc107;
            color: #856404;
        }
        
        .validation-error {
            background: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }
        
        .last-sync {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-size: 14px;
            color: #6c757d;
        }
        
        .cycle-info-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .cycle-progress {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            margin: 8px 0;
            overflow: hidden;
        }
        
        .cycle-progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #28a745, #20c997);
            transition: width 0.3s;
        }
        
        .cycle-progress-overtime {
            background: linear-gradient(45deg, #dc3545, #fd7e14);
        }
        
        .cycle-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            min-width: 80px;
        }
        
        .cycle-active {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .cycle-complete {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .cycle-overtime {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .cycle-pending {
            background: #e7f3ff;
            color: #0066cc;
            border: 1px solid #b3d9ff;
        }
        
        .token-saved {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🐙 GitHub 版工時管理系統</h1>
        <div style="text-align: center; margin-bottom: 20px;">
            <small>📊 GitHub 資料庫 | 🔄 即時同步 | 👥 團隊協作</small>
        </div>
        
        <!-- GitHub Token 設定區域 -->
        <div id="token-setup" class="token-setup">
            <h3>🔑 系統設定</h3>
            <p><strong>選擇設定方式：</strong></p>
            
            <!-- 方式選擇 -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px;">
                    <input type="radio" name="setup-mode" value="admin" onchange="switchSetupMode('admin')" checked>
                    <strong>管理員模式：</strong> 我來設定 Token，其他人直接使用
                </label>
                <label style="display: block;">
                    <input type="radio" name="setup-mode" value="individual" onchange="switchSetupMode('individual')">
                    <strong>個人模式：</strong> 每個人使用自己的 GitHub Token
                </label>
            </div>
            
            <!-- 管理員設定模式 -->
            <div id="admin-setup" class="setup-mode">
                <div class="success-message">
                    <h4>👨‍💼 管理員設定步驟：</h4>
                    <ol>
                        <li><strong>在代碼中設定 Token：</strong><br>
                            找到代碼第 350 行左右：<code>let githubToken = '';</code><br>
                            改為：<code>let githubToken = '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';</code>
                        </li>
                        <li><strong>修改設定：</strong><br>
                            將 <code>ALLOW_CUSTOM_TOKEN = true</code> 改為 <code>false</code>
                        </li>
                        <li><strong>分享檔案：</strong><br>
                            所有員工打開修改後的檔案就能直接使用，無需設定
                        </li>
                    </ol>
                </div>
                
                <div class="warning-message">
                    <strong>🎯 一勞永逸的解決方案：</strong><br>
                    設定一次後，任何人在任何電腦上都能直接使用，不需要重複設定 Token。
                </div>
            </div>
            
            <!-- 個人設定模式 -->
            <div id="individual-setup" class="setup-mode" style="display: none;">
                <div class="token-input-group">
                    <input 
                        type="password" 
                        id="github-token-input" 
                        class="token-input" 
                        placeholder="請輸入您的 GitHub Personal Access Token"
                        value=""
                    >
                    <button class="save-token-btn" onclick="saveGitHubToken()">
                        💾 儲存並連接
                    </button>
                </div>
                
                <div class="token-instructions">
                    <h4>📋 如何取得 GitHub Token：</h4>
                    <ol>
                        <li>GitHub → Settings → Developer settings → Personal access tokens</li>
                        <li>點擊 "Generate new token (classic)"</li>
                        <li>設定權限：勾選 <code>repo</code> 權限</li>
                        <li>複製 Token 並貼到上方輸入框</li>
                    </ol>
                </div>
            </div>
            
            <div class="error-message">
                <strong>🔒 安全提醒：</strong><br>
                • GitHub Token 具有帳戶權限，請妥善保管<br>
                • 建議建立專用的 GitHub 帳戶供工時系統使用<br>
                • 如果 Token 洩露，請立即撤銷並重新生成
            </div>
        </div>
        
        <!-- GitHub 資料庫概念說明 -->
        <div class="central-db-info">
            <h3>💡 GitHub 資料庫概念</h3>
            <div class="workflow-step">
                <div class="step-number">1</div>
                <div>任何人上傳 CSV 工時表</div>
            </div>
            <div class="workflow-step">
                <div class="step-number">2</div>
                <div>系統自動整合資料並推送到 GitHub repository</div>
            </div>
            <div class="workflow-step">
                <div class="step-number">3</div>
                <div>所有團隊成員重新整理頁面即可看到最新資料</div>
            </div>
            <div class="workflow-step">
                <div class="step-number">4</div>
                <div>完整的版本控制，可查看所有歷史更新</div>
            </div>
        </div>
        
        <!-- GitHub 連接狀態 -->
        <div id="github-status" class="github-section github-disconnected">
            <h3>🐙 GitHub 連接狀態</h3>
            <p id="github-status-text">尚未連接到 GitHub repository</p>
            <div id="last-sync" class="last-sync" style="display: none;">
                <strong>最後同步：</strong><span id="sync-time">尚未同步</span>
            </div>
            <button id="github-sync-btn" class="github-btn" onclick="syncFromGitHub()" style="display: none;">
                🔄 從 GitHub 載入最新資料
            </button>
            <button id="github-download-btn" class="github-btn" onclick="downloadFromGitHub()" style="display: none;">
                📥 下載完整資料檔
            </button>
            <button id="github-disconnect-btn" class="github-btn-warning" onclick="disconnectGitHub()" style="display: none;">
                🔌 中斷連接
            </button>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('upload')">📁 資料上傳</div>
            <div class="tab" onclick="switchTab('overview')">👥 員工總覽</div>
            <div class="tab" onclick="switchTab('payroll')">💰 薪資計算</div>
        </div>
        
        <!-- 上傳區域 -->
        <div id="upload-tab" class="tab-content active">
            <div class="format-info">
                <h4>📊 工時表格式說明</h4>
                <div class="format-example">
                    Payroll ID, First Name, Last Name, Start Date, Work Week, Hours, Level, Rate, Farm
                    <br>EQ-0001, John, Doe, 2024-01-15, 2024-01-15, 45, Senior, 25.50, Farm A
                    <br>EQ-0001, John, Doe, 2024-01-15, 2024-01-22, 38, Senior, 25.50, Farm A
                    <br>EQ-0002, Jane, Smith, 2024-02-01, 2024-02-05, 42, Junior, 20.00, Farm B
                </div>
                <p><strong>重要格式說明：</strong></p>
                <ul>
                    <li>📅 <strong>Start Date</strong>：員工在該農場工作的第一天（只需在第一次上傳時提供，後續會自動保留）</li>
                    <li>📅 <strong>Work Week</strong>：工作週的週一日期（例如：2024-01-15 表示 2024年1月15日那一週）</li>
                    <li>🔢 <strong>週數計算</strong>：系統會自動根據 Start Date 和 Work Week 計算正確的週數</li>
                    <li>🏭 <strong>Farm/Level/Rate 更新</strong>：如果員工轉換農場或調整薪資，新資料會覆蓋舊資料</li>
                </ul>
                <p><strong>上傳後自動處理：</strong></p>
                <ul>
                    <li>✅ 驗證 EQ-0001 格式的員工編號</li>
                    <li>✅ 自動計算正確的工作週數</li>
                    <li>✅ 支援農場和職級異動</li>
                    <li>✅ 整合新舊資料，檢測重複工作週</li>
                    <li>✅ 自動推送到 GitHub repository</li>
                    <li>✅ 所有團隊成員即時看到最新資料</li>
                </ul>
            </div>
            
            <div class="upload-section" id="timesheet-upload">
                <h3>📋 上傳工時表 (CSV)</h3>
                <p>上傳後將自動整合並推送到 GitHub repository</p>
                <button class="upload-btn" onclick="document.getElementById('timesheet-file').click()">
                    選擇工時表文件
                </button>
                <input type="file" id="timesheet-file" class="file-input" accept=".csv" onchange="handleTimesheetFile(event)">
                <div id="timesheet-file-info" class="file-info"></div>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <p id="progress-text">等待上傳文件...</p>
            
            <div id="validation-results" class="validation-results"></div>
        </div>
        
        <!-- 員工總覽（整合週期分析） -->
        <div id="overview-tab" class="tab-content">
            <h2>👥 員工總覽與週期分析</h2>
            
            <!-- 篩選器 -->
            <div class="format-info">
                <h4>🔍 篩選選項</h4>
                <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                    <div>
                        <label><strong>農場：</strong></label>
                        <select id="farm-filter" onchange="updateAllTables()" style="padding: 5px 10px; margin-left: 8px;">
                            <option value="">所有農場</option>
                        </select>
                    </div>
                    <div>
                        <label><strong>職級：</strong></label>
                        <select id="level-filter" onchange="updateAllTables()" style="padding: 5px 10px; margin-left: 8px;">
                            <option value="">所有職級</option>
                        </select>
                    </div>
                    <div>
                        <label><strong>週期狀態：</strong></label>
                        <select id="status-filter" onchange="updateAllTables()" style="padding: 5px 10px; margin-left: 8px;">
                            <option value="">所有狀態</option>
                            <option value="active">進行中</option>
                            <option value="overtime">需加班費</option>
                            <option value="complete">已完成</option>
                        </select>
                    </div>
                    <button onclick="clearFilters()" style="padding: 5px 15px; background: #6c757d; color: white; border: none; border-radius: 3px;">清除篩選</button>
                </div>
            </div>
            
            <div class="summary-cards" id="overview-summary-cards"></div>
            <div id="overview-table-container"></div>
            
            <button class="upload-btn" onclick="exportOverview()" style="margin-top: 20px;">
                📥 匯出員工總覽報告 (CSV)
            </button>
        </div>
        
        <!-- 薪資計算 -->
        <div id="payroll-tab" class="tab-content">
            <h2>💰 薪資計算結果</h2>
            <div class="summary-cards" id="payroll-summary-cards"></div>
            <div id="payroll-table-container"></div>
            <button class="upload-btn" onclick="exportPayroll()" style="margin-top: 20px;">
                📥 匯出薪資報表 (CSV)
            </button>
        </div>
        
        <div id="messages"></div>
    </div>

    <script>
        // 全域變數
        let employees = {};
        let timesheetData = [];
        let pendingData = null;
        let isGitHubConnected = false;
        
        // ================================
        // 🔑 GitHub 設定區域 - 管理員設定
        // ================================
        // 管理員請將您的 Token 填入下方，其他人就不需要再設定
        let githubToken = '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'; // 您的 GitHub Token
        
        const REPO_OWNER = 'lass120625';  // 您的 GitHub 用戶名
        const REPO_NAME = 'timesheet-system';  // Repository 名稱
        const DATA_FILE_NAME = 'timesheet_data.json';
        
        // 管理員模式：員工不需要設定 Token
        const ALLOW_CUSTOM_TOKEN = false;
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            loadLocalData();
            updateProgress(0, '系統就緒');
        });
        
        // 切換設定模式
        function switchSetupMode(mode) {
            const adminSetup = document.getElementById('admin-setup');
            const individualSetup = document.getElementById('individual-setup');
            
            if (mode === 'admin') {
                adminSetup.style.display = 'block';
                individualSetup.style.display = 'none';
            } else {
                adminSetup.style.display = 'none';
                individualSetup.style.display = 'block';
            }
        }
        
        // 載入設定
        function loadSettings() {
            // 檢查是否有預設的 GitHub Token（在代碼中設定）
            if (githubToken && githubToken !== '') {
                // 有預設 Token，隱藏設定區域並自動連接
                hideTokenSetup();
                connectToGitHub();
                return;
            }
            
            // 沒有預設 Token，檢查是否允許用戶輸入
            if (!ALLOW_CUSTOM_TOKEN) {
                // 不允許用戶輸入，顯示管理員設定提示
                showAdminSetupMessage();
                return;
            }
            
            // 允許用戶輸入，從 localStorage 載入已儲存的 token
            const savedToken = localStorage.getItem('github_token');
            if (savedToken) {
                githubToken = savedToken;
                document.getElementById('github-token-input').value = savedToken;
                hideTokenSetup();
                connectToGitHub();
            }
        }
        
        // 顯示管理員設定提示
        function showAdminSetupMessage() {
            const tokenSetup = document.getElementById('token-setup');
            tokenSetup.innerHTML = `
                <h3>⚠️ 系統設定未完成</h3>
                <div class="validation-error">
                    <strong>系統管理員注意：</strong><br>
                    請在代碼中設定 GitHub Token 以啟用系統功能。<br><br>
                    <strong>設定步驟：</strong><br>
                    1. 取得 GitHub Personal Access Token<br>
                    2. 在代碼第 ${findTokenLineNumber()} 行左右找到：<br>
                    <code>let githubToken = 'YOUR_GITHUB_TOKEN_HERE';</code><br>
                    3. 將 'YOUR_GITHUB_TOKEN_HERE' 替換為真實的 Token<br>
                    4. 重新載入頁面
                </div>
            `;
        }
        
        // 找到 Token 設定的大概行數（用於提示）
        function findTokenLineNumber() {
            try {
                const scriptText = document.scripts[document.scripts.length - 1].innerHTML;
                const lines = scriptText.split('\n');
                for (let i = 0; i < lines.length; i++) {
                    if (lines[i].includes('githubToken = ') && lines[i].includes('YOUR_GITHUB_TOKEN_HERE')) {
                        return i + 1;
                    }
                }
                return '大約 350';
            } catch (error) {
                return '大約 350';
            }
        }
        
        // 儲存 GitHub Token
        function saveGitHubToken() {
            const tokenInput = document.getElementById('github-token-input');
            const token = tokenInput.value.trim();
            
            if (!token) {
                showMessage('請輸入 GitHub Token', 'error');
                return;
            }
            
            // 驗證 token 格式（GitHub Personal Access Token 通常以 ghp_ 開頭）
            if (!token.startsWith('ghp_') && !token.startsWith('github_pat_')) {
                showMessage('Token 格式可能不正確，請確認是否為正確的 GitHub Personal Access Token', 'warning');
            }
            
            githubToken = token;
            
            // 只有在允許自訂 Token 時才儲存到 localStorage
            if (ALLOW_CUSTOM_TOKEN) {
                localStorage.setItem('github_token', token);
            }
            
            showMessage('✅ GitHub Token 已儲存！正在連接...', 'success');
            hideTokenSetup();
            connectToGitHub();
        }
        
        // 隱藏 Token 設定區域
        function hideTokenSetup() {
            const tokenSetup = document.getElementById('token-setup');
            tokenSetup.style.display = 'none';
        }
        
        // 顯示 Token 設定區域
        function showTokenSetup() {
            const tokenSetup = document.getElementById('token-setup');
            tokenSetup.style.display = 'block';
        }
        
        // 載入本地資料
        function loadLocalData() {
            try {
                const savedEmployees = localStorage.getItem('timesheet_employees');
                const savedTimesheet = localStorage.getItem('timesheet_data');
                
                if (savedEmployees) {
                    employees = JSON.parse(savedEmployees);
                }
                
                if (savedTimesheet) {
                    timesheetData = JSON.parse(savedTimesheet);
                }
                
                if (Object.keys(employees).length > 0) {
                    updateAllTables();
                    showMessage('📂 已載入本地資料');
                }
            } catch (error) {
                console.error('載入本地資料失敗:', error);
            }
        }
        
        // 儲存本地資料
        function saveLocalData() {
            try {
                localStorage.setItem('timesheet_employees', JSON.stringify(employees));
                localStorage.setItem('timesheet_data', JSON.stringify(timesheetData));
            } catch (error) {
                console.error('儲存本地資料失敗:', error);
            }
        }
        
        // 連接到 GitHub
        function connectToGitHub() {
            if (!githubToken) {
                showMessage('❌ 請先設定 GitHub Token', 'error');
                showTokenSetup();
                return;
            }
            
            updateGitHubStatus('loading', '正在連接 GitHub...');
            
            // 測試 GitHub API 連接
            fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}`, {
                headers: {
                    'Authorization': `token ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            })
            .then(response => {
                if (response.ok) {
                    isGitHubConnected = true;
                    updateGitHubStatus('connected', '✅ 已連接到 GitHub repository');
                    showMessage('✅ GitHub 連接成功！正在載入資料...');
                    syncFromGitHub();
                } else if (response.status === 401) {
                    throw new Error('Token 無效或已過期，請檢查 GitHub Token');
                } else if (response.status === 404) {
                    throw new Error('找不到指定的 repository，請檢查設定');
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            })
            .catch(error => {
                console.error('GitHub 連接失敗:', error);
                showMessage(`❌ GitHub 連接失敗: ${error.message}`, 'error');
                updateGitHubStatus('disconnected', 'GitHub 連接失敗');
                
                // 如果是認證錯誤，顯示 token 設定區域
                if (error.message.includes('Token') || error.message.includes('401')) {
                    showTokenSetup();
                }
            });
        }
        
        // 更新 GitHub 連接狀態
        function updateGitHubStatus(status, message) {
            const statusDiv = document.getElementById('github-status');
            const statusText = document.getElementById('github-status-text');
            const syncBtn = document.getElementById('github-sync-btn');
            const downloadBtn = document.getElementById('github-download-btn');
            const disconnectBtn = document.getElementById('github-disconnect-btn');
            const lastSyncDiv = document.getElementById('last-sync');
            
            statusText.textContent = message;
            
            if (status === 'connected') {
                statusDiv.className = 'github-section github-connected';
                syncBtn.style.display = 'inline-block';
                downloadBtn.style.display = 'inline-block';
                disconnectBtn.style.display = 'inline-block';
                lastSyncDiv.style.display = 'block';
            } else if (status === 'loading') {
                statusDiv.className = 'github-section github-loading';
                syncBtn.style.display = 'none';
                downloadBtn.style.display = 'none';
                disconnectBtn.style.display = 'none';
            } else {
                statusDiv.className = 'github-section github-disconnected';
                syncBtn.style.display = 'none';
                downloadBtn.style.display = 'none';
                disconnectBtn.style.display = 'none';
                lastSyncDiv.style.display = 'none';
            }
        }
        
        // 中斷 GitHub 連接
        function disconnectGitHub() {
            if (confirm('確定要中斷 GitHub 連接嗎？您可以隨時重新連接。')) {
                isGitHubConnected = false;
                githubToken = '';
                localStorage.removeItem('github_token');
                document.getElementById('github-token-input').value = '';
                updateGitHubStatus('disconnected', '尚未連接到 GitHub repository');
                showTokenSetup();
                showMessage('🔌 已中斷 GitHub 連接');
            }
        }
        
        // 從 GitHub 同步資料
        async function syncFromGitHub() {
            if (!isGitHubConnected) {
                showMessage('❌ 請先連接 GitHub', 'error');
                return;
            }
            
            try {
                showMessage('🔄 正在從 GitHub 載入最新資料...');
                
                const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${DATA_FILE_NAME}`, {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.status === 404) {
                    showMessage('📝 GitHub 中尚無資料檔案，將在首次上傳時建立', 'warning');
                    updateSyncTime();
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const fileData = await response.json();
                const content = atob(fileData.content);
                const data = JSON.parse(content);
                
                // 載入到系統中
                employees = data.employees || {};
                timesheetData = data.timesheetData || [];
                
                // 儲存到本地
                saveLocalData();
                
                updateAllTables();
                updateSyncTime();
                
                const empCount = Object.keys(employees).length;
                const recordCount = timesheetData.length;
                
                showMessage(`✅ 成功載入 GitHub 資料！<br>👥 ${empCount} 位員工<br>📊 ${recordCount} 筆工時記錄`);
                
            } catch (error) {
                console.error('從 GitHub 同步失敗:', error);
                showMessage(`❌ 從 GitHub 載入失敗: ${error.message}`, 'error');
            }
        }
        
        // 上傳到 GitHub
        async function uploadToGitHub() {
            if (!isGitHubConnected) {
                throw new Error('未連接到 GitHub');
            }
            
            try {
                // 準備資料
                const data = {
                    employees: employees,
                    timesheetData: timesheetData,
                    lastUpdated: new Date().toISOString(),
                    version: '1.0',
                    systemName: 'GitHub 版工時管理系統'
                };
                
                const content = JSON.stringify(data, null, 2);
                const encodedContent = btoa(unescape(encodeURIComponent(content)));
                
                // 先檢查檔案是否存在以取得 sha
                let sha = null;
                try {
                    const existingFile = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${DATA_FILE_NAME}`, {
                        headers: {
                            'Authorization': `token ${githubToken}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (existingFile.ok) {
                        const fileData = await existingFile.json();
                        sha = fileData.sha;
                    }
                } catch (error) {
                    console.log('檔案不存在，將建立新檔案');
                }
                
                // 更新或建立檔案
                const updateData = {
                    message: `更新工時資料 - ${new Date().toLocaleString('zh-TW')}`,
                    content: encodedContent
                };
                
                if (sha) {
                    updateData.sha = sha;
                }
                
                const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${DATA_FILE_NAME}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`GitHub API 錯誤: ${errorData.message}`);
                }
                
                const result = await response.json();
                console.log('GitHub 更新成功:', result);
                
                updateSyncTime();
                return true;
                
            } catch (error) {
                console.error('上傳到 GitHub 失敗:', error);
                throw error;
            }
        }
        
        // 從 GitHub 下載完整資料檔
        async function downloadFromGitHub() {
            if (!isGitHubConnected) {
                showMessage('❌ 請先連接 GitHub', 'error');
                return;
            }
            
            try {
                const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${DATA_FILE_NAME}`, {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const fileData = await response.json();
                const content = atob(fileData.content);
                
                const blob = new Blob([content], { type: 'application/json' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `工時系統完整資料_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                showMessage('✅ 完整資料檔已下載！');
                
            } catch (error) {
                showMessage(`❌ 下載失敗: ${error.message}`, 'error');
            }
        }
        
        // 更新同步時間
        function updateSyncTime() {
            const syncTimeElement = document.getElementById('sync-time');
            if (syncTimeElement) {
                syncTimeElement.textContent = new Date().toLocaleString('zh-TW');
            }
        }
        
        // 計算員工週期資訊
        function calculateEmployeeCycle(employee, referenceDate = new Date()) {
            if (!employee.startDate) {
                return {
                    currentCycle: 1,
                    weekInCycle: 1,
                    cycleStartDate: new Date(),
                    cycleEndDate: new Date(),
                    daysInCycle: 0,
                    weeksFromStart: 0,
                    status: 'pending'
                };
            }
            
            // 確保日期格式正確處理
            const startDate = new Date(employee.startDate);
            const currentDate = new Date(referenceDate);
            
            // 調整時區，確保計算準確
            startDate.setHours(0, 0, 0, 0);
            currentDate.setHours(0, 0, 0, 0);
            
            // 計算總天數和週數
            const totalDays = Math.floor((currentDate - startDate) / (1000 * 60 * 60 * 24));
            const totalWeeks = Math.floor(totalDays / 7);
            
            // 避免負數情況
            if (totalDays < 0) {
                return {
                    currentCycle: 1,
                    weekInCycle: 1,
                    cycleStartDate: startDate,
                    cycleEndDate: new Date(startDate.getTime() + 56 * 24 * 60 * 60 * 1000),
                    daysInCycle: 0,
                    weeksFromStart: 0,
                    status: 'pending',
                    progressPercentage: 0
                };
            }
            
            // 計算當前週期（從1開始）
            const currentCycle = Math.floor(totalWeeks / 8) + 1;
            
            // 計算在當前週期中的週數（1-8）
            const weekInCycle = (totalWeeks % 8) + 1;
            
            // 計算當前週期的開始和結束日期
            const cycleNumber = currentCycle - 1; // 週期編號從0開始計算日期
            const cycleStartDate = new Date(startDate);
            cycleStartDate.setDate(cycleStartDate.getDate() + (cycleNumber * 56)); // 56天 = 8週
            
            const cycleEndDate = new Date(cycleStartDate);
            cycleEndDate.setDate(cycleEndDate.getDate() + 55); // 55天後（第56天是週期最後一天）
            
            // 計算在當前週期中的天數
            const daysInCycle = Math.max(0, Math.floor((currentDate - cycleStartDate) / (1000 * 60 * 60 * 24)) + 1);
            
            // 判斷週期狀態
            let status = 'active';
            if (weekInCycle > 8) {
                status = 'complete';
            } else if (employee.totalHours > 304) {
                status = 'overtime';
            } else if (daysInCycle <= 0) {
                status = 'pending';
            }
            
            // 計算進度百分比
            const progressPercentage = Math.min((daysInCycle / 56) * 100, 100);
            
            return {
                currentCycle,
                weekInCycle: Math.min(Math.max(weekInCycle, 1), 8), // 確保在1-8範圍內
                cycleStartDate,
                cycleEndDate,
                daysInCycle: Math.min(Math.max(daysInCycle, 0), 56),
                weeksFromStart: totalWeeks,
                status,
                progressPercentage
            };
        }
        
        // Tab 切換
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }
        
        // 顯示訊息
        function showMessage(message, type = 'success') {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'error' ? 'error-message' : 
                                 type === 'warning' ? 'warning-message' : 'success-message';
            messageDiv.innerHTML = message;
            messagesDiv.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 8000);
        }
        
        // 更新進度
        function updateProgress(percentage, text) {
            document.getElementById('progress-fill').style.width = percentage + '%';
            document.getElementById('progress-text').textContent = text;
        }
        
        // 驗證 Payroll ID 格式
        function validatePayrollID(payrollId) {
            if (!payrollId) return false;
            const pattern = /^[A-Z]{2,3}-\d{3,4}$/;
            return pattern.test(payrollId.trim());
        }
        
        // 解析週數（從工作週的日期計算實際週數）
        function parseWeekNumber(workWeekDateString, startDateString) {
            if (!workWeekDateString || !startDateString) return 1;
            
            try {
                // 解析工作週日期（週一的日期）
                const workWeekDate = new Date(workWeekDateString);
                const startDate = new Date(startDateString);
                
                // 確保日期有效
                if (isNaN(workWeekDate.getTime()) || isNaN(startDate.getTime())) {
                    console.warn('日期格式無效:', workWeekDateString, startDateString);
                    return 1;
                }
                
                // 計算從開始日期到工作週的天數差
                const daysDiff = Math.floor((workWeekDate - startDate) / (1000 * 60 * 60 * 24));
                
                // 計算週數（從第1週開始）
                const weekNumber = Math.floor(daysDiff / 7) + 1;
                
                // 確保週數在合理範圍內
                return Math.max(1, Math.min(weekNumber, 52));
                
            } catch (error) {
                console.error('週數計算錯誤:', error);
                return 1;
            }
        }
        
        // 解析工資率
        function parseRate(rateString) {
            if (!rateString) return 0;
            return parseFloat(rateString.toString().replace(/[^0-9.]/g, '')) || 0;
        }
        
        // 處理工時表文件
        async function handleTimesheetFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                updateProgress(20, '正在讀取工時表...');
                
                const data = await readFile(file);
                const parsed = parseCSV(data);
                
                updateProgress(40, '驗證資料格式...');
                
                const validationResult = validateTimesheetData(parsed);
                
                if (validationResult.errors.length > 0) {
                    showValidationResults(validationResult);
                    updateProgress(0, '資料驗證失敗');
                    return;
                }
                
                updateProgress(60, '檢查資料衝突...');
                
                const conflicts = checkForConflicts(parsed);
                
                if (conflicts.length > 0) {
                    showConflictDialog(parsed, conflicts);
                } else {
                    processTimesheetData(parsed);
                }
                
            } catch (error) {
                showMessage('讀取工時表時發生錯誤: ' + error.message, 'error');
                updateProgress(0, '載入失敗');
            }
        }
        
        // 驗證工時表資料
        function validateTimesheetData(data) {
            const result = {
                success: [],
                warnings: [],
                errors: []
            };
            
            if (data.length === 0) {
                result.errors.push('文件為空或格式不正確');
                return result;
            }
            
            const requiredFields = ['Payroll ID', 'First Name', 'Last Name', 'Work Week', 'Hours'];
            const headers = Object.keys(data[0]);
            
            for (const field of requiredFields) {
                if (!headers.includes(field)) {
                    result.errors.push(`缺少必要欄位: ${field}`);
                }
            }
            
            if (result.errors.length > 0) {
                return result;
            }
            
            const employeeConsistency = {};
            let validRecords = 0;
            let skippedEmptyRecords = 0;
            
            data.forEach((row, index) => {
                const payrollId = row['Payroll ID']?.trim();
                const firstName = row['First Name']?.trim();
                const lastName = row['Last Name']?.trim();
                const workWeek = row['Work Week']?.trim();
                const hours = parseFloat(row['Hours']);
                
                // 如果整行都是空的，跳過但不報錯
                if (!payrollId && !firstName && !lastName && !workWeek && isNaN(hours)) {
                    skippedEmptyRecords++;
                    return;
                }
                
                validRecords++;
                
                if (!validatePayrollID(payrollId)) {
                    result.errors.push(`第${index + 2}行: Payroll ID 格式錯誤 (${payrollId})，應為 EQ-0001 格式`);
                }
                
                if (!payrollId) {
                    result.errors.push(`第${index + 2}行: Payroll ID 為空`);
                }
                
                if (!firstName || !lastName) {
                    result.errors.push(`第${index + 2}行: 姓名資料不完整`);
                }
                
                if (!workWeek) {
                    result.errors.push(`第${index + 2}行: Work Week 為空`);
                }
                
                if (isNaN(hours) || hours < 0) {
                    result.errors.push(`第${index + 2}行: 工時資料無效 (${row['Hours']})`);
                }
                
                if (hours > 168) {
                    result.warnings.push(`第${index + 2}行: 工時超過一週168小時 (${hours})`);
                }
                
                if (payrollId && validatePayrollID(payrollId)) {
                    if (!employeeConsistency[payrollId]) {
                        employeeConsistency[payrollId] = {
                            firstName: firstName,
                            lastName: lastName,
                            startDate: row['Start Date'],
                            level: row['Level'],
                            rate: row['Rate'],
                            farm: row['Farm']
                        };
                    } else {
                        const existing = employeeConsistency[payrollId];
                        if (existing.firstName !== firstName || existing.lastName !== lastName) {
                            result.errors.push(`第${index + 2}行: 員工 ${payrollId} 的姓名與先前記錄不一致`);
                        }
                    }
                }
            });
            
            if (result.errors.length === 0) {
                result.success.push(`成功驗證 ${validRecords} 筆工時記錄`);
                result.success.push(`涉及 ${Object.keys(employeeConsistency).length} 位員工`);
                
                if (skippedEmptyRecords > 0) {
                    result.warnings.push(`已自動跳過 ${skippedEmptyRecords} 行空白記錄`);
                }
            }
            
            return result;
        }
        
        // 檢查資料衝突（使用工作週日期作為唯一識別）
        function checkForConflicts(newData) {
            const conflicts = [];
            
            newData.forEach(row => {
                const payrollId = row['Payroll ID']?.trim();
                const workWeekDate = row['Work Week']?.trim();
                const startDate = row['Start Date']?.trim();
                const weekNum = parseWeekNumber(workWeekDate, startDate);
                
                const existing = timesheetData.find(existing => 
                    existing.payrollId === payrollId && 
                    (existing.weekNumber === weekNum || existing.workWeekDate === workWeekDate)
                );
                
                if (existing) {
                    conflicts.push({
                        payrollId: payrollId,
                        weekNumber: weekNum,
                        workWeekDate: workWeekDate,
                        existingHours: existing.hours,
                        newHours: parseFloat(row['Hours']),
                        employeeName: `${row['First Name']} ${row['Last Name']}`
                    });
                }
            });
            
            return conflicts;
        }
        
        // 顯示衝突對話框
        function showConflictDialog(newData, conflicts) {
            const dialog = document.createElement('div');
            dialog.className = 'confirm-dialog';
            
            let conflictsList = '';
            conflicts.forEach(conflict => {
                conflictsList += `
                    <div class="validation-warning">
                        <strong>${conflict.employeeName} (${conflict.payrollId})</strong> - 第${conflict.weekNumber}週
                        <br>現有工時: ${conflict.existingHours} → 新工時: ${conflict.newHours}
                    </div>
                `;
            });
            
            dialog.innerHTML = `
                <div class="confirm-content">
                    <h3>⚠️ 發現資料衝突</h3>
                    <p>以下員工的工時資料已存在於系統中，是否要覆蓋？</p>
                    ${conflictsList}
                    <div class="confirm-buttons">
                        <button class="btn-confirm" onclick="confirmOverwrite(true)">覆蓋並更新</button>
                        <button class="btn-cancel" onclick="confirmOverwrite(false)">取消上傳</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(dialog);
            pendingData = newData;
        }
        
        // 確認覆蓋
        function confirmOverwrite(confirmed) {
            const dialog = document.querySelector('.confirm-dialog');
            if (dialog) {
                dialog.remove();
            }
            
            if (confirmed && pendingData) {
                processTimesheetData(pendingData, true);
            } else {
                updateProgress(0, '上傳已取消');
            }
            
            pendingData = null;
        }
        
        // 處理工時表資料
        async function processTimesheetData(data, overwrite = false) {
            updateProgress(80, '整合資料中...');
            
            const uploadSummary = {
                totalRecords: data.length,
                employees: new Set(),
                weeks: new Set(),
                newRecords: 0,
                updatedRecords: 0
            };
            
            // 處理每筆記錄
            data.forEach(row => {
                const payrollId = row['Payroll ID']?.trim();
                const firstName = row['First Name']?.trim();
                const lastName = row['Last Name']?.trim();
                const startDate = row['Start Date']?.trim();
                const workWeekDate = row['Work Week']?.trim();
                const hours = parseFloat(row['Hours']);
                const level = row['Level']?.trim();
                const rate = parseRate(row['Rate']);
                const farm = row['Farm']?.trim();
                const weekNumber = parseWeekNumber(workWeekDate, startDate);
                
                uploadSummary.employees.add(payrollId);
                uploadSummary.weeks.add(`第${weekNumber}週 (${workWeekDate})`);
                
                // 更新或建立員工基本資料
                if (!employees[payrollId]) {
                    employees[payrollId] = {
                        payrollId: payrollId,
                        firstName: firstName,
                        lastName: lastName,
                        startDate: startDate || '2024-01-01',
                        level: level || '',
                        farm: farm || '',
                        hourlyRate: rate || 25.0,
                        overtimeRate: (rate || 25.0) * 1.5,
                        weeklyHours: Array(52).fill(0), // 擴展到52週
                        totalHours: 0,
                        payrollData: {
                            regularHours: 0,
                            overtimeHours: 0,
                            regularPay: 0,
                            overtimePay: 0,
                            totalPay: 0
                        }
                    };
                } else {
                    // 更新員工資訊（允許修改 Farm、Level、Rate 等）
                    if (startDate) employees[payrollId].startDate = startDate;
                    if (level) employees[payrollId].level = level;
                    if (farm) employees[payrollId].farm = farm;
                    if (rate > 0) {
                        employees[payrollId].hourlyRate = rate;
                        employees[payrollId].overtimeRate = rate * 1.5;
                    }
                }
                
                // 更新工時資料
                const existingIndex = timesheetData.findIndex(item => 
                    item.payrollId === payrollId && 
                    (item.weekNumber === weekNumber || item.workWeekDate === workWeekDate)
                );
                
                if (existingIndex >= 0) {
                    if (overwrite) {
                        timesheetData[existingIndex].hours = hours;
                        timesheetData[existingIndex].workWeekDate = workWeekDate;
                        timesheetData[existingIndex].weekNumber = weekNumber;
                        uploadSummary.updatedRecords++;
                    }
                } else {
                    timesheetData.push({
                        payrollId: payrollId,
                        firstName: firstName,
                        lastName: lastName,
                        workWeek: `Week ${weekNumber}`,
                        workWeekDate: workWeekDate,
                        weekNumber: weekNumber,
                        hours: hours,
                        uploadDate: new Date().toISOString()
                    });
                    uploadSummary.newRecords++;
                }
                
                // 更新員工週時數（限制在前52週內）
                if (weekNumber >= 1 && weekNumber <= 52) {
                    employees[payrollId].weeklyHours[weekNumber - 1] = hours;
                }
            });
            
            // 重新計算每個員工的總工時（使用當前週期的前8週）
            Object.values(employees).forEach(employee => {
                const cycleInfo = calculateEmployeeCycle(employee);
                const cycleStartWeek = Math.max(1, (cycleInfo.currentCycle - 1) * 8 + 1);
                const cycleEndWeek = Math.min(52, cycleStartWeek + 7);
                
                // 計算當前週期的總工時
                let currentCycleTotalHours = 0;
                for (let week = cycleStartWeek; week <= cycleEndWeek; week++) {
                    currentCycleTotalHours += employee.weeklyHours[week - 1] || 0;
                }
                
                employee.totalHours = currentCycleTotalHours;
                calculatePayroll(employee);
            });
            
            // 儲存到本地
            saveLocalData();
            
            try {
                if (isGitHubConnected) {
                    updateProgress(95, '推送到 GitHub...');
                    await uploadToGitHub();
                    updateProgress(100, 'GitHub 更新完成');
                } else {
                    updateProgress(100, '本地更新完成');
                }
                
                // 顯示上傳摘要
                showUploadSummary(uploadSummary);
                
                // 更新所有表格
                updateAllTables();
                
                // 顯示成功訊息
                const githubStatus = isGitHubConnected ? '<br>🐙 已推送到 GitHub repository' : '<br>💾 已保存到本地（建議連接 GitHub 以便團隊協作）';
                
                showMessage(`
                    ✅ 上傳成功！<br>
                    📊 處理 ${uploadSummary.totalRecords} 筆記錄<br>
                    👥 涉及 ${uploadSummary.employees.size} 位員工<br>
                    📅 涵蓋 ${Array.from(uploadSummary.weeks).join(', ')}<br>
                    ➕ 新增 ${uploadSummary.newRecords} 筆，更新 ${uploadSummary.updatedRecords} 筆
                    ${githubStatus}
                `);
                
            } catch (error) {
                updateProgress(80, '推送失敗');
                showMessage(`❌ 推送到 GitHub 失敗: ${error.message}<br>💾 資料已保存到本地`, 'warning');
                
                // 即使 GitHub 失敗，也要顯示摘要和更新表格
                showUploadSummary(uploadSummary);
                updateAllTables();
            }
        }
        
        // 計算薪資（修改為只計算加班費）
        function calculatePayroll(employee) {
            const totalHours = employee.totalHours;
            const hourlyRate = employee.hourlyRate;
            
            if (totalHours > 304) {
                employee.payrollData.regularHours = 304;
                employee.payrollData.overtimeHours = totalHours - 304;
                employee.payrollData.regularPay = 304 * hourlyRate;
                employee.payrollData.overtimePay = employee.payrollData.overtimeHours * hourlyRate; // 加班費 = 加班工時 * 時薪
            } else {
                employee.payrollData.regularHours = totalHours;
                employee.payrollData.overtimeHours = 0;
                employee.payrollData.regularPay = totalHours * hourlyRate;
                employee.payrollData.overtimePay = 0;
            }
            
            employee.payrollData.totalPay = employee.payrollData.regularPay + employee.payrollData.overtimePay;
        }
        
        // 取得篩選後的員工列表
        function getFilteredEmployees() {
            const farmFilter = document.getElementById('farm-filter')?.value || '';
            const levelFilter = document.getElementById('level-filter')?.value || '';
            const statusFilter = document.getElementById('status-filter')?.value || '';
            
            return Object.values(employees).filter(employee => {
                // 農場篩選
                if (farmFilter && employee.farm !== farmFilter) return false;
                
                // 職級篩選
                if (levelFilter && employee.level !== levelFilter) return false;
                
                // 狀態篩選
                if (statusFilter) {
                    const cycleInfo = calculateEmployeeCycle(employee);
                    if (statusFilter === 'overtime' && employee.totalHours <= 304) return false;
                    if (statusFilter === 'active' && (employee.totalHours > 304 || cycleInfo.status !== 'active')) return false;
                    if (statusFilter === 'complete' && cycleInfo.status !== 'complete') return false;
                }
                
                return true;
            });
        }
        
        // 更新篩選器選項
        function updateFilterOptions() {
            const farmFilter = document.getElementById('farm-filter');
            const levelFilter = document.getElementById('level-filter');
            
            if (!farmFilter || !levelFilter) return;
            
            // 收集所有農場和職級
            const farms = new Set();
            const levels = new Set();
            
            Object.values(employees).forEach(employee => {
                if (employee.farm) farms.add(employee.farm);
                if (employee.level) levels.add(employee.level);
            });
            
            // 更新農場篩選器
            const currentFarm = farmFilter.value;
            farmFilter.innerHTML = '<option value="">所有農場</option>';
            [...farms].sort().forEach(farm => {
                const option = document.createElement('option');
                option.value = farm;
                option.textContent = farm;
                if (farm === currentFarm) option.selected = true;
                farmFilter.appendChild(option);
            });
            
            // 更新職級篩選器
            const currentLevel = levelFilter.value;
            levelFilter.innerHTML = '<option value="">所有職級</option>';
            [...levels].sort().forEach(level => {
                const option = document.createElement('option');
                option.value = level;
                option.textContent = level;
                if (level === currentLevel) option.selected = true;
                levelFilter.appendChild(option);
            });
        }
        
        // 清除篩選
        function clearFilters() {
            document.getElementById('farm-filter').value = '';
            document.getElementById('level-filter').value = '';
            document.getElementById('status-filter').value = '';
            updateAllTables();
        }
        
        // 更新員工總覽（整合週期分析）
        function updateOverviewTable() {
            const container = document.getElementById('overview-table-container');
            
            if (Object.keys(employees).length === 0) {
                container.innerHTML = '<p>尚未載入員工資料，請先上傳工時表</p>';
                return;
            }
            
            updateFilterOptions();
            const filteredEmployees = getFilteredEmployees();
            
            let tableHTML = `
                <table class="employee-table">
                    <thead>
                        <tr>
                            <th>員工編號</th>
                            <th>姓名</th>
                            <th>農場</th>
                            <th>職級</th>
                            <th>開始日期</th>
                            <th>當前週期</th>
                            <th>週期進度</th>
                            <th>週期狀態</th>
                            <th>週期工時</th>
                            <th>剩餘額度</th>
                            <th>預計結束</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // 計算統計
            let activeCycles = 0;
            let completeCycles = 0;
            let overtimeCycles = 0;
            
            filteredEmployees
                .sort((a, b) => a.payrollId.localeCompare(b.payrollId))
                .forEach(employee => {
                    const fullName = `${employee.firstName} ${employee.lastName}`.trim();
                    const cycleInfo = calculateEmployeeCycle(employee);
                    
                    // 統計週期狀態
                    if (employee.totalHours > 304) {
                        overtimeCycles++;
                    } else if (cycleInfo.status === 'complete') {
                        completeCycles++;
                    } else {
                        activeCycles++;
                    }
                    
                    // 狀態顯示
                    let statusClass = 'cycle-active';
                    let statusText = '進行中';
                    
                    if (employee.totalHours > 304) {
                        statusClass = 'cycle-overtime';
                        statusText = '需加班費';
                    } else if (cycleInfo.status === 'complete') {
                        statusClass = 'cycle-complete';
                        statusText = '已完成';
                    }
                    
                    // 剩餘工時額度
                    const remainingHours = Math.max(0, 304 - employee.totalHours);
                    const remainingText = employee.totalHours > 304 ? 
                        `超出 ${employee.totalHours - 304}h` : 
                        `剩餘 ${remainingHours}h`;
                    
                    // 週期進度條
                    const progressPercentage = cycleInfo.progressPercentage;
                    const progressClass = employee.totalHours > 304 ? 'cycle-progress-overtime' : '';
                    
                    tableHTML += `
                        <tr>
                            <td><strong>${employee.payrollId}</strong></td>
                            <td>${fullName}</td>
                            <td>${employee.farm || '-'}</td>
                            <td>${employee.level}</td>
                            <td>${employee.startDate}</td>
                            <td>第 ${cycleInfo.currentCycle} 週期<br><small>第 ${cycleInfo.weekInCycle}/8 週</small></td>
                            <td>
                                <div class="cycle-progress">
                                    <div class="cycle-progress-fill ${progressClass}" style="width: ${progressPercentage}%"></div>
                                </div>
                                <small>${progressPercentage.toFixed(1)}% 完成</small>
                            </td>
                            <td><span class="cycle-status ${statusClass}">${statusText}</span></td>
                            <td><strong>${employee.totalHours}h</strong></td>
                            <td>${remainingText}</td>
                            <td>${cycleInfo.cycleEndDate.toLocaleDateString('zh-TW')}</td>
                        </tr>
                    `;
                });
            
            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
            
            // 更新摘要卡片
            const totalFiltered = filteredEmployees.length;
            const summaryHTML = `
                <div class="summary-card">
                    <h3>${totalFiltered}</h3>
                    <p>篩選後員工數</p>
                </div>
                <div class="summary-card">
                    <h3>${activeCycles}</h3>
                    <p>進行中週期</p>
                </div>
                <div class="summary-card">
                    <h3>${overtimeCycles}</h3>
                    <p>需加班費</p>
                </div>
                <div class="summary-card">
                    <h3>${completeCycles}</h3>
                    <p>已完成週期</p>
                </div>
            `;
            document.getElementById('overview-summary-cards').innerHTML = summaryHTML;
        }
        
        // 匯出員工總覽報告
        function exportOverview() {
            if (Object.keys(employees).length === 0) {
                showMessage('沒有資料可以匯出', 'error');
                return;
            }
            
            const filteredEmployees = getFilteredEmployees();
            let csvContent = 'Payroll ID,姓名,農場,職級,開始日期,當前週期,週期內週數,週期狀態,週期工時,剩餘額度,週期開始日,週期結束日,進度百分比\n';
            
            filteredEmployees.forEach(employee => {
                const fullName = `${employee.firstName} ${employee.lastName}`.trim();
                const cycleInfo = calculateEmployeeCycle(employee);
                
                let statusText = '進行中';
                if (employee.totalHours > 304) statusText = '需加班費';
                else if (cycleInfo.status === 'complete') statusText = '已完成';
                
                const remainingHours = Math.max(0, 304 - employee.totalHours);
                const remainingText = employee.totalHours > 304 ? 
                    `超出${employee.totalHours - 304}小時` : 
                    `剩餘${remainingHours}小時`;
                
                csvContent += `${employee.payrollId},"${fullName}",${employee.farm || ''},${employee.level},${employee.startDate},${cycleInfo.currentCycle},${cycleInfo.weekInCycle},${statusText},${employee.totalHours},${remainingText},${cycleInfo.cycleStartDate.toLocaleDateString('zh-TW')},${cycleInfo.cycleEndDate.toLocaleDateString('zh-TW')},${cycleInfo.progressPercentage.toFixed(1)}%\n`;
            });
            
            downloadCSV(csvContent, `員工總覽報告_${new Date().toISOString().split('T')[0]}.csv`);
            showMessage('✅ 員工總覽報告已匯出');
        }
        
        // 顯示上傳摘要
        function showUploadSummary(summary) {
            const container = document.getElementById('timesheet-file-info');
            container.style.display = 'block';
            container.className = 'upload-summary';
            
            container.innerHTML = `
                <h3>📊 上傳摘要</h3>
                <div class="summary-item">
                    <span>總記錄數：</span>
                    <span class="highlight">${summary.totalRecords}</span>
                </div>
                <div class="summary-item">
                    <span>員工數量：</span>
                    <span class="highlight">${summary.employees.size}</span>
                </div>
                <div class="summary-item">
                    <span>涵蓋週數：</span>
                    <span>${Array.from(summary.weeks).join(', ')}</span>
                </div>
                <div class="summary-item">
                    <span>新增記錄：</span>
                    <span class="highlight">${summary.newRecords}</span>
                </div>
                <div class="summary-item">
                    <span>更新記錄：</span>
                    <span class="highlight">${summary.updatedRecords}</span>
                </div>
                <div class="summary-item">
                    <span>上傳時間：</span>
                    <span>${new Date().toLocaleString('zh-TW')}</span>
                </div>
                <div class="summary-item">
                    <span>同步狀態：</span>
                    <span class="highlight">${isGitHubConnected ? '已同步到 GitHub' : '僅本地儲存'}</span>
                </div>
            `;
        }
        
        // 顯示驗證結果
        function showValidationResults(result) {
            const container = document.getElementById('validation-results');
            
            let html = '';
            
            result.success.forEach(msg => {
                html += `<div class="validation-item validation-success">✅ ${msg}</div>`;
            });
            
            result.warnings.forEach(msg => {
                html += `<div class="validation-item validation-warning">⚠️ ${msg}</div>`;
            });
            
            result.errors.forEach(msg => {
                html += `<div class="validation-item validation-error">❌ ${msg}</div>`;
            });
            
            container.innerHTML = html;
        }
        
        // 讀取文件
        async function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) { resolve(e.target.result); };
                reader.onerror = function() { reject(new Error('文件讀取失敗')); };
                reader.readAsText(file, 'UTF-8');
            });
        }
        
        // 解析CSV
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            
            return lines.slice(1)
                .filter(line => {
                    // 過濾掉空行或只有逗號的行
                    const trimmedLine = line.trim();
                    return trimmedLine && !trimmedLine.match(/^,*$/);
                })
                .map(line => {
                    const values = [];
                    let current = '';
                    let inQuotes = false;
                    
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            values.push(current.trim());
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    values.push(current.trim());
                    
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] || '';
                    });
                    return row;
                })
                .filter(row => {
                    // 進一步過濾：確保至少有 Payroll ID 或其他關鍵資料
                    const payrollId = row['Payroll ID']?.trim();
                    const firstName = row['First Name']?.trim();
                    const lastName = row['Last Name']?.trim();
                    return payrollId || firstName || lastName;
                });
        }
        
        // 更新所有表格
        function updateAllTables() {
            updateOverviewTable();
            updatePayrollTable();
        }
        
        // 更新薪資表格
        function updatePayrollTable() {
            const container = document.getElementById('payroll-table-container');
            
            if (Object.keys(employees).length === 0) {
                container.innerHTML = '<p>尚未載入員工資料，請先上傳工時表</p>';
                return;
            }
            
            let tableHTML = `
                <table class="employee-table">
                    <thead>
                        <tr>
                            <th>員工編號</th>
                            <th>姓名</th>
                            <th>職級</th>
                            <th>正常工時</th>
                            <th>加班工時</th>
                            <th>正常薪資</th>
                            <th>加班費</th>
                            <th>總薪資</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            let totalRegularPay = 0;
            let totalOvertimePay = 0;
            let totalPay = 0;
            
            Object.values(employees)
                .sort((a, b) => b.payrollData.totalPay - a.payrollData.totalPay)
                .forEach(employee => {
                    const fullName = `${employee.firstName} ${employee.lastName}`.trim();
                    
                    totalRegularPay += employee.payrollData.regularPay;
                    totalOvertimePay += employee.payrollData.overtimePay;
                    totalPay += employee.payrollData.totalPay;
                    
                    tableHTML += `
                        <tr>
                            <td><strong>${employee.payrollId}</strong></td>
                            <td>${fullName}</td>
                            <td>${employee.level}</td>
                            <td>${employee.payrollData.regularHours}</td>
                            <td>${employee.payrollData.overtimeHours}</td>
                            <td class="money">${employee.payrollData.regularPay.toFixed(2)}</td>
                            <td class="money">${employee.payrollData.overtimePay.toFixed(2)}</td>
                            <td class="money"><strong>${employee.payrollData.totalPay.toFixed(2)}</strong></td>
                        </tr>
                    `;
                });
            
            tableHTML += `
                <tr style="background: #f0f0f0; font-weight: bold;">
                    <td colspan="5">總計</td>
                    <td class="money">${totalRegularPay.toFixed(2)}</td>
                    <td class="money">${totalOvertimePay.toFixed(2)}</td>
                    <td class="money">${totalPay.toFixed(2)}</td>
                </tr>
            `;
            
            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
            
            // 更新薪資摘要
            const totalEmployees = Object.keys(employees).length;
            const overtimeEmployees = Object.values(employees).filter(emp => emp.totalHours > 304).length;
            
            const summaryHTML = `
                <div class="summary-card">
                    <h3>${totalPay.toFixed(0)}</h3>
                    <p>總薪資支出</p>
                </div>
                <div class="summary-card">
                    <h3>${totalOvertimePay.toFixed(0)}</h3>
                    <p>加班費支出</p>
                </div>
                <div class="summary-card">
                    <h3>${overtimeEmployees}</h3>
                    <p>加班員工數</p>
                </div>
                <div class="summary-card">
                    <h3>${totalEmployees > 0 ? (totalPay / totalEmployees).toFixed(0) : 0}</h3>
                    <p>平均薪資</p>
                </div>
            `;
            document.getElementById('payroll-summary-cards').innerHTML = summaryHTML;
        }
        
        // 匯出薪資報表（只包含加班費）
        function exportPayroll() {
            if (Object.keys(employees).length === 0) {
                showMessage('沒有資料可以匯出', 'error');
                return;
            }
            
            const filteredEmployees = getFilteredEmployees();
            let csvContent = 'Payroll ID,姓名,農場,職級,總工時,加班工時,時薪,加班費\n';
            
            filteredEmployees.forEach(employee => {
                const fullName = `${employee.firstName} ${employee.lastName}`.trim();
                
                csvContent += `${employee.payrollId},"${fullName}",${employee.farm || ''},${employee.level},${employee.totalHours},${employee.payrollData.overtimeHours},${employee.hourlyRate},${employee.payrollData.overtimePay.toFixed(2)}\n`;
            });
            
            downloadCSV(csvContent, `加班費報表_${new Date().toISOString().split('T')[0]}.csv`);
            showMessage('✅ 加班費報表已匯出');
        }
        
        // 下載CSV文件
        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }
        
        // 拖拽功能
        const uploadSection = document.getElementById('timesheet-upload');
        
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });
        
        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });
        
        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('timesheet-file').files = files;
                handleTimesheetFile({ target: { files } });
            }
        });
    </script>
</body>
</html>
