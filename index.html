<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub 版工時管理系統</title>
    <style>
        /* General Styles */
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            /* Softer gradient for a more 'exquisite' feel */
            background: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            /* Lighter, more subtle shadow */
            box-shadow: 0 15px 30px rgba(0,0,0,0.08);
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 32px; /* Slightly larger */
            font-weight: 600;
        }

        /* Token Setup */
        .token-setup {
            background: #f8f9fa;
            border: 2px solid #28a745;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .token-setup h3 {
            color: #28a745;
            margin: 0 0 15px 0;
            font-size: 22px;
        }

        .token-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap; /* Allow wrapping on small screens */
        }

        .token-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
            min-width: 200px; /* Ensure input is not too small */
        }

        .token-input:focus {
            border-color: #667eea; /* Focus color for inputs */
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.25);
        }

        .save-token-btn {
            background: #667eea; /* Use main theme color */
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s ease, transform 0.2s ease;
        }

        .save-token-btn:hover {
            background: #506ee5; /* Darker shade on hover */
            transform: translateY(-2px);
        }

        .save-token-btn:active {
            transform: translateY(0);
        }

        .token-instructions {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 5px;
            padding: 15px;
            margin-top: 15px;
            font-size: 14px;
        }

        /* Message Styles */
        .success-message {
            background: #e6ffe6;
            color: #006600;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 5px solid #006600;
            opacity: 1;
            transition: opacity 0.5s ease;
        }

        .error-message {
            background: #ffe6e6;
            color: #cc0000;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 5px solid #cc0000;
            opacity: 1;
            transition: opacity 0.5s ease;
        }

        .warning-message {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 5px solid #ffc107;
            opacity: 1;
            transition: opacity 0.5s ease;
        }
        
        .message-fadeout {
            opacity: 0;
        }

        /* GitHub Section */
        .github-section {
            background: #f6f8fa;
            border: 2px solid #0366d6;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }

        .github-connected {
            background: #d4edda;
            border-color: #28a745;
        }

        .github-disconnected {
            background: #f8d7da;
            border-color: #dc3545;
        }

        .github-loading {
            background: #fff3cd;
            border-color: #ffc107;
        }

        .central-db-info {
            background: #e7f3ff;
            border: 2px solid #b3d9ff;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .central-db-info h3 {
            color: #0066cc;
            margin: 0 0 15px 0;
            font-size: 22px;
        }

        .workflow-step {
            display: flex;
            align-items: center;
            margin: 15px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); /* Subtle shadow for steps */
        }

        .step-number {
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: bold;
            flex-shrink: 0; /* Prevent shrinking */
        }

        /* Upload Section */
        .upload-section {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
            background: #f8f9ff;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }

        .upload-section.dragover {
            border-color: #764ba2;
            background: #e8ebff;
            transform: scale(1.01); /* Slightly less aggressive scale */
        }

        .file-input {
            display: none;
        }

        .upload-btn, .github-btn, .action-btn { /* Unified button styles */
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px; /* Adjust margin for multiple buttons */
            transition: transform 0.2s, background 0.3s, box-shadow 0.2s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); /* Add shadow */
            display: inline-flex; /* For spinner alignment */
            align-items: center;
            justify-content: center;
            gap: 8px; /* Space for spinner */
        }
        
        .github-btn {
            background: linear-gradient(45deg, #0366d6, #0256cc);
        }

        .github-btn-warning {
            background: linear-gradient(45deg, #ffc107, #e0a800);
            color: #333;
        }
        
        .github-btn-danger { /* For clear data button */
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
        }
        .github-btn-danger:hover {
            background: linear-gradient(45deg, #c82333, #bd2130);
        }


        .upload-btn:hover, .github-btn:hover, .action-btn:hover {
            transform: translateY(-3px); /* More pronounced lift */
            box-shadow: 0 6px 12px rgba(0,0,0,0.15); /* Stronger shadow on hover */
        }
        .upload-btn:active, .github-btn:active, .action-btn:active {
             transform: translateY(0);
             box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .upload-btn:disabled, .github-btn:disabled, .action-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .file-info {
            margin-top: 15px;
            padding: 10px;
            background: #e8f5e8;
            border-radius: 5px;
            display: none;
        }

        /* Tabs */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
            flex-wrap: wrap;
            justify-content: center; /* Center tabs */
            gap: 10px; /* Gap between tabs */
        }

        .tab {
            padding: 15px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            min-width: 120px;
            text-align: center;
            font-weight: 500;
            color: #555;
        }

        .tab.active {
            border-bottom-color: #667eea;
            color: #667eea;
            font-weight: bold;
            background: #f0f2ff; /* Light background for active tab */
        }
        .tab:hover:not(.active) {
            background: #f8faff;
            color: #667eea;
        }

        .tab-content {
            display: none;
            padding-top: 10px; /* Give some space below tabs */
        }

        .tab-content.active {
            display: block;
        }

        /* Tables */
        .employee-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px; /* Slightly larger font */
        }

        .employee-table th,
        .employee-table td {
            border: 1px solid #ddd;
            padding: 10px 8px; /* More padding */
            text-align: left;
        }

        .employee-table th {
            background: #667eea;
            color: white;
            font-size: 13px;
            text-transform: uppercase; /* Uppercase headers */
            letter-spacing: 0.5px;
        }

        .employee-table tr:nth-child(even) {
            background: #f9f9f9;
        }
        .employee-table tr:hover {
            background: #f0f2ff; /* Hover effect for table rows */
        }

        .status-normal {
            color: #228B22;
            font-weight: bold;
        }

        .status-overtime {
            color: #ff4444;
            font-weight: bold;
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef; /* Lighter background */
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease-out; /* Smoother transition */
        }
        
        #progress-text {
            text-align: center;
            font-weight: 500;
            color: #555;
        }

        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); /* Add shadow */
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .summary-card h3 {
            margin: 0 0 10px 0;
            font-size: 24px; /* Larger font for key numbers */
            font-weight: 700;
        }

        .summary-card p {
            margin: 0;
            font-size: 14px;
            opacity: 0.9;
        }

        /* Other utility styles */
        .money {
            color: #28a745;
            font-weight: bold;
        }

        .format-info {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            font-size: 14px;
        }

        .format-info h4 {
            margin: 0 0 10px 0;
            color: #0066cc;
            font-size: 18px;
        }

        .format-example {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            margin: 5px 0;
            white-space: pre-wrap; /* Preserve line breaks */
            word-break: break-all;
            line-height: 1.5;
        }
        .format-info ul {
            padding-left: 20px;
            margin-top: 10px;
        }
        .format-info li {
            margin-bottom: 5px;
        }

        /* Confirmation Dialog */
        .confirm-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6); /* Slightly darker overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .confirm-dialog.active {
            opacity: 1;
            visibility: visible;
        }

        .confirm-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            max-height: 90%; /* Allow more height */
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0,0,0,0.25); /* Stronger shadow */
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        .confirm-dialog.active .confirm-content {
            transform: scale(1);
        }
        
        .confirm-content h3 {
            font-size: 24px;
            margin-bottom: 15px;
            text-align: center;
            color: #333;
        }
        .confirm-content p {
            margin-bottom: 20px;
            text-align: center;
            font-size: 16px;
        }

        .confirm-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .btn-confirm, .btn-cancel {
            border: none;
            padding: 12px 25px; /* More generous padding */
            border-radius: 8px; /* Softer corners */
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s, transform 0.2s;
        }
        .btn-confirm {
            background: #28a745;
            color: white;
        }
        .btn-confirm:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        .btn-cancel {
            background: #dc3545;
            color: white;
        }
        .btn-cancel:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        /* Upload Summary */
        .upload-summary {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .upload-summary h3 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-size: 15px;
        }
        .summary-item:last-child {
            border-bottom: none;
        }

        .highlight {
            background: #fff3cd;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: bold;
        }
        
        /* Validation Results */
        .validation-results {
            margin: 20px 0;
        }

        .validation-item {
            padding: 12px; /* More padding */
            margin: 8px 0; /* More margin */
            border-radius: 5px;
            border-left: 5px solid; /* Thicker border */
            font-size: 15px;
        }

        .validation-success {
            background: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }

        .validation-warning {
            background: #fff3cd;
            border-left-color: #ffc107;
            color: #856404;
        }

        .validation-error {
            background: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }

        /* Last Sync Info */
        .last-sync {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin: 10px auto; /* Center it */
            font-size: 14px;
            color: #6c757d;
            display: inline-block; /* Adjust display for centering */
        }
        
        /* Cycle Info Card */
        .cycle-info-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .cycle-progress {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            margin: 8px 0;
            overflow: hidden;
        }

        .cycle-progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #28a745, #20c997);
            transition: width 0.3s;
        }

        .cycle-progress-overtime {
            background: linear-gradient(45deg, #dc3545, #fd7e14);
        }

        .cycle-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            min-width: 80px;
        }

        .cycle-active {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .cycle-complete {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .cycle-overtime {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .cycle-pending {
            background: #e7f3ff;
            color: #0066cc;
            border: 1px solid #b3d9ff;
        }
        
        /* Loading spinner */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #fff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 5px;
        }
        .spinner-dark {
            border: 3px solid rgba(0, 0, 0, 0.2);
            border-top: 3px solid #333;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🐙 GitHub 版工時管理系統</h1>
        <div style="text-align: center; margin-bottom: 20px;">
            <small>📊 GitHub 資料庫 | 🔄 即時同步 | 👥 團隊協作</small>
        </div>
        
        <div id="token-setup" class="token-setup">
            <h3>🔑 GitHub Token 輸入</h3>
            <p><strong>為了您的安全，Token 不會被儲存，每次使用都需要重新輸入。</strong></p>
            
            <div class="token-input-group">
                <input 
                    type="password" 
                    id="github-token-input" 
                    class="token-input" 
                    placeholder="請輸入您的 GitHub Personal Access Token (ghp_ 或 github_pat_ 開頭)"
                    title="請輸入您的 GitHub Personal Access Token"
                >
                <button id="save-token-btn" class="save-token-btn" onclick="saveGitHubToken()">
                    🔗 連接 GitHub
                </button>
            </div>
            
            <div class="token-instructions">
                <h4>📋 如何使用：</h4>
                <ol>
                    <li><strong>輸入 Token：：</strong>將您的 GitHub Token 貼到上方輸入框</li>
                    <li><strong>點擊連接：：</strong>系統會測試連接並載入資料</li>
                    <li><strong>開始使用：：</strong>上傳工時表、查看報表等</li>
                    <li><strong>安全性提醒：：</strong>Token 不會被儲存，關閉瀏覽器後自動清除，確保安全。</li>
                </ol>
                
                <h4>🔐 如何取得 GitHub Token：</h4>
                <ol>
                    <li>登入 GitHub → Settings → Developer settings → Personal access tokens</li>
                    <li>點擊 "Generate new token (classic)" 或 "Generate new token"</li>
                    <li>設定權限：勾選 <code>repo</code> 權限 (必要)</li>
                    <li>複製生成的 token（格式：ghp_xxxxxxxxxxxxxx 或 github_pat_xxxxxxxxxxxxxx）</li>
                </ol>
                
                <div class="success-message">
                    <strong>✅ 安全優勢：</strong><br>
                    • Token 不會被**持久化**儲存在電腦中<br>
                    • 每次使用都需要重新輸入，適合共用電腦環境<br>
                    • 關閉瀏覽器後 Token 從記憶體中自動清除
                </div>
                
                <div class="warning-message">
                    <strong>🎯 使用建議：：</strong><br>
                    • 建議建立專用的 GitHub 帳戶供工時系統使用<br>
                    • 或使用公司統一的 GitHub Token<br>
                    • Token 具有 GitHub 權限，請妥善保管，如果洩露請立即撤銷並重新生成
                </div>
            </div>
        </div>
        
        <div class="central-db-info">
            <h3>💡 GitHub 資料庫概念</h3>
            <div class="workflow-step">
                <div class="step-number">1</div>
                <div>任何人上傳 CSV 工時表</div>
            </div>
            <div class="workflow-step">
                <div class="step-number">2</div>
                <div>系統自動整合資料並推送到 GitHub repository</div>
            </div>
            <div class="workflow-step">
                <div class="step-number">3</div>
                <div>所有團隊成員重新整理頁面即可看到最新資料</div>
            </div>
            <div class="workflow-step">
                <div class="step-number">4</div>
                <div>完整的版本控制，可查看所有歷史更新</div>
            </div>
        </div>
        
        <div id="github-status" class="github-section github-disconnected">
            <h3>🐙 GitHub 連接狀態</h3>
            <p id="github-status-text">尚未連接到 GitHub repository</p>
            <div id="last-sync" class="last-sync" style="display: none;">
                <strong>最後同步：：</strong><span id="sync-time">尚未同步</span>
            </div>
            <button id="github-sync-btn" class="github-btn" onclick="syncFromGitHub()" style="display: none;">
                <span class="spinner" style="display: none;"></span>
                🔄 從 GitHub 載入最新資料
            </button>
            <button id="github-download-btn" class="github-btn" onclick="downloadFromGitHub()" style="display: none;">
                <span class="spinner" style="display: none;"></span>
                📥 下載完整資料檔
            </button>
            <button id="github-disconnect-btn" class="github-btn-warning" onclick="disconnectGitHub()" style="display: none;">
                <span class="spinner spinner-dark" style="display: none;"></span>
                🔌 中斷連接
            </button>
            
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                <button id="resetAllData" class="github-btn-danger action-btn" onclick="resetAllData()">
                    <span class="spinner" style="display: none;"></span>
                    🗑️ 清除所有資料
                </button>
                <p style="font-size: 12px; color: #666; margin: 5px 0 0 0;">
                    如果系統卡住或資料異常，可以清除重新開始
                </p>
            </div>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('upload')">📁 資料上傳</div>
            <div class="tab" onclick="switchTab('overview')">👥 員工總覽</div>
            <div class="tab" onclick="switchTab('payroll')">💰 薪資計算</div>
        </div>
        
        <div id="upload-tab" class="tab-content active">
            <div class="format-info">
                <h4>📊 工時表格式說明</h4>
                <div class="format-example">
                    Payroll ID, First Name, Last Name, Start Date, Work Week, Hours, Level, Rate, Farm
                    <br>EQ-0001, John, Doe, 2024-01-15, 2024-01-15, 45, Senior, 25.50, Farm A
                    <br>EQ-0001, John, Doe, 2024-01-15, 2024-01-22, 38, Senior, 25.50, Farm A
                    <br>EQ-0002, Jane, Smith, 2024-02-01, 2024-02-05, 42, Junior, 20.00, Farm B
                </div>
                <p><strong>重要格式說明：：</strong></p>
                <ul>
                    <li>📅 <strong>Start Date</strong>：員工在該農場工作的第一天（只需在第一次上傳時提供，後續會自動保留），格式為 `YYYY-MM-DD` 或 `DD/MM/YYYY`。</li>
                    <li>📅 <strong>Work Week</strong>：工作週的週一日期（例如：2024-01-15 表示 2024年1月15日那一週），格式為 `YYYY-MM-DD` 或 `DD/MM/YYYY`。</li>
                    <li>🔢 <strong>週數計算</strong>：系統會自動根據 Start Date 和 Work Week 計算正確的週數</li>
                    <li>🏭 <strong>Farm/Level/Rate 更新</strong>：如果員工轉換農場或調整薪資，新資料會覆蓋舊資料</li>
                </ul>
                <p><strong>上傳後自動處理：：</strong></p>
                <ul>
                    <li>✅ 驗證 EQ-0001 格式的員工編號</li>
                    <li>✅ 自動計算正確的工作週數</li>
                    <li>✅ 支援農場和職級異動</li>
                    <li>✅ 整合新舊資料，檢測重複工作週</li>
                    <li>✅ 自動推送到 GitHub repository</li>
                    <li>✅ 所有團隊成員即時看到最新資料</li>
                </ul>
            </div>
            
            <div class="upload-section" id="timesheet-upload">
                <h3>📋 上傳工時表 (CSV)</h3>
                <p>上傳後將自動整合並推送到 GitHub repository</p>
                <button id="upload-file-btn" class="upload-btn" onclick="document.getElementById('timesheet-file').click()">
                    <span class="spinner" style="display: none;"></span>
                    選擇工時表文件
                </button>
                <input type="file" id="timesheet-file" class="file-input" accept=".csv" onchange="handleTimesheetFile(event)">
                <div id="timesheet-file-info" class="file-info"></div>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <p id="progress-text">等待上傳文件...</p>
            
            <div id="validation-results" class="validation-results"></div>
        </div>
        <div class="tabs">
            <div class="tab active" onclick="switchTab('upload')">📁 資料上傳</div>
            <div class="tab" onclick="switchTab('overview')">👥 員工總覽</div>
            <div class="tab" onclick="switchTab('payroll')">💰 薪資計算</div>
        </div>
        
        <div id="overview-tab" class="tab-content active">
            <h2>👥 員工總覽與週期分析</h2>
            
            <div class="format-info">
                <h4>🔍 篩選選項</h4>
                <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                    <div>
                        <label for="farm-filter"><strong>農場：：</strong></label>
                        <select id="farm-filter" onchange="updateAllTables()" style="padding: 8px 12px; margin-left: 8px; border-radius: 5px; border: 1px solid #ccc;">
                            <option value="">所有農場</option>
                        </select>
                    </div>
                    <div>
                        <label for="level-filter"><strong>職級：：</strong></label>
                        <select id="level-filter" onchange="updateAllTables()" style="padding: 8px 12px; margin-left: 8px; border-radius: 5px; border: 1px solid #ccc;">
                            <option value="">所有職級</option>
                        </select>
                    </div>
                    <div>
                        <label for="status-filter"><strong>週期狀態：：</strong></label>
                        <select id="status-filter" onchange="updateAllTables()" style="padding: 8px 12px; margin-left: 8px; border-radius: 5px; border: 1px solid #ccc;">
                            <option value="">所有狀態</option>
                            <option value="active">進行中</option>
                            <option value="overtime">需加班費</option>
                            </select>
                    </div>
                    <button class="action-btn" onclick="clearFilters()" style="padding: 8px 18px; background: #6c757d; color: white; border: none; border-radius: 3px; box-shadow: none;">清除篩選</button>
                </div>
            </div>
            
            <div class="summary-cards" id="overview-summary-cards"></div>
            <div id="overview-table-container"></div>
            
            <button id="exportOverview" class="upload-btn action-btn" onclick="exportOverview()" style="margin-top: 20px;">
                <span class="spinner" style="display: none;"></span>
                📥 匯出員工總覽報告 (CSV)
            </button>
        </div>
        
        <div id="payroll-tab" class="tab-content">
            <h2>💰 薪資計算結果</h2>
            <div class="summary-cards" id="payroll-summary-cards"></div>
            <div id="payroll-table-container"></div>
            <button id="exportPayroll" class="upload-btn action-btn" onclick="exportPayroll()" style="margin-top: 20px;">
                <span class="spinner" style="display: none;"></span>
                📥 匯出薪資報表 (CSV)
            </button>
        </div>
        
        <div id="messages"></div>
    </div>

    <script>
        // 全域變數
        let employees = {};
        let timesheetData = []; // Stores all individual work week records
        let pendingData = null;
        let isGitHubConnected = false;
        
        // ================================
        // 🔑 GitHub Configuration - Token Input Mode (No localStorage persistence)
        // ================================
        let githubToken = ''; // Token is held in memory for the session
        
        const REPO_OWNER = 'lass120625';  // Your GitHub username
        const REPO_NAME = 'timesheet-system';  // Repository name
        const DATA_FILE_NAME = 'timesheet_data.json';
        
        // Constants definition
        const REGULAR_HOURS_THRESHOLD = 304; // Max regular hours per 8-week cycle (8 weeks * 38 hours/week)
        const WEEKS_PER_CYCLE = 8; // Number of weeks in one cycle

        // Initialize application on DOM load
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings(); // Initiate GitHub connection logic
            updateProgress(0, '請先連接 GitHub 以開始使用');
        });
        
        // Clear all local data (in-memory)
        function clearAllData() {
            employees = {};
            timesheetData = [];
            // Also clear localStorage just in case old data exists from previous versions
            try {
                localStorage.removeItem('timesheet_employees');
                localStorage.removeItem('timesheet_data');
                localStorage.removeItem('github_token'); 
                console.log('✅ All local data (in-memory and localStorage) cleared.');
            } catch (error) {
                console.log('Error clearing data:', error);
            }
        }
        
        // Function for manual data reset button
        async function resetAllData() {
            if (confirm('⚠️ 確定要清除所有資料嗎？這將會刪除所有員工資料和工時記錄，並且無法復原！')) {
                setButtonLoading('resetAllData', true, '清除中...');

                clearAllData();
                updateAllTables();
                showMessage('🗑️ 所有資料已清除！', 'warning');
                
                // Attempt to delete the data file on GitHub
                if (isGitHubConnected && githubToken) {
                    try {
                        showMessage('嘗試從 GitHub 刪除資料檔案...', 'warning');
                        await deleteGitHubFile(DATA_FILE_NAME);
                        showMessage('✅ GitHub 資料檔案已刪除。', 'success');
                    } catch (error) {
                        showMessage(`❌ 從 GitHub 刪除檔案失敗: ${error.message}<br>請手動前往 GitHub repository 刪除檔案。`, 'error');
                        console.error('Failed to delete file from GitHub:', error);
                    }
                }
                
                // Reload page for complete reset
                setTimeout(() => {
                    location.reload();
                }, 2000);

                setButtonLoading('resetAllData', false, '清除所有資料'); 
            }
        }
        
        // Delete a file from GitHub repository
        async function deleteGitHubFile(filePath) {
            const getFileResponse = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${filePath}`, {
                headers: {
                    'Authorization': `token ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });

            if (getFileResponse.status === 404) {
                return; // File does not exist, nothing to delete
            }

            if (!getFileResponse.ok) {
                throw new Error(`Failed to get file SHA: HTTP ${getFileResponse.status}`);
            }

            const fileData = await getFileResponse.json();
            const sha = fileData.sha;

            const deleteResponse = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${filePath}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `token ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: `Delete ${filePath} for timesheet system reset - ${new Date().toLocaleString('zh-TW')}`,
                    sha: sha
                })
            });

            if (!deleteResponse.ok) {
                const errorData = await deleteResponse.json();
                throw new Error(`Failed to delete file: ${errorData.message || deleteResponse.statusText}`);
            }
        }

        // Load settings (only handles UI display, no token loading from localStorage)
        function loadSettings() {
            showTokenSetup();
            updateGitHubStatus('disconnected', '尚未連接到 GitHub repository');
        }
        
        // Display dialog for repository creation
        function showCreateRepositoryDialog() {
            const dialog = document.createElement('div');
            dialog.className = 'confirm-dialog active';
            
            dialog.innerHTML = `
                <div class="confirm-content">
                    <h3>📁 Repository 不存在</h3>
                    <p>在您的 GitHub 帳戶中找不到名為 <strong>${REPO_NAME}</strong> 的 repository。</p>
                    
                    <div class="warning-message">
                        <strong>目前設定：：</strong><br>
                        用戶：${REPO_OWNER}<br>
                        Repository：${REPO_NAME}
                    </div>
                    
                    <p>請選擇以下其中一個選項：：</p>
                    
                    <div class="confirm-buttons">
                        <button class="btn-confirm" id="createRepoBtn" onclick="createRepository()">
                            🆕 自動建立 Repository
                        </button>
                        <button class="btn-cancel" onclick="showRepositorySettings()">
                            ⚙️ 修改設定 (需手動修改代碼)
                        </button>
                        <button class="btn-cancel" onclick="closeCreateDialog()">
                            ❌ 取消
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(dialog);
        }
        
        // Create a new GitHub repository
        async function createRepository() {
            setButtonLoading('createRepoBtn', true, '建立中...'); // Set loading for create button in dialog
            try {
                showMessage('🔨 正在建立 Repository...', 'warning');
                
                const response = await fetch('https://api.github.com/user/repos', {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: REPO_NAME,
                        description: 'GitHub 版工時管理系統 - 自動建立',
                        private: false, 
                        auto_init: true 
                    })
                });
                
                if (response.ok) {
                    const repo = await response.json();
                    closeCreateDialog();
                    isGitHubConnected = true;
                    updateGitHubStatus('connected', `✅ 已建立並連接到 Repository: ${repo.full_name}`);
                    showMessage(`✅ Repository 建立成功！<br>📍 位置：<a href="${repo.html_url}" target="_blank">${repo.full_name}</a>`);
                    
                    setTimeout(() => {
                        syncFromGitHub(); // Wait a bit for GitHub to initialize, then sync
                    }, 2000);
                    
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `建立失敗: HTTP ${response.status}`);
                }
                
            } catch (error) {
                showMessage(`❌ 建立 Repository 失敗: ${error.message}`, 'error');
                console.error('Failed to create repository:', error);
            } finally {
                setButtonLoading('createRepoBtn', false, '自動建立 Repository');
            }
        }
        
        // Show repository settings message (user needs to manually edit code)
        function showRepositorySettings() {
            closeCreateDialog();
            const currentOwner = REPO_OWNER;
            const currentName = REPO_NAME;
            alert(`請手動修改代碼中的 REPO_OWNER 和 REPO_NAME 常數，並重新載入頁面。\n\n目前設定：\nREPO_OWNER = '${currentOwner}'\nREPO_NAME = '${currentName}'`);
        }
        
        // Close the generic confirmation dialog
        function closeCreateDialog() {
            const dialog = document.querySelector('.confirm-dialog');
            if (dialog) {
                dialog.classList.remove('active');
                setTimeout(() => dialog.remove(), 300); 
            }
        }
        
        // Save GitHub Token (only to memory, no localStorage)
        async function saveGitHubToken() {
            const tokenInput = document.getElementById('github-token-input');
            const token = tokenInput.value.trim();
            
            if (!token) {
                showMessage('請輸入 GitHub Token', 'error');
                return;
            }
            
            if (!token.startsWith('ghp_') && !token.startsWith('github_pat_')) {
                showMessage('Token 格式可能不正確，請確認是否為正確的 GitHub Personal Access Token', 'warning');
            }
            
            githubToken = token;
            setButtonLoading('save-token-btn', true, '連接中...');
            
            try {
                await connectToGitHub();
            } finally {
                setButtonLoading('save-token-btn', false, '連接 GitHub');
            }
        }
        
        // Hide Token setup section
        function hideTokenSetup() {
            const tokenSetup = document.getElementById('token-setup');
            tokenSetup.style.display = 'none';
        }
        
        // Show Token setup section
        function showTokenSetup() {
            const tokenSetup = document.getElementById('token-setup');
            tokenSetup.style.display = 'block';
        }
        
        // Load local data (in-memory, not from localStorage)
        function loadLocalData() {
            if (Object.keys(employees).length > 0) {
                updateAllTables();
            }
        }
        
        // Save local data (in-memory, no localStorage)
        function saveLocalData() {
            // Data is primarily stored in-memory and pushed to GitHub
        }
        
        // Connect to GitHub API
        async function connectToGitHub() {
            if (!githubToken) {
                showMessage('❌ 請先連接 GitHub', 'error');
                return;
            }
            
            updateGitHubStatus('loading', '正在連接 GitHub...');
            
            try {
                const userResponse = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'User-Agent': 'Timesheet-System/1.0'
                    }
                });
                
                if (!userResponse.ok) {
                    if (userResponse.status === 401) {
                        throw new Error('Token 認證失敗，請檢查 Token 是否正確');
                    } else if (userResponse.status === 403) {
                        throw new Error('權限不足，請檢查 Token 權限設定（需勾選 repo 權限）');
                    } else {
                        throw new Error(`API 錯誤: ${userResponse.status} - ${userResponse.statusText}`);
                    }
                }
                const user = await userResponse.json();
                showMessage(`✅ GitHub 認證成功！用戶：${user.login}`, 'success');
                
                const repoResponse = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}`, {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'User-Agent': 'Timesheet-System/1.0'
                    }
                });
                
                if (repoResponse.status === 404) {
                    showCreateRepositoryDialog();
                    isGitHubConnected = false; 
                    updateGitHubStatus('disconnected', `Repository '${REPO_NAME}' 不存在`);
                    return; 
                } else if (!repoResponse.ok) {
                    throw new Error(`無法存取 Repository: ${repoResponse.status} - ${repoResponse.statusText}`);
                }
                
                const repo = await repoResponse.json();
                isGitHubConnected = true;
                updateGitHubStatus('connected', `✅ 已連接到 Repository: ${repo.full_name}`);
                showMessage('✅ GitHub 連接完全成功！正在載入資料...');
                syncFromGitHub();
                
            } catch (error) {
                let errorMessage = error.message;
                let suggestions = '';
                
                if (error.message.includes('Token 認證失敗')) {
                    suggestions = '<br><br>🔧 請檢查 Token 是否正確複製';
                } else if (error.message.includes('權限不足')) {
                    suggestions = '<br><br>🔧 請檢查 Token 權限是否包含 "repo"';
                } else if (error.message.includes('Repository')) {
                    suggestions = '<br><br>🔧 請確認 Repository 名稱正確，或點擊自動建立';
                }
                
                showMessage(`❌ GitHub 連接失敗: ${errorMessage}${suggestions}`, 'error');
                updateGitHubStatus('disconnected', `GitHub 連接失敗: ${errorMessage}`);
                
                if (error.message.includes('Token') || error.message.includes('認證') || error.message.includes('權限')) {
                    setTimeout(() => {
                        showTokenSetup();
                    }, 1000);
                }
            }
        }
        
        // Update GitHub connection status UI
        function updateGitHubStatus(status, message) {
            const statusDiv = document.getElementById('github-status');
            const statusText = document.getElementById('github-status-text');
            const syncBtn = document.getElementById('github-sync-btn');
            const downloadBtn = document.getElementById('github-download-btn');
            const disconnectBtn = document.getElementById('github-disconnect-btn');
            const lastSyncDiv = document.getElementById('last-sync');
            const resetButton = document.getElementById('resetAllData'); 

            statusText.textContent = message;
            
            if (status === 'connected') {
                statusDiv.className = 'github-section github-connected';
                syncBtn.style.display = 'inline-flex'; 
                downloadBtn.style.display = 'inline-flex';
                disconnectBtn.style.display = 'inline-flex';
                lastSyncDiv.style.display = 'block';
                resetButton.style.display = 'inline-flex'; 
            } else if (status === 'loading') {
                statusDiv.className = 'github-section github-loading';
                syncBtn.style.display = 'none';
                downloadBtn.style.display = 'none';
                disconnectBtn.style.display = 'none';
                resetButton.style.display = 'none'; 
            } else {
                statusDiv.className = 'github-section github-disconnected';
                syncBtn.style.display = 'none';
                downloadBtn.style.display = 'none';
                disconnectBtn.style.display = 'none';
                lastSyncDiv.style.display = 'none';
                resetButton.style.display = 'inline-flex'; 
            }
        }
        
        // Disconnect from GitHub
        function disconnectGitHub() {
            if (confirm('確定要中斷 GitHub 連接嗎？您可以隨時重新連接。這將會清除您本次輸入的 GitHub Token。')) {
                isGitHubConnected = false;
                githubToken = ''; 
                document.getElementById('github-token-input').value = ''; 
                updateGitHubStatus('disconnected', '尚未連接到 GitHub repository');
                showTokenSetup();
                showMessage('🔌 已中斷 GitHub 連接');
            }
        }

        // Set button loading state with spinner
        function setButtonLoading(buttonId, isLoading, loadingText = '處理中...') {
            const button = document.getElementById(buttonId);
            if (!button) {
                console.warn(`Button with ID '${buttonId}' not found for loading state management.`);
                return;
            }
            
            const spinner = button.querySelector('.spinner');
            const originalText = button.dataset.originalText || button.textContent.trim();

            if (isLoading) {
                button.dataset.originalText = originalText; 
                button.disabled = true;
                button.innerHTML = ''; // Clear original text
                if (spinner) {
                    button.appendChild(spinner);
                    spinner.style.display = 'inline-block';
                } else { 
                    const newSpinner = document.createElement('span');
                    newSpinner.className = `spinner ${buttonId.includes('warning') || buttonId.includes('danger') ? 'spinner-dark' : ''}`;
                    button.prepend(newSpinner);
                }
                button.append(loadingText); 
            } else {
                button.disabled = false;
                button.innerHTML = originalText;
                if (spinner) spinner.style.display = 'none';
            }
        }
        
        // Synchronize data from GitHub
        async function syncFromGitHub() {
            if (!isGitHubConnected) {
                showMessage('❌ 請先連接 GitHub', 'error');
                return;
            }
            
            setButtonLoading('github-sync-btn', true, '載入中...');
            
            try {
                showMessage('🔄 正在從 GitHub 載入最新資料...');
                
                let response;
                // Try fetching data from GitHub using token
                if (githubToken) {
                    response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${DATA_FILE_NAME}`, {
                        headers: {
                            'Authorization': `token ${githubToken}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'User-Agent': 'Timesheet-System/1.0'
                        }
                    });
                } else {
                    // If no token, try fetching raw content (for public repos)
                    response = await fetch(`https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/main/${DATA_FILE_NAME}`);
                }

                if (response.status === 404) {
                    showMessage('📝 GitHub 中尚無資料檔案，將在首次上傳時建立', 'warning');
                    updateSyncTime();
                    employees = {}; 
                    timesheetData = [];
                    updateAllTables();
                    return;
                }
                
                if (!response.ok) {
                    // For raw.githubusercontent.com, 403 means permission denied (private repo without token)
                    if (response.status === 403 && !githubToken) {
                         throw new Error(`權限不足，無法在未提供 Token 的情況下訪問私有 Repository。請連接 GitHub。`);
                    }
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                let fileData;
                if (githubToken) { // If fetched with API, it's JSON with content base64 encoded
                    fileData = await response.json();
                    const content = atob(fileData.content);
                    fileData = JSON.parse(content);
                } else { // If fetched raw, it's plain JSON text
                    fileData = await response.json();
                }
                
                employees = fileData.employees || {};
                timesheetData = fileData.timesheetData || [];
                
                updateAllTables();
                updateSyncTime();
                
                const empCount = Object.keys(employees).length;
                const recordCount = timesheetData.length;
                
                showMessage(`✅ 成功載入 GitHub 資料！<br>👥 ${empCount} 位員工<br>📊 ${recordCount} 筆工時記錄`);
                
            } catch (error) {
                console.error('Failed to sync from GitHub:', error);
                showMessage(`❌ 從 GitHub 載入失敗: ${error.message}`, 'error');
            } finally {
                setButtonLoading('github-sync-btn', false, '🔄 從 GitHub 載入最新資料');
            }
        }
        
        // Upload data to GitHub
        async function uploadToGitHub() {
            if (!isGitHubConnected) {
                throw new Error('未連接到 GitHub');
            }
            
            try {
                const data = {
                    employees: employees,
                    timesheetData: timesheetData,
                    lastUpdated: new Date().toISOString(),
                    version: '1.2', 
                    systemName: 'GitHub 版工時管理系統'
                };
                
                const content = JSON.stringify(data, null, 2);
                const encodedContent = btoa(unescape(encodeURIComponent(content)));
                
                let sha = null;
                try {
                    const existingFile = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${DATA_FILE_NAME}`, {
                        headers: {
                            'Authorization': `token ${githubToken}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (existingFile.ok) {
                        const fileData = await existingFile.json();
                        sha = fileData.sha;
                    }
                } catch (error) {
                    console.log('File does not exist or SHA not found, creating new file:', error.message);
                }
                
                const updateData = {
                    message: `更新工時資料 - ${new Date().toLocaleString('zh-TW')}`,
                    content: encodedContent
                };
                
                if (sha) {
                    updateData.sha = sha;
                }
                
                const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${DATA_FILE_NAME}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`GitHub API Error: ${errorData.message || response.statusText}`);
                }
                
                const result = await response.json();
                console.log('GitHub update successful:', result);
                
                updateSyncTime();
                return true;
                
            } catch (error) {
                console.error('Failed to upload to GitHub:', error);
                throw error;
            }
        }
        
        // Download full data file from GitHub
        async function downloadFromGitHub() {
            if (!isGitHubConnected) {
                showMessage('❌ 請先連接 GitHub', 'error');
                return;
            }
            
            setButtonLoading('github-download-btn', true, '下載中...');

            try {
                const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${DATA_FILE_NAME}`, {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.status === 404) {
                     showMessage('⚠️ GitHub 中尚無資料檔案可供下載。', 'warning');
                     return;
                }

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const fileData = await response.json();
                const content = atob(fileData.content);
                
                const blob = new Blob([content], { type: 'application/json' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `工時系統完整資料_${new Date().toLocaleDateString('en-AU').replace(/\//g, '-')}.json`; // Australian date format
                document.body.appendChild(link); 
                link.click();
                document.body.removeChild(link); 
                
                showMessage('✅ 完整資料檔已下載！');
                
            } catch (error) {
                showMessage(`❌ 下載失敗: ${error.message}`, 'error');
            } finally {
                setButtonLoading('github-download-btn', false, '📥 下載完整資料檔');
            }
        }
        
        // Update last sync time displayed in UI
        function updateSyncTime() {
            const syncTimeElement = document.getElementById('sync-time');
            if (syncTimeElement) {
                syncTimeElement.textContent = new Date().toLocaleDateString('en-AU') + ' ' + new Date().toLocaleTimeString('en-AU'); // Australian date and time format
            }
        }
        
        /**
         * Calculates employee cycle information based on start date and current date.
         * This function determines:
         * - currentCycle: Which 8-week cycle the employee is in.
         * - weekInCycle: The week number within the current 8-week cycle (1-8).
         * - cycleStartDate: The start date of the current 8-week cycle.
         * - cycleEndDate: The end date of the current 8-week cycle.
         * - daysInCycle: Number of days passed in the current cycle relative to today.
         * - totalWeeksFromStart: Total weeks passed since the employee's start date.
         * - status: 'active', 'overtime', 'complete', or 'pending'. (Internal status)
         * - progressPercentage: Progress of the current cycle.
         * - cycleHours: Sum of hours *only* within the current 8-week cycle.
         */
        function calculateEmployeeCycle(employee, referenceDate = new Date()) {
            // Ensure employee.startDate is valid
            const parsedStartDate = parseDate(employee.startDate);
            if (!parsedStartDate || isNaN(parsedStartDate.getTime())) {
                const defaultCycleStartDate = getMonday(new Date(referenceDate.getFullYear(), referenceDate.getMonth(), referenceDate.getDate()));
                const defaultCycleEndDate = new Date(defaultCycleStartDate);
                defaultCycleEndDate.setDate(defaultCycleEndDate.getDate() + (WEEKS_PER_CYCLE * 7) - 1);
                return {
                    currentCycle: 0, 
                    weekInCycle: 0, 
                    cycleStartDate: defaultCycleStartDate,
                    cycleEndDate: defaultCycleEndDate,
                    daysInCycle: 0,
                    totalWeeksFromStart: 0,
                    status: 'pending', 
                    progressPercentage: 0,
                    cycleHours: 0
                };
            }
            
            try {
                const startDate = parsedStartDate;
                const currentDate = new Date(referenceDate);
                currentDate.setHours(0, 0, 0, 0);
                
                const startMonday = getMonday(startDate);
                const currentMonday = getMonday(currentDate);
                
                const totalWeeksFromStart = Math.floor((currentMonday - startMonday) / (7 * 24 * 60 * 60 * 1000)) + 1;
                
                const currentCycle = Math.max(1, Math.floor((totalWeeksFromStart - 1) / WEEKS_PER_CYCLE) + 1);
                const weekInCycle = Math.max(1, ((totalWeeksFromStart - 1) % WEEKS_PER_CYCLE) + 1);
                
                const cycleStartWeekIndex = (currentCycle - 1) * WEEKS_PER_CYCLE;
                const cycleStartDate = new Date(startMonday);
                cycleStartDate.setDate(cycleStartDate.getDate() + (cycleStartWeekIndex * 7));
                
                const cycleEndDate = new Date(cycleStartDate);
                cycleEndDate.setDate(cycleEndDate.getDate() + (WEEKS_PER_CYCLE * 7) - 1); 
                
                const daysInCycle = Math.max(0, Math.floor((currentDate - cycleStartDate) / (1000 * 60 * 60 * 24)) + 1);
                const totalDaysInCyclePeriod = WEEKS_PER_CYCLE * 7;
                const progressPercentage = Math.min((daysInCycle / totalDaysInCyclePeriod) * 100, 100);
                
                let cycleHours = 0;
                for (const workWeekDateStr in employee.workWeeks) {
                    const workWeekDate = parseDate(workWeekDateStr);
                    if (workWeekDate && workWeekDate >= cycleStartDate && workWeekDate <= cycleEndDate) {
                        cycleHours += employee.workWeeks[workWeekDate];
                    }
                }

                let status = 'active'; // Internal status
                if (currentDate < cycleStartDate) { 
                    status = 'pending';
                } else if (cycleHours > REGULAR_HOURS_THRESHOLD) {
                    status = 'overtime';
                } else if (currentDate > cycleEndDate) { 
                    status = 'complete';
                }
                
                return {
                    currentCycle,
                    weekInCycle,
                    cycleStartDate,
                    cycleEndDate,
                    daysInCycle: Math.min(Math.max(daysInCycle, 0), totalDaysInCyclePeriod),
                    totalWeeksFromStart,
                    status, // Internal status
                    progressPercentage,
                    cycleHours 
                };
            } catch (error) {
                console.error("Error calculating employee cycle for:", employee, error);
                const defaultCycleStartDate = getMonday(new Date(referenceDate.getFullYear(), referenceDate.getMonth(), referenceDate.getDate()));
                const defaultCycleEndDate = new Date(defaultCycleStartDate);
                defaultCycleEndDate.setDate(defaultCycleEndDate.getDate() + (WEEKS_PER_CYCLE * 7) - 1);
                return {
                    currentCycle: 0, 
                    weekInCycle: 0, 
                    cycleStartDate: defaultCycleStartDate,
                    cycleEndDate: defaultCycleEndDate,
                    daysInCycle: 0,
                    totalWeeksFromStart: 0,
                    status: 'pending',
                    progressPercentage: 0,
                    cycleHours: 0
                };
            }
        }
        
        // Switch between tabs
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }
        
        // Display messages to the user
        function showMessage(message, type = 'success', duration = 8000) { 
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'error' ? 'error-message' : 
                                 type === 'warning' ? 'warning-message' : 'success-message';
            messageDiv.innerHTML = message;
            messagesDiv.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.classList.add('message-fadeout'); 
                messageDiv.addEventListener('transitionend', () => messageDiv.remove()); 
            }, duration);
        }
        
        // Update progress bar
        function updateProgress(percentage, text) {
            document.getElementById('progress-fill').style.width = percentage + '%';
            document.getElementById('progress-text').textContent = text;
        }
        
        // Validate Payroll ID format (e.g., EQ-0001)
        function validatePayrollID(payrollId) {
            if (!payrollId) return false;
            const pattern = /^[A-Za-z]{2,3}-\d{3,4}$/; 
            return pattern.test(payrollId.trim());
        }
        
        // Parse date string into Date object (robust)
        function parseDate(dateString) {
            if (!dateString) return null;
            
            // Try YYYY-MM-DD
            let date = new Date(dateString);
            if (!isNaN(date.getTime()) && date.toISOString().slice(0,10) === dateString) {
                return date;
            }

            // Try DD/MM/YYYY (Australian format)
            const partsSlash = dateString.split('/');
            if (partsSlash.length === 3) {
                // new Date(year, monthIndex, day)
                date = new Date(parseInt(partsSlash[2]), parseInt(partsSlash[1]) - 1, parseInt(partsSlash[0]));
                if (!isNaN(date.getTime())) return date;
            }
            
            // Try MM/DD/YYYY (common in some locales)
            // No need to explicitly add this if DD/MM/YYYY is the primary target for Australian format
            // If it could be either, parseDate needs to try both and return first valid or user specify which format.
            // For now, assuming DD/MM/YYYY for input based on user's examples.

            // If all fails, return null
            return null;
        }
        
        // Get the Monday of a given date's week
        function getMonday(date) {
            const result = new Date(date);
            const dayOfWeek = result.getDay(); 
            const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; // Adjust for Sunday (0) vs. Monday (1)
            result.setDate(result.getDate() + daysToMonday);
            result.setHours(0, 0, 0, 0); 
            return result;
        }
        
        // Parse hourly rate string to float
        function parseRate(rateString) {
            if (!rateString) return 0;
            const cleanedString = rateString.toString().replace(/[^0-9.]/g, '');
            return parseFloat(cleanedString) || 0;
        }
        
        // Handle timesheet file upload
        async function handleTimesheetFile(event) {
            const file = event.target.files[0];
            if (!file) {
                document.getElementById('timesheet-file-info').style.display = 'none'; 
                updateProgress(0, '等待上傳文件...');
                return;
            }
            
            document.getElementById('validation-results').innerHTML = '';
            document.getElementById('timesheet-file-info').style.display = 'none';

            setButtonLoading('upload-file-btn', true, '讀取中...');

            try {
                updateProgress(20, '正在讀取工時表...');
                
                const data = await readFile(file);
                const parsed = parseCSV(data); 
                
                updateProgress(40, '驗證資料格式...');
                
                const validationResult = validateTimesheetData(parsed);
                
                if (validationResult.errors.length > 0) {
                    showValidationResults(validationResult);
                    updateProgress(0, '資料驗證失敗');
                    showMessage('❌ 工時表驗證失敗，請檢查格式並重試。', 'error');
                    return;
                }
                
                updateProgress(60, '檢查資料衝突...');
                
                const conflicts = checkForConflicts(parsed);
                
                if (conflicts.length > 0) {
                    showConflictDialog(parsed, conflicts);
                } else {
                    await processTimesheetData(parsed);
                }
                
            } catch (error) {
                showMessage('讀取工時表時發生錯誤: ' + error.message, 'error');
                updateProgress(0, '載入失敗');
                console.error('File handling error:', error);
            } finally {
                setButtonLoading('upload-file-btn', false, '選擇工時表文件');
                document.getElementById('timesheet-file').value = ''; 
            }
        }
        
        // Validate timesheet data from parsed CSV
        function validateTimesheetData(data) {
            const result = {
                success: [],
                warnings: [],
                errors: []
            };
            
            if (data.length === 0) {
                result.errors.push('文件為空或格式不正確，請確保 CSV 包含數據行。');
                return result;
            }
            
            const requiredFields = ['Payroll ID', 'First Name', 'Last Name', 'Work Week', 'Hours'];
            const headers = Object.keys(data[0] || {}); 
            
            for (const field of requiredFields) {
                if (!headers.includes(field)) {
                    result.errors.push(`缺少必要欄位: ${field}。請檢查 CSV 標題行。`);
                }
            }
            
            if (result.errors.length > 0) {
                return result;
            }
            
            const employeeConsistency = {};
            let validRecords = 0;
            let skippedEmptyRecords = 0;
            
            data.forEach((row, index) => {
                const payrollId = row['Payroll ID']?.trim();
                const firstName = row['First Name']?.trim();
                const lastName = row['Last Name']?.trim();
                const workWeek = row['Work Week']?.trim();
                const hours = parseFloat(row['Hours']);
                
                // Skip processing if row is entirely empty
                if (!payrollId && !firstName && !lastName && !workWeek && (isNaN(hours) || hours === 0) && !row['Start Date'] && !row['Level'] && !row['Rate'] && !row['Farm']) {
                    skippedEmptyRecords++;
                    return;
                }
                
                validRecords++;
                
                if (!validatePayrollID(payrollId)) {
                    result.errors.push(`第${index + 2}行: Payroll ID 格式錯誤 (${payrollId || '空'})，應為 EQ-XXXX 格式 (例如 EQ-0001)。`);
                } else if (!payrollId) { 
                    result.errors.push(`第${index + 2}行: Payroll ID 為空。`);
                }
                
                if (!firstName || !lastName) {
                    result.warnings.push(`第${index + 2}行: 員工 ${payrollId || ''} 的姓名資料不完整。`);
                }
                
                if (!workWeek) {
                    result.errors.push(`第${index + 2}行: Work Week 為空。`);
                } else if (isNaN(parseDate(workWeek)?.getTime())) {
                    result.errors.push(`第${index + 2}行: Work Week 日期格式錯誤 (${workWeek})，請使用YYYY-MM-DD 或 DD/MM/YYYY 格式。`);
                }

                if (row['Start Date'] && isNaN(parseDate(row['Start Date'])?.getTime())) {
                    result.warnings.push(`第${index + 2}行: Start Date 日期格式錯誤或為空 (${row['Start Date'] || '空'})，將使用預設日期或已存在的日期。`);
                }
                
                if (isNaN(hours) || hours < 0) {
                    result.errors.push(`第${index + 2}行: 工時資料無效 (${row['Hours'] || '空'})，必須是正數。`);
                }
                
                if (hours > 168) {
                    result.warnings.push(`第${index + 2}行: 員工 ${payrollId || ''} 在 ${workWeek || ''} 的工時超過一週168小時 (${hours})，請確認。`);
                }
                
                if (payrollId && validatePayrollID(payrollId)) {
                    if (!employeeConsistency[payrollId]) {
                        employeeConsistency[payrollId] = {
                            firstName: firstName,
                            lastName: lastName,
                            startDate: row['Start Date'],
                            level: row['Level'],
                            rate: row['Rate'],
                            farm: row['Farm']
                        };
                    } else {
                        const existing = employeeConsistency[payrollId];
                        if (existing.firstName !== firstName || existing.lastName !== lastName) {
                            result.warnings.push(`第${index + 2}行: 員工 ${payrollId} 的姓名 (${firstName} ${lastName}) 與先前記錄 (${existing.firstName} ${existing.lastName}) 不一致，將以最新上傳的為準。`);
                        }
                    }
                }
            });
            
            if (result.errors.length === 0) {
                result.success.push(`✅ 成功驗證 ${validRecords} 筆工時記錄`);
                result.success.push(`👥 涉及 ${Object.keys(employeeConsistency).length} 位員工`);
                
                if (skippedEmptyRecords > 0) {
                    result.warnings.push(`⚠️ 已自動跳過 ${skippedEmptyRecords} 行空白記錄。`);
                }
            }
            
            return result;
        }
        
        // Check for conflicts with existing data
        function checkForConflicts(newData) {
            const conflicts = [];
            
            const existingDataMap = new Map();
            timesheetData.forEach(item => {
                existingDataMap.set(`${item.payrollId}-${item.workWeekDate}`, item.hours);
            });
            
            newData.forEach(row => {
                const payrollId = row['Payroll ID']?.trim();
                const workWeekDate = row['Work Week']?.trim();
                
                if (payrollId && workWeekDate) {
                    const key = `${payrollId}-${workWeekDate}`;
                    const existingHours = existingDataMap.get(key);
                    
                    if (existingHours !== undefined) { 
                        const newHours = parseFloat(row['Hours']) || 0;
                        if (existingHours !== newHours) { 
                            conflicts.push({
                                payrollId: payrollId,
                                workWeekDate: workWeekDate,
                                existingHours: existingHours,
                                newHours: newHours,
                                employeeName: `${row['First Name']} ${row['Last Name']}`.trim()
                            });
                        }
                    }
                }
            });
            return conflicts;
        }
        
        // Show conflict resolution dialog
        function showConflictDialog(newData, conflicts) {
            const dialog = document.createElement('div');
            dialog.className = 'confirm-dialog active'; 
            
            const conflictCount = conflicts.length;
            const sampleConflicts = conflicts.slice(0, 5); 
            
            let conflictsList = '';
            sampleConflicts.forEach(conflict => {
                conflictsList += `
                    <div class="validation-warning" style="margin-bottom: 5px;">
                        <strong>${conflict.employeeName}</strong> (${conflict.payrollId}) - ${conflict.workWeekDate}
                        <br>現有工時: <span class="highlight">${conflict.existingHours}</span> → 新工時: <span class="highlight">${conflict.newHours}</span>
                    </div>
                `;
            });
            
            if (conflictCount > 5) {
                conflictsList += `<div class="validation-warning" style="margin-top: 10px;">...還有 ${conflictCount - 5} 個衝突未顯示</div>`;
            }
            
            dialog.innerHTML = `
                <div class="confirm-content">
                    <h3>⚠️ 發現 ${conflictCount} 個資料衝突</h3>
                    <p>以下工時資料已存在且工時數值不同，是否要用新上傳的資料覆蓋？</p>
                    <p style="font-size: 14px; color: #666;">(僅顯示前 5 筆衝突)</p>
                    ${conflictsList}
                    <div class="confirm-buttons">
                        <button class="btn-confirm" onclick="confirmOverwrite(true)">覆蓋並更新</button>
                        <button class="btn-cancel" onclick="confirmOverwrite(false)">取消上傳</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(dialog);
            pendingData = newData; 
        }
        
        // Confirm overwrite for conflicts
        async function confirmOverwrite(confirmed) {
            closeCreateDialog(); 
            
            if (confirmed && pendingData) {
                await processTimesheetData(pendingData, true); 
            } else {
                updateProgress(0, '上傳已取消');
                showMessage('ℹ️ 資料上傳已取消。', 'info');
            }
            
            pendingData = null; 
        }
        
        // Process timesheet data (main logic for integrating new data)
        async function processTimesheetData(data, overwrite = false) {
            updateProgress(10, '開始處理資料...');
            
            const uploadSummary = {
                totalRecords: data.length,
                employees: new Set(),
                newRecords: 0,
                updatedRecords: 0,
                weeks: new Set() 
            };
            
            updateProgress(20, '處理資料中...');
            
            for (let i = 0; i < data.length; i++) {
                const row = data[i];
                const payrollId = row['Payroll ID']?.trim();
                const firstName = row['First Name']?.trim();
                const lastName = row['Last Name']?.trim();
                const startDateStr = row['Start Date']?.trim();
                const workWeekDate = row['Work Week']?.trim();
                const hours = parseFloat(row['Hours']) || 0; // Ensure hours are 0 if NaN
                const level = row['Level']?.trim();
                const rate = parseRate(row['Rate']);
                const farm = row['Farm']?.trim();

                if (!validatePayrollID(payrollId) || !workWeekDate || isNaN(parseDate(workWeekDate)?.getTime())) {
                    continue; 
                }
                
                uploadSummary.employees.add(payrollId);
                uploadSummary.weeks.add(workWeekDate); 
                
                let employeeStartDate = '2024-01-01'; // Default value if not provided or invalid
                if (startDateStr) {
                    const parsedStartDate = parseDate(startDateStr);
                    if (parsedStartDate && !isNaN(parsedStartDate.getTime())) {
                        employeeStartDate = parsedStartDate.toISOString().slice(0, 10);
                    }
                }

                if (!employees[payrollId]) {
                    employees[payrollId] = {
                        payrollId,
                        firstName,
                        lastName,
                        startDate: employeeStartDate, 
                        level: level || '',
                        farm: farm || '',
                        hourlyRate: rate,
                        workWeeks: {}, // Stores workWeekDate -> hours (all historical)
                        totalHours: 0, // Sum of all historical hours
                        payrollData: { regularHours: 0, overtimeHours: 0, regularPay: 0, overtimePay: 0, cycleHours: 0 } // Current cycle hours
                    };
                } else {
                    employees[payrollId].firstName = firstName;
                    employees[payrollId].lastName = lastName;
                    if (startDateStr) { 
                         const newParsedStartDate = parseDate(startDateStr);
                         if(newParsedStartDate && !isNaN(newParsedStartDate.getTime())) {
                            const currentStartDate = parseDate(employees[payrollId].startDate);
                            if (!currentStartDate || newParsedStartDate.getTime() < currentStartDate.getTime() || employees[payrollId].startDate === '2024-01-01') {
                                employees[payrollId].startDate = newParsedStartDate.toISOString().slice(0, 10);
                            }
                         }
                    }
                    if (farm) employees[payrollId].farm = farm;
                    if (level) employees[payrollId].level = level;
                    if (rate) employees[payrollId].hourlyRate = rate;
                }
                
                const currentRecordIndex = timesheetData.findIndex(item => 
                    item.payrollId === payrollId && item.workWeekDate === workWeekDate
                );

                if (currentRecordIndex !== -1) {
                    if (overwrite || timesheetData[currentRecordIndex].hours !== hours) {
                        timesheetData[currentRecordIndex].hours = hours;
                        timesheetData[currentRecordIndex].uploadDate = new Date().toISOString();
                        uploadSummary.updatedRecords++;
                    }
                } else {
                    timesheetData.push({
                        payrollId,
                        firstName,
                        lastName,
                        workWeekDate,
                        hours,
                        uploadDate: new Date().toISOString()
                    });
                    uploadSummary.newRecords++;
                }
                
                const progress = 30 + ((i + 1) / data.length) * 50; 
                updateProgress(progress, `處理中... ${i + 1}/${data.length}`);
                
                if (i % 5 === 0) {
                    await new Promise(resolve => setTimeout(resolve, 1));
                }
            }
            
            updateProgress(85, '計算工時與薪資...');
            
            // Re-calculate all employee data after all new records are processed
            Object.values(employees).forEach(employee => {
                // Ensure employee.workWeeks is up-to-date from timesheetData
                employee.workWeeks = timesheetData
                                        .filter(item => item.payrollId === employee.payrollId)
                                        .reduce((acc, item) => {
                                            acc[item.workWeekDate] = item.hours;
                                            return acc;
                                        }, {});

                // Calculate total historical hours
                employee.totalHours = Object.values(employee.workWeeks).reduce((sum, hours) => sum + hours, 0);
                
                // Calculate payroll data including cycle hours
                calculatePayroll(employee); 
            });
            
            updateProgress(90, '同步資料...');
            
            try {
                if (isGitHubConnected) {
                    updateProgress(95, '推送到 GitHub...');
                    await uploadToGitHub();
                }
            } catch (error) {
                console.error('GitHub upload failed:', error);
                showMessage(`❌ 自動同步到 GitHub 失敗: ${error.message}<br>數據已儲存在本地記憶體中，請嘗試手動同步。`, 'error', 15000); 
            }
            
            updateProgress(100, '完成！');
            
            showUploadSummary(uploadSummary);
            updateAllTables();
            
            showMessage(`
                ✅ 上傳成功！<br>
                📊 處理 ${uploadSummary.totalRecords} 筆記錄<br>
                👥 涉及 ${uploadSummary.employees.size} 位員工<br>
                ➕ 新增 ${uploadSummary.newRecords} 筆，更新 ${uploadSummary.updatedRecords} 筆
            `);
        }
        
        /**
         * Calculates payroll data for an employee.
         * Now uses employee.payrollData.cycleHours for overtime calculation.
         */
        function calculatePayroll(employee) {
            const hourlyRate = employee.hourlyRate || 0; 
            
            // Get current cycle info to get cycleHours
            const cycleInfo = calculateEmployeeCycle(employee, new Date());
            employee.payrollData.cycleHours = cycleInfo.cycleHours; // Store cycle hours in payrollData
            
            const currentCycleHours = employee.payrollData.cycleHours;

            if (currentCycleHours > REGULAR_HOURS_THRESHOLD) {
                employee.payrollData.regularHours = REGULAR_HOURS_THRESHOLD;
                employee.payrollData.overtimeHours = currentCycleHours - REGULAR_HOURS_THRESHOLD;
                employee.payrollData.regularPay = REGULAR_HOURS_THRESHOLD * hourlyRate;
                employee.payrollData.overtimePay = employee.payrollData.overtimeHours * hourlyRate; 
            } else {
                employee.payrollData.regularHours = currentCycleHours;
                employee.payrollData.overtimeHours = 0;
                employee.payrollData.regularPay = currentCycleHours * hourlyRate;
                employee.payrollData.overtimePay = 0;
            }
        }
        
        // Get filtered employee list based on UI filters
        function getFilteredEmployees() {
            const farmFilter = document.getElementById('farm-filter')?.value || '';
            const levelFilter = document.getElementById('level-filter')?.value || '';
            const statusFilter = document.getElementById('status-filter')?.value || '';
            
            return Object.values(employees).filter(employee => {
                if (farmFilter && employee.farm !== farmFilter) return false;
                if (levelFilter && employee.level !== levelFilter) return false;
                
                if (statusFilter) {
                    const cycleInfo = calculateEmployeeCycle(employee, new Date()); 
                    if (statusFilter === 'overtime' && cycleInfo.status !== 'overtime') return false; 
                    if (statusFilter === 'active' && cycleInfo.status !== 'active') return false;
                    // Removed filtering for 'complete' and 'pending' statuses as per request
                }
                
                return true;
            });
        }
        
        // Update filter options in dropdowns
        function updateFilterOptions() {
            const farmFilter = document.getElementById('farm-filter');
            const levelFilter = document.getElementById('level-filter');
            
            if (!farmFilter || !levelFilter) return;
            
            const farms = new Set();
            const levels = new Set();
            
            Object.values(employees).forEach(employee => {
                if (employee.farm) farms.add(employee.farm);
                if (employee.level) levels.add(employee.level);
            });
            
            const currentFarm = farmFilter.value;
            farmFilter.innerHTML = '<option value="">所有農場</option>';
            [...farms].sort().forEach(farm => {
                const option = document.createElement('option');
                option.value = farm;
                option.textContent = farm;
                if (farm === currentFarm) option.selected = true;
                farmFilter.appendChild(option);
            });
            
            const currentLevel = levelFilter.value;
            levelFilter.innerHTML = '<option value="">所有職級</option>';
            [...levels].sort().forEach(level => {
                const option = document.createElement('option');
                option.value = level;
                option.textContent = level;
                if (level === currentLevel) option.selected = true;
                levelFilter.appendChild(option);
            });
        }
        
        // Clear all filter selections
        function clearFilters() {
            document.getElementById('farm-filter').value = '';
            document.getElementById('level-filter').value = '';
            document.getElementById('status-filter').value = '';
            updateAllTables();
        }
        
        // Update the employee overview table with cycle info
        function updateOverviewTable() {
            const container = document.getElementById('overview-table-container');
            
            if (Object.keys(employees).length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #777; margin-top: 30px;">尚未載入員工資料，請先上傳工時表或從 GitHub 同步。</p>';
                document.getElementById('overview-summary-cards').innerHTML = ''; 
                return;
            }
            
            updateFilterOptions();
            const filteredEmployees = getFilteredEmployees();
            
            if (filteredEmployees.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #777; margin-top: 30px;">沒有符合篩選條件的員工資料。</p>';
                document.getElementById('overview-summary-cards').innerHTML = ''; 
                return;
            }

            let tableHTML = `
                <table class="employee-table">
                    <thead>
                        <tr>
                            <th>員工編號</th>
                            <th>姓名</th>
                            <th>農場</th>
                            <th>職級</th>
                            <th>開始日期</th>
                            <th>當前週期</th>      <th>週期內週數</th>    <th>歷史總工時</th>
                            <th>週期工時</th>
                            <th>剩餘額度</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            let activeCycles = 0;
            let overtimeCycles = 0; 
            
            filteredEmployees
                .sort((a, b) => a.payrollId.localeCompare(b.payrollId))
                .forEach(employee => {
                    const fullName = `${employee.firstName} ${employee.lastName}`.trim();
                    const cycleInfo = calculateEmployeeCycle(employee, new Date());
                    
                    // Count cycle status (only Active & Overtime for display summary)
                    if (cycleInfo.status === 'overtime') {
                        overtimeCycles++;
                    } else if (cycleInfo.status === 'active') { // Only count active for summary
                        activeCycles++;
                    }
                    
                    // Display currentCycle and weekInCycle separately, show 0 if calculation result is 0/NaN
                    const displayCurrentCycle = Number(cycleInfo.currentCycle) || 0; // Ensure 0 if NaN/null/undefined
                    const displayWeekInCycle = Number(cycleInfo.weekInCycle) || 0;

                    // Remaining hours within the current cycle
                    const remainingCycleHours = Math.max(0, REGULAR_HOURS_THRESHOLD - (Number(cycleInfo.cycleHours) || 0));
                    const remainingText = (Number(cycleInfo.cycleHours) || 0) > REGULAR_HOURS_THRESHOLD ? 
                        `超出 ${Number(cycleInfo.cycleHours) || 0}` : // Show actual cycle hours when exceeding, no 'h'
                        `剩餘 ${remainingCycleHours}`; // No 'h'
                    
                    // Progress bar color based on cycle status (overtime specifically)
                    const progressClass = (Number(cycleInfo.cycleHours) || 0) > REGULAR_HOURS_THRESHOLD ? 'cycle-progress-overtime' : '';
                    
                    tableHTML += `
                        <tr>
                            <td><strong>${employee.payrollId}</strong></td>
                            <td>${fullName}</td>
                            <td>${employee.farm || '-'}</td>
                            <td>${employee.level || '-'}</td>
                            <td>${(parseDate(employee.startDate) || new Date()).toLocaleDateString('en-AU')}</td> <td>${displayCurrentCycle}</td>   <td>${displayWeekInCycle}</td>    <td>
                                <div class="cycle-progress">
                                    <div class="cycle-progress-fill ${progressClass}" style="width: ${cycleInfo.progressPercentage}%"></div>
                                </div>
                                <small>${cycleInfo.progressPercentage.toFixed(1)}% 完成</small>
                            </td>
                            <td><strong>${Number(employee.totalHours) || 0}</strong></td> <td><strong>${Number(cycleInfo.cycleHours) || 0}</strong></td>  <td>${remainingText}</td>
                        </tr>
                    `;
                });
            
            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
            
            // Update summary cards (only Active and Overtime)
            const totalFiltered = filteredEmployees.length;
            const summaryHTML = `
                <div class="summary-card">
                    <h3>${totalFiltered}</h3>
                    <p>篩選後員工數</p>
                </div>
                <div class="summary-card">
                    <h3>${activeCycles}</h3>
                    <p>進行中週期</p>
                </div>
                <div class="summary-card">
                    <h3>${overtimeCycles}</h3>
                    <p>需加班費週期</p>
                </div>
            `;
            document.getElementById('overview-summary-cards').innerHTML = summaryHTML;
        }
        
        // Export employee overview report
        async function exportOverview() {
            if (Object.keys(employees).length === 0) {
                showMessage('沒有資料可以匯出', 'error');
                return;
            }
            
            setButtonLoading('exportOverview', true, '匯出中...'); 
            
            try {
                const filteredEmployees = getFilteredEmployees();
                // Updated CSV header for new column structure
                let csvContent = '員工編號,姓名,農場,職級,開始日期,當前週期,週期內週數,週期進度(%),歷史總工時,週期工時,剩餘額度\n';
                
                filteredEmployees.forEach(employee => {
                    const fullName = `${employee.firstName} ${employee.lastName}`.trim();
                    const cycleInfo = calculateEmployeeCycle(employee, new Date());
                    
                    const remainingCycleHours = Math.max(0, REGULAR_HOURS_THRESHOLD - (Number(cycleInfo.cycleHours) || 0));
                    const remainingText = (Number(cycleInfo.cycleHours) || 0) > REGULAR_HOURS_THRESHOLD ? 
                        `超出${(Number(cycleInfo.cycleHours) || 0)}` : 
                        `剩餘${remainingCycleHours}`;
                    
                    csvContent += `${employee.payrollId},"${fullName}",${employee.farm || ''},${employee.level || ''},${(parseDate(employee.startDate) || new Date()).toLocaleDateString('en-AU')},${Number(cycleInfo.currentCycle) || 0},${Number(cycleInfo.weekInCycle) || 0},${cycleInfo.progressPercentage.toFixed(1)},${Number(employee.totalHours) || 0},${Number(cycleInfo.cycleHours) || 0},"${remainingText}"\n`;
                });
                
                downloadCSV(csvContent, `員工總覽報告_${new Date().toLocaleDateString('en-AU').replace(/\//g, '-')}.csv`); // Australian date format
                showMessage('✅ 員工總覽報告已匯出');
            } catch (error) {
                showMessage(`❌ 匯出失敗: ${error.message}`, 'error');
                console.error("Export Overview failed:", error);
            } finally {
                setButtonLoading('exportOverview', false, '📥 匯出員工總覽報告 (CSV)');
            }
        }
        
        // Show upload summary after processing
        function showUploadSummary(summary) {
            const container = document.getElementById('timesheet-file-info');
            container.style.display = 'block';
            container.className = 'upload-summary';
            
            const sortedWeeks = Array.from(summary.weeks).sort();
            const weeksDisplay = sortedWeeks.length > 0 ? sortedWeeks.join(', ') : '無';

            container.innerHTML = `
                <h3>📊 上傳摘要</h3>
                <div class="summary-item">
                    <span>總記錄數：：</span>
                    <span class="highlight">${summary.totalRecords}</span>
                </div>
                <div class="summary-item">
                    <span>員工數量：：</span>
                    <span class="highlight">${summary.employees.size}</span>
                </div>
                <div class="summary-item">
                    <span>涵蓋週數：：</span>
                    <span>${weeksDisplay}</span>
                </div>
                <div class="summary-item">
                    <span>新增記錄：：</span>
                    <span class="highlight">${summary.newRecords}</span>
                </div>
                <div class="summary-item">
                    <span>更新記錄：：</span>
                    <span class="highlight">${summary.updatedRecords}</span>
                </div>
                <div class="summary-item">
                    <span>上傳時間：：</span>
                    <span>${new Date().toLocaleDateString('en-AU') + ' ' + new Date().toLocaleTimeString('en-AU')}</span>
                </div>
                <div class="summary-item">
                    <span>同步狀態：：</span>
                    <span class="highlight">${isGitHubConnected ? '已同步到 GitHub' : '未連接 GitHub (僅本地記憶體)'}</span>
                </div>
            `;
        }
        
        // Show validation results (errors, warnings, success messages)
        function showValidationResults(result) {
            const container = document.getElementById('validation-results');
            
            let html = '';
            
            result.success.forEach(msg => {
                html += `<div class="validation-item validation-success">✅ ${msg}</div>`;
            });
            
            result.warnings.forEach(msg => {
                html += `<div class="validation-item validation-warning">⚠️ ${msg}</div>`;
            });
            
            result.errors.forEach(msg => {
                html += `<div class="validation-item validation-error">❌ ${msg}</div>`;
            });
            
            container.innerHTML = html;
        }
        
        // Read file content as text
        async function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) { resolve(e.target.result); };
                reader.onerror = function() { reject(new Error('文件讀取失敗')); };
                reader.readAsText(file, 'UTF-8');
            });
        }
        
        // === MODIFIED parseCSV and parseCSVLine to handle TAB delimiters ===
        // Parse CSV text into an array of objects
        function parseCSV(csvText) {
            const lines = csvText.trim().split(/\r?\n/); 
            if (lines.length === 0) return [];

            const headerLine = lines[0];
            // === Delimiter detection logic ===
            // Prioritize tab if more tabs than commas, or if only tabs exist.
            const commaCount = (headerLine.match(/,/g) || []).length;
            const tabCount = (headerLine.match(/\t/g) || []).length;
            let delimiter = ','; // Default to comma
            if (tabCount > commaCount && tabCount > 0) { // If tabs are more prevalent and exist
                delimiter = '\t';
            }
            // === End Delimiter detection logic ===

            const headers = parseCSVLine(headerLine, delimiter); 
            
            return lines.slice(1)
                .map(line => parseCSVLine(line, delimiter)) 
                .filter(values => values.some(val => val.trim() !== '')) // Filter out truly empty lines
                .map(values => {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] !== undefined ? values[index] : '';
                    });
                    return row;
                })
                .filter(row => {
                    const payrollId = row['Payroll ID']?.trim();
                    const firstName = row['First Name']?.trim();
                    const lastName = row['Last Name']?.trim();
                    const workWeek = row['Work Week']?.trim();
                    const hours = parseFloat(row['Hours']);
                    return payrollId || firstName || lastName || workWeek || !isNaN(hours);
                });
        }

        // Helper function to parse a single CSV line based on detected delimiter
        // This version assumes fields are not quoted with commas inside.
        function parseCSVLine(line, delimiter) {
            const values = line.split(delimiter); 
            return values.map(val => val.trim()); 
        }
        // === END MODIFIED parseCSV and parseCSVLine ===
        
        // Update all displayed tables (overview and payroll)
        function updateAllTables() {
            updateOverviewTable();
            updatePayrollTable();
        }
        
        // Update the payroll calculation table
        function updatePayrollTable() {
            const container = document.getElementById('payroll-table-container');
            
            if (Object.keys(employees).length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #777; margin-top: 30px;">尚未載入員工資料，請先上傳工時表或從 GitHub 同步。</p>';
                document.getElementById('payroll-summary-cards').innerHTML = ''; 
                return;
            }
            
            let tableHTML = `
                <table class="employee-table">
                    <thead>
                        <tr>
                            <th>員工編號</th>
                            <th>姓名</th>
                            <th>農場</th>
                            <th>職級</th>
                            <th>歷史總工時</th>
                            <th>週期工時</th>
                            <th>正常工時</th>
                            <th>加班工時</th>
                            <th>時薪</th>
                            <th>加班費</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            let totalOvertimePay = 0;
            let totalOvertimeHours = 0;
            let totalCycleHours = 0;
            let accumulatedOvertimePay = 0; // New accumulator
            
            Object.values(employees)
                .sort((a, b) => b.payrollData.overtimePay - a.payrollData.overtimePay) // Sort by overtime pay
                .forEach(employee => {
                    const fullName = `${employee.firstName} ${employee.lastName}`.trim();
                    
                    // These come from calculatePayroll which now uses cycleHours for calculation
                    totalOvertimePay += (Number(employee.payrollData.overtimePay) || 0);
                    totalOvertimeHours += (Number(employee.payrollData.overtimeHours) || 0);
                    totalCycleHours += (Number(employee.payrollData.cycleHours) || 0); 

                    // Accumulate overtime pay across all employees (if it's not reset per cycle)
                    // Assuming '累積加班費' means sum of all overtimePay across all cycles/records, but
                    // current payrollData.overtimePay only stores for the *current* cycle.
                    // To calculate *true* accumulated, would need a separate history.
                    // For now, I'll sum current payrollData.overtimePay which is for *current cycle*.
                    // If you mean a historical accumulated sum across all periods, that would require
                    // storing that sum per employee. For simple sum of current displayed payroll table,
                    // totalOvertimePay is the correct sum. Let's make "累積加班費" explicitly mean
                    // sum of current cycle's overtime pay displayed.
                    accumulatedOvertimePay += (Number(employee.payrollData.overtimePay) || 0);


                    const overtimeClass = (Number(employee.payrollData.overtimeHours) || 0) > 0 ? 'status-overtime' : '';
                    
                    tableHTML += `
                        <tr>
                            <td><strong>${employee.payrollId}</strong></td>
                            <td>${fullName}</td>
                            <td>${employee.farm || '-'}</td>
                            <td>${employee.level || '-'}</td>
                            <td><strong>${Number(employee.totalHours) || 0}</strong></td> <td><strong>${Number(employee.payrollData.cycleHours) || 0}</strong></td> <td>${Number(employee.payrollData.regularHours) || 0}</td> <td class="${overtimeClass}">${Number(employee.payrollData.overtimeHours) || 0}</td> <td>${Number(employee.hourlyRate).toFixed(2) || '0.00'}</td>
                            <td class="money ${overtimeClass}"><strong>$${(Number(employee.payrollData.overtimePay) || 0).toFixed(2)}</strong></td>
                        </tr>
                    `;
                });
            
            tableHTML += `
                <tr style="background: #f0f0f0; font-weight: bold;">
                    <td colspan="5" style="text-align: right;">總計</td>
                    <td>${Number(totalCycleHours) || 0}</td>
                    <td>-</td>
                    <td class="status-overtime">${Number(totalOvertimeHours) || 0}</td>
                    <td>-</td>
                    <td class="money status-overtime">$${(Number(totalOvertimePay) || 0).toFixed(2)}</td>
                </tr>
            `;
            
            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
            
            // Update payroll summary cards
            const totalEmployees = Object.keys(employees).length;
            const overtimeEmployees = Object.values(employees).filter(emp => (Number(emp.payrollData.overtimeHours) || 0) > 0).length;
            const avgOvertimePay = overtimeEmployees > 0 ? (totalOvertimePay / overtimeEmployees) : 0;
            
            const summaryHTML = `
                <div class="summary-card">
                    <h3>$${(Number(totalOvertimePay) || 0).toFixed(0)}</h3>
                    <p>總加班費支出 (本週期)</p>
                </div>
                <div class="summary-card">
                    <h3>${(Number(totalOvertimeHours) || 0)}</h3>
                    <p>總加班工時 (本週期)</p>
                </div>
                <div class="summary-card">
                    <h3>${(Number(totalCycleHours) || 0)}</h3>
                    <p>當前週期總工時</p>
                </div>
                <div class="summary-card">
                    <h3>${overtimeEmployees} / ${totalEmployees}</h3>
                    <p>需加班費員工</p>
                </div>
                <div class="summary-card">
                    <h3>$${(Number(accumulatedOvertimePay) || 0).toFixed(0)}</h3>
                    <p>累積加班費</p> </div>
            `;
            document.getElementById('payroll-summary-cards').innerHTML = summaryHTML;
        }
        
        // Export payroll report (overtime report)
        async function exportPayroll() {
            if (Object.keys(employees).length === 0) {
                showMessage('沒有資料可以匯出', 'error');
                return;
            }
            
            setButtonLoading('exportPayroll', true, '匯出中...');
            
            try {
                const filteredEmployees = getFilteredEmployees(); // Use filtered employees for export
                let csvContent = '員工編號,姓名,農場,職級,歷史總工時,週期工時,正常工時,加班工時,時薪,加班費\n'; // No 'h'
                
                filteredEmployees.forEach(employee => {
                    const fullName = `${employee.firstName} ${employee.lastName}`.trim();
                    
                    csvContent += `${employee.payrollId},"${fullName}",${employee.farm || ''},${employee.level || ''},${(Number(employee.totalHours) || 0)},${(Number(employee.payrollData.cycleHours) || 0)},${(Number(employee.payrollData.regularHours) || 0)},${(Number(employee.payrollData.overtimeHours) || 0)},${(Number(employee.hourlyRate) || 0)},${(Number(employee.payrollData.overtimePay) || 0).toFixed(2)}\n`;
                });
                
                downloadCSV(csvContent, `加班費報表_${new Date().toLocaleDateString('en-AU').replace(/\//g, '-')}.csv`); 
                showMessage('✅ 加班費報表已匯出');
            } catch (error) {
                showMessage(`❌ 匯出失敗: ${error.message}`, 'error');
                console.error("Export Payroll failed:", error);
            } finally {
                setButtonLoading('exportPayroll', false, '📥 匯出薪資報表 (CSV)');
            }
        }
        
        // Download CSV file to user's computer
        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link); 
            link.click();
            document.body.removeChild(link); 
        }
        
        // Drag and drop functionality for file upload
        const uploadSection = document.getElementById('timesheet-upload');
        
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });
        
        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });
        
        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('timesheet-file').files = files;
                handleTimesheetFile({ target: { files } });
            }
        });
    </script>
</body>
</html>
