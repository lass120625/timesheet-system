<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Drive ä¸­å¤®è³‡æ–™åº«å·¥æ™‚ç³»çµ±</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
        }
        
        .drive-section {
            background: #e8f5e8;
            border: 2px solid #4CAF50;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .drive-connected {
            background: #d4edda;
            border-color: #28a745;
        }
        
        .drive-disconnected {
            background: #f8d7da;
            border-color: #dc3545;
        }
        
        .drive-loading {
            background: #fff3cd;
            border-color: #ffc107;
        }
        
        .central-db-info {
            background: #e7f3ff;
            border: 2px solid #b3d9ff;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .central-db-info h3 {
            color: #0066cc;
            margin: 0 0 15px 0;
        }
        
        .workflow-step {
            display: flex;
            align-items: center;
            margin: 15px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .step-number {
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: bold;
        }
        
        .upload-section {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
            background: #f8f9ff;
            transition: all 0.3s ease;
        }
        
        .upload-section:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }
        
        .upload-section.dragover {
            border-color: #764ba2;
            background: #e8ebff;
            transform: scale(1.02);
        }
        
        .file-input {
            display: none;
        }
        
        .upload-btn, .drive-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            transition: transform 0.2s;
        }
        
        .drive-btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
        }
        
        .drive-btn-warning {
            background: linear-gradient(45deg, #ffc107, #e0a800);
            color: #333;
        }
        
        .upload-btn:hover, .drive-btn:hover {
            transform: translateY(-2px);
        }
        
        .upload-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .file-info {
            margin-top: 15px;
            padding: 10px;
            background: #e8f5e8;
            border-radius: 5px;
            display: none;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 15px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            min-width: 120px;
            text-align: center;
        }
        
        .tab.active {
            border-bottom-color: #667eea;
            color: #667eea;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .employee-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 13px;
        }
        
        .employee-table th,
        .employee-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        .employee-table th {
            background: #667eea;
            color: white;
            font-size: 12px;
        }
        
        .employee-table tr:nth-child(even) {
            background: #f9f9f9;
        }
        
        .status-normal {
            color: #228B22;
            font-weight: bold;
        }
        
        .status-overtime {
            color: #ff4444;
            font-weight: bold;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .summary-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .summary-card h3 {
            margin: 0 0 10px 0;
            font-size: 20px;
        }
        
        .summary-card p {
            margin: 0;
            font-size: 12px;
            opacity: 0.9;
        }
        
        .error-message {
            background: #ffe6e6;
            color: #cc0000;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 5px solid #cc0000;
        }
        
        .success-message {
            background: #e6ffe6;
            color: #006600;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 5px solid #006600;
        }
        
        .warning-message {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 5px solid #ffc107;
        }
        
        .money {
            color: #28a745;
            font-weight: bold;
        }
        
        .format-info {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            font-size: 14px;
        }
        
        .format-info h4 {
            margin: 0 0 10px 0;
            color: #0066cc;
        }
        
        .format-example {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            margin: 5px 0;
        }
        
        .confirm-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .confirm-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        
        .confirm-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .btn-confirm {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .btn-cancel {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .upload-summary {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .upload-summary h3 {
            margin: 0 0 15px 0;
            color: #495057;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .highlight {
            background: #fff3cd;
            padding: 2px 6px;
            border-radius: 3px;
        }
        
        .validation-results {
            margin: 20px 0;
        }
        
        .validation-item {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            border-left: 4px solid;
        }
        
        .validation-success {
            background: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }
        
        .validation-warning {
            background: #fff3cd;
            border-left-color: #ffc107;
            color: #856404;
        }
        
        .validation-error {
            background: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }
        
        .cycle-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            min-width: 80px;
        }
        
        .cycle-active {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .cycle-complete {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .cycle-overtime {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .cycle-pending {
            background: #e7f3ff;
            color: #0066cc;
            border: 1px solid #b3d9ff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>â˜ï¸ Google Drive ä¸­å¤®è³‡æ–™åº«å·¥æ™‚ç³»çµ±</h1>
        <div style="text-align: center; margin-bottom: 20px;">
            <small>ğŸ”„ ä¸­å¤®è³‡æ–™åº« | ğŸ“Š å³æ™‚åŒæ­¥ | ğŸ‘¥ åœ˜éšŠå…±ç”¨</small>
        </div>
        
        <!-- ä¸­å¤®è³‡æ–™åº«æ¦‚å¿µèªªæ˜ -->
        <div class="central-db-info">
            <h3>ğŸ’¡ ä¸­å¤®è³‡æ–™åº«æ¦‚å¿µ</h3>
            <div class="workflow-step">
                <div class="step-number">1</div>
                <div>ä»»ä½•äººä¸Šå‚³ CSV å·¥æ™‚è¡¨</div>
            </div>
            <div class="workflow-step">
                <div class="step-number">2</div>
                <div>ç³»çµ±è‡ªå‹•æ•´åˆè³‡æ–™ä¸¦æ›´æ–° Google Drive ä¸»æª”æ¡ˆ</div>
            </div>
            <div class="workflow-step">
                <div class="step-number">3</div>
                <div>æ‰€æœ‰åœ˜éšŠæˆå“¡è‡ªå‹•çœ‹åˆ°æœ€æ–°æ•´åˆè³‡æ–™</div>
            </div>
            <div class="workflow-step">
                <div class="step-number">4</div>
                <div>å¯éš¨æ™‚ä¸‹è¼‰å®Œæ•´è³‡æ–™æª”æ¡ˆå‚™ä»½</div>
            </div>
        </div>
        
        <!-- Google Drive é€£æ¥ç‹€æ…‹ -->
        <div id="drive-status" class="drive-section drive-disconnected">
            <h3>â˜ï¸ Google Drive é€£æ¥ç‹€æ…‹</h3>
            <p id="drive-status-text">å°šæœªé€£æ¥åˆ° Google Drive</p>
            <div id="last-sync" class="last-sync" style="display: none;">
                <strong>æœ€å¾ŒåŒæ­¥ï¼š</strong><span id="sync-time">å°šæœªåŒæ­¥</span>
            </div>
            <button id="drive-connect-btn" class="drive-btn" onclick="connectToGoogleDrive()">
                ğŸ”— é€£æ¥ Google Drive
            </button>
            <button id="drive-sync-btn" class="drive-btn" onclick="syncFromDrive()" style="display: none;">
                ğŸ”„ å¾ Drive è¼‰å…¥æœ€æ–°è³‡æ–™
            </button>
            <button id="drive-download-btn" class="drive-btn" onclick="downloadFromDrive()" style="display: none;">
                ğŸ“¥ ä¸‹è¼‰å®Œæ•´è³‡æ–™æª”
            </button>
            <button id="drive-disconnect-btn" class="drive-btn-warning" onclick="disconnectDrive()" style="display: none;">
                ğŸ”Œ ä¸­æ–·é€£æ¥
            </button>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('upload')">ğŸ“ è³‡æ–™ä¸Šå‚³</div>
            <div class="tab" onclick="switchTab('employees')">ğŸ‘¥ å“¡å·¥ç¸½è¦½</div>
            <div class="tab" onclick="switchTab('cycles')">ğŸ”„ é€±æœŸåˆ†æ</div>
            <div class="tab" onclick="switchTab('payroll')">ğŸ’° è–ªè³‡è¨ˆç®—</div>
            <div class="tab" onclick="switchTab('setup')">âš™ï¸ è¨­å®šèªªæ˜</div>
        </div>
        
        <!-- ä¸Šå‚³å€åŸŸ -->
        <div id="upload-tab" class="tab-content active">
            <div class="format-info">
                <h4>ğŸ“Š å·¥æ™‚è¡¨æ ¼å¼èªªæ˜</h4>
                <div class="format-example">
                    Payroll ID, First Name, Last Name, Start Date, Work Week, Hours, Level, Rate
                    <br>EQ-0001, John, Doe, 2024-01-15, Week 1, 45, Senior, 25.50
                    <br>EQ-0001, John, Doe, 2024-01-15, Week 2, 38, Senior, 25.50
                    <br>EQ-0002, Jane, Smith, 2024-02-01, Week 1, 42, Junior, 20.00
                </div>
                <p><strong>ä¸Šå‚³å¾Œè‡ªå‹•è™•ç†ï¼š</strong></p>
                <ul>
                    <li>âœ… é©—è­‰ EQ-0001 æ ¼å¼çš„å“¡å·¥ç·¨è™Ÿ</li>
                    <li>âœ… æ•´åˆæ–°èˆŠè³‡æ–™ï¼Œæª¢æ¸¬é‡è¤‡é€±æ•¸</li>
                    <li>âœ… è‡ªå‹•æ›´æ–° Google Drive ä¸­å¤®è³‡æ–™åº«</li>
                    <li>âœ… æ‰€æœ‰åœ˜éšŠæˆå“¡å³æ™‚çœ‹åˆ°æœ€æ–°è³‡æ–™</li>
                </ul>
            </div>
            
            <div class="upload-section" id="timesheet-upload">
                <h3>ğŸ“‹ ä¸Šå‚³å·¥æ™‚è¡¨ (CSV)</h3>
                <p>ä¸Šå‚³å¾Œå°‡è‡ªå‹•æ•´åˆåˆ° Google Drive ä¸­å¤®è³‡æ–™åº«</p>
                <button class="upload-btn" onclick="document.getElementById('timesheet-file').click()">
                    é¸æ“‡å·¥æ™‚è¡¨æ–‡ä»¶
                </button>
                <input type="file" id="timesheet-file" class="file-input" accept=".csv" onchange="handleTimesheetFile(event)">
                <div id="timesheet-file-info" class="file-info"></div>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <p id="progress-text">ç­‰å¾…ä¸Šå‚³æ–‡ä»¶...</p>
            
            <div id="validation-results" class="validation-results"></div>
        </div>
        
        <!-- é€±æœŸåˆ†æ -->
        <div id="cycles-tab" class="tab-content">
            <h2>ğŸ”„ å“¡å·¥é€±æœŸåˆ†æ</h2>
            
            <div class="format-info">
                <h4>ğŸ“… é€±æœŸè¨ˆç®—èªªæ˜</h4>
                <ul>
                    <li><strong>é€±æœŸèµ·å§‹ï¼š</strong>ä»¥å“¡å·¥é–‹å§‹æ—¥æœŸï¼ˆStart Dateï¼‰ç‚ºåŸºæº–</li>
                    <li><strong>é€±æœŸé•·åº¦ï¼š</strong>æ¯8é€±ç‚ºä¸€å€‹å®Œæ•´é€±æœŸ</li>
                    <li><strong>åŠ ç­é–€æª»ï¼š</strong>æ¯é€±æœŸè¶…é304å°æ™‚è§¸ç™¼åŠ ç­è²»</li>
                    <li><strong>é€±æœŸé‡ç½®ï¼š</strong>ç¬¬9é€±è‡ªå‹•é–‹å§‹æ–°é€±æœŸ</li>
                </ul>
            </div>
            
            <div class="summary-cards" id="cycle-summary-cards"></div>
            <div id="cycles-table-container"></div>
            
            <button class="upload-btn" onclick="exportCycleAnalysis()" style="margin-top: 20px;">
                ğŸ“¥ åŒ¯å‡ºé€±æœŸåˆ†æå ±å‘Š (CSV)
            </button>
        </div>

        <!-- å“¡å·¥è³‡æ–™é¡¯ç¤º -->
        <div id="employees-tab" class="tab-content">
            <h2>ğŸ‘¥ å“¡å·¥è³‡æ–™ç¸½è¦½</h2>
            <div class="summary-cards" id="employee-summary-cards"></div>
            <div id="employees-table-container"></div>
        </div>
        
        <!-- è–ªè³‡è¨ˆç®— -->
        <div id="payroll-tab" class="tab-content">
            <h2>ğŸ’° è–ªè³‡è¨ˆç®—çµæœ</h2>
            <div class="summary-cards" id="payroll-summary-cards"></div>
            <div id="payroll-table-container"></div>
            <button class="upload-btn" onclick="exportPayroll()" style="margin-top: 20px;">
                ğŸ“¥ åŒ¯å‡ºè–ªè³‡å ±è¡¨ (CSV)
            </button>
        </div>
        
        <!-- è¨­å®šèªªæ˜ -->
        <div id="setup-tab" class="tab-content">
            <h2>âš™ï¸ è¨­å®šèªªæ˜</h2>
            
            <div class="format-info">
                <h4>ğŸš€ å¿«é€Ÿéƒ¨ç½²æŒ‡å—</h4>
                
                <div style="margin: 20px 0;">
                    <h5><strong>æ–¹æ¡ˆä¸€ï¼šGitHub Pagesï¼ˆæ¨è–¦ï¼‰</strong></h5>
                    <ol>
                        <li>å»ºç«‹ <a href="https://github.com" target="_blank">GitHub å¸³è™Ÿ</a></li>
                        <li>å»ºç«‹æ–°çš„ repositoryï¼Œå‘½åç‚º "timesheet-system"</li>
                        <li>ä¸Šå‚³é€™å€‹ HTML æ–‡ä»¶ï¼Œå‘½åç‚º "index.html"</li>
                        <li>åœ¨ Settings â†’ Pages ä¸­å•Ÿç”¨ GitHub Pages</li>
                        <li>ä½ çš„ç¶²ç«™ç¶²å€ï¼šhttps://ä½ çš„ç”¨æˆ¶å.github.io/timesheet-system</li>
                    </ol>
                </div>
                
                <div style="margin: 20px 0;">
                    <h5><strong>æ–¹æ¡ˆäºŒï¼šGoogle Sitesï¼ˆæœ€ç°¡å–®ï¼‰</strong></h5>
                    <ol>
                        <li>å‰å¾€ <a href="https://sites.google.com" target="_blank">Google Sites</a></li>
                        <li>å»ºç«‹æ–°ç¶²ç«™</li>
                        <li>æ’å…¥ â†’ åµŒå…¥ â†’ åµŒå…¥ä»£ç¢¼</li>
                        <li>å°‡æ•´å€‹ HTML ä»£ç¢¼è²¼å…¥</li>
                        <li>ç™¼å¸ƒç¶²ç«™ï¼Œå–å¾—åˆ†äº«é€£çµ</li>
                    </ol>
                </div>
                
                <div style="margin: 20px 0;">
                    <h5><strong>Google Drive API è¨­å®š</strong></h5>
                    <ol>
                        <li>å‰å¾€ <a href="https://console.developers.google.com" target="_blank">Google Cloud Console</a></li>
                        <li>å»ºç«‹æ–°å°ˆæ¡ˆæˆ–é¸æ“‡ç¾æœ‰å°ˆæ¡ˆ</li>
                        <li>å•Ÿç”¨ Google Drive API</li>
                        <li>å»ºç«‹æ†‘è­‰ â†’ OAuth 2.0 å®¢æˆ¶ç«¯ ID</li>
                        <li>è¨­å®šæˆæ¬Šç¶²åŸŸç‚ºä½ çš„ç¶²ç«™ç¶²å€</li>
                        <li>å°‡å®¢æˆ¶ç«¯ ID å¡«å…¥ä¸‹æ–¹ï¼š</li>
                    </ol>
                    
                    <div style="margin-top: 15px;">
                        <label><strong>Google OAuth å®¢æˆ¶ç«¯ IDï¼š</strong></label><br>
                        <input type="text" id="client-id-input" placeholder="è«‹è²¼ä¸Šä½ çš„ OAuth å®¢æˆ¶ç«¯ ID" style="width: 100%; padding: 8px; margin-top: 5px; font-family: monospace;">
                        <button onclick="saveClientId()" style="margin-top: 10px; padding: 8px 15px; background: #4CAF50; color: white; border: none; border-radius: 5px;">å„²å­˜è¨­å®š</button>
                    </div>
                </div>
            </div>
            
            <div class="format-info">
                <h4>ğŸ’¡ ç³»çµ±æ¶æ§‹èªªæ˜</h4>
                <p><strong>ä¸­å¤®è³‡æ–™åº«æ¦‚å¿µï¼š</strong></p>
                <ul>
                    <li><strong>ä¸»æª”æ¡ˆï¼š</strong>Google Drive ä¸­çš„ "timesheet_database.json"</li>
                    <li><strong>ä¸Šå‚³æµç¨‹ï¼š</strong>CSV â†’ è§£æ â†’ æ•´åˆ â†’ æ›´æ–°ä¸»æª”æ¡ˆ</li>
                    <li><strong>åŒæ­¥æ©Ÿåˆ¶ï¼š</strong>æ‰€æœ‰äººå…±ç”¨åŒä¸€å€‹ä¸»æª”æ¡ˆ</li>
                    <li><strong>ç‰ˆæœ¬æ§åˆ¶ï¼š</strong>æ¯æ¬¡æ›´æ–°éƒ½ä¿ç•™æ™‚é–“æˆ³è¨˜</li>
                </ul>
                
                <p><strong>åœ˜éšŠä½¿ç”¨æ–¹å¼ï¼š</strong></p>
                <ol>
                    <li>ä¸»ç®¡è¨­å®šå¥½ç³»çµ±ä¸¦åˆ†äº«ç¶²å€çµ¦åœ˜éšŠ</li>
                    <li>ä»»ä½•äººéƒ½å¯ä»¥ä¸Šå‚³å·¥æ™‚ CSV</li>
                    <li>ç³»çµ±è‡ªå‹•æ•´åˆæ‰€æœ‰è³‡æ–™åˆ° Google Drive</li>
                    <li>æ‰€æœ‰äººçœ‹åˆ°çš„éƒ½æ˜¯æœ€æ–°çš„æ•´åˆè³‡æ–™</li>
                    <li>å¯éš¨æ™‚ä¸‹è¼‰å®Œæ•´è³‡æ–™æª”æ¡ˆå‚™ä»½</li>
                </ol>
            </div>
        </div>
        
        <div id="messages"></div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let employees = {};
        let timesheetData = [];
        let pendingData = null;
        let isGoogleDriveConnected = false;
        let gapi = null;
        let clientId = '';
        const MASTER_FILE_NAME = 'timesheet_database.json';
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            updateProgress(0, 'ç³»çµ±å°±ç·’');
        });
        
        // è¼‰å…¥è¨­å®š
        function loadSettings() {
            const savedClientId = localStorage.getItem('google_oauth_client_id');
            if (savedClientId) {
                clientId = savedClientId;
                document.getElementById('client-id-input').value = savedClientId;
            }
        }
        
        // å„²å­˜å®¢æˆ¶ç«¯ ID
        function saveClientId() {
            const input = document.getElementById('client-id-input');
            clientId = input.value.trim();
            
            if (clientId) {
                localStorage.setItem('google_oauth_client_id', clientId);
                showMessage('âœ… å®¢æˆ¶ç«¯ ID å·²å„²å­˜ï¼ç¾åœ¨å¯ä»¥é€£æ¥ Google Drive');
            } else {
                showMessage('âŒ è«‹è¼¸å…¥æœ‰æ•ˆçš„ OAuth å®¢æˆ¶ç«¯ ID', 'error');
            }
        }
        
        // é€£æ¥åˆ° Google Drive
        function connectToGoogleDrive() {
            if (!clientId) {
                showMessage('âŒ è«‹å…ˆåœ¨è¨­å®šé é¢è¼¸å…¥ OAuth å®¢æˆ¶ç«¯ ID', 'error');
                switchTab('setup');
                return;
            }
            
            updateDriveStatus('loading', 'æ­£åœ¨é€£æ¥ Google Drive...');
            
            // è¼‰å…¥ Google API
            if (!window.gapi) {
                const script = document.createElement('script');
                script.src = 'https://apis.google.com/js/api.js';
                script.onload = () => {
                    gapi = window.gapi;
                    gapi.load('auth2:client', initializeGapi);
                };
                document.head.appendChild(script);
            } else {
                gapi = window.gapi;
                initializeGapi();
            }
        }
        
        // åˆå§‹åŒ– Google API
        function initializeGapi() {
            gapi.client.init({
                clientId: clientId,
                discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                scope: 'https://www.googleapis.com/auth/drive.file'
            }).then(() => {
                const authInstance = gapi.auth2.getAuthInstance();
                
                if (authInstance.isSignedIn.get()) {
                    handleSignInSuccess();
                } else {
                    return authInstance.signIn();
                }
            }).then(() => {
                handleSignInSuccess();
            }).catch((error) => {
                console.error('Google Drive é€£æ¥å¤±æ•—:', error);
                showMessage(`âŒ Google Drive é€£æ¥å¤±æ•—: ${error.error || error.message}`, 'error');
                updateDriveStatus('disconnected', 'é€£æ¥å¤±æ•—');
            });
        }
        
        // è™•ç†ç™»å…¥æˆåŠŸ
        function handleSignInSuccess() {
            isGoogleDriveConnected = true;
            updateDriveStatus('connected', 'âœ… å·²é€£æ¥åˆ° Google Drive');
            showMessage('âœ… Google Drive é€£æ¥æˆåŠŸï¼æ­£åœ¨è¼‰å…¥ä¸­å¤®è³‡æ–™åº«...');
            
            // ç«‹å³è¼‰å…¥ä¸­å¤®è³‡æ–™åº«
            syncFromDrive();
        }
        
        // æ›´æ–° Drive é€£æ¥ç‹€æ…‹
        function updateDriveStatus(status, message) {
            const statusDiv = document.getElementById('drive-status');
            const statusText = document.getElementById('drive-status-text');
            const connectBtn = document.getElementById('drive-connect-btn');
            const syncBtn = document.getElementById('drive-sync-btn');
            const downloadBtn = document.getElementById('drive-download-btn');
            const disconnectBtn = document.getElementById('drive-disconnect-btn');
            const lastSyncDiv = document.getElementById('last-sync');
            
            statusText.textContent = message;
            
            if (status === 'connected') {
                statusDiv.className = 'drive-section drive-connected';
                connectBtn.style.display = 'none';
                syncBtn.style.display = 'inline-block';
                downloadBtn.style.display = 'inline-block';
                disconnectBtn.style.display = 'inline-block';
                lastSyncDiv.style.display = 'block';
            } else if (status === 'loading') {
                statusDiv.className = 'drive-section drive-loading';
                connectBtn.style.display = 'none';
                syncBtn.style.display = 'none';
                downloadBtn.style.display = 'none';
                disconnectBtn.style.display = 'none';
            } else {
                statusDiv.className = 'drive-section drive-disconnected';
                connectBtn.style.display = 'inline-block';
                syncBtn.style.display = 'none';
                downloadBtn.style.display = 'none';
                disconnectBtn.style.display = 'none';
                lastSyncDiv.style.display = 'none';
            }
        }
        
        // ä¸­æ–·é€£æ¥
        function disconnectDrive() {
            if (gapi && gapi.auth2) {
                gapi.auth2.getAuthInstance().signOut();
            }
            isGoogleDriveConnected = false;
            updateDriveStatus('disconnected', 'å°šæœªé€£æ¥åˆ° Google Drive');
            showMessage('ğŸ”Œ å·²ä¸­æ–· Google Drive é€£æ¥');
        }
        
        // å¾ Drive åŒæ­¥è³‡æ–™
        async function syncFromDrive() {
            if (!isGoogleDriveConnected) {
                showMessage('âŒ è«‹å…ˆé€£æ¥ Google Drive', 'error');
                return;
            }
            
            try {
                showMessage('ğŸ”„ æ­£åœ¨å¾ Google Drive è¼‰å…¥æœ€æ–°è³‡æ–™...');
                
                // æœå°‹ä¸»æª”æ¡ˆ
                const response = await gapi.client.drive.files.list({
                    q: `name='${MASTER_FILE_NAME}'`,
                    spaces: 'drive'
                });
                
                if (response.result.files.length === 0) {
                    showMessage('ğŸ“ Google Drive ä¸­å°šç„¡è³‡æ–™æª”æ¡ˆï¼Œå°‡åœ¨é¦–æ¬¡ä¸Šå‚³æ™‚å»ºç«‹', 'warning');
                    updateSyncTime();
                    return;
                }
                
                const fileId = response.result.files[0].id;
                
                // ä¸‹è¼‰æª”æ¡ˆå…§å®¹
                const fileResponse = await gapi.client.drive.files.get({
                    fileId: fileId,
                    alt: 'media'
                });
                
                const masterData = JSON.parse(fileResponse.body);
                
                // è¼‰å…¥åˆ°ç³»çµ±ä¸­
                employees = masterData.employees || {};
                timesheetData = masterData.timesheetData || [];
                
                updateAllTables();
                updateSyncTime();
                
                const empCount = Object.keys(employees).length;
                const recordCount = timesheetData.length;
                
                showMessage(`âœ… æˆåŠŸè¼‰å…¥ä¸­å¤®è³‡æ–™åº«ï¼<br>ğŸ‘¥ ${empCount} ä½å“¡å·¥<br>ğŸ“Š ${recordCount} ç­†å·¥æ™‚è¨˜éŒ„`);
                
            } catch (error) {
                console.error('å¾ Drive åŒæ­¥å¤±æ•—:', error);
                showMessage(`âŒ å¾ Google Drive è¼‰å…¥å¤±æ•—: ${error.message}`, 'error');
            }
        }
        
        // ä¸Šå‚³åˆ° Driveï¼ˆæ›´æ–°ä¸­å¤®è³‡æ–™åº«ï¼‰
        async function uploadToDrive(data) {
            if (!isGoogleDriveConnected) {
                throw new Error('æœªé€£æ¥åˆ° Google Drive');
            }
            
            try {
                // æº–å‚™ä¸»æª”æ¡ˆè³‡æ–™
                const masterData = {
                    employees: employees,
                    timesheetData: timesheetData,
                    lastUpdated: new Date().toISOString(),
                    version: '1.0',
                    systemName: 'Google Drive ä¸­å¤®è³‡æ–™åº«å·¥æ™‚ç³»çµ±'
                };
                
                const fileContent = JSON.stringify(masterData, null, 2);
                
                // æœå°‹æ˜¯å¦å·²å­˜åœ¨ä¸»æª”æ¡ˆ
                const searchResponse = await gapi.client.drive.files.list({
                    q: `name='${MASTER_FILE_NAME}'`,
                    spaces: 'drive'
                });
                
                if (searchResponse.result.files.length > 0) {
                    // æ›´æ–°ç¾æœ‰æª”æ¡ˆ
                    const fileId = searchResponse.result.files[0].id;
                    
                    const response = await gapi.client.request({
                        path: `https://www.googleapis.com/upload/drive/v3/files/${fileId}`,
                        method: 'PATCH',
                        params: {
                            uploadType: 'media'
                        },
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: fileContent
                    });
                    
                    console.log('ä¸»æª”æ¡ˆå·²æ›´æ–°:', response.result);
                } else {
                    // å»ºç«‹æ–°æª”æ¡ˆ
                    const metadata = {
                        name: MASTER_FILE_NAME,
                        description: 'å·¥æ™‚ç³»çµ±ä¸­å¤®è³‡æ–™åº«'
                    };
                    
                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
                    form.append('file', new Blob([fileContent], {type: 'application/json'}));
                    
                    const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                        method: 'POST',
                        headers: new Headers({
                            'Authorization': 'Bearer ' + gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token
                        }),
                        body: form
                    });
                    
                    const result = await response.json();
                    console.log('ä¸»æª”æ¡ˆå·²å»ºç«‹:', result);
                }
                
                updateSyncTime();
                return true;
                
            } catch (error) {
                console.error('ä¸Šå‚³åˆ° Drive å¤±æ•—:', error);
                throw error;
            }
        }
        
        // ä¸‹è¼‰å®Œæ•´è³‡æ–™æª”
        async function downloadFromDrive() {
            if (!isGoogleDriveConnected) {
                showMessage('âŒ è«‹å…ˆé€£æ¥ Google Drive', 'error');
                return;
            }
            
            try {
                const response = await gapi.client.drive.files.list({
                    q: `name='${MASTER_FILE_NAME}'`,
                    spaces: 'drive'
                });
                
                if (response.result.files.length === 0) {
                    showMessage('âŒ Google Drive ä¸­æ²’æœ‰æ‰¾åˆ°è³‡æ–™æª”æ¡ˆ', 'error');
                    return;
                }
                
                const fileId = response.result.files[0].id;
                const fileResponse = await gapi.client.drive.files.get({
                    fileId: fileId,
                    alt: 'media'
                });
                
                const blob = new Blob([fileResponse.body], { type: 'application/json' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `å·¥æ™‚ç³»çµ±å®Œæ•´è³‡æ–™_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                showMessage('âœ… å®Œæ•´è³‡æ–™æª”å·²ä¸‹è¼‰ï¼');
                
            } catch (error) {
                showMessage(`âŒ ä¸‹è¼‰å¤±æ•—: ${error.message}`, 'error');
            }
        }
        
        // æ›´æ–°åŒæ­¥æ™‚é–“
        function updateSyncTime() {
            const syncTimeElement = document.getElementById('sync-time');
            if (syncTimeElement) {
                syncTimeElement.textContent = new Date().toLocaleString('zh-TW');
            }
        }
        
        // Tab åˆ‡æ›
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }
        
        // é¡¯ç¤ºè¨Šæ¯
        function showMessage(message, type = 'success') {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'error' ? 'error-message' : 
                                 type === 'warning' ? 'warning-message' : 'success-message';
            messageDiv.innerHTML = message;
            messagesDiv.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 8000);
        }
        
        // æ›´æ–°é€²åº¦
        function updateProgress(percentage, text) {
            document.getElementById('progress-fill').style.width = percentage + '%';
            document.getElementById('progress-text').textContent = text;
        }
        
        // é©—è­‰ Payroll ID æ ¼å¼
        function validatePayrollID(payrollId) {
            if (!payrollId) return false;
            const pattern = /^[A-Z]{2,3}-\d{3,4}$/;
            return pattern.test(payrollId.trim());
        }
        
        // è§£æé€±æ•¸
        function parseWeekNumber(weekString) {
            if (!weekString) return 1;
            const match = weekString.toString().match(/(\d+)/);
            return match ? parseInt(match[1]) : 1;
        }
        
        // è¨ˆç®—å“¡å·¥é€±æœŸè³‡è¨Š
        function calculateEmployeeCycle(employee, referenceDate = new Date()) {
            if (!employee.startDate) {
                return {
                    currentCycle: 1,
                    weekInCycle: 1,
                    cycleStartDate: new Date(),
                    cycleEndDate: new Date(),
                    daysInCycle: 0,
                    weeksFromStart: 0,
                    status: 'pending'
                };
            }
            
            const startDate = new Date(employee.startDate);
            const currentDate = new Date(referenceDate);
            
            // è¨ˆç®—ç¸½å¤©æ•¸å’Œé€±æ•¸
            const totalDays = Math.floor((currentDate - startDate) / (1000 * 60 * 60 * 24));
            const totalWeeks = Math.floor(totalDays / 7);
            
            // è¨ˆç®—ç•¶å‰é€±æœŸ
            const currentCycle = Math.floor(totalWeeks / 8) + 1;
            const weekInCycle = (totalWeeks % 8) + 1;
            
            // è¨ˆç®—ç•¶å‰é€±æœŸçš„é–‹å§‹å’ŒçµæŸæ—¥æœŸ
            const cycleNumber = currentCycle - 1;
            const cycleStartDate = new Date(startDate);
            cycleStartDate.setDate(cycleStartDate.getDate() + (cycleNumber * 8 * 7));
            
            const cycleEndDate = new Date(cycleStartDate);
            cycleEndDate.setDate(cycleEndDate.getDate() + (8 * 7) - 1);
            
            // è¨ˆç®—åœ¨ç•¶å‰é€±æœŸä¸­çš„å¤©æ•¸
            const daysInCycle = Math.max(0, Math.floor((currentDate - cycleStartDate) / (1000 * 60 * 60 * 24)) + 1);
            
            // åˆ¤æ–·é€±æœŸç‹€æ…‹
            let status = 'active';
            if (weekInCycle > 8) {
                status = 'complete';
            } else if (employee.totalHours > 304) {
                status = 'overtime';
            } else if (daysInCycle < 0) {
                status = 'pending';
            }
            
            return {
                currentCycle,
                weekInCycle: Math.min(weekInCycle, 8),
                cycleStartDate,
                cycleEndDate,
                daysInCycle: Math.min(daysInCycle, 56), // æœ€å¤š56å¤©(8é€±)
                weeksFromStart: totalWeeks,
                status,
                progressPercentage: Math.min((daysInCycle / 56) * 100, 100)
            };
        }
        function parseRate(rateString) {
            if (!rateString) return 0;
            return parseFloat(rateString.toString().replace(/[^0-9.]/g, '')) || 0;
        }
        
        // è™•ç†å·¥æ™‚è¡¨æ–‡ä»¶
        async function handleTimesheetFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!isGoogleDriveConnected) {
                showMessage('âŒ è«‹å…ˆé€£æ¥ Google Drive æ‰èƒ½ä¸Šå‚³è³‡æ–™', 'error');
                return;
            }
            
            try {
                updateProgress(20, 'æ­£åœ¨è®€å–å·¥æ™‚è¡¨...');
                
                const data = await readFile(file);
                const parsed = parseCSV(data);
                
                updateProgress(40, 'é©—è­‰è³‡æ–™æ ¼å¼...');
                
                const validationResult = validateTimesheetData(parsed);
                
                if (validationResult.errors.length > 0) {
                    showValidationResults(validationResult);
                    updateProgress(0, 'è³‡æ–™é©—è­‰å¤±æ•—');
                    return;
                }
                
                updateProgress(60, 'æª¢æŸ¥è³‡æ–™è¡çª...');
                
                const conflicts = checkForConflicts(parsed);
                
                if (conflicts.length > 0) {
                    showConflictDialog(parsed, conflicts);
                } else {
                    processTimesheetData(parsed);
                }
                
            } catch (error) {
                showMessage('è®€å–å·¥æ™‚è¡¨æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message, 'error');
                updateProgress(0, 'è¼‰å…¥å¤±æ•—');
            }
        }
        
        // é©—è­‰å·¥æ™‚è¡¨è³‡æ–™
        function validateTimesheetData(data) {
            const result = {
                success: [],
                warnings: [],
                errors: []
            };
            
            if (data.length === 0) {
                result.errors.push('æ–‡ä»¶ç‚ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¢º');
                return result;
            }
            
            const requiredFields = ['Payroll ID', 'First Name', 'Last Name', 'Work Week', 'Hours'];
            const headers = Object.keys(data[0]);
            
            for (const field of requiredFields) {
                if (!headers.includes(field)) {
                    result.errors.push(`ç¼ºå°‘å¿…è¦æ¬„ä½: ${field}`);
                }
            }
            
            if (result.errors.length > 0) {
                return result;
            }
            
            const employeeConsistency = {};
            
            data.forEach((row, index) => {
                const payrollId = row['Payroll ID']?.trim();
                const firstName = row['First Name']?.trim();
                const lastName = row['Last Name']?.trim();
                const workWeek = row['Work Week']?.trim();
                const hours = parseFloat(row['Hours']);
                
                if (!validatePayrollID(payrollId)) {
                    result.errors.push(`ç¬¬${index + 2}è¡Œ: Payroll ID æ ¼å¼éŒ¯èª¤ (${payrollId})ï¼Œæ‡‰ç‚º EQ-0001 æ ¼å¼`);
                }
                
                if (!payrollId) {
                    result.errors.push(`ç¬¬${index + 2}è¡Œ: Payroll ID ç‚ºç©º`);
                }
                
                if (!firstName || !lastName) {
                    result.errors.push(`ç¬¬${index + 2}è¡Œ: å§“åè³‡æ–™ä¸å®Œæ•´`);
                }
                
                if (!workWeek) {
                    result.errors.push(`ç¬¬${index + 2}è¡Œ: Work Week ç‚ºç©º`);
                }
                
                if (isNaN(hours) || hours < 0) {
                    result.errors.push(`ç¬¬${index + 2}è¡Œ: å·¥æ™‚è³‡æ–™ç„¡æ•ˆ (${row['Hours']})`);
                }
                
                if (hours > 168) {
                    result.warnings.push(`ç¬¬${index + 2}è¡Œ: å·¥æ™‚è¶…éä¸€é€±168å°æ™‚ (${hours})`);
                }
                
                if (payrollId && validatePayrollID(payrollId)) {
                    if (!employeeConsistency[payrollId]) {
                        employeeConsistency[payrollId] = {
                            firstName: firstName,
                            lastName: lastName,
                            startDate: row['Start Date'],
                            level: row['Level'],
                            rate: row['Rate']
                        };
                    } else {
                        const existing = employeeConsistency[payrollId];
                        if (existing.firstName !== firstName || existing.lastName !== lastName) {
                            result.errors.push(`ç¬¬${index + 2}è¡Œ: å“¡å·¥ ${payrollId} çš„å§“åèˆ‡å…ˆå‰è¨˜éŒ„ä¸ä¸€è‡´`);
                        }
                    }
                }
            });
            
            if (result.errors.length === 0) {
                result.success.push(`æˆåŠŸé©—è­‰ ${data.length} ç­†å·¥æ™‚è¨˜éŒ„`);
                result.success.push(`æ¶‰åŠ ${Object.keys(employeeConsistency).length} ä½å“¡å·¥`);
            }
            
            return result;
        }
        
        // æª¢æŸ¥è³‡æ–™è¡çª
        function checkForConflicts(newData) {
            const conflicts = [];
            
            newData.forEach(row => {
                const payrollId = row['Payroll ID']?.trim();
                const workWeek = row['Work Week']?.trim();
                const weekNum = parseWeekNumber(workWeek);
                
                const existing = timesheetData.find(existing => 
                    existing.payrollId === payrollId && existing.weekNumber === weekNum
                );
                
                if (existing) {
                    conflicts.push({
                        payrollId: payrollId,
                        weekNumber: weekNum,
                        existingHours: existing.hours,
                        newHours: parseFloat(row['Hours']),
                        employeeName: `${row['First Name']} ${row['Last Name']}`
                    });
                }
            });
            
            return conflicts;
        }
        
        // é¡¯ç¤ºè¡çªå°è©±æ¡†
        function showConflictDialog(newData, conflicts) {
            const dialog = document.createElement('div');
            dialog.className = 'confirm-dialog';
            
            let conflictsList = '';
            conflicts.forEach(conflict => {
                conflictsList += `
                    <div class="validation-warning">
                        <strong>${conflict.employeeName} (${conflict.payrollId})</strong> - ç¬¬${conflict.weekNumber}é€±
                        <br>ç¾æœ‰å·¥æ™‚: ${conflict.existingHours} â†’ æ–°å·¥æ™‚: ${conflict.newHours}
                    </div>
                `;
            });
            
            dialog.innerHTML = `
                <div class="confirm-content">
                    <h3>âš ï¸ ç™¼ç¾è³‡æ–™è¡çª</h3>
                    <p>ä»¥ä¸‹å“¡å·¥çš„å·¥æ™‚è³‡æ–™å·²å­˜åœ¨æ–¼ä¸­å¤®è³‡æ–™åº«ï¼Œæ˜¯å¦è¦è¦†è“‹ï¼Ÿ</p>
                    ${conflictsList}
                    <div class="confirm-buttons">
                        <button class="btn-confirm" onclick="confirmOverwrite(true)">è¦†è“‹ä¸¦æ›´æ–°ä¸­å¤®è³‡æ–™åº«</button>
                        <button class="btn-cancel" onclick="confirmOverwrite(false)">å–æ¶ˆä¸Šå‚³</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(dialog);
            pendingData = newData;
        }
        
        // ç¢ºèªè¦†è“‹
        function confirmOverwrite(confirmed) {
            const dialog = document.querySelector('.confirm-dialog');
            if (dialog) {
                dialog.remove();
            }
            
            if (confirmed && pendingData) {
                processTimesheetData(pendingData, true);
            } else {
                updateProgress(0, 'ä¸Šå‚³å·²å–æ¶ˆ');
            }
            
            pendingData = null;
        }
        
        // è™•ç†å·¥æ™‚è¡¨è³‡æ–™
        async function processTimesheetData(data, overwrite = false) {
            updateProgress(80, 'æ•´åˆè³‡æ–™åˆ°ä¸­å¤®è³‡æ–™åº«...');
            
            const uploadSummary = {
                totalRecords: data.length,
                employees: new Set(),
                weeks: new Set(),
                newRecords: 0,
                updatedRecords: 0
            };
            
            // è™•ç†æ¯ç­†è¨˜éŒ„
            data.forEach(row => {
                const payrollId = row['Payroll ID']?.trim();
                const firstName = row['First Name']?.trim();
                const lastName = row['Last Name']?.trim();
                const startDate = row['Start Date']?.trim();
                const workWeek = row['Work Week']?.trim();
                const hours = parseFloat(row['Hours']);
                const level = row['Level']?.trim();
                const rate = parseRate(row['Rate']);
                const weekNumber = parseWeekNumber(workWeek);
                
                uploadSummary.employees.add(payrollId);
                uploadSummary.weeks.add(`ç¬¬${weekNumber}é€±`);
                
                // æ›´æ–°å“¡å·¥åŸºæœ¬è³‡æ–™
                if (!employees[payrollId]) {
                    employees[payrollId] = {
                        payrollId: payrollId,
                        firstName: firstName,
                        lastName: lastName,
                        startDate: startDate || '2024-01-01',
                        level: level || '',
                        hourlyRate: rate || 25.0,
                        overtimeRate: (rate || 25.0) * 1.5,
                        weeklyHours: Array(8).fill(0),
                        totalHours: 0,
                        payrollData: {
                            regularHours: 0,
                            overtimeHours: 0,
                            regularPay: 0,
                            overtimePay: 0,
                            totalPay: 0
                        }
                    };
                }
                
                // æ›´æ–°å·¥æ™‚è³‡æ–™
                const existingIndex = timesheetData.findIndex(item => 
                    item.payrollId === payrollId && item.weekNumber === weekNumber
                );
                
                if (existingIndex >= 0) {
                    if (overwrite) {
                        timesheetData[existingIndex].hours = hours;
                        uploadSummary.updatedRecords++;
                    }
                } else {
                    timesheetData.push({
                        payrollId: payrollId,
                        firstName: firstName,
                        lastName: lastName,
                        workWeek: workWeek,
                        weekNumber: weekNumber,
                        hours: hours,
                        uploadDate: new Date().toISOString()
                    });
                    uploadSummary.newRecords++;
                }
                
                // æ›´æ–°å“¡å·¥é€±æ™‚æ•¸
                if (weekNumber >= 1 && weekNumber <= 8) {
                    employees[payrollId].weeklyHours[weekNumber - 1] = hours;
                }
            });
            
            // é‡æ–°è¨ˆç®—è–ªè³‡
            Object.values(employees).forEach(employee => {
                employee.totalHours = employee.weeklyHours.reduce((sum, hours) => sum + hours, 0);
                calculatePayroll(employee);
            });
            
            try {
                updateProgress(95, 'ä¸Šå‚³åˆ° Google Drive...');
                
                // ä¸Šå‚³åˆ° Google Drive ä¸­å¤®è³‡æ–™åº«
                await uploadToDrive();
                
                updateProgress(100, 'ä¸­å¤®è³‡æ–™åº«æ›´æ–°å®Œæˆ');
                
                // é¡¯ç¤ºä¸Šå‚³æ‘˜è¦
                showUploadSummary(uploadSummary);
                
                // æ›´æ–°æ‰€æœ‰è¡¨æ ¼
                updateAllTables();
                
                // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                showMessage(`
                    âœ… ä¸Šå‚³æˆåŠŸï¼ä¸­å¤®è³‡æ–™åº«å·²æ›´æ–°<br>
                    ğŸ“Š è™•ç† ${uploadSummary.totalRecords} ç­†è¨˜éŒ„<br>
                    ğŸ‘¥ æ¶‰åŠ ${uploadSummary.employees.size} ä½å“¡å·¥<br>
                    ğŸ“… æ¶µè“‹ ${Array.from(uploadSummary.weeks).join(', ')}<br>
                    â• æ–°å¢ ${uploadSummary.newRecords} ç­†ï¼Œæ›´æ–° ${uploadSummary.updatedRecords} ç­†<br>
                    â˜ï¸ Google Drive ä¸»æª”æ¡ˆå·²åŒæ­¥æ›´æ–°
                `);
                
            } catch (error) {
                updateProgress(80, 'ä¸Šå‚³å¤±æ•—');
                showMessage(`âŒ ä¸Šå‚³åˆ° Google Drive å¤±æ•—: ${error.message}`, 'error');
            }
        }
        
        // è¨ˆç®—è–ªè³‡
        function calculatePayroll(employee) {
            const totalHours = employee.totalHours;
            const hourlyRate = employee.hourlyRate;
            const overtimeRate = employee.overtimeRate;
            
            if (totalHours > 304) {
                employee.payrollData.regularHours = 304;
                employee.payrollData.overtimeHours = totalHours - 304;
            } else {
                employee.payrollData.regularHours = totalHours;
                employee.payrollData.overtimeHours = 0;
            }
            
            employee.payrollData.regularPay = employee.payrollData.regularHours * hourlyRate;
            employee.payrollData.overtimePay = employee.payrollData.overtimeHours * overtimeRate;
            employee.payrollData.totalPay = employee.payrollData.regularPay + employee.payrollData.overtimePay;
        }
        
        // é¡¯ç¤ºä¸Šå‚³æ‘˜è¦
        function showUploadSummary(summary) {
            const container = document.getElementById('timesheet-file-info');
            container.style.display = 'block';
            container.className = 'upload-summary';
            
            container.innerHTML = `
                <h3>ğŸ“Š ä¸Šå‚³æ‘˜è¦</h3>
                <div class="summary-item">
                    <span>ç¸½è¨˜éŒ„æ•¸ï¼š</span>
                    <span class="highlight">${summary.totalRecords}</span>
                </div>
                <div class="summary-item">
                    <span>å“¡å·¥æ•¸é‡ï¼š</span>
                    <span class="highlight">${summary.employees.size}</span>
                </div>
                <div class="summary-item">
                    <span>æ¶µè“‹é€±æ•¸ï¼š</span>
                    <span>${Array.from(summary.weeks).join(', ')}</span>
                </div>
                <div class="summary-item">
                    <span>æ–°å¢è¨˜éŒ„ï¼š</span>
                    <span class="highlight">${summary.newRecords}</span>
                </div>
                <div class="summary-item">
                    <span>æ›´æ–°è¨˜éŒ„ï¼š</span>
                    <span class="highlight">${summary.updatedRecords}</span>
                </div>
                <div class="summary-item">
                    <span>ä¸Šå‚³æ™‚é–“ï¼š</span>
                    <span>${new Date().toLocaleString('zh-TW')}</span>
                </div>
                <div class="summary-item">
                    <span>ä¸­å¤®è³‡æ–™åº«ï¼š</span>
                    <span class="highlight">å·²æ›´æ–°åˆ° Google Drive</span>
                </div>
            `;
        }
        
        // é¡¯ç¤ºé©—è­‰çµæœ
        function showValidationResults(result) {
            const container = document.getElementById('validation-results');
            
            let html = '';
            
            result.success.forEach(msg => {
                html += `<div class="validation-item validation-success">âœ… ${msg}</div>`;
            });
            
            result.warnings.forEach(msg => {
                html += `<div class="validation-item validation-warning">âš ï¸ ${msg}</div>`;
            });
            
            result.errors.forEach(msg => {
                html += `<div class="validation-item validation-error">âŒ ${msg}</div>`;
            });
            
            container.innerHTML = html;
        }
        
        // è®€å–æ–‡ä»¶
        async function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) { resolve(e.target.result); };
                reader.onerror = function() { reject(new Error('æ–‡ä»¶è®€å–å¤±æ•—')); };
                reader.readAsText(file, 'UTF-8');
            });
        }
        
        // è§£æCSV
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            
            return lines.slice(1).map(line => {
                const values = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                values.push(current.trim());
                
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });
                return row;
            });
        }
        
        // æ›´æ–°æ‰€æœ‰è¡¨æ ¼
        function updateAllTables() {
            updateEmployeesTable();
            updateCycleAnalysis();
            updatePayrollTable();
        }
        
        // æ›´æ–°å“¡å·¥è¡¨æ ¼
        function updateEmployeesTable() {
            const container = document.getElementById('employees-table-container');
            
            if (Object.keys(employees).length === 0) {
                container.innerHTML = '<p>å°šæœªè¼‰å…¥å“¡å·¥è³‡æ–™ï¼Œè«‹å…ˆé€£æ¥ Google Drive ä¸¦ä¸Šå‚³å·¥æ™‚è¡¨</p>';
                return;
            }
            
            let tableHTML = `
                <table class="employee-table">
                    <thead>
                        <tr>
                            <th>å“¡å·¥ç·¨è™Ÿ</th>
                            <th>å§“å</th>
                            <th>è·ç´š</th>
                            <th>é–‹å§‹æ—¥æœŸ</th>
                            <th>ç•¶å‰é€±æœŸ</th>
                            <th>æ™‚è–ª</th>
                            <th>é€±1</th>
                            <th>é€±2</th>
                            <th>é€±3</th>
                            <th>é€±4</th>
                            <th>é€±5</th>
                            <th>é€±6</th>
                            <th>é€±7</th>
                            <th>é€±8</th>
                            <th>ç¸½æ™‚æ•¸</th>
                            <th>ç‹€æ…‹</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            Object.values(employees).forEach(employee => {
                const fullName = `${employee.firstName} ${employee.lastName}`.trim();
                const isOvertime = employee.totalHours > 304;
                const statusClass = isOvertime ? 'status-overtime' : 'status-normal';
                const statusText = isOvertime ? 'éœ€åŠ ç­è²»' : 'æ­£å¸¸';
                const cycleInfo = calculateEmployeeCycle(employee);
                
                tableHTML += `
                    <tr>
                        <td><strong>${employee.payrollId}</strong></td>
                        <td>${fullName}</td>
                        <td>${employee.level}</td>
                        <td>${employee.startDate}</td>
                        <td>ç¬¬${cycleInfo.currentCycle}é€±æœŸ<br><small>ç¬¬${cycleInfo.weekInCycle}/8é€±</small></td>
                        <td>${employee.hourlyRate.toFixed(2)}</td>
                        ${employee.weeklyHours.map(hours => `<td>${hours || '-'}</td>`).join('')}
                        <td><strong>${employee.totalHours}</strong></td>
                        <td class="${statusClass}">${statusText}</td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
            
            // æ›´æ–°å“¡å·¥æ‘˜è¦
            const totalEmployees = Object.keys(employees).length;
            const overtimeEmployees = Object.values(employees).filter(emp => emp.totalHours > 304).length;
            const normalEmployees = totalEmployees - overtimeEmployees;
            const totalHours = Object.values(employees).reduce((sum, emp) => sum + emp.totalHours, 0);
            const avgHours = totalEmployees > 0 ? (totalHours / totalEmployees).toFixed(1) : 0;
            
            const summaryHTML = `
                <div class="summary-card">
                    <h3>${totalEmployees}</h3>
                    <p>ç¸½å“¡å·¥æ•¸</p>
                </div>
                <div class="summary-card">
                    <h3>${overtimeEmployees}</h3>
                    <p>éœ€è¦åŠ ç­è²»</p>
                </div>
                <div class="summary-card">
                    <h3>${normalEmployees}</h3>
                    <p>æ­£å¸¸å·¥æ™‚</p>
                </div>
                <div class="summary-card">
                    <h3>${avgHours}</h3>
                    <p>å¹³å‡å·¥æ™‚</p>
                </div>
            `;
            document.getElementById('employee-summary-cards').innerHTML = summaryHTML;
        }
        
        // æ›´æ–°è–ªè³‡è¡¨æ ¼
        function updatePayrollTable() {
            const container = document.getElementById('payroll-table-container');
            
            if (Object.keys(employees).length === 0) {
                container.innerHTML = '<p>å°šæœªè¼‰å…¥å“¡å·¥è³‡æ–™ï¼Œè«‹å…ˆé€£æ¥ Google Drive ä¸¦ä¸Šå‚³å·¥æ™‚è¡¨</p>';
                return;
            }
            
            let tableHTML = `
                <table class="employee-table">
                    <thead>
                        <tr>
                            <th>å“¡å·¥ç·¨è™Ÿ</th>
                            <th>å§“å</th>
                            <th>è·ç´š</th>
                            <th>æ­£å¸¸å·¥æ™‚</th>
                            <th>åŠ ç­å·¥æ™‚</th>
                            <th>æ­£å¸¸è–ªè³‡</th>
                            <th>åŠ ç­è²»</th>
                            <th>ç¸½è–ªè³‡</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            let totalRegularPay = 0;
            let totalOvertimePay = 0;
            let totalPay = 0;
            
            Object.values(employees)
                .sort((a, b) => b.payrollData.totalPay - a.payrollData.totalPay)
                .forEach(employee => {
                    const fullName = `${employee.firstName} ${employee.lastName}`.trim();
                    
                    totalRegularPay += employee.payrollData.regularPay;
                    totalOvertimePay += employee.payrollData.overtimePay;
                    totalPay += employee.payrollData.totalPay;
                    
                    tableHTML += `
                        <tr>
                            <td><strong>${employee.payrollId}</strong></td>
                            <td>${fullName}</td>
                            <td>${employee.level}</td>
                            <td>${employee.payrollData.regularHours}</td>
                            <td>${employee.payrollData.overtimeHours}</td>
                            <td class="money">$${employee.payrollData.regularPay.toFixed(2)}</td>
                            <td class="money">$${employee.payrollData.overtimePay.toFixed(2)}</td>
                            <td class="money"><strong>$${employee.payrollData.totalPay.toFixed(2)}</strong></td>
                        </tr>
                    `;
                });
            
            tableHTML += `
                <tr style="background: #f0f0f0; font-weight: bold;">
                    <td colspan="5">ç¸½è¨ˆ</td>
                    <td class="money">$${totalRegularPay.toFixed(2)}</td>
                    <td class="money">$${totalOvertimePay.toFixed(2)}</td>
                    <td class="money">$${totalPay.toFixed(2)}</td>
                </tr>
            `;
            
            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
            
            // æ›´æ–°è–ªè³‡æ‘˜è¦
            const totalEmployees = Object.keys(employees).length;
            const overtimeEmployees = Object.values(employees).filter(emp => emp.totalHours > 304).length;
            
            const summaryHTML = `
                <div class="summary-card">
                    <h3>$${totalPay.toFixed(0)}</h3>
                    <p>ç¸½è–ªè³‡æ”¯å‡º</p>
                </div>
                <div class="summary-card">
                    <h3>${totalOvertimePay.toFixed(0)}</h3>
                    <p>åŠ ç­è²»æ”¯å‡º</p>
                </div>
                <div class="summary-card">
                    <h3>${overtimeEmployees}</h3>
                    <p>åŠ ç­å“¡å·¥æ•¸</p>
                </div>
                <div class="summary-card">
                    <h3>${totalEmployees > 0 ? (totalPay / totalEmployees).toFixed(0) : 0}</h3>
                    <p>å¹³å‡è–ªè³‡</p>
                </div>
            `;
            document.getElementById('payroll-summary-cards').innerHTML = summaryHTML;
        }
        
        // åŒ¯å‡ºè–ªè³‡å ±è¡¨
        function exportPayroll() {
            if (Object.keys(employees).length === 0) {
                showMessage('æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡º', 'error');
                return;
            }
            
            let csvContent = 'Payroll ID,å§“å,è·ç´š,æ­£å¸¸å·¥æ™‚,åŠ ç­å·¥æ™‚,æ™‚è–ª,åŠ ç­è²»ç‡,æ­£å¸¸è–ªè³‡,åŠ ç­è²»,ç¸½è–ªè³‡\n';
            
            Object.values(employees).forEach(employee => {
                const fullName = `${employee.firstName} ${employee.lastName}`.trim();
                
                csvContent += `${employee.payrollId},"${fullName}",${employee.level},${employee.payrollData.regularHours},${employee.payrollData.overtimeHours},${employee.hourlyRate},${employee.overtimeRate},${employee.payrollData.regularPay.toFixed(2)},${employee.payrollData.overtimePay.toFixed(2)},${employee.payrollData.totalPay.toFixed(2)}\n`;
            });
            
            downloadCSV(csvContent, `è–ªè³‡å ±è¡¨_${new Date().toISOString().split('T')[0]}.csv`);
            showMessage('âœ… è–ªè³‡å ±è¡¨å·²åŒ¯å‡º');
        }
        
        // ä¸‹è¼‰CSVæ–‡ä»¶
        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }
        
        // æ‹–æ‹½åŠŸèƒ½
        const uploadSection = document.getElementById('timesheet-upload');
        
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });
        
        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });
        
        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('timesheet-file').files = files;
                handleTimesheetFile({ target: { files } });
            }
        });
    </script>
</body>
</html>
