<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工時管理系統</title>
    <style>
        /* General Styles */
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.08);
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 32px;
            font-weight: 600;
        }

        /* Message Styles */
        .success-message {
            background: #e6ffe6;
            color: #006600;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 5px solid #006600;
            opacity: 1;
            transition: opacity 0.5s ease;
        }

        .error-message {
            background: #ffe6e6;
            color: #cc0000;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 5px solid #cc0000;
            opacity: 1;
            transition: opacity 0.5s ease;
        }

        .warning-message {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 5px solid #ffc107;
            opacity: 1;
            transition: opacity 0.5s ease;
        }
        
        .message-fadeout {
            opacity: 0;
        }

        /* Upload Section */
        .upload-section {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
            background: #f8f9ff;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }

        .upload-section.dragover {
            border-color: #28a745;
            background: #e8f5e8;
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.2);
        }

        .upload-section.dragover h3 {
            color: #28a745;
        }

        .upload-section.dragover p {
            color: #155724;
            font-weight: bold;
        }

        .file-input {
            display: none;
        }

        .upload-btn, .action-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: transform 0.2s, background 0.3s, box-shadow 0.2s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .upload-btn:hover, .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .upload-btn:active, .action-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .upload-btn:disabled, .action-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .file-info {
            margin-top: 15px;
            padding: 10px;
            background: #e8f5e8;
            border-radius: 5px;
        }

        /* Data Management */
        .data-section {
            background: #f6f8fa;
            border: 2px solid #28a745;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }

        .data-section h3 {
            color: #28a745;
            margin: 0 0 15px 0;
            font-size: 22px;
        }

        .data-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .btn-export {
            background: linear-gradient(45deg, #28a745, #20c997);
        }

        .btn-import {
            background: linear-gradient(45deg, #007bff, #6610f2);
        }

        .btn-clear {
            background: linear-gradient(45deg, #dc3545, #fd7e14);
        }

        /* Tabs */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }

        .tab {
            padding: 15px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            min-width: 120px;
            text-align: center;
            font-weight: 500;
            color: #555;
        }

        .tab.active {
            border-bottom-color: #667eea;
            color: #667eea;
            font-weight: bold;
            background: #f0f2ff;
        }

        .tab:hover:not(.active) {
            background: #f8faff;
            color: #667eea;
        }

        .tab-content {
            display: none;
            padding-top: 10px;
        }

        .tab-content.active {
            display: block;
        }

        /* Tables */
        .employee-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
            text-align: center;
        }

        .employee-table th,
        .employee-table td {
            border: 1px solid #ddd;
            padding: 10px 8px;
            text-align: center;
            vertical-align: middle;
        }

        .employee-table th {
            background: #667eea;
            color: white;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .employee-table tr:nth-child(even) {
            background: #f9f9f9;
        }

        .employee-table tr.main-row:hover {
            background: #f0f2ff;
        }

        .money {
            color: #28a745;
            font-weight: bold;
        }

        .format-info {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            font-size: 14px;
        }

        .format-info h4 {
            margin: 0 0 10px 0;
            color: #0066cc;
            font-size: 18px;
        }

        .format-example {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            margin: 5px 0;
            white-space: pre-wrap;
            word-break: break-all;
            line-height: 1.5;
        }

        .format-info ul {
            padding-left: 20px;
            margin-top: 10px;
        }

        .format-info li {
            margin-bottom: 5px;
        }

        /* Validation Results */
        .validation-results {
            margin: 20px 0;
        }

        .validation-item {
            padding: 12px;
            margin: 8px 0;
            border-radius: 5px;
            border-left: 5px solid;
            font-size: 15px;
        }

        .validation-success {
            background: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }

        .validation-warning {
            background: #fff3cd;
            border-left-color: #ffc107;
            color: #856404;
        }

        .validation-error {
            background: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease-out;
        }
        
        #progress-text {
            text-align: center;
            font-weight: 500;
            color: #555;
            margin-top: 5px;
        }

        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .summary-card h3 {
            margin: 0 0 10px 0;
            font-size: 24px;
            font-weight: 700;
        }

        .summary-card p {
            margin: 0;
            font-size: 14px;
            opacity: 0.9;
        }

        /* Debug Info */
        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }

        /* Loading spinner */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #fff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 5px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>📊 工時管理系統</h1>
        <div style="text-align: center; margin-bottom: 20px;">
            <small>🔄 本地儲存 | 📊 即時計算 | 💾 檔案管理</small>
        </div>
        
        <div class="data-section">
            <h3>💾 資料管理</h3>
            <p>所有資料儲存在瀏覽器本地，關閉瀏覽器後資料仍會保留。</p>
            <div class="data-buttons">
                <button class="action-btn btn-export" onclick="exportAllData()">
                    📤 匯出完整資料
                </button>
                <button class="action-btn btn-import" onclick="document.getElementById('data-import').click()">
                    📥 匯入資料檔
                </button>
                <button class="action-btn btn-clear" onclick="clearAllData()">
                    🗑️ 清除所有資料
                </button>
            </div>
            <input type="file" id="data-import" class="file-input" accept=".json" onchange="importData(event)">
            <div id="data-status" style="margin-top: 15px; padding: 10px; background: #e8f5e8; border-radius: 5px; font-size: 14px; display: none;">
                <strong>資料狀態：</strong><span id="data-status-text">載入中...</span>
            </div>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('upload')">📁 資料上傳</div>
            <div class="tab" onclick="switchTab('overview')">👥 員工總覽</div>
            <div class="tab" onclick="switchTab('debug')">🔧 除錯資訊</div>
        </div>
        
        <div id="upload-tab" class="tab-content active">
            <div class="format-info">
                <h4>📊 工時表格式說明</h4>
                <div class="format-example">Payroll ID, First Name, Last Name, Monday of the Work Week, Hours, Level, Rate, Farm
EQ-0001, John, Doe, 2025-02-10, 45, Senior, 25.50, Farm A
EQ-0001, John, Doe, 2025-02-17, 38, Senior, 25.50, Farm A
EQ-0002, Jane, Smith, 2025-02-10, 42, Junior, 20.00, Farm B</div>
                <p><strong>重要格式說明：</strong></p>
                <ul>
                    <li>📅 <strong>Monday of the Work Week</strong>：工作週的週一日期，格式為YYYY-MM-DD 或 DD/MM/YYYY</li>
                    <li>🔢 <strong>週期計算</strong>：系統會自動根據統一起始日期（2025/2/10）計算週期</li>
                    <li>🏭 <strong>Farm/Level/Rate 更新</strong>：如果員工轉換農場或調整薪資，新資料會覆蓋舊資料</li>
                    <li>👤 <strong>員工資訊</strong>：系統會自動建立員工檔案，無需額外的開始日期</li>
                </ul>
            </div>
            
            <div class="upload-section" id="timesheet-upload" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                <h3>📋 上傳工時表 (CSV)</h3>
                <p>🖱️ 點擊選擇檔案 或 📁 直接拖拽 CSV 檔案到此區域</p>
                <button id="upload-file-btn" class="upload-btn" onclick="document.getElementById('timesheet-file').click()">
                    <span class="spinner" style="display: none;"></span>
                    選擇工時表文件
                </button>
                <input type="file" id="timesheet-file" class="file-input" accept=".csv" onchange="handleTimesheetFile(event)">
                <div id="timesheet-file-info" class="file-info" style="display: none;"></div>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <p id="progress-text">等待上傳文件...</p>
            
            <div id="validation-results" class="validation-results"></div>
        </div>
        
        <div id="overview-tab" class="tab-content"> 
            <h2>👥 員工總覽與薪資</h2>
            <div id="overview-table-container"></div>
        </div>
        
        <div id="debug-tab" class="tab-content">
            <h2>🔧 除錯資訊</h2>
            <div id="debug-info" class="debug-info">
                系統除錯資訊將顯示在這裡...
            </div>
            <button class="action-btn" onclick="clearDebugLog()">清除除錯記錄</button>
        </div>
        
        <div id="messages"></div>
    </div>

    <script>
        // Global variables
        let employees = {};
        let timesheetData = [];
        let debugLog = [];
        
        // Constants
        const REGULAR_HOURS_THRESHOLD = 304;
        const WEEKS_PER_CYCLE = 8;
        const WEEKLY_HOURS_THRESHOLD = 38;
        const SYSTEM_START_DATE = new Date(2025, 1, 10); // Feb 10, 2025

        // Debug functions
        function addDebugLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            debugLog.push({
                timestamp,
                message,
                type
            });
            updateDebugDisplay();
            console.log(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
        }

        function updateDebugDisplay() {
            const debugDiv = document.getElementById('debug-info');
            const logHtml = debugLog.slice(-50).map(log => 
                `<div style="color: ${log.type === 'error' ? 'red' : log.type === 'warning' ? 'orange' : 'black'}">
                    [${log.timestamp}] ${log.type.toUpperCase()}: ${log.message}
                </div>`
            ).join('');
            debugDiv.innerHTML = logHtml;
            debugDiv.scrollTop = debugDiv.scrollHeight;
        }

        function clearDebugLog() {
            debugLog = [];
            updateDebugDisplay();
        }

        // Initialization
        document.addEventListener('DOMContentLoaded', function() {
            addDebugLog('系統初始化開始');
            try {
                loadLocalData();
                updateProgress(0, '系統已就緒，請上傳工時表');
                addDebugLog('系統初始化成功');
            } catch (error) {
                addDebugLog('系統初始化失敗: ' + error.message, 'error');
            }
        });

        // File reading with better error handling
        function readFile(file) {
            return new Promise((resolve, reject) => {
                addDebugLog(`開始讀取檔案: ${file.name} (大小: ${file.size} bytes)`);
                
                if (file.size === 0) {
                    reject(new Error('檔案是空的'));
                    return;
                }
                
                if (file.size > 10 * 1024 * 1024) { // 10MB limit
                    reject(new Error('檔案太大，請選擇小於10MB的檔案'));
                    return;
                }
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    addDebugLog('檔案讀取成功');
                    resolve(e.target.result);
                };
                
                reader.onerror = function() {
                    addDebugLog('檔案讀取失敗', 'error');
                    reject(new Error('無法讀取檔案'));
                };
                
                reader.onabort = function() {
                    addDebugLog('檔案讀取被中斷', 'warning');
                    reject(new Error('檔案讀取被中斷'));
                };
                
                reader.readAsText(file, 'UTF-8');
            });
        }

        // Improved CSV parsing
        function parseCSV(csvText) {
            addDebugLog('開始解析CSV資料');
            
            if (!csvText || csvText.trim().length === 0) {
                throw new Error('CSV檔案內容為空');
            }
            
            try {
                const lines = csvText.trim().split('\n');
                addDebugLog(`CSV共有 ${lines.length} 行`);
                
                if (lines.length < 2) {
                    throw new Error('CSV檔案至少需要標題行和一行資料');
                }
                
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                addDebugLog(`CSV標題: ${headers.join(', ')}`);
                
                const data = [];
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line.length === 0) continue;
                    
                    const values = line.split(',').map(v => v.trim().replace(/"/g, ''));
                    if (values.length !== headers.length) {
                        addDebugLog(`第${i+1}行欄位數量不符: 期望${headers.length}個，實際${values.length}個`, 'warning');
                        continue;
                    }
                    
                    const rowData = {};
                    headers.forEach((header, index) => {
                        rowData[header] = values[index];
                    });
                    data.push(rowData);
                }
                
                addDebugLog(`成功解析 ${data.length} 筆資料`);
                return data;
                
            } catch (error) {
                addDebugLog('CSV解析失敗: ' + error.message, 'error');
                throw error;
            }
        }

        // Local Data Management
        function loadLocalData() {
            try {
                const storedEmployees = JSON.parse(localStorage.getItem('timesheet_employees') || '{}');
                const storedTimesheetData = JSON.parse(localStorage.getItem('timesheet_data') || '[]');
                
                employees = storedEmployees;
                timesheetData = storedTimesheetData;
                
                updateAllTables();
                updateDataStatus();
                addDebugLog(`載入本地資料: ${Object.keys(employees).length} 位員工, ${timesheetData.length} 筆記錄`);
            } catch (error) {
                addDebugLog('載入本地資料失敗: ' + error.message, 'error');
                showMessage('載入本地資料時發生錯誤', 'warning');
            }
        }

        function saveLocalData() {
            try {
                localStorage.setItem('timesheet_employees', JSON.stringify(employees));
                localStorage.setItem('timesheet_data', JSON.stringify(timesheetData));
                localStorage.setItem('last_update', new Date().toLocaleString('zh-TW'));
                updateDataStatus();
                addDebugLog('資料已儲存到本地');
            } catch (error) {
                addDebugLog('儲存資料失敗: ' + error.message, 'error');
                showMessage('儲存資料時發生錯誤', 'error');
            }
        }

        function updateDataStatus() {
            const statusDiv = document.getElementById('data-status');
            const statusText = document.getElementById('data-status-text');
            
            const empCount = Object.keys(employees).length;
            const recordCount = timesheetData.length;
            const lastUpdate = localStorage.getItem('last_update') || '未知';
            
            if (empCount > 0 || recordCount > 0) {
                statusDiv.style.display = 'block';
                statusText.textContent = `${empCount} 位員工，${recordCount} 筆工時記錄，最後更新：${lastUpdate}`;
            } else {
                statusDiv.style.display = 'none';
            }
        }

        function exportAllData() {
            if (Object.keys(employees).length === 0 && timesheetData.length === 0) {
                showMessage('沒有資料可以匯出', 'warning');
                return;
            }

            const data = {
                employees: employees,
                timesheetData: timesheetData,
                exportDate: new Date().toISOString(),
                version: '2.2',
                systemName: '本地版工時管理系統'
            };

            downloadData(JSON.stringify(data, null, 2), `工時系統完整資料_${new Date().toLocaleDateString('zh-TW').replace(/\//g, '-')}.json`);
            showMessage('✅ 完整資料已匯出！');
        }

        function downloadData(content, filename) {
            const blob = new Blob([content], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.employees && data.timesheetData) {
                        if (confirm('確定要匯入資料嗎？這會覆蓋現有的所有資料！')) {
                            employees = data.employees;
                            timesheetData = data.timesheetData;
                            saveLocalData();
                            updateAllTables();
                            showMessage('✅ 資料匯入成功！');
                        }
                    } else {
                        showMessage('檔案格式不正確，請選擇正確的資料檔', 'error');
                    }
                } catch (error) {
                    showMessage('讀取檔案失敗：' + error.message, 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function clearAllData() {
            if (confirm('⚠️ 確定要清除所有資料嗎？這將會刪除所有員工資料和工時記錄，並且無法復原！')) {
                employees = {};
                timesheetData = [];
                localStorage.removeItem('timesheet_employees');
                localStorage.removeItem('timesheet_data');
                localStorage.removeItem('last_update');
                updateAllTables();
                updateDataStatus();
                addDebugLog('所有資料已清除');
                showMessage('🗑️ 所有資料已清除！', 'warning');
            }
        }

        // UI Functions
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        function showMessage(message, type = 'success', duration = 5000) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'error' ? 'error-message' : 
                                 type === 'warning' ? 'warning-message' : 'success-message';
            messageDiv.innerHTML = message;
            messagesDiv.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.classList.add('message-fadeout');
                messageDiv.addEventListener('transitionend', () => messageDiv.remove());
            }, duration);
        }

        function updateProgress(percentage, text) {
            document.getElementById('progress-fill').style.width = percentage + '%';
            document.getElementById('progress-text').textContent = text;
        }

        function setButtonLoading(buttonId, loading, text) {
            const button = document.getElementById(buttonId);
            const spinner = button.querySelector('.spinner');
            
            if (loading) {
                button.disabled = true;
                spinner.style.display = 'inline-block';
                button.innerHTML = `<span class="spinner"></span>${text}`;
            } else {
                button.disabled = false;
                spinner.style.display = 'none';
                button.innerHTML = text;
            }
        }

        // Utility Functions
        function validatePayrollID(payrollId) {
            if (!payrollId) return false;
            const pattern = /^[A-Za-z]{2,3}-\d{3,4}$/;
            return pattern.test(payrollId.trim());
        }

        function parseDate(dateString) {
            if (!dateString) return null;
            
            try {
                // Try YYYY-MM-DD format first
                let date = new Date(dateString);
                if (!isNaN(date.getTime()) && dateString.includes('-')) {
                    return new Date(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate());
                }

                // Try DD/MM/YYYY format
                const partsSlash = dateString.split('/');
                if (partsSlash.length === 3 && partsSlash[0].length <= 2) {
                    date = new Date(parseInt(partsSlash[2]), parseInt(partsSlash[1]) - 1, parseInt(partsSlash[0]));
                    if (!isNaN(date.getTime())) return date;
                }
                
                return null;
            } catch (error) {
                addDebugLog(`日期解析失敗: ${dateString}`, 'warning');
                return null;
            }
        }

        function parseRate(rateString) {
            if (!rateString) return 0;
            const cleanedString = rateString.toString().replace(/[^0-9.]/g, '');
            return parseFloat(cleanedString) || 0;
        }

        function toLocalDateString(date) {
            if (!date || isNaN(date.getTime())) return '';
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // File Handling
        function handleDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            document.getElementById('timesheet-upload').classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.preventDefault();
            event.stopPropagation();
            document.getElementById('timesheet-upload').classList.remove('dragover');
        }

        function handleDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            document.getElementById('timesheet-upload').classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            if (files.length > 0 && files[0].name.toLowerCase().endsWith('.csv')) {
                const fileInput = document.getElementById('timesheet-file');
                fileInput.files = files;
                const changeEvent = new Event('change', { bubbles: true });
                fileInput.dispatchEvent(changeEvent);
                showMessage(`📁 已接收檔案: ${files[0].name}`, 'success', 3000);
            } else {
                showMessage('❌ 請選擇 CSV 檔案', 'error');
            }
        }

        async function handleTimesheetFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            addDebugLog(`開始處理檔案: ${file.name}`);
            document.getElementById('validation-results').innerHTML = '';
            setButtonLoading('upload-file-btn', true, '處理中...');

            try {
                updateProgress(20, '正在讀取工時表...');
                const data = await readFile(file);
                
                updateProgress(40, '解析CSV資料...');
                const parsed = parseCSV(data);
                
                updateProgress(60, '驗證資料格式...');
                const validationResult = validateTimesheetData(parsed);
                showValidationResults(validationResult);
                
                if (validationResult.errors.length > 0) {
                    updateProgress(0, '資料驗證失敗');
                    showMessage('❌ 工時表驗證失敗，請檢查格式並重試。', 'error');
                    return;
                }
                
                updateProgress(80, '處理工時資料...');
                await processTimesheetData(parsed);
                
                updateProgress(100, '處理完成！');
                showMessage('✅ 工時表上傳並處理成功！');
                
            } catch (error) {
                addDebugLog('處理檔案時發生錯誤: ' + error.message, 'error');
                showMessage('處理工時表時發生錯誤: ' + error.message, 'error');
                updateProgress(0, '處理失敗');
            } finally {
                setButtonLoading('upload-file-btn', false, '選擇工時表文件');
                event.target.value = '';
            }
        }
        
        // Data Processing Logic
        function validateTimesheetData(data) {
            const result = { success: [], warnings: [], errors: [] };
            
            addDebugLog(`開始驗證 ${data.length} 筆資料`);
            
            if (data.length === 0) {
                result.errors.push('文件為空或格式不正確。');
                return result;
            }
            
            const requiredFields = ['Payroll ID', 'First Name', 'Last Name', 'Monday of the Work Week', 'Hours'];
            const headers = Object.keys(data[0] || {});
            
            addDebugLog(`檢查必要欄位: ${requiredFields.join(', ')}`);
            addDebugLog(`實際欄位: ${headers.join(', ')}`);
            
            requiredFields.forEach(field => {
                if (!headers.includes(field)) {
                    result.errors.push(`缺少必要欄位: ${field}。`);
                    addDebugLog(`缺少必要欄位: ${field}`, 'error');
                }
            });
            
            if (result.errors.length > 0) return result;
            
            let validRecords = 0;
            data.forEach((row, index) => {
                const payrollId = row['Payroll ID']?.trim();
                const workWeek = row['Monday of the Work Week']?.trim();
                const hours = parseFloat(row['Hours']);
                const firstName = row['First Name']?.trim();
                const lastName = row['Last Name']?.trim();

                let hasError = false;

                if (!payrollId) {
                    result.errors.push(`第${index + 2}行: 缺少Payroll ID。`);
                    hasError = true;
                } else if (!validatePayrollID(payrollId)) {
                    result.errors.push(`第${index + 2}行: Payroll ID 格式錯誤 (${payrollId})。應為XX-000或XXX-0000格式。`);
                    hasError = true;
                }

                if (!firstName || !lastName) {
                    result.errors.push(`第${index + 2}行: 缺少員工姓名。`);
                    hasError = true;
                }

                if (!workWeek) {
                    result.errors.push(`第${index + 2}行: 缺少工作週日期。`);
                    hasError = true;
                } else if (!parseDate(workWeek)) {
                    result.errors.push(`第${index + 2}行: 日期格式錯誤 (${workWeek})。請使用YYYY-MM-DD或DD/MM/YYYY格式。`);
                    hasError = true;
                }

                if (isNaN(hours)) {
                    result.errors.push(`第${index + 2}行: 工時資料無效 (${row['Hours']})。`);
                    hasError = true;
                } else if (hours < 0) {
                    result.errors.push(`第${index + 2}行: 工時不能為負數 (${hours})。`);
                    hasError = true;
                } else if (hours > 80) {
                    result.warnings.push(`第${index + 2}行: 工時異常高 (${hours}小時)，請確認是否正確。`);
                }

                if (!hasError) {
                    validRecords++;
                }
            });

            addDebugLog(`驗證完成: ${validRecords} 筆有效記錄，${result.errors.length} 個錯誤，${result.warnings.length} 個警告`);

            if (result.errors.length === 0) {
                result.success.push(`✅ 成功驗證 ${validRecords} 筆記錄。`);
            }
            
            return result;
        }

        function showValidationResults(result) {
            const container = document.getElementById('validation-results');
            let html = '';
            
            result.success.forEach(msg => {
                html += `<div class="validation-item validation-success">${msg}</div>`;
            });
            
            result.warnings.forEach(msg => {
                html += `<div class="validation-item validation-warning">⚠️ ${msg}</div>`;
            });
            
            result.errors.forEach(msg => {
                html += `<div class="validation-item validation-error">❌ ${msg}</div>`;
            });
            
            container.innerHTML = html;
        }

        async function processTimesheetData(data) {
            addDebugLog(`開始處理 ${data.length} 筆工時資料`);
            
            let processedCount = 0;
            let newEmployees = 0;
            let updatedRecords = 0;
            
            for (let i = 0; i < data.length; i++) {
                const row = data[i];
                const payrollId = row['Payroll ID']?.trim();
                const firstName = row['First Name']?.trim();
                const lastName = row['Last Name']?.trim();
                const workWeekStr = row['Monday of the Work Week']?.trim();
                const hours = parseFloat(row['Hours']) || 0;
                const level = row['Level']?.trim() || '';
                const rate = parseRate(row['Rate']) || 0;
                const farm = row['Farm']?.trim() || '';

                if (!validatePayrollID(payrollId)) continue;

                const parsedWorkWeek = parseDate(workWeekStr);
                if (!parsedWorkWeek) continue;
                
                const workWeekDate = toLocalDateString(parsedWorkWeek);
                
                // Create or update employee
                if (!employees[payrollId]) {
                    employees[payrollId] = {
                        payrollId,
                        firstName,
                        lastName,
                        startDate: workWeekDate,
                        level,
                        farm,
                        hourlyRate: rate,
                        workWeeks: {},
                        totalHours: 0
                    };
                    newEmployees++;
                    addDebugLog(`新增員工: ${firstName} ${lastName} (${payrollId})`);
                } else {
                    // Update employee info if provided
                    if (firstName) employees[payrollId].firstName = firstName;
                    if (lastName) employees[payrollId].lastName = lastName;
                    if (farm) employees[payrollId].farm = farm;
                    if (level) employees[payrollId].level = level;
                    if (rate > 0) employees[payrollId].hourlyRate = rate;
                }
                
                // Add or update timesheet record
                const existingRecordIndex = timesheetData.findIndex(
                    item => item.payrollId === payrollId && item.workWeekDate === workWeekDate
                );

                if (existingRecordIndex !== -1) {
                    timesheetData[existingRecordIndex].hours = hours;
                    timesheetData[existingRecordIndex].uploadDate = new Date().toISOString();
                    updatedRecords++;
                } else {
                    timesheetData.push({
                        payrollId,
                        firstName,
                        lastName,
                        workWeekDate,
                        hours,
                        uploadDate: new Date().toISOString()
                    });
                }
                
                processedCount++;
            }
            
            // Update employee totals
            Object.values(employees).forEach(employee => {
                employee.workWeeks = {};
                employee.totalHours = 0;
                
                timesheetData
                    .filter(item => item.payrollId === employee.payrollId)
                    .forEach(item => {
                        employee.workWeeks[item.workWeekDate] = item.hours;
                        employee.totalHours += item.hours;
                    });
            });
            
            saveLocalData();
            updateAllTables();
            
            addDebugLog(`處理完成: ${processedCount} 筆記錄，${newEmployees} 位新員工，${updatedRecords} 筆更新`);
        }

        function updateAllTables() {
            updateOverviewTable();
        }

        function updateOverviewTable() {
            const container = document.getElementById('overview-table-container');
            
            if (Object.keys(employees).length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #777; margin-top: 30px;">尚未載入員工資料。</p>';
                return;
            }
            
            let tableHTML = `
                <div class="summary-cards">
                    <div class="summary-card">
                        <h3>${Object.keys(employees).length}</h3>
                        <p>總員工數</p>
                    </div>
                    <div class="summary-card">
                        <h3>${timesheetData.length}</h3>
                        <p>工時記錄總數</p>
                    </div>
                    <div class="summary-card">
                        <h3>${Object.values(employees).reduce((sum, emp) => sum + emp.totalHours, 0).toFixed(0)}</h3>
                        <p>總工時數</p>
                    </div>
                </div>
                
                <table class="employee-table">
                    <thead>
                        <tr>
                            <th>員工編號</th>
                            <th>姓名</th>
                            <th>農場</th>
                            <th>職級</th>
                            <th>時薪</th>
                            <th>總工時</th>
                            <th>最後更新</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            Object.values(employees).forEach(employee => {
                const fullName = `${employee.firstName} ${employee.lastName}`.trim();
                const lastRecord = timesheetData
                    .filter(item => item.payrollId === employee.payrollId)
                    .sort((a, b) => new Date(b.uploadDate) - new Date(a.uploadDate))[0];
                const lastUpdate = lastRecord ? new Date(lastRecord.uploadDate).toLocaleDateString('zh-TW') : '未知';
                
                tableHTML += `
                    <tr>
                        <td><strong>${employee.payrollId}</strong></td>
                        <td>${fullName}</td>
                        <td>${employee.farm || '-'}</td>
                        <td>${employee.level || '-'}</td>
                        <td class="money">$${(employee.hourlyRate || 0).toFixed(2)}</td>
                        <td><strong>${(employee.totalHours || 0).toFixed(2)}</strong></td>
                        <td>${lastUpdate}</td>
                    </tr>
                `;
            });
            
            tableHTML += `</tbody></table>`;
            container.innerHTML = tableHTML;
        }
    </script>
</body>
</html>
